Task 1 - Introduction
--------------------------------

Once we have an initial foothold in the system, it is essential that we begin enumeration so that we can become as familiar with our new environment as possible. This will help us make decisions on what to do and where to pivot next. Now that we have this new foothold, it is time to begin post-exploitation.

This room will cover the commonly-used concepts, technologies and products that we need to be aware of.

It is assumed at this point that we already have established an initial foothold.  and are ready to expland our knowledge more about the environment by enumerating for the following:

-   Network infrastrucutre
-   Active Directory Environment
-   Users and Groups
-   Host-based security solutions
-   Network-based security solutions
-   Applications and services

__Questions__

Let's start learning!
Answer: _None Needed_


Task 2 - Deploy the VM
--------------------------------------

Start the VM.

Connect via split-screen or by RDP once you connect to either the Attackbox or via VPN.

`xfreerdp /v:kkidd /p:Pass123321@ /cert:ignore /smart-sizing:1600x1200 +clipboard`

__Questions__

Let's discuss the common network infrastructure in the next task!

Answer: _None Needed_


Task 3 -  Network Infrastructure
--------------------------------------------------------

Once we gain our first foothold on the new system, our first goal must be to enumerate the system to find out where we are and we we can get to.  We need to understand what services the machine provides, what kind of network we are in, etc. This task will discuss the common types of networks we may face during a Red Team engagement.

Typically network segmentation via additional subnets/vlans are an extra layer of protection on the network which will keep users from unauthorized access to customer data, financial records, etc.

Hosts within a these VLANs may only communicate with other hosts within the same VLAN.

### Internal Networks
Internal Networks are subnetworks are segregated based on their importance of accessibility of its data.  The main purpose of the internal network(s) is to share information, faster and easier communications, collaboration tools, operational systems, and network services within an organization.  Some reasons that network administrators use to segment the network are:

* Controlling Network Traffic
* Optimizing Network Performance
* Improving Security Posture

### A Demilitarized Zone (DMZ)
A DMZ Network is an edge network employees use to put hosts on the Internet, where they are actually on a subnetwork between the company networks and the actual Internet. It provides an extra layer of protection.

Companies use these DMZ's to host public services such as DNS, FTP, Proxy, VPN, etc.

DMZ network traffic is **untrusted traffic**

### Network Enumeration
During this phase there are some things we want to check:

* TCP ports
* UDP ports
* Established Connections
* Routing Tables
* ARP Tables
* etc

We can gather TCP and UDP open ports using the `netstat` command.

```Powershell
PS C:\Users\thm> netstat -na

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING
  TCP    0.0.0.0:88             0.0.0.0:0              LISTENING
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING
  TCP    0.0.0.0:389            0.0.0.0:0              LISTENING
```

Next we can check out the ARP table, which contains the IP address and the physical address of the computers that communicated with the target within the network. This information may help us understand possible new pivot points.

```Powershell
PS C:\Users\thm> arp -a

Interface: 10.10.141.51 --- 0xa
  Internet Address      Physical Address      Type
  10.10.0.1             02-c8-85-b5-5a-aa     dynamic
  10.10.255.255         ff-ff-ff-ff-ff-ff     static
```

### Internal Network Services
In this example, we see only private networks in the arp table. It looks like this machine only has access to the internal network.  It will not be accessible outside of the network from the Internet, however once we have a foothold here we can access internal network services.

We will discuss more Windows applications and services in Task 9.

__Questions__

Read the above!
Answer: _None Needed_


Task 4 - Active Directory (AD) Environment
---------------------------------------------------------------------

### What is the Active Directory (AD) Environment?

![[ad-1.png]]

AD  is a Windows-based directory service that stores and provides data objects to the internal network environment. It allows for centralized management of authentication and authorization. The AD contains essential information about the network and the environment, including users, computers, printers, etc. For example, AD might have users' details such as job title, phone number, address, passwords, groups, permission, etc.

![[ad-2.png]]

The above diagram is one possible arrangement, where the Domain Controller (DC) is placed in a Servers network, and the other workstations are placed in a Controlled Network which is separated by Firewall. Those workstations can join the domain and use AD services through the firewall which has various Access Control Lists (ACLs) opened to allow this communication.

Here are some AD components that we need to be familiar with:

-   Domain Controllers
-   Organizational Units
-   AD objects
-   AD Domains
-   Forest
-   AD Service Accounts: Built-in local users, Domain users, Managed service accounts
-   Domain Administrators

The **Domain Controller (DC)** is a Windows server that provides AD services and controls the entire domain.  It is a form of centralized user management that provides encryption of user data as well as controlling access to a network, including users, groups, policies, and computers. It also enables resource access and sharing. These are all reasons why attackers target a domain controller in a domain because it contains a lot of high-value information.

![[ad-3.png]]

**Organizational Units (OU's)** are containers within the AD domain with a hierarchical structure.

**Active Directory Objects** can be a single user or a group, or a hardware component, such as a computer or printer. Each domain holds a database that contains object identity information that creates an AD environment, including:

-   Users - A security principal that is allowed to authenticate to machines in the domain
-   Computers - A special type of user accounts
-   GPOs - Collections of policies that are applied to other AD objects

**AD domains** are a collection of Microsoft components within an AD network. 

**AD Forest** is a collection of domains that trust each other.

![[ad-4.png]]

If we find that the network we have access to has an AD environment, it is significant because we can enumerate this information and leverage methods of exploiting AD to gain further access in the lateral movement stage.

__Questions__

In order to check whether the Windows machine is part of the AD environment or not, one way, we can use the command prompt systeminfo command. The output of the systeminfo provides information about the machine, including the operating system name and version, hostname, and other hardware information as well as the AD domain.

```Powershell
PS C:\Users\thm> systeminfo | findstr Domain
OS Configuration:          Primary Domain Controller
Domain:                    thmdomain.com
```

From the above output, we can see that the computer name is an AD with thmdomain.com as a domain name which confirms that it is a part of the AD environment. 

Note that if we get WORKGROUP in the domain section, then it means that this machine is part of a local workgroup.

Before going any further, ensure the attached machine is deployed and try what we discussed. **Is the attached machine part of the AD environment? (Y|N)**
Answer: _Y_

If it is part of an AD environment, **what is the domain name of the AD?**
Answer: _thmredteam.com_

![[ad-env-1.jpg]]


Task 5 - Users and Groups Management
----------------------------------------------------------------

In this task we will be learning more about users and groups in the AD structure. Gathering information in this compromised machine that will be critical to use in next steps. Account discovery is one of the 1st steps once we gain access. 

AD contains various accounts with the permissions, roles and purposes. Common AD service accounts include built-in local accounts, domain user accounts, managed service accounts, and virtual accounts.

-   The built-in local users' accounts are used to manage the system locally, which is not part of the AD environment.
-   Domain user accounts with access to an active directory environment can use the AD services (managed by AD).
-   AD managed service accounts are limited domain user account with higher privileges to manage AD services.
-   Domain Administrators are user accounts that can manage information in an Active Directory environment, including AD configurations, users, groups, permissions, roles, services, etc. One of the red team goals in engagement is to hunt for information that leads to a domain administrator having complete control over the AD environment.

The following are Active Directory Administrators accounts:

| BUILTIN\Administrator | Local admin access on a domain controller              |
| --------------------- | ------------------------------------------------------ |
| Domain Admins         | Administrative access to all resources in the domain   |
| Enterprise Admins     | Available only in the forest root                      |
| Schema Admins         | Capable of modifying domain/forest; useful for redteam |
| Server Operators      | Can manage domain servers                              |
| Account Operators     | Can manage users that are not in privileged groups     |
|                       |                                                        |

Now that we know some of the basic info on accounts, let's enumerate that compromised Windows box. As a current user, we have specific permissions to view or manage things within the machine and the AD environment.

### Active Directory (AD) Enum

Enumerating AD will require differnt sets of tools. Once we confirm that the machine is part of AD, we can start hunting for other variables and info that we can use later on. At this stage we will use PowerShell to enumerate for users and groups.

The following PowerShell command is to get all the AD user accounts. 

`Get-ADUser -Filter *`

![[ad-env-2.jpg]]

We can also use the [LDAP hierarchical tree structure](http://www.ietf.org/rfc/rfc2253.txt) to find a user within the AD environment. The Distinguished Name (DN) is a collection of comma-separated key and value pairs used to identify unique records within the directory. The DN consists of Domain Component (DC), OrganizationalUnitName (OU), Common Name (CN), and others. The following "CN=User1,CN=Users,DC=thmredteam,DC=com" is an example of DN, which can be visualized as follow:


Using SearchBase option, we can look for the CN in AD.  For example, we can list any user in the Users  Group:

```PowerShell
PS C:\Users\thm> Get-ADUser -Filter * -SearchBase "CN=Users,DC=THMREDTEAM,DC=COM"


DistinguishedName : CN=Administrator,CN=Users,DC=thmredteam,DC=com
Enabled           : True
GivenName         :
Name              : Administrator
ObjectClass       : user
ObjectGUID        : 4094d220-fb71-4de1-b5b2-ba18f6583c65
SamAccountName    : Administrator
SID               : S-1-5-21-1966530601-3185510712-10604624-500
Surname           :
UserPrincipalName :
```


__Questions__

  
Use the Get-ADUser -Filter * -SearchBase command to list the available user accounts within THM OU in the thmredteam.com domain. How many users are available?

```PowerShell
PS C:\Users\thm> Get-ADUser -Filter * -SearchBase "OU=THM,DC=THMREDTEAM,DC=COM"
```

Answer: _6_

Once you run the previous command, what is the UserPrincipalName (email) of the admin account?

![[ad-env-3.jpg]]

Answer: _thmadmin@thmredteam.com_








