
Task 1 - Introduction
-------------------------------------

Operating systems have a lot more technology and architecture behind them than we may see at first. In this room, we will be observing the Windows operating systems and common internal components.

### Learning Objectives

-   Understand and interact with Windows processes and their underlying technologies.
-   Learn about core file formats and how they are used.
-   Interact with Windows internals and understand how the Windows kernel operates.

With Windows machines making up a majority of corporate infrastructure, red teams need to understand Windows internals and how they can be (ab)used. The red team can (ab)use Windows to aid in evasion and exploitation when crafting offensive tools or exploits.  

Before beginning this room, familiarize yourself with basic Windows usage and functionality. Basic programming knowledge in C++ and PowerShell is also recommended but not required.

We have provided a base Windows machine with the files needed to complete this room. You can access the machine in-browser or through RDP using the credentials below.

Machine IP: `MACHINE_IP`             Username: `THM-Attacker`             Password: `Tryhackme!`

This is going to be a lot of information. Please buckle your seatbelts and locate your nearest fire extinguisher.

__Questions__

Start the provided machine and move on to the next tasks.
Answer: _None Needed_

Task 2 - Processes
-------------------------------

A process maintains and represents the execution of a program; an application can contain one or more processes. A process has many components that it gets broken down into to be stored and interacted with. The [Microsoft docs](https://docs.microsoft.com/en-us/windows/win32/procthread/about-processes-and-threads) break down these other components, "Each process provides the resources needed to execute a program. A process has a virtual address space, executable code, open handles to system objects, a security context, a unique process identifier, environment variables, a priority class, minimum and maximum working set sizes, and at least one thread of execution." This information may seem intimidating, but this room aims to make this concept a little less complex.

As previously mentioned, processes are created from the execution of an application. Processes are core to how Windows functions, most functionality of Windows can be encompassed as an application and has a corresponding process. Below are a few examples of default applications that start processes.

-   MsMpEng (Microsoft Defender)
-   wininit (keyboard and mouse)
-   lsass (credential storage)

Attackers can target processes to evade detections and hide malware as legitimate processes. Below is a small list of potential attack vectors attackers could employ against processes,

-   Process Injection ([TI055](https://attack.mitre.org/techniques/T1055/))
-   Process Hollowing ([TI055.012](https://attack.mitre.org/techniques/T1055/012/))
-   Process Masquerading ([TI055.013](https://attack.mitre.org/techniques/T1055/013/))

Processes have many components; they can be split into key characteristics that we can use to describe processes at a high level. The table below describes each critical component of processes and their purpose.

| Process Component             | Purpose                                                                          |
| ----------------------------- | -------------------------------------------------------------------------------- |
| Private Virtual Address Space | Virtual Mom Addr that process is allocated                                       |
| Executable Program            | Defines code & data stored in the virtual addr space                             |
| Open Handles                  | Defines handles to system resources accessible to the process                    |
| Security Context              | The access token defines the user, security groups, privs, & other security info |
| Process ID                    | Unique numerical identifier of the process                                       |
| Threads                       | Section of a process scheduled for execution                                                                                 |

We can also explain a process at a lower level as it resides in the virtual address space. The table and diagram below depict what a process looks like in memory.

| Component         | Purpose                                   |
| ----------------- | ----------------------------------------- |
| Code              | Code to be executed by the process        |
| Global Variables  | Stored Variables                          |
| Process Heap      | Defines the heap where the data is stored |
| Process Resources | Defines further resources of the process  |
| Environment Block | Data structure to define process information                                          |

![[winsysinternals-1.png]]

This information is excellent to have when we get deeper into exploiting and abusing the underlying technologies, but they are still very abstract. We can make the process tangible by observing them in the _Windows Task Manager_. The task manager can report on many components and information about a process. Below is a table with a brief list of essential process details.

| Value/Component | Purpose                                                              | Example     |
| --------------- | -------------------------------------------------------------------- | ----------- |
| Name            | Defines the name of the process, typicall inherited from the app     | conhost.exe |
| PID             | Unique numerical value to id the process                             | 7408        |
| Status          | Determines how the process is running (running, suspended, etc.)     | Running     |
| User name       | User that initiated the process. Can denote privilege of the process | SYSTEM            |

These are what you would interact with the most as an end-user or manipulate as an attacker.

There are multiple utilities available that make observing processes easier; including [Process Hacker 2](https://github.com/processhacker/processhacker), [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer), and [Procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon).

Processes are at the core of most internal Windows components. The following tasks will extend the information about processes and how they're used in Windows.

__Questions__

Open the provided file: "Logfile.PML" in Procmon and answer the questions below.

![[winsysinternals-2.jpg]]

Answer: _None Needed_

What is the process ID of "notepad.exe"?

![[winsysinternals-3.jpg]]
Answer: _5984_

What is the parent process ID of the previous process?
![[winsysinternals-4.jpg]]
Listed under process start Parent PID

Answer: _3412_


What is the integrity level of the process?
Right click on the process and show properties to show this.

Answer: _High_

Task 3 - Threads
-------------------------------

﻿A thread is an executable unit employed by a process and scheduled based on device factors.

Device factors can vary based on CPU and memory specifications, priority and logical factors, and others.

We can simplify the definition of a thread: "controlling the execution of a process."

Since threads control execution, this is a commonly targeted component. Thread abuse can be used on its own to aid in code execution, or it is more widely used to chain with other API calls as part of other techniques. 

Threads share the same details and resources as their parent process, such as code, global variables, etc. Threads also have their unique values and data, outlined in the table below.

| Component            | Purpose                                                                  |
| -------------------- | ------------------------------------------------------------------------ |
| Stack                | All data relevant & specific to the thread (exception, proceedures, etc) |
| Thread Local Storage | Pointers for allocating storage to a unique data environment             |
| Stack Argument       | Unique value assigned to each thread                                     |
| Context Structure    | Holds machine register values maintained by the kernel                                                                         |

Threads may seem like bare-bones and simple components, but their function is critical to processes.

__Questions__

Open the provided file: "Logfile.PML" in Procmon and answer the questions below.
Answer: _None Needed_

What is the thread ID of the first thread created by notepad.exe?
![[winsysinternals-5.jpg]]
On the Thread Create operation see the Details column.

Answer: _5908_

What is the stack argument of the previous thread?
![[winsysinternals-6.jpg]]
Shown as Thread # on the Event Properties.

Answer: _6584_

Task 4 - Virtual Memory
------------------------------------------

Virtual memory is a critical component of how Windows internals work and interact with each other. Virtual memory allows other internal components to interact with memory as if it was physical memory without the risk of collisions between applications. The concept of modes and collisions is explained further in task 8.

Virtual memory provides each process with a [private virtual address space](https://docs.microsoft.com/en-us/windows/win32/memory/virtual-address-space). A memory manager is used to translate virtual addresses to physical addresses. By having a private virtual address space and not directly writing to physical memory, processes have less risk of causing damage.

The memory manager will also use _pages_ or _transfers_ to handle memory. Applications may use more virtual memory than physical memory allocated; the memory manager will transfer or page virtual memory to the disk to solve this problem. You can visualize this concept in the diagram below.

![[winsysinternals-7.png]]

The theoretical maximum virtual address space is 4 GB on a 32-bit x86 system.

This address space is split in half, the lower half (_0x00000000 - 0x7FFFFFFF_) is allocated to processes as mentioned above. The upper half (_0x80000000 - 0xFFFFFFFF_) is allocated to OS memory utilization. Administrators can alter this allocation layout for applications that require a larger address space through settings (_increaseUserVA_) or the [AWE (**A**ddress **W**indowing **E**xtensions)](https://docs.microsoft.com/en-us/windows/win32/memory/address-windowing-extensions).

The theoretical maximum virtual address space is 256 TB on a 64-bit modern system.

The exact address layout ratio from the 32-bit system is allocated to the 64-bit system.

Most issues that require settings or AWE are resolved with the increased theoretical maximum.

You can visualize both of the address space allocation layouts to the right.

![[winsysinternals-8.png]]

Although this concept does not directly translate to Windows internals or concepts, it is crucial to understand. If understood correctly, it can be leveraged to aid in abusing Windows internals.

__Questions__

Read the above and answer the questions below.
Answer: _None Needed_

What is the total theoretical maximum virtual address space of a 32-bit x86 system?
4 GB on 32bit and 256 TB on 64bit systems

Answer: _4 GB_

What default setting flag can be used to reallocate user process address space?
IncreaseUserVA is part of the AWE (Address Windowing Extentions)
Answer: _increaseuserva_

Open the provided file: "Logfile.PML" in Procmon and answer the questions below.
Answer: _None Needed_

What is the base address of "notepad.exe"?
![[winsysinternals-9.jpg]]
Go to the Operation Load Image, then check Event properties to see the Image Base and size.
Answer: _0x7ff652ec0000_


Task 5 - Dynamic Link Libraries
---------------------------------------------------


