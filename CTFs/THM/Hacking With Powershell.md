
Task1 - Objectives
----------------------

Using powershell to get information or perform exploits. There are additional addon modules we can load to make it much more functional for this purpose.

__Questions__

Read the above and deploy the machine!
Answer: _None Needed_


Task2 - What is Powershell
---------------------------------

Powershell is Part of the Windows environment. It is a scripting language built on the .NET framework.

Most of these commands for Powershell, aka cmdlets, are written in .NET, so they are partially object-oriented. It's possible to pass output from one command to another.

To get help with any commands you can use the `Get-Command` keyword either alone or followed with a verb. Here are some common verbs:

Common verbs to use include:

-   Get
-   Start
-   Stop 
-   Read
-   Write
-   New
-   Out

visit [this](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/approved-verbs-for-windows-powershell-commands?view=powershell-7) link for a complete list.

__Questions__

What is the command to get help about a particular cmdlet(without any parameters)?
Answer: _Get-Help_

Task3 - Basic Powershell Commands
---------------------------------------------

`Get-Help` and `Get-Command` are 2 of the best commands to help you get started.

__Using Get-Help__

It's easy to use Get-Help either without any options or from listing a Command-Name after it for additional per-command help.

Example: `Get-Help Command-Name` or `Get-Help Command-Name -examples`

__Using Get-Command__

The command prints a list of all current cmdlets on the system. It also does a bit of wildcard matching so you can search with simple expressions.

Here are some examples:

`Get-Command Word-*`
`Get-Command *-Word`

For Example using `Get-Command New-*` would show all of the cmdlets installed on the system that start with the word 'new'.

__Object Manipulation__

Like Unix based systems, with Powershell, the output of cmdlets are 'objects'. You can pass these objects between other cmdlets using the Pipe (pipeline) character. If you using Unix or Linux then you are already familar with this concept.

Example:
`Get-Command | Get-Member -MemberType Method`

You can also pass flags as shown to filter down on Methods and Properties.

__Creating Objects From Previous cmdlets__

One thing you can do is to pull properties from cmdlets using the `Select-Object` cmdlet to create new objects.

`Get-ChildItem | Select-Object -Property Mode`

You can also use these flags:
-   first - gets the first x object
-   last - gets the last x object
-   unique - shows the unique objects
-   skip - skips x objects

__Filtering Objects__

When you need to filter output to a very specific Object, you can use the Where-Object cmdlet. Here are some examples:

`Verb-Noun | Where-Object -Property PropertyName -operator Value`

`Verb-Noun | Where-Object {$_.PropertyName -operator Value}`

Notive in the 2nd invocation, it uses the `$_` which allows us to iterate through each of the results.

The Value for the `-operator` could be one of these:
  -   -Contains: if any item in the property value is an exact match for the specified value
-   -EQ: if the property value is the same as the specified value
-   -GT: if the property value is greater than the specified value

You can find the full list here at [this](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/where-object?view=powershell-6) link.

`Get-Service | Where-Object -Property Status -eq Stopped`

Would return a list of all the stopped services.

__Sort Object__

If there is a lot of output you can sort through it with the `Sort-Object` cmdlet.

Example:
`Get-ChildItem | Sort-Object`

__Finding the Answers__

`Get-ChildItem -Path C:\ -Include *interesting-file.txt* -File -Recurse -ErrorAction SilentlyContinue`

![[hwp1.png]]

`Get-Content "C:\Program Files\interesting-file.txt.txt"`

![[hwp2.png]]

`Get-Command | Where-Object -Property CommandType -eq Cmdlet | Measure-Object`

![[hwp3.png]]

`Get-FileHash -Path "C:\Program Files\interesting-file.txt.txt" -Algorithm MD5`

![[hwp4.png]]

`Get-Location`

![[hwp5.png]]

`Get-Location -Path "C:\Users\Administrator\Documents\Passwords"`

![[hwp6.png]]

```powershell
Invoke-WebRequest


`Get-ChildItem -Path C:\ -Include b64.txt -Recurse -File -ErrorAction SilentlyContinue

`certutil -decode "C:\Users\Administrator\Desktop\b64.txt" b64.txt.dec`

`Get-Content .\b64.txt.dec`
```


![[hwp7.png]]

__Questions__

What is the location of the file "interesting-file.txt"
Answer: _C:\Program Files_

Specify the contents of this file
Answer: _notsointerestingcontent_

How many cmdlets are installed on the system(only cmdlets, not functions and aliases)?
Answer: _6638_

Get the MD5 hash of interesting-file.txt
Answer: _49A586A2A9456226F8A1B4CEC6FAB329_

What is the command to get the current working directory?
Answer: _Get-Location_

Does the path "C:\Users\Administrator\Documents\Passwords" Exist(Y/N)?
Answer: _N_

What command would you use to make a request to a web server?
Answer: _Invoke-WebRequest_

Base64 decode the file b64.txt on Windows.
Answer: _ihopeyoudidthisonwindows_



Task4 - Enumeration
-----------------------------

Now that we kinda have some familiarity with PowerShell, we will be enumerating some more realworld stuff now with it such as:

-   users
-   basic networking information
-   file permissions
-   registry permissions
-   scheduled and running tasks
-   insecure files

__Questions__

How many users are there on the machine?
`Get-LocalUser`
![[hwp10.png]]

Answer: _5_

Which local user does this SID(S-1-5-21-1394777289-3961777894-1791813945-501) belong to?
`Get-LocalUser -SID S-1-5-21-1394777289-3961777894-1791813945-501`
![[hwp11.png]]

Answer: _Guest_

How many users have their password required values set to False?
`Get-LocalUser | Where-Object -Property PasswordRequired -Match false`
![[hwp12.png]]
Answer: _4_

How many local groups exist?
`Get-LocalGroup | measure`
![[hwp13.png]]

Answer:  _24_

What command did you use to get the IP address info?
`Get-NetIPAddress`
![[hwp14.png]]
Answer: _Get-NetIPAddress_


How many ports are listed as listening?
`GEt-NetTCPConnection | Where-Object -Property State -Match Listen | measure`
![[hwp15.png]]
Answer: _20_

What is the remote address of the local port listening on port 445?
`GEt-NetTCPConnection | Where-Object -Property State -Match Listen`
![[hwp16.png]]
Answer: _::_


How many patches have been applied?
`Get-Hotfix | measure`
![[hwp17.png]]
Answer: _20_

When was the patch with ID KB4023834 installed?
`Get-Hotfix -Id KB4023834`
![[hwp18.png]]
Answer: _6/15/2017 12:00:00 AM_

Find the contents of a backup file.
`Get-ChildItem -Path C:\ -Include *.bak* -File -Recurse -ErrorAction SilentlyContinue`
`Get-Content "C:\Program Files (x86)\Internet Explorer\passwords.bak.txt"`
![[hwp19.png]]
Answer: _backpassflag_

Search for all files containing API_KEY
`Get-ChildItem C:\* -Recurse | Select-String -pattern API_KEY`
![[hwp20.png]]

Answer: _fakekey123_

What command do you do to list all the running processes?
`Get-Process`
![[hwp21.png]]
Answer: _Get-Process_


What is the path of the scheduled task called new-sched-task?
`Get-ScheduleTask -TaskName new-sched-task`
![[hwp22.png]]
Answer: _`/`_


Who is the owner of the C:\
`Get-Acl c:\`
![[hwp23.png]]
Answer: _NT SERVICE\TrustedInstaller_

Task5 - Basic Scripting Challenge
-----------------------------------------

In this challenge we will start looking into using Powershell to form scripts which will give us more power to do more complex tasks.

There is a script on the Desktop called `listening-ports.ps1` which we are encouraged to go through and understand.  Part of this script we can actually use for a later task which is to write a small port scanner.

```powershell
$system_ports = Get-NetTCPConnection -State Listen

$text_port = Get-Content -Path C:\Users\Administrator\Desktop\ports.txt

foreach($port in $text_port){

    if($port -in $system_ports.LocalPort){
        echo $port
     }

}
```

The script takes all of the listening ports using the 1st line and puts them in the variable `$system_ports`.   The second part reads all the ports in a file on the desktop and finally, for each port in that list that we read into the variable `$text_port`, if one of those ports in also listed in the `$system_ports` varible then we want to print that out.

__Questions__

For these quetions, we are expected to write some small scripts to open the email files on the desktop and get the info we need (without opening and searching them in a GUI based text editor or something)

What file contains the password?

```powershell
$path = "C:\Users\Administrator\Desktop\emails\*"
$string_pattern = "password"
$command = Get-ChildItem -Path $path -Recurse | Select-String -Pattern $String_pattern 
echo $command
```

![[hwp24.png]]

Answer: _Doc3M_

What is the password?
Answer: _johnisalegend99_

What files contains an HTTPS link?

For this we can slightly modify the script we had previously written:
```powershell
$path = "C:\Users\Administrator\Desktop\emails\*"  
$string_pattern = "https://"  
$command = Get-ChildItem -Path $path -Recurse | Select-String -Pattern $String_pattern
echo $command
```

![[hwp25.png]]
Answer: _Doc2Mary_


Task6 - Intermediate Scripting
----------------------------------------

In this task we will be working on a tiny port scanner I was discussing in the previous task.  This time we will make a script to do a TCP connect port scan on the localhost to find any ports open between 130-140.

__Question__

How many open ports did you find between 130 and 140(inclusive of those two)?

```powershell
for($i=130; $i -le 140; $i++){
    Test-NetConnection localhost -Port $i -InformationLevel Quiet
}
```

Here is another way you can do this from the CLI:
```powershell
1..1024 | % {echo ((New-Object Net.Sockets.TcpClient).Connect("127.0.0.1", $_)) "Open port - $_"} 2>$null
```

![[hwp26.png]]

Answer: _11_


