
<span class="highlight" style="color: red; background-color: #170202">An introduction to Data Exfiltration and Tunneling over various protocols.</span>

Task 1 - Introduction
----------------------------------

### Welcome to Data Exfiltration

Cybercriminals often use unique techniques to get the data from servers they hack without anyone noticing.  Of course companies employee many methods to protect data, but there are very sneaky ways to get data off of a server over standard protocols like DNS, HTTP(s)/ SSH/ etc. so that it looks like standard traffic.  This makes it extremelt difficult to determine how it is happening.

### Learning Objectives

We will learn about some of the data exfilration types and showcase some techniques about this:

-   What is Data exfiltration?
-   Understand data exfiltration types and how they can be used.  
-   Practice data exfiltration over protocols: Sockets, SSH, ICMP, HTTP(s), and DNS.
-   Practice C2 communications over various protocols.
-   Practice establishing Tunneling over DNS and HTTP.

### Room Prerequisites

-   [Introductory Networking](https://tryhackme.com/room/introtonetworking)  
-   [Protocols and Servers](https://tryhackme.com/room/protocolsandservers)  
-   [DNS in Detail](https://tryhackme.com/room/dnsindetail)
-   [DNS Manipulation](https://tryhackme.com/room/dnsmanipulation)
-   Using tmux or similar tools! (for multiple sessions on single SSH login)

__Questions__
Read the task above!
Answer: _None Needed_


Task 2 - Network Infrastructure
-----------------------------------------------------

### Network Infrastructure

Here we have a practical scenario where we can perform data exfiltration and tunneling using various network protocols. The provided VM in the task contains two separate networks with multiple clients. We also hav a Jumpbox with access to both networks. The following diagram shows the setup:

![[dataexfil-1.png]]

Use the network diagram for your reference during the coming tasks for various protocols. We also set up a domain name, thm.com, to make it easier to communicate and connect within the network environment. Check the following table for more information about the domain names and network access used in this room.

| Domain Name      | IP Address    | Network Access  |
| ---------------- | ------------- | --------------- |
| jump.thm.com     | 192.168.0.133 | Net 1 and Net 2 |
| uploader.thm.com | 172.20.0.100  | Net 1           |
| flag.thm.com     | ###.##.#.###  | Net 1           |
| victim2.thm.com  | 172.20.0.101  | Net 1           |
| web.thm.com      | 192.168.0.100 | Net 2           |
| icmp.thm.com     | 192.168.0.121 | Net 2           |
| victim1.thm.com  | 192.168.0.101 | Net 2                |

### Deploy the VM!

Deploy the provided VM and connect to it via an SSH client by deploying the AttackBox or connecting to the VPN. Use the following credentials to connect to the Jumpbox machine with access to the internal networks.

Machine IP: MACHINE_IP            Username: thm         Password: tryhackme 

Connect to the VM via the SSH client

```shell
root@AttackBox$ ssh thm@MACHINE_IP 
```

Once you are connected to the Jumpbox machine, you have access to both networks. Check the network infrastructure for more information.

### Lab Recommendation

-   We recommend using the **JumpBox** and the network environment for most tasks (TCP, SSH, ICMP, DNS) to avoid technical issues with DNS and networking. However, If you prefer to use the AttackBox for the DNS Tunneling task (task 10), you must change the DNS settings of the AttackBox to MACHINE_IP. For more information about changing the DNS for AttackBox, check the DNS configuration (Task 8). 

-   In most cases, we need to use two machines to establish communication. Thus, we need two or more Linux terminals available to complete the task. Therefore, we recommend using the tmux tool for creating multiple sessions over a single SSH login.

__Questions__

Once you've deployed the VM, please wait a few minutes for the VM and the networks to start, then progress to the next task!

Answer: _None Needed_


Task 3 - Data Exfiltration
-------------------------------------------

### What is Data Exfiltration

As the name implies. It's the process of taking an unauthorized copy of data from a victim's network to a location outside the network. Data Exfiltration happens post-compromise where a threat actor has already gained access to the victim's network and/or associated systems.  Data Exfiltration usually happens as the last step in the Cyber Kill Chain mode, Actions on Objectives.

Data Exfiltration is also used to hide an adversary's actions and bypass security products. For example, the DNS Exfiltration technique can evade security products, such as a fireall.

Some examples of sensative data:

-   Usernames and passwords or any authentication information.
-   Bank accounts details
-   Business strategic decisions.
-   Cryptographic keys.
-   Employee and personnel information.
-   Project code data.

### How to use Data Exfiltration

There are three primary use case scenarios of data exfiltration, including:

1.  Exfiltrate data
2.  Command and control communications.
3.  Tunneling

**Traditional Data Exfiltration**

![[dataexfil-2.png]]

The traditional Data Exfiltration scenario is moving sensitive data out of the organization's network. An attacker can make one or more network requests to transfer the data, depending on the data size and the protocol used. Note that a threat actor does not care about the reply or response to his request. Thus, all traffic will be in one direction, from inside the network to outside. Once the data is stored on the attacker's server, he logs into it and grabs the data.

**C2 Communications**

![[dataexfil-3.png]]

Many C2 frameworks provide options to establish a communication channel, including standard and non-traditional protocols to send commands and receive responses from a victim machine. In C2 communications a limited number of requests where an attacker sends a request to execute a command in the victim's machine. Then, the agent's client executes the command and sends a reply with the result over a non-traditional protocol. The communications will go in two directions: into and out of the network.

**Tunneling**

![[dataexfil-4.png]]

In the Tunneling scenario, an attacker uses this data exfiltration technique to establish a communication channel between a victim and an attacker's machine. The communication channel acts as a bridge to let the attacker machine access the entire internal network. There will be continuous traffic sent and received while establishing the connection.

In the coming tasks, we will discuss the following techniques and use cases:

-   Exfiltrate using TCP socket and Base64
-   Exfiltrate using SSH
-   Exfiltrate using HTTPS (POST request)
-   ICMP
-   DNS

__Questions__

In which case scenario will sending and receiving traffic continue during the connection?
Answer: __

In which case scenario will sending and receiving traffic be in one direction?
Answer: __

In the next task, we will be discussing how data exfiltration over the TCP socket works!
Answer: __


Task 4 - Exfiltration using TCP socket
----------------------------------------------------------

