#activedirectory

Task1 - Introduction
-----------------------------------------

This rooms' focus will be around Active Directory.

For this Series of AD rooms, they seem to be more focused on learning rather than actual exploits, though they do walk through it. I am putting a lot of notes regarding these methods here and focussing less on the exploits, though I do show how I get them too. I won't be posting these AD rooms but will push them up to git incase I need them later. 

Task2 - Windows Domains
------------------------------------------

The main purpose of a Windows Domain is to simplify the management of a large number of devices and users by managing policy through a single source of truth which is called Active Directory (AD).

Advantages:
Central Identity Management
Managing Security Policies

In this task we will take over role of Admin on THM.local.

__Questions__
In a Windows domain, credentials are stored in a centralised repository called...
Answer:_active directory_

The server in charge of running the Active Directory services is called...
Answer: _domain controller_


Task3 - Active Directory
-----------------------------------------------

The Core of AD is Domain Service (DS). It is a catalog of objects such as user, group, machines etc.

Principals are objects such as users which can act within the domain because they can be authenticated by the domain and assigned priviledges over resources like machines and printers.

There are 2 types of Users:
1. People - those who are normal people doing their jobs.
2. Service Users - Services need to run as a user, but these users are generally only require certain privs to run a specfic service/task.

Machines are another object in the domain but also considered a Security Principal and get assigned accounts like any other user. They have local administrator on the assigned computer with limited rights in the domain.

Machine account passwords are generally rotated and are comprised of 120 random characters.

Machine accounts are easy to identify because they follow some kind of naming scheme DC01$ and as you see are followed with a dollar sign.

Here are some typical security groups:
**Security Group**

**Description**

Domain Admins

Users of this group have administrative privileges over the entire domain. By default, they can administer any computer on the domain, including the DCs.

Server Operators

Users in this group can administer Domain Controllers. They cannot change any administrative group memberships.

Backup Operators

Users in this group are allowed to access any file, ignoring their permissions. They are used to perform backups of data on computers.

Account Operators

Users in this group can create or modify other accounts in the domain.

Domain Users

Includes all existing user accounts in the domain.

Domain Computers

Includes all existing computers in the domain.

Domain Controllers

Includes all existing DCs on the domain.

Microsoft has an exhaustive list here:
https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups

You can open Active Directory Users and Computers from start menu search for users.

It will display a list of objects organised by Organizational Units (OU). 

Note: A User can only be part of a single OU at a time.

An OU can be defined arbitrarily but generally has some normal naming schemes for companies.

Default Containers other than our your own:

-   **Builtin:** Contains default groups available to any Windows host.
-   **Computers:** Any machine joining the network will be put here by default. You can move them if needed.
-   **Domain Controllers:** Default OU that contains the DCs in your network.
-   **Users:** Default users and groups that apply to a domain-wide context.
-   **Managed Service Accounts:** Holds accounts used by services in your Windows domain.

Security Groups vs. OU

OU is used to apply policy to users and computers that have sets of policies for set configurations.
SGs are used to grant permissions over resources such as printers.

__Questions__

Which group normally administrates all computers and resources in a domain?
Answer: _domain admins_

What would be the name of the machine account associated with a machine named TOM-PC?
Answer: _TOM-PC$_

Suppose our company creates a new department for Quality Assurance. What type of containers should we use to group all Quality Assurance users so that policies can be applied consistently to them?
Answer: _organizational units_


Task4 - Managing Users in AD
-----------------------------------------------

For this task we have to make a new OU for THM.

This means deleting the Research group containing the user Bob. You can right click on the group, go to advanced, and uncheck the property to prevent accidental deletion.

Then we use delegation to allow the user Phillip to manage all users password resets. This is accomplished by right clicking a group in the OU and Delegation. Then add user phillip, check name, then next, then check the box for password, next, finish. Do for each group.

Next login as Phillip on RDP.

```bash
xfreerdp /u:THM\phillip /p:Claire2008 /cert:ignore /v:10.10.8.80 /smart-sizing:1600x1200
```

As Phillip we need to open a Powershell and reset user Sophie's password.

```shell-session
PS C:\Users\phillip> Set-ADAccountPassword sophie -Reset -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') -Verbose

New Password: *********

VERBOSE: Performing the operation "Set-ADAccountPassword" on target "CN=Sophie,OU=Sales,OU=THM,DC=thm,DC=local".
```

We can also force Sophie to reset her password again upon next login with this command:

```shell-session
PS C:\Users\phillip> Set-ADUser -ChangePasswordAtLogon $true -Identity sophie -Verbose

VERBOSE: Performing the operation "Set" on target "CN=Sophie,OU=Sales,OU=THM,DC=thm,DC=local".
```

Next we login with user Sophie on RDP.

```bash
/u:THM\sophie /p:N3wpa44wurD% /cert:ignore /v:10.10.8.80 /smart-sizing:1600x1200
```

__Questions__

What is the flag found on Sophie's desktop?
Answer: _THM{thanks_for_contacting_support}

The process for granting privileges to a user over some OU or other AD object is called..
Answer: _delegation_

Task5 - Managing Computers in AD

In this task we just need to create 2 OUs under thm.local
Workstations
Servers

Then in the original Computers OU, we can select all computers except the 3 servers, and click move to move those to the new Workstations group, and for the remaining 3 servers, move those to Servers Group.

__Questions__
After organising the available comptuers, how many ended up in the Workstations OU?
Answer: _7_

Is it recommended to create separate OUs for Servers and Workstations? (yay/nay)
Answer: _yay_


Task6 - Group Policies
---------------------------------

The main idea here is to use Group Policy Objects (GPOs) to push separate policies for each group.

To configure GPOs you can use Start->Group Policy Management

You can edit policies by right clicking the policy then click Edit and then navigate to the policy you want to change.
Eg. Right click on 'Default Domain Policy' then click Edit. Then under Computer Configurations->Policies->Windows Settings->Security Settings->Account Policies->Password Policy you can change password related settings, click Apply.

In this task we will create some GPOs.

1st, we want to restrict access to the control panel to only IT users.

Then we want to create an Auto Lock Screen Policy and link it to the root domain.

You can right click on the THM->Group Policy Objects then create a new Policy. After you make it in the Group Policy Editor, you can close that, and then drag/drop the policy where it needs to go, such as THM->Marketing, Sales, Management.

It's important to note that GPOs are distributed via a network share called SYSVOL which is stored in the DC.  All users have access to that in order to periodically sync.  The default for SYSVOL is `C:\Windows\SYSVOL\sysvol\` on each of the DCs in our network.

Changes typically take 1-2 hours to propagate, but we can force that with:
`PS C:\> gpupdate /force`

__Questions__

What is the name of the network share used to distribute GPOs to domain machines?
Answer: _SYSVOL_

Can a GPO be used to apply settings to a users and computers? (yay/nay)
Answer: _yay_



Task7 - Authentication Methods
------------------------------------------

Windows will ask Windows Domain Controller to verify password access for services needing it.

There are 2 Protocols for this:
Kerberos - Recent protocol which most user today. (default)
NetNTLM - Legacy, usually enabled anyway for backward compatibility reasons.

__Kerberos__

For Kerberos, users send username and timestamp encyrpted using a key derived from their password to the Key Distribution Center (KDC). The KDC will create and send back a Ticket Granting Ticket (TGT) that allows the user to request additional tickets to access specified services. This allows users to request other access without having to keep sending their username/password.

Also the KDC will send back a Session Key along with the TGT to the user.

Then if a user wants to connect to a service like a share, website or Database, they use their TGT and ask KDC for Ticket Granting Service (TGS). TGS only allows access to the specific service they were generated for. These services are known by their Servive Prinicipal Name (SPN).

_NOTE: There is no need to store Session Key as it can recover a copy by decrypting the TGT if needed._

After our request is sent, the KDC will send us back a TGS and a Service Session Key, which we use to Auth to any services we want to access. The TGS is encypted using the Service Owner Hash. Again, as noted the Service Owner can decrypt the TGS to acces it's contents.

Next the TGS can be sent to the desired service to auth and get a connection.

__NetNTLM__

NetNTLM uses an older Challenge-Response system. Here are the steps:

1.  The client sends an authentication request to the server they want to access.
2.  The server generates a random number and sends it as a challenge to the client.
3.  The client combines their NTLM password hash with the challenge (and other known data) to generate a response to the challenge and sends it back to the server for verification.
4.  The server forwards the challenge and the response to the Domain Controller for verification.
5.  The domain controller uses the challenge to recalculate the response and compares it to the original response sent by the client. If they both match, the client is authenticated; otherwise, access is denied. The authentication result is sent back to the server.
6.  The server forwards the authentication result to the client.

NOTE: The users password/hash is never sent over the network for security. Also of note is that this process only applies when using a domain account for sending outside of the machine. Local accounts can authenticate locally where it's password hash is stored on it's SAM.

__Questions__

Will a current version of Windows use NetNTLM as the preferred authentication protocol by default? (yay/nay)
Answer: _nay_

When referring to Kerberos, what type of ticket allows us to request further tickets know as TGS?
Answer: _Ticket Granting Ticket

When using NetNTLM, is a user's password transmitted over the network at any point? (yay/nay)
Answer: _nay_


Task8 - Trees, Forests and Trusts
-----------------------------------------

Sometimes you need more than one domain. For example you may have operations in other countries where different laws require different GPOs etc.

__Trees__

If you have 2 domains that share the same namespace like thm.local, you can join them into a Tree.

example: uk.thm.local and us.thm.local would belong to thm.local (DC-root)

As surmissed to allow admins from each of these tree brances to manage, we'd need a new security group called 'Enterprise Admins' who manage from the top down.

__Forrests__

This is when your company acquires another company (domain) and you want to link Trees together.

example: thm.local and mht.local

__Trusts__

When you have forrets, you need to sometimes share trust between them so users from one domain can access shares from another.

One-way trusts are where domainA trusts domainB, so domainB can access shares on domainA.

Two-way trusts are also possible. By default joining several domains under a tree or forrest will form a Two-way trust.

_NOTE: Just because you have a trust relationship doesn't always grant access to all resources on another domain. You also need to authorise users across different domains._

__Questions__

What is a group of Windows domains that share the same namespace called?
Answer: _tree_

What should be configured between two domains for a user in Domain A to access a resource in Domain B?
Answer: _a trust relationship_


Task9 - Conclusion
-----------------------------

This was a very basic intro to AD. There should soon be a new room for Active Directory Hardening so please look for that. There is currently a room for Compromising Active Directory here: 
https://tryhackme.com/module/hacking-active-directory

__Questions__

Continue Learning
Answer: _no answer needed_


