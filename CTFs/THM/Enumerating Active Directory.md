
We will continue moving on with the newly aquired AD credentials that we have.

Task1 - Why AD Enumeration
-------------------------------------

In this module we will cover the following:

-   The AD snap-ins of the Microsoft Management Console.  
-   The net commands of Command Prompt.
-   The AD-RSAT cmdlets of PowerShell.
-   Bloodhound.

First make sure we connect to DNS

```shell-session
[thm@thm]$ systemd-resolve --interface enumad --set-dns $THMDCIP (10.200.67.101) --set-domain za.tryhackme.com
```

Check access:
`nslookup thmdc.za.tryhackme.com`

Should resolve an IP. 

If you use Kali with openvpn, then download the profile for enumeratingad

`sudo openvpn enumeratingad.ovpn`

Go here to get initial credential pair:
[http://distributor.za.tryhackme.com/creds](http://distributor.za.tryhackme.com/creds)

Use those for THMJMP1.za.tryhackme.com (RDP, SSH)

For SSH use:
`ssh za.tryhackme.com\\<AD Username>@thmjmp1.za.tryhackme.com`

__Questions__

I have completed the Breaching AD network and am ready to learn about AD enumeration techniques.
Answer: _No answer needed_

I have connected to the network and configured DNS.
Answer: _No answer needed_

I have requested my credential pair from the distributor and verified that I can RDP and SSH into THMJMP1.
Answer: _No answer needed_


Task2 - Credential Injection
------------------------------------

We can do a lot with Kali Linux but for Windows environment we would really need Windows so we can run built in tools on the network. We should know and mimic our enemy.

Runas is a great tool for this:

```
runas.exe /netonly /user:<domain>\<username> cmd.exe
```

-   **/netonly** - Since we are not domain-joined, we want to load the credentials for network authentication but not authenticate against a domain controller. So commands executed locally on the computer will run in the context of your standard Windows account, but any network connections will occur using the account specified here.
-   **/user** - Here, we provide the details of the domain and the username. It is always a safe bet to use the Fully Qualified Domain Name (FQDN) instead of just the NetBIOS name of the domain since this will help with resolution.
-   **cmd.exe** - This is the program we want to execute once the credentials are injected. This can be changed to anything, but the safest bet is cmd.exe since you can then use that to launch whatever you want, with the credentials injected.

If using our own Windows box to run these commands then make sure we do it as Admin so our Admin token will be used and we can run further commands using the token.

So we need to verify our setup we can test against SYSVOL since any access to AD no matter how small, would need access to this since that's were all the configs are pushed by etc.

Next we can run this:
```powershell
$dnsip = "<DC IP>"
$index = Get-NetAdapter -Name 'Ethernet' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```

Ethernet would be whatever interface name we are connected to the network.

Again check DNS is working:
```shell-session
C:\> nslookup za.tryhackme.com
```

Now we can force a directory listing of SYSVOL using our newfound credentials:
```shell-session
C:\Tools>dir \\za.tryhackme.com\SYSVOL\ 
Volume in drive \\za.tryhackme.com\SYSVOL is Windows 
Volume Serial Number is 1634-22A9 

Directory of \\za.tryhackme.com\SYSVOL 
02/24/2022 09:57 PM <DIR> . 
02/24/2022 09:57 PM <DIR> .. 
02/24/2022 09:57 PM <JUNCTION> za.tryhackme.com [C:\Windows\SYSVOL\domain] 
	0 File(s) 0 bytes 
	3 Dir(s) 51,835,408,384 bytes free
```

_difference between_ _`dir \\za.tryhackme.com\SYSVOL` and `dir \\<DC IP>\SYSVOL`_

If you use IP, you will force NTLM auth. Otherwise hostnames will be embedded in the auth tickets and Kerberos will be used. Good trick to know since orgs monitor Overpass and Pass the Hash techniques.

Now if we use /netonly option all network comms happen using the credentials we injected.

NOTE: You can use MS SQL Studio from the Command Prompt. Even if it shows your local username it will authenticate to AD. We can even use this to auth to Web apps that use NTLM.

__Questions__

What native Windows binary allows us to inject credentials legitimately into memory?
Answer:

What parameter option of the runas binary will ensure that the injected credentials are used for all network connections?
Answer: 

What network folder on a domain controller is accessible by any authenticated AD account and stores GPO information?
Answer: 

When performing dir \\za.tryhackme.com\SYSVOL, what type of authentication is performed by default?
Answer: 
