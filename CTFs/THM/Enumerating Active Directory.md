
We will continue moving on with the newly aquired AD credentials that we have.

Task1 - Why AD Enumeration
-------------------------------------

In this module we will cover the following:

-   The AD snap-ins of the Microsoft Management Console.  
-   The net commands of Command Prompt.
-   The AD-RSAT cmdlets of PowerShell.
-   Bloodhound.

First make sure we connect to DNS

```shell-session
[thm@thm]$ systemd-resolve --interface enumad --set-dns $THMDCIP (10.200.67.101) --set-domain za.tryhackme.com
```

Check access:
`nslookup thmdc.za.tryhackme.com`

Should resolve an IP. 

If you use Kali with openvpn, then download the profile for enumeratingad

`sudo openvpn enumeratingad.ovpn`

Go here to get initial credential pair:
[http://distributor.za.tryhackme.com/creds](http://distributor.za.tryhackme.com/creds)

Use those for THMJMP1.za.tryhackme.com (RDP, SSH)

For SSH use:
`ssh za.tryhackme.com\\<AD Username>@thmjmp1.za.tryhackme.com`

__Questions__

I have completed the Breaching AD network and am ready to learn about AD enumeration techniques.
Answer: _No answer needed_

I have connected to the network and configured DNS.
Answer: _No answer needed_

I have requested my credential pair from the distributor and verified that I can RDP and SSH into THMJMP1.
Answer: _No answer needed_


Task2 - Credential Injection
------------------------------------

We can do a lot with Kali Linux but for Windows environment we would really need Windows so we can run built in tools on the network. We should know and mimic our enemy.

Runas is a great tool for this:

```
runas.exe /netonly /user:<domain>\<username> cmd.exe
```

-   **/netonly** - Since we are not domain-joined, we want to load the credentials for network authentication but not authenticate against a domain controller. So commands executed locally on the computer will run in the context of your standard Windows account, but any network connections will occur using the account specified here.
-   **/user** - Here, we provide the details of the domain and the username. It is always a safe bet to use the Fully Qualified Domain Name (FQDN) instead of just the NetBIOS name of the domain since this will help with resolution.
-   **cmd.exe** - This is the program we want to execute once the credentials are injected. This can be changed to anything, but the safest bet is cmd.exe since you can then use that to launch whatever you want, with the credentials injected.

If using our own Windows box to run these commands then make sure we do it as Admin so our Admin token will be used and we can run further commands using the token.

So we need to verify our setup we can test against SYSVOL since any access to AD no matter how small, would need access to this since that's were all the configs are pushed by etc.

Next we can run this if we are running on our own Windows Attackbox:
```powershell
$dnsip = "<DC IP>"
$index = Get-NetAdapter -Name 'Ethernet' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```

Ethernet would be whatever interface name we are connected to the network.

Again check DNS is working:
```shell-session
C:\> nslookup za.tryhackme.com
```

Use runas:
```shell-session
za\phillip.reid@THMJMP1 C:\Users\phillip.reid>runas.exe /netonly /user:za.tryhac
kme.com\phillip.reid cmd.exe
Enter the password for za.tryhackme.com\phillip.reid:
Attempting to start cmd.exe as user "za.tryhackme.com\phillip.reid" ...
```

Now we can force a directory listing of SYSVOL using our newfound credentials:
```shell-session
za\phillip.reid@THMJMP1 C:\Users\phillip.reid>dir \\za.tryhackme.com\SYSVOL\ 
 Volume in drive \\za.tryhackme.com\SYSVOL is Windows 
 Volume Serial Number is 1634-22A9 

 Directory of \\za.tryhackme.com\SYSVOL

02/24/2022  09:57 PM    <DIR>          .
02/24/2022  09:57 PM    <DIR>          ..
02/24/2022  09:57 PM    <JUNCTION>     za.tryhackme.com [C:\Windows\SYSVOL\domai
n]
               0 File(s)              0 bytes
               3 Dir(s)  51,581,083,648 bytes free

za\phillip.reid@THMJMP1 C:\Users\phillip.reid>

```

_difference between_ _`dir \\za.tryhackme.com\SYSVOL` and `dir \\<DC IP>\SYSVOL`_

If you use IP, you will force NTLM auth. Otherwise hostnames will be embedded in the auth tickets and Kerberos will be used. Good trick to know since orgs monitor Overpass and Pass the Hash techniques.

Now if we use /netonly option all network comms happen using the credentials we injected.

NOTE: You can use MS SQL Studio from the Command Prompt. Even if it shows your local username it will authenticate to AD. We can even use this to auth to Web apps that use NTLM.

__Questions__

What native Windows binary allows us to inject credentials legitimately into memory?
Answer: _runas.exe_

What parameter option of the runas binary will ensure that the injected credentials are used for all network connections?
Answer: _/netonly_ 

What network folder on a domain controller is accessible by any authenticated AD account and stores GPO information?
Answer: _SYSVOL_

When performing `dir \\za.tryhackme.com\SYSVOL`, what type of authentication is performed by default?
Answer: _Kerberos authentication_


Task3 - Enumeration through Microsoft Management Console
-------------------------------------------------------------

Here we use Windows MMC tool to enumerate AD further.

This can be installed by installing the Microsoft Management Console (MMC) with the [Remote Server Administration Tools'](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps) (RSAT) AD Snap-Ins.

1.  Press **Start**
2.  Search **"Apps & Features"** and press enter
3.  Click **Manage Optional Features**
4.  Click **Add a feature**
5.  Search for **"RSAT"**
6.  Select "**RSAT: Active Directory Domain Services and Lightweight Directory Tools"** and click **Install**

Start MMC using Windows Start -> Run -> MMC

In the MMC we add the AD RSAT snap-ip
-   Click **File** -> **Add/Remove Snap-in**
-   Select and **Add** all three Active Directory Snap-ins
-   Click through any errors and warnings  
-   Right-click on **Active Directory Domains and Trusts** and select **Change Forest**
-   Enter _za.tryhackme.com_ as the **Root domain** and Click **OK**
-   Right-click on **Active Directory Sites and Services** and select **Change Forest**
-   Enter _za.tryhackme.com_ as the **Root domain** and Click OK
-   Right-click on **Active Directory Users and Computers** and select **Change Domain**
-   Enter _za.tryhackme.com_ as the **Domain** and Click **OK**
-   Right-click on **Active Directory Users and Computers** in the left-hand pane  
-   Click on **View** -> **Advanced Features**

Now you should be able to see everything in the domain.

Clicking on Active Directory Users and Computers you can drill down into any of the AD objects like computers, server, users etc.

__Questions__

How many Computer objects are part of the Servers OU?
Answer: _2_

How many Computer objects are part of the Workstations OU?
Answer: _1_

How many departments (Organisational Units) does this organisation consist of?
Answer: _7_

How many Admin tiers does this organisation have?
Answer: _3_

What is the value of the flag stored in the description attribute of the t0_tinus.green account?
Answer: _THM{Enumerating.Via.MMC}_


Task4 - Enumerating through Command Prompt
-------------------------------------------------------------

In this task we will use some common command line techniques to enumerate AD

```shell-session
za\phillip.reid@THMJMP1 C:\Users\phillip.reid>net user /domain
The request will be processed at a domain controller for domain za.tryhackme.com
.


User accounts for \\THMDC.za.tryhackme.com

------------------------------------------------------------------------------- 
aaron.conway             aaron.hancock            aaron.harris
aaron.johnson            aaron.lewis              aaron.moore
aaron.patel              aaron.smith              abbie.joyce
abbie.robertson          abbie.taylor             abbie.walker
abdul.akhtar             abdul.bates              abdul.holt
abdul.jones              abdul.wall               abdul.west
abdul.wilson             abigail.cox              abigail.cox1
abigail.smith            abigail.ward             abigail.wheeler
adam.heath               adam.jones               adam.parker
adam.pugh                adam.reynolds            adam.woodward
Administrator            adrian.blake             adrian.chapman
adrian.foster            adrian.wilson            aimee.ball
aimee.dean               aimee.humphries          aimee.jones
aimee.potter             aimee.robinson           alan.brown
alan.jones               albert.elliott           albert.harrison
albert.hayes             albert.hunter            albert.lee
[..]
zoe.hopkins              zoe.humphreys            zoe.lane
zoe.marshall             zoe.watson
The command completed successfully.
```


We can also drill down using user sub-option:


```shell-session
za\phillip.reid@THMJMP1 C:\Users\phillip.reid> net user zoe.marshall /domain    
The request will be processed at a domain controller for domain za.tryhackme.com
.

User name                    zoe.marshall 
Full Name                    Zoe Marshall 
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2/24/2022 10:06:06 PM
Password expires             Never
Password changeable          2/24/2022 10:06:06 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   Never

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users         *Internet Access
The command completed successfully.
```

NOTE: this command will not list more than 10 group memberships.

We can use group command to enumerate groups in the domain:

```shell-session
za\phillip.reid@THMJMP1 C:\Users\phillip.reid>net group /domain
The request will be processed at a domain controller for domain za.tryhackme.com
.


Group Accounts for \\THMDC.za.tryhackme.com 

------------------------------------------------------------------------------- 
*Cloneable Domain Controllers
*DnsUpdateProxy
*Domain Admins
*Domain Computers
*Domain Controllers
*Domain Guests
*Domain Users
*Enterprise Admins
*Enterprise Key Admins
*Enterprise Read-only Domain Controllers
*Group Policy Creator Owners
*HR Share RW
*Internet Access
*Key Admins
*Protected Users
*Read-only Domain Controllers
*Schema Admins
*Server Admins
*Tier 0 Admins
*Tier 1 Admins
*Tier 2 Admins
The command completed successfully.
```

And again to drill down into a group:

```shell-session
za\phillip.reid@THMJMP1 C:\Users\phillip.reid>net group "Tier 1 Admins" /domain 
The request will be processed at a domain controller for domain za.tryhackme.com
.

Group name     Tier 1 Admins
Comment

Members

------------------------------------------------------------------------------- 
t1_arthur.tyler          t1_gary.moss             t1_henry.miller
t1_jill.wallis           t1_joel.stephenson       t1_marian.yates
t1_rosie.bryant
The command completed successfully.
```

Check password policy:

```shell-session
za\phillip.reid@THMJMP1 C:\Users\phillip.reid>net accounts /domain
The request will be processed at a domain controller for domain za.tryhackme.com
.

Force user logoff how long after time expires?:       Never
Minimum password age (days):                          0
Maximum password age (days):                          Unlimited
Minimum password length:                              0
Length of password history maintained:                None
Lockout threshold:                                    Never
Lockout duration (minutes):                           30
Lockout observation window (minutes):                 30
Computer role:                                        PRIMARY
The command completed successfully.
```

This will provide us with helpful information such as:

-   Length of password history kept. Meaning how many unique passwords must the user provide before they can reuse an old password.
-   The lockout threshold for incorrect password attempts and for how long the account will be locked.
-   The minimum length of the password.
-   The maximum age that passwords are allowed to reach indicating if passwords have to be rotated at a regular interval.

This kind of information we can find can help us in further enumeration or attacks later.

There is 1 major drawback to using these net commands, that the machine must be net-joined.

__Questions__

Apart from the Domain Users group, what other group is the aaron.harris account a member of?
Answer: _Internet Access_

Is the Guest account active? (Yay,Nay)
Answer: _nay_

How many accounts are a member of the Tier 1 Admins group?
Answer: _7_

What is the account lockout duration of the current password policy in minutes?
Answer: _30_


Task5 - Enumeration through PowerShell
----------------------------------------------------

Powershell gives us a lot more power/flexibility when enumerating AD. There are a lot of scripts we can download but there are some powerful ones already built in, and with the install of the AD-RSAT we already installed previously, we get 50+ more cmdlets.

Here is a link to view them:
https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps

```shell-session

za\phillip.reid@THMJMP1 C:\Users\phillip.reid>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\phillip.reid> Get-ADUser -Identity gordon.stevens -Server za.tryhack
me.com -Properties *


AccountExpirationDate                :
accountExpires                       : 9223372036854775807
AccountLockoutTime                   :
AccountNotDelegated                  : False
AllowReversiblePasswordEncryption    : False
AuthenticationPolicy                 : {}
AuthenticationPolicySilo             : {}
BadLogonCount                        : 2
badPasswordTime                      : 133121503915856297
badPwdCount                          : 2
CannotChangePassword                 : False
CanonicalName                        : za.tryhackme.com/People/Consulting/gordo 
                                       n.stevens
Certificates                         : {}
City                                 :  
CN                                   : gordon.stevens
codePage                             : 0
Company                              :
CompoundIdentitySupported            : {}
Country                              :
countryCode                          : 0
Created                              : 2/24/2022 10:06:44 PM
createTimeStamp                      : 2/24/2022 10:06:44 PM
Deleted                              :
Department                           : Consulting
Description                          :
DisplayName                          : Gordon Stevens
DistinguishedName                    : CN=gordon.stevens,OU=Consulting,OU=Peopl 
                                       e,DC=za,DC=tryhackme,DC=com
Division                             :
DoesNotRequirePreAuth                : False
dSCorePropagationData                : {1/1/1601 12:00:00 AM}
EmailAddress                         :
EmployeeID                           :
EmployeeNumber                       :
Enabled                              : True
Fax                                  :
GivenName                            : Gordon
HomeDirectory                        :
HomedirRequired                      : False
HomeDrive                            :
HomePage                             :
HomePhone                            :
Initials                             :
instanceType                         : 4
isDeleted                            :
KerberosEncryptionType               : {}
LastBadPasswordAttempt               : 11/5/2022 7:33:11 PM
LastKnownParent                      :  
lastLogoff                           : 0
lastLogon                            : 132908987618422496
LastLogonDate                        : 4/29/2022 11:13:07 PM
lastLogonTimestamp                   : 132957439878817675
LockedOut                            : False
logonCount                           : 4
LogonWorkstations                    :
Manager                              :
MemberOf                             : {CN=Internet Access,OU=Groups,DC=za,DC=t 
                                       ryhackme,DC=com}
MNSLogonAccount                      : False
MobilePhone                          :
Modified                             : 4/29/2022 11:13:07 PM
modifyTimeStamp                      : 4/29/2022 11:13:07 PM
msDS-User-Account-Control-Computed   : 0
Name                                 : gordon.stevens
nTSecurityDescriptor                 : System.DirectoryServices.ActiveDirectory 
                                       Security
ObjectCategory                       : CN=Person,CN=Schema,CN=Configuration,DC= 
                                       za,DC=tryhackme,DC=com
ObjectClass                          : user
ObjectGUID                           : 48ddd5f1-37ae-4040-a281-47dd58313fcb     
objectSid                            : S-1-5-21-3330634377-1326264276-632209373 
                                       -3058
Office                               :
OfficePhone                          :
Organization                         :
OtherName                            :
PasswordExpired                      : False
PasswordLastSet                      : 2/24/2022 10:06:44 PM
PasswordNeverExpires                 : False
PasswordNotRequired                  : False
POBox                                :
PostalCode                           :
PrimaryGroup                         : CN=Domain
                                       Users,CN=Users,DC=za,DC=tryhackme,DC=com 
primaryGroupID                       : 513
PrincipalsAllowedToDelegateToAccount : {}
ProfilePath                          :
ProtectedFromAccidentalDeletion      : False
pwdLastSet                           : 132902140043901058
SamAccountName                       : gordon.stevens
sAMAccountType                       : 805306368
ScriptPath                           :
sDRightsEffective                    : 0
ServicePrincipalNames                : {}
SID                                  : S-1-5-21-3330634377-1326264276-632209373 
                                       -3058
SIDHistory                           : {}
SmartcardLogonRequired               : False
sn                                   : Stevens
State                                :
StreetAddress                        :  
Surname                              : Stevens
Title                                : Mid-level
TrustedForDelegation                 : False
TrustedToAuthForDelegation           : False
UseDESKeyOnly                        : False
userAccountControl                   : 512
userCertificate                      : {}
UserPrincipalName                    :
uSNChanged                           : 103860
uSNCreated                           : 30825
whenChanged                          : 4/29/2022 11:13:07 PM
whenCreated                          : 2/24/2022 10:06:44 PM
```

We can use filters to give us more granular control and also Format-Table cmdlet to display them neatly.

```shell-session
PS C:\Users\phillip.reid> Get-ADUser -Filter 'Name -like "*stevens"' -Server za.
tryhackme.com | Format-Table Name,SamAccountName -A

Name             SamAccountName   
----             --------------
chloe.stevens    chloe.stevens
samantha.stevens samantha.stevens
mohammed.stevens mohammed.stevens
jacob.stevens    jacob.stevens
timothy.stevens  timothy.stevens
trevor.stevens   trevor.stevens
owen.stevens     owen.stevens
jane.stevens     jane.stevens
janice.stevens   janice.stevens
gordon.stevens   gordon.stevens
```

We can also do groups:

```shell-session
PS C:\Users\phillip.reid> Get-ADGroup -Identity Administrators -Server za.tryhac
kme.com


DistinguishedName : CN=Administrators,CN=Builtin,DC=za,DC=tryhackme,DC=com      
GroupCategory     : Security
GroupScope        : DomainLocal
Name              : Administrators
ObjectClass       : group
ObjectGUID        : f4d1cbcd-4a6f-4531-8550-0394c3273c4f
SamAccountName    : Administrators
SID               : S-1-5-32-544
```

And also group membership:

```shell-session
PS C:\Users\phillip.reid> Get-ADGroupMember -Identity Administrators -Server za.
tryhackme.com


distinguishedName : CN=Domain Admins,CN=Users,DC=za,DC=tryhackme,DC=com
name              : Domain Admins
objectClass       : group
objectGUID        : 8a6186e5-e20f-4f13-b1b0-067f3326f67c
SamAccountName    : Domain Admins
SID               : S-1-5-21-3330634377-1326264276-632209373-512

distinguishedName : CN=Enterprise Admins,CN=Users,DC=za,DC=tryhackme,DC=com     
name              : Enterprise Admins
objectClass       : group
objectGUID        : 93846b04-25b9-4915-baca-e98cce4541c6
SamAccountName    : Enterprise Admins
SID               : S-1-5-21-3330634377-1326264276-632209373-519

distinguishedName : CN=vagrant,CN=Users,DC=za,DC=tryhackme,DC=com 
name              : vagrant
objectClass       : user
objectGUID        : ed901eff-9ec0-4851-ba32-7a26a8f0858f
SamAccountName    : vagrant
SID               : S-1-5-21-3330634377-1326264276-632209373-1000

distinguishedName : CN=Administrator,CN=Users,DC=za,DC=tryhackme,DC=com 
name              : Administrator
objectClass       : user
objectGUID        : b10fe384-bcce-450b-85c8-218e3c79b30f
SamAccountName    : Administrator
SID               : S-1-5-21-3330634377-1326264276-632209373-500
```

We can do generic searches for any AD objects with a cmdlet called Get-ADObject. Like for finding all AD Objects changed after a certain date:

```shell-session
PS C:\Users\phillip.reid> Get-ADObject -Filter 'badPwdCount -gt 0' -Server za.tr
yhackme.com

DistinguishedName                                                        Name   
-----------------                                                        ----   
CN=henry.taylor,OU=IT,OU=People,DC=za,DC=tryhackme,DC=com                hen... 
CN=frank.fletcher,OU=IT,OU=People,DC=za,DC=tryhackme,DC=com              fra... 
CN=henry.black,OU=Engineering,OU=People,DC=za,DC=tryhackme,DC=com        hen... 
CN=mark.oconnor,OU=Engineering,OU=People,DC=za,DC=tryhackme,DC=com       mar... 
CN=dawn.hughes,OU=Finance,OU=People,DC=za,DC=tryhackme,DC=com            daw... 
CN=joanne.davies,OU=Marketing,OU=People,DC=za,DC=tryhackme,DC=com        joa... 
CN=alan.jones,OU=Human Resources,OU=People,DC=za,DC=tryhackme,DC=com     ala... 
CN=maria.sheppard,OU=Human Resources,OU=People,DC=za,DC=tryhackme,DC=com mar... 
CN=sophie.blackburn,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=com    sop... 
CN=gordon.stevens,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=com      gor... 
CN=dominic.elliott,OU=Finance,OU=People,DC=za,DC=tryhackme,DC=com        dom... 
CN=louise.talbot,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=com       lou... 
CN=jennifer.wood,OU=Engineering,OU=People,DC=za,DC=tryhackme,DC=com      jen... 
CN=frances.chapman,OU=Engineering,OU=People,DC=za,DC=tryhackme,DC=com    fra... 
CN=dawn.turner,OU=Finance,OU=People,DC=za,DC=tryhackme,DC=com            daw... 
CN=samantha.thompson,OU=Engineering,OU=People,DC=za,DC=tryhackme,DC=com  sam... 
CN=anthony.reynolds,OU=Marketing,OU=People,DC=za,DC=tryhackme,DC=com     ant... 
```

We can use Get-ADDomain to display additional info about the domain:

```shell-session
PS C:\Users\phillip.reid> GET-ADDomain -Server za.tryhackme.com


AllowedDNSSuffixes                 : {}
ChildDomains                       : {}
ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=com     
DeletedObjectsContainer            : CN=Deleted
                                     Objects,DC=za,DC=tryhackme,DC=com
DistinguishedName                  : DC=za,DC=tryhackme,DC=com
DNSRoot                            : za.tryhackme.com
DomainControllersContainer         : OU=Domain
                                     Controllers,DC=za,DC=tryhackme,DC=com      
DomainMode                         : Windows2012R2Domain
DomainSID                          : S-1-5-21-3330634377-1326264276-632209373   
ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=za,DC=tryh 
                                     ackme,DC=com
Forest                             : za.tryhackme.com
InfrastructureMaster               : THMDC.za.tryhackme.com
LastLogonReplicationInterval       :
LinkedGroupPolicyObjects           : {CN={31B2F340-016D-11D2-945F-00C04FB984F9} 
                                     ,CN=Policies,CN=System,DC=za,DC=tryhackme, 
                                     DC=com}
LostAndFoundContainer              : CN=LostAndFound,DC=za,DC=tryhackme,DC=com  
ManagedBy                          :
Name                               : za
NetBIOSName                        : ZA
ObjectClass                        : domainDNS
ObjectGUID                         : 518ee1e7-f427-4e91-a081-bb75e655ce7a       
ParentDomain                       :
PDCEmulator                        : THMDC.za.tryhackme.com
PublicKeyRequiredPasswordRolling   :
QuotasContainer                    : CN=NTDS Quotas,DC=za,DC=tryhackme,DC=com   
ReadOnlyReplicaDirectoryServers    : {}
ReplicaDirectoryServers            : {THMDC.za.tryhackme.com}
RIDMaster                          : THMDC.za.tryhackme.com
SubordinateReferences              : {DC=ForestDnsZones,DC=za,DC=tryhackme,DC=c 
                                     om, DC=DomainDnsZones,DC=za,DC=tryhackme,D 
                                     C=com, CN=Configuration,DC=za,DC=tryhackme 
                                     ,DC=com}
SystemsContainer                   : CN=System,DC=za,DC=tryhackme,DC=com        
UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=com
```

It's also possible to change or add new values using cmdlets. For example force changing a users password:

```shell-session
PS C:\> Set-ADAccountPassword -Identity gordon.stevens -Server za.tryhackme.com -OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "new" -Force)
```

We only need to specify the -Server option when we are not net-joined on a domain.

We need to be more careful since cmdlets/powershell is more closely monitored by blue teams.

Also we need to install AD-RSAT toos or other which are also potentially detectable.

Here is another how to find when a group was created:
```shell-session
PS C:\Users\phillip.reid> Get-ADGroup -Identity "Tier 2 Admins" -Properties when
created -Server za.tryhackme.com


DistinguishedName : CN=Tier 2 Admins,OU=Groups,DC=za,DC=tryhackme,DC=com        
GroupCategory     : Security
GroupScope        : Global
Name              : Tier 2 Admins
ObjectClass       : group
ObjectGUID        : 6edab731-c305-4959-bd34-4ca1eefe2b3f
SamAccountName    : Tier 2 Admins
SID               : S-1-5-21-3330634377-1326264276-632209373-1104
whencreated       : 2/24/2022 10:04:41 PM

```
__Questions__

What is the value of the Title attribute of Beth Nolan (beth.nolan)?
Answer: _Senior_

What is the value of the DistinguishedName attribute of Annette Manning (annette.manning)?
Answer: _CN=annette.manning,OU=Marketing,OU=People,DC=za,DC=tryhackme,DC=com_

When was the Tier 2 Admins group created?
Answer: _2/24/2022 10:04:41 PM_


What is the value of the SID attribute of the Enterprise Admins group?
Answer: _S-1-5-21-3330634377-1326264276-632209373-519_


Which container is used to store deleted AD objects?
Answer: _CN=Deleted Objects,DC=za,DC=tryhackme,DC=com_
hint: Get-ADDomain


Task6 - Enumeration through Bloodhound
--------------------------------------------------

In this task we will look at Bloodhound which is a GUI based tool for AD exploitation.

Sharphound is a componet of Bloodhound that performs enumeration.

Here are the 3 sharphound collectors:
There are three different Sharphound collectors:

-   **Sharphound.ps1** - PowerShell script for running Sharphound. However, the latest release of Sharphound has stopped releasing the Powershell script version. This version is good to use with RATs since the script can be loaded directly into memory, evading on-disk AV scans.  
-   **Sharphound.exe** - A Windows executable version for running Sharphound.
-   **AzureHound.ps1** - PowerShell script for running Sharphound for Azure (Microsoft Cloud Computing Services) instances. Bloodhound can ingest data enumerated from Azure to find attack paths related to the configuration of Azure Identity and Access Management.

These scripts are very noisy so its useful to have our own non-domain joined windows machine that we can run runas.exe on and inject our creds to point sharphound to the Domain Controller.

`Sharphound.exe --CollectionMethods <Methods> --Domain za.tryhackme.com --ExcludeDCs`  

Parameters explained:

-   CollectionMethods - Determines what kind of data Sharphound would collect. The most common options are Default or All. Also, since Sharphound caches information, once the first run has been completed, you can only use the Session collection method to retrieve new user sessions to speed up the process.
-   Domain - Here, we specify the domain we want to enumerate. In some instances, you may want to enumerate a parent or other domain that has trust with your existing domain. You can tell Sharphound which domain should be enumerated by altering this parameter.
- ExcludeDCs -This will instruct Sharphound not to touch domain controllers, which reduces the likelihood that the Sharphound run will raise an alert.

More info here:
https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html

Copy the tools:

```shell-session
PS C:\> copy C:\Tools\Sharphound.exe ~\Documents\
PS C:\> cd ~\Documents\
PS C:\Users\andrea.mitchell\Documents>
```

Let's use sharphound to enumerate. This will generate a zip file that we can download.

```shell-session
```markup
PS C:\Users\andrea.mitchell\Documents\>SharpHound.exe --CollectionMethods All --Domain za.tryhackme.com --ExcludeDCs
2022-03-16T19:11:41.2898508+00:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-03-16T19:11:41.3056683+00:00|INFORMATION|Initializing SharpHound at 7:11 PM on 3/16/2022
2022-03-16T19:11:41.6648113+00:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-03-16T19:11:41.8211318+00:00|INFORMATION|Beginning LDAP search for za.tryhackme.com
[....]
2022-03-16T19:12:31.6981568+00:00|INFORMATION|Output channel closed, waiting for output task to complete
Closing writers
2022-03-16T19:12:32.2605943+00:00|INFORMATION|Status: 2163 objects finished (+2163 43.26)/s -- Using 85 MB RAM
2022-03-16T19:12:32.2605943+00:00|INFORMATION|Enumeration finished in 00:00:50.4369344
2022-03-16T19:12:32.5418517+00:00|INFORMATION|SharpHound Enumeration Completed at 7:12 PM on 3/16/2022! Happy Graphing!
```

Now we have our zip:

```shell-session
PS C:\Users\andrea.mitchell\Documents> dir

    Directory: C:\Users\andrea.mitchell\Documents

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        3/16/2022   7:12 PM         121027 20220316191229_BloodHound.zip
-a----        3/16/2022   5:19 PM         906752 SharpHound.exe
-a----        3/16/2022   7:12 PM         360355 YzE4MDdkYjAtYjc2MC00OTYyLTk1YTEtYjI0NjhiZmRiOWY1.bin 
```


Bloodhound uses neo4j for backend db. Make sure both are installed.

Start up neo4j:

```bash
root@ip-10-10-2-182:~# neo4j console start
Active database: graph.db
Directories in use:
  home:         /var/lib/neo4j
  config:       /etc/neo4j
  logs:         /var/log/neo4j
  plugins:      /var/lib/neo4j/plugins
  import:       /var/lib/neo4j/import
  data:         /var/lib/neo4j/data
  certificates: /var/lib/neo4j/certificates
  run:          /var/run/neo4j
Neo4j is already running (pid 5935).
```

Start blood hound in another terminal:
`bloodhound --no-sandbox`

From here you can login to bloodhound. Default creds are neo4j:neo4j

Drag and drop your json files from the .zip file you downloaded earlier. You can drop them directly in bloodhound.

Once they are all imported you can make queries at the top.

Bloodhound gives a ton of information. 

-   **Overview** - Provides summaries information such as the number of active sessions the account has and if it can reach high-value targets.  
    
-   **Node Properties** - Shows information regarding the AD account, such as the display name and the title.  
    
-   **Extra Properties** - Provides more detailed AD information such as the distinguished name and when the account was created.  
    
-   **Group Membership** - Shows information regarding the groups that the account is a member of.  
    
-   **Local Admin Rights** - Provides information on domain-joined hosts where the account has administrative privileges.  
    
-   **Execution Rights** - Provides information on special privileges such as the ability to RDP into a machine.  
    
-   **Outbound Control Rights** - Shows information regarding AD objects where this account has permissions to modify their attributes.  
    
-   **Inbound Control Rights** -  Provides information regarding AD objects that can modify the attributes of this account.

Drilling down into Group memberships of our user andrea.mitchell, we click on the number next to 'First Degree Group Membership' and see she is in 2 groups Internet Access and Domain Users.

Importantly these are shown as a chart so we get a nice visual about paths that can be taken during enumeration and exploit of AD.

now click on the Analysis tab. These are functions made my others are that extremely useful in enumeration.

Clicking on Find all Domain Admins (1st option) shows us 2 admin accounts.

You can then input a target such as TIER 1 ADMINS and click the filter icon and show analysis to find graphical vectors to our target. This greatly helps us to know exactly what to do and exploit when we get back into the network. The idea is that we  do all this investigation offline, then when ready, jump on and own the network in mins before the blue team even has a chance to respond to the alarms.

__Questions__

What command can be used to execute Sharphound.exe and request that it recovers Session information only from the za.tryhackme.com domain without touching domain controllers?
Answer: _SharpHound.exe --CollectionMethods All --Domain za.tryhackme.com --ExcludeDCs_

Apart from the krbtgt account, how many other accounts are potentially kerberoastable?
Answer: _4_

How many machines do members of the Tier 1 Admins group have administrative access to?
Answer: _2_

How many users are members of the Tier 2 Admins group?
Answer: _15_


Task7 - Conclusion
-----------------------------------

Additional Enumeration Techniques  

In this network, we covered several techniques that can be used to enumerate AD. This is by no means an exhaustive list. Here is a list of enumeration techniques that also deserve mention:

-   **[LDAP enumeration](https://book.hacktricks.xyz/pentesting/pentesting-ldap)** - Any valid AD credential pair should be able to bind to a Domain Controller's LDAP interface. This will allow you to write LDAP search queries to enumerate information regarding the AD objects in the domain.
-   **[PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)** - PowerView is a recon script part of the [PowerSploit](https://github.com/PowerShellMafia/PowerSploit) project. Although this project is no longer receiving support, scripts such as PowerView can be incredibly useful to perform semi-manual enumeration of AD objects in a pinch.
-   **[Windows Management Instrumentation (WMI)](https://0xinfection.github.io/posts/wmi-ad-enum/)** - WMI can be used to enumerate information from Windows hosts. It has a provider called "root\directory\ldap" that can be used to interact with AD. We can use this provider and WMI in PowerShell to perform AD enumeration.

There is not much way to defend against AD enumeration since these lookups are just like normal traffic.

We can however monitor for Sharphound use through signatures etc. Also we can monitor the use of Powershell and command prompt for enumeration techniques.