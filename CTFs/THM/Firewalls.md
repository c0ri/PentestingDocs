Task 1 - Introduction
------------------------------------

A firewall is software or hardware that monitors the network traffic and compares it against a set of rules before passing or blocking it. One simple analogy is a guard or gatekeeper at the entrance of an event. This gatekeeper can check the ID of individuals against a set of rules before letting them enter (or leave).

Before we go into more details about firewalls, it is helpful to remember the contents of an IP packet and TCP segment. The following figure shows the fields we expect to find in an IP header. If the figure below looks complicated, you don’t need to worry as we are only interested in a few fields. Different types of firewalls are capable of inspecting various packet fields; however, the most basic firewall should be able to inspect at least the following fields:

-   Protocol
-   Source Address
-   Destination Address

![[redteamfirewalls-1.png]]

Depending on the protocol field, the data in the IP datagram can be one of many options. Three common protocols are:

-   TCP
-   UDP
-   ICMP

In the case of TCP or UDP, the firewall should at least be able to check the TCP and UDP headers for:

-   Source Port Number
-   Destination Port Number

The TCP header is shown in the figure below. We notice that there are many fields that the firewall might or might not be able to analyze; however, even the most limited of firewalls should give the firewall administrator control over allowed or blocked source and destination port numbers.

![[redteamfirewalls-2.png]]

### Learning Objectives

This room covers:

1.  The different types of firewalls, according to different classification criteria
2.  Various techniques to evade firewalls

This room requires the user to have basic knowledge of:

-   ISO/OSI layers and TCP/IP layers. We suggest going through the [Network Fundamentals](https://tryhackme.com/module/network-fundamentals) module if you want to refresh your knowledge.
-   Network and port scanning. We suggest you complete the [Nmap](https://tryhackme.com/module/nmap) module to learn more about this topic.
-   Reverse and bind shells. We recommend the [What the Shell?](https://tryhackme.com/room/introtoshells) room to learn more about shells.

__Questions__

  
The design logic of traditional firewalls is that a port number would identify the service and the protocol. For instance, visit [Service Name and Transport Protocol Port Number Registry](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml) to answer the following questions.

If you want to block telnet, which TCP port number would you deny?
Answer: _23_

You want to allow HTTPS, which TCP port number do you need to permit?
Answer: _443_

What is an alternate TCP port number used for HTTP? It is described as “HTTP Alternate.”
Answer: _8080_

You need to allow SNMP over SSH, snmpssh. Which port should be permitted?

You can find this here:
https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.txt
```bash
snmpssh            5161        tcp    SNMP over SSH Transport                                                                                                                                                [RFC5592]
                                      Model
                   5161        udp    Reserved
```
Answer: _5161_

Task 2 - Types of Firewalls
------------------------------------------

There are multiple ways to classify firewalls. One way to classify firewalls would be whether they are independent appliances.

1.  Hardware Firewall (appliance firewall): As the name implies, an appliance firewall is a separate piece of hardware that the network traffic has to go through. Examples include Cisco ASA (Adaptive Security Appliance), WatchGuard Firebox, and Netgate pfSense Plus appliance.
2.  Software firewall: This is a piece of software that comes bundled with the OS, or you can install it as an additional service. MS Windows has a built-in firewall, Windows Defender Firewall, that runs along with the other OS services and user applications. Another example is Linux iptables and firewalld.

We can also classify firewalls into:

1.  Personal firewall: A personal firewall is designed to protect a single system or a small network, for example, a small number of devices and systems at a home network. Most likely, you are using a personal firewall at home without paying much attention to it. For instance, many wireless access points designed for homes have a built-in firewall. One example is Bitdefender BOX. Another example is the firewall that comes as part of many wireless access points and home routers from Linksys and Dlink.
2.  Commercial firewall: A commercial firewall protects medium-to-large networks. Consequently, you would expect higher reliability and processing power, in addition to supporting a higher network bandwidth. Most likely, you are going through such a firewall when accessing the Internet from within your university or company.

From the red team perspective, the most crucial classification would be based on the firewall inspection abilities. It is worth thinking about the firewall abilities in terms of the ISO/OSI layers shown in the figure below. Before we classify firewalls based on their abilities, it is worthy of remembering that firewalls focus on layers 3 and 4 and, to a lesser extent, layer 2. Next-generation firewalls are also designed to cover layers 5, 6, and 7. The more layers a firewall can inspect, the more sophisticated it gets and the more processing power it needs.

![[redteamfirewalls-3.png]]

Based on firewall abilities, we can list the following firewall types:

-   Packet-Filtering Firewall: Packet-filtering is the most basic type of firewall. This type of firewall inspects the protocol, source and destination IP addresses, and source and destination ports in the case of TCP and UDP datagrams. It is a stateless inspection firewall.
-   Circuit-Level Gateway: In addition to the features offered by the packet-filtering firewalls, circuit-level gateways can provide additional capabilities, such as checking TCP three-way-handshake against the firewall rules.
-   Stateful Inspection Firewall: Compared to the previous types, this type of firewall gives an additional layer of protection as it keeps track of the established TCP sessions. As a result, it can detect and block any TCP packet outside an established TCP session.
-   Proxy Firewall: A proxy firewall is also referred to as Application Firewall (AF) and Web Application Firewall (WAF). It is designed to masquerade as the original client and requests on its behalf. This process allows the proxy firewall to inspect the contents of the packet payload instead of being limited to the packet headers. Generally speaking, this is used for web applications and does not work for all protocols.
-   Next-Generation Firewall (NGFW): NGFW offers the highest firewall protection. It can practically monitor all network layers, from OSI Layer 2 to OSI Layer 7. It has application awareness and control. Examples include the Juniper SRX series and Cisco Firepower.
-   Cloud Firewall or Firewall as a Service (FWaaS): FWaaS replaces a hardware firewall in a cloud environment. Its features might be comparable to NGFW, depending on the service provider; however, it benefits from the scalability of cloud architecture. One example is Cloudflare Magic Firewall, which is a network-level firewall. Another example is Juniper vSRX; it has the same features as an NGFW but is deployed in the cloud. It is also worth mentioning AWS WAF for web application protection and AWS Shield for DDoS protection.

__Questions__

What is the most basic type of firewall?
Answer: _Packet-Filtering Firewall_

What is the most advanced type of firewall that you can have on company premises?
Answer: _Next-Generation Firewall_

Task 3 - Evasion via Controlling the Source MAC/IP/Port
-------------------------------------------------------------------------------------

When scanning a host behind a firewall, the firewall will usually detect and block port scans. This situation would require you to adapt your network and port scan to evade the firewall. A network scanner like Nmap provides few features to help with such a task. In this room, we group Nmap techniques into three groups:

1.  Evasion via controlling the source MAC/IP/Port
2.  Evasion via fragmentation, MTU, and data length
3.  Evasion through modifying header fields

Nmap allows you to hide or spoof the source as you can use:

1.  Decoy(s)
2.  Proxy
3.  Spoofed MAC Address
4.  Spoofed Source IP Address
5.  Fixed Source Port Number

Before we elaborate on each approach, let’s show what a Nmap stealth (SYN) scan looks like. We are scanning an MS Windows target (with default built-in firewall), so we added `-Pn` to force the scan to proceed even if no ping reply is received. `-Pn` is used to skip host discovery and testing whether the host is live. Moreover, to speed up the scan, we limited ourselves to the 100 most common ports using the `-F` option. The scan was performed using the following command `nmap -sS -Pn -F MACHINE_IP`.

The following screenshot shows Wireshark’s capture of the Nmap probe packets. Wireshark was running on the same system running Nmap.

![[redteamfirewalls-4.png]]

We can dive into all the details embedded into each packet; however, for this exercise, we would like to note the following:

-   Our IP address `10.14.17.226` has generated and sent around 200 packets. The `-F` option limits the scan to the top 100 common ports; moreover, each port is sent a second SYN packet if it does not reply to the first one.
-   The source port number is chosen at random. In the screenshot, you can see it is 37710.
-   The total length of the IP packet is 44 bytes. There are 20 bytes for the IP header, which leaves 24 bytes for the TCP header. No data is sent via TCP.
-   The Time to Live (TTL) is 42.
-   No errors are introduced in the checksum.

In the following sections and tasks, we will see how Nmap provides various options to evade the firewall and other network security solutions.

__Questions__

What is the size of the IP packet when using a default Nmap stealth (SYN) scan?
**HINT:** Add the IP header size to the TCP header size.
Answer: _44_



How many bytes does the TCP segment hold in its data field when using a default Nmap stealth (SYN) scan?
Answer: _0_

  
Approximately, how many packets do you expect Nmap to send when running the command `nmap -sS -F MACHINE_IP`? Approximate to the nearest 100, such as 100, 200, 300, etc.
**HINT:** -F scans the 100 most common ports. Each port is expected to get 2 SYN packets.
Answer: _200_

### Decoy(s)

Hide your scan with decoys. Using decoys makes your IP address mix with other “decoy” IP addresses. Consequently, it will be difficult for the firewall and target host to know where the port scan is coming from. Moreover, this can exhaust the blue team investigating each source IP address.

Using the `-D` option, you can add decoy source IP addresses to confuse the target. Consider the following command, `nmap -sS -Pn -D 10.10.10.1,10.10.10.2,ME -F MACHINE_IP`. The Wireshark capture is shown in the following figure.

![[redteamfirewalls-5.png]]

The target `MACHINE_IP` will also see scans coming from `10.10.10.1` and `10.10.10.2` when only one source IP address, `ME`, is running the scan. Note that if you omit the `ME` entry in the scan command, Nmap will put your real IP address, i.e. `ME`, in a random position.

You can also set Nmap to use random source IP addresses instead of explicitly specifying them. By running `nmap -sS -Pn -D RND,RND,ME -F MACHINE_IP`, Nmap will choose two random source IP addresses to use as decoys. Nmap will use new random IP addresses each time you run this command. In the screenshot below, we see how Nmap picked two random IP addresses in addition to our own, `10.14.17.226`.

![[redteamfirewalls-6.png]]

Approximately, how many packets do you expect Nmap to send when running the command `nmap -sS -Pn -D RND,10.10.55.33,ME,RND -F MACHINE_IP`? Approximate to the nearest 100, such as 100, 200, 300, etc.
Answer: _800_

### Proxy

Use an HTTP/SOCKS4 proxy. Relaying the port scan via a proxy helps keep your IP address unknown to the target host. This technique allows you to keep your IP address hidden while the target logs the IP address of the proxy server. You can go this route using the Nmap option `--proxies PROXY_URL`. For example, `nmap -sS -Pn --proxies PROXY_URL -F MACHINE_IP` will send all its packets via the proxy server you specify. Note that you can chain proxies using a comma-separated list.

What do you expect the target to see as the source of the scan when you run the command `nmap -sS -Pn --proxies 10.10.13.37 MACHINE_IP`

Answer: _10.10.13.37_

### Spoofed MAC Address

Spoof the source MAC address. Nmap allows you to spoof your MAC address using the option `--spoof-mac MAC_ADDRESS`. This technique is tricky; spoofing the MAC address works only if your system is on the same network segment as the target host. The target system is going to reply to a spoofed MAC address. If you are not on the same network segment, sharing the same Ethernet, you won’t be able to capture and read the responses. It allows you to exploit any trust relationship based on MAC addresses. Moreover, you can use this technique to hide your scanning activities on the network. For example, you can make your scans appear as if coming from a network printer.

What company has registered the following Organizationally Unique Identifier (OUI), i.e., the first 24 bits of a MAC address, `00:02:DC`?
**HINT:** Requires research. You may use a website that looks up MAC addresses. Some sites return "Limited" instead of "Ltd"; please use Ltd instead of Limited.

Answer: _Fujitsu General Ltd_

### Spoofed IP Address

Spoof the source IP address. Nmap lets you spoof your IP address using `-S IP_ADDRESS`. Spoofing the IP address is useful if your system is on the same subnetwork as the target host; otherwise, you won’t be able to read the replies sent back. The reason is that the target host will reply to the spoofed IP address, and unless you can capture the responses, you won’t benefit from this technique. Another use for spoofing your IP address is when you control the system that has that particular IP address. Consequently, if you notice that the target started to block the spoofed IP address, you can switch to a different spoofed IP address that belongs to a system that you also control. This scanning technique can help you maintain stealthy existence; moreover, you can use this technique to exploit trust relationships on the network based on IP addresses.

To mislead the opponent, you decided to make your port scans appear as if coming from a local access point that has the IP address `10.10.0.254`. What option needs to be added to your Nmap command to spoof your address accordingly?

Answer: _-S 10.10.0.254_

### Fixed Source Port Number

Use a specific source port number. Scanning from one particular source port number can be helpful if you discover that the firewalls allow incoming packets from particular source port numbers, such as port 53 or 80. Without inspecting the packet contents, packets from source TCP port 80 or 443 look like packets from a web server, while packets from UDP port 53 look like responses to DNS queries. You can set your port number using `-g` or `--source-port` options.

The following Wireshark screenshot shows a Nmap scan with the fixed source TCP port number 8080. We have used the following Nmap command, `nmap -sS -Pn -g 8080 -F MACHINE_IP`. You can see in the screenshot how it is that all the TCP connections are sent from the same TCP port number.

![[redteamfirewalls-7.png]]

You decide to use Nmap to scan for open UDP ports. You notice that using `nmap -sU -F MACHINE_IP` to discover the open common UDP ports won’t give you any meaningful results. What do you need to add to your Nmap command to set the source port number to 53?
**HINT:** If there is more than one answer, choose the shorter version.

Answer: _-g 53_

This is a quick summary of the Nmap options discussed in this task.
| Evasion Approach                              | Nmap Argument              |
| --------------------------------------------- | -------------------------- |
| Hide a scan with decoys                       | -D DECOY1_IP1,DECOY_IP2,ME |
| Hide a scan with random decoys                | -D RND,RND,ME              |
| Use an HTTP/SOCKS4 proxy to relay connections | --proxies PROXY_URL        |
| Spoof source MAC address                      | --spoof-mac MAC_ADDRESS    |
| Spoof source IP address                       | -S IP_ADDRESS              |
| Use a specific source port number             | -g PORT_NUM or --source-port PORT                           |

Answer: _None Needed_


Task 4 - Evasion via Forcing Fragmentation, MTU, and Data Length
----------------------------------------------------------------------------------

You can control the packet size as it allows you to:

-   Fragment packets, optionally with given MTU. If the firewall, or the IDS/IPS, does not reassemble the packet, it will most likely let it pass. Consequently, the target system will reassemble and process it.
-   Send packets with specific data lengths.

__Questions__ (in-line)

### Fragment Your Packets with 8 Bytes of Data

One easy way to fragment your packets would be to use the `-f` option. This option will fragment the IP packet to carry only 8 bytes of data. As mentioned earlier, running a Nmap TCP port scan means that the IP packet will hold 24 bytes, the TCP header. If you want to limit the IP data to 8 bytes, the 24 bytes of the TCP header will be divided across 3 IP packets. And this is precisely what we obtained when we ran this Nmap scan, `nmap -sS -Pn -f -F MACHINE_IP`. As we can see in the Wireshark capture in the figure below, each IP packet is fragmented into three packets, each with 8 bytes of data.

![[redteamfirewalls-8.png]]

What is the size of the IP packet when running Nmap with the `-f` option?
**HINT:** Add the IP header to the size of the data fragment.
Answer: _28_

### Fragment Your Packets with 16 Bytes of Data

Another handy option is the `-ff`, limiting the IP data to 16 bytes. (One easy way to remember this is that one `f` is 8 bytes, but two `f`s are 16 bytes.) By running `nmap -sS -Pn -ff -F MACHINE_IP`, we expect the 24 bytes of the TCP header to be divided between two IP packets, 16 + 8, because `-ff` has put an upper limit of 16 bytes. The first few packets are shown in the Wireshark capture below.

![[redteamfirewalls-9.png]]

What is the maximum size of the IP packet when running Nmap with the `-ff` option?
Answer: _36_

### Fragment Your Packets According to a Set MTU

Another neat way to fragment your packets is by setting the MTU. In Nmap, `--mtu VALUE` specifies the number of bytes per IP packet. In other words, the IP header size is not included. The value set for MTU must always be a multiple of 8.

_Note that the Maximum Transmission Unit (MTU) indicates the maximum packet size that can pass on a certain link-layer connection. For instance, Ethernet has an MTU of 1500, meaning that the largest IP packet that can be sent over an Ethernet (link layer) connection is 1500 bytes. Please don’t confuse this MTU with the `--mtu` in Nmap options._

Running Nmap with `--mtu 8` will be identical to `-f` as the IP data will be limited to 8 bytes. The first few packets generated by this Nmap scan `nmap -sS -Pn --mtu 8 -F MACHINE_IP` are shown in the following Wireshark capture.

![[redteamfirewalls-10.png]]

What is the maximum size of the IP packet when running Nmap with `--mtu 36` option?
Answer: _56_

### Generate Packets with Specific Length

In some instances, you might find out that the size of the packets is triggering the firewall or the IDS/IPS to detect and block you. If you ever find yourself in such a situation, you can make your port scanning more evasive by setting a specific length. You can set the length of data carried within the IP packet using `--data-length VALUE`. Again, remember that the length should be a multiple of 8.

If you run the following Nmap scan `nmap -sS -Pn --data-length 64 -F MACHINE_IP`, each TCP segment will be padded with random data till its length is 64 bytes. In the screenshot below, we can see that each TCP segment has a length of 64 bytes.

![[redteamfirewalls-11.png]]

What is the maximum size of the IP packet when running Nmap with `--data-length 128` option?
Answer: _148_

This is a quick summary of the Nmap options discussed in this task.
| Evasion                         | Nmap Argument |
| ------------------------------- | ------------- |
| Fragment IP data into 8 bytes   | -f            |
| Fragment IP data into 16 bytes  | -ff           |
| Fragment packets with given MTU | --mtu VALUE   |
| Specify packet length           | --data-length NUM              |

Answer: _None Needed_

