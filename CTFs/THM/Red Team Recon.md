Learn how to use DNS, advanced searching, Recon-ng, and Maltego to collect information about your target.

Task 1 - Introduction
-----------------------------------

It is important to understand your enemy in battle. If you watch and wait, you can understand their normal patterns and attack during a time they are not expecting.

Reconnaisance (recon) allows us to collect various information about our target without alerting them to our precense because it is a passive activity where we don't really need to connect to any of their resources. Much information can be found on the internet.

The tasks of this room cover the following topics:

-   Types of reconnaissance activities
-   WHOIS and DNS-based reconnaissance
-   Advanced searching
-   Searching by image
-   Google Hacking
-   Specialized search engines
-   Recon-ng
-   Maltego

Some specific objectives we'll cover include:

-   Discovering subdomains related to our target company
-   Gathering publicly available information about a host and IP addresses
-   Finding email addresses related to the target
-   Discovering login credentials and leaked passwords
-   Locating leaked documents and spreadsheets

There are essentially 2 types of recon:

* Active - This is noisy and may alert somenoe to our precense.
* Passive - This is stealthy and won't require us to connect to the enemy but rather gather data from other sources outside of the enemy resources.

__Questions__

We suggest you start the AttackBox and experiment with every command and tool we demonstrate.
Answer: _None Needed_

Task 2 - Taxonomy of Reconnaissance
----------------------------------------------------------------

Reconnaissance (recon) can be classified into two parts:

1.  **Passive Recon**: can be carried out by watching passively
2.  **Active Recon**: requires interacting with the target to provoke it in order to observe its response.

Passive recon is just using open tools like DNS lookups, whois and other data that are maintained by 3rd parties. We can find lots of great info such as IP address blocks, email addresses, employee names, and job postings.

Active recon requires that we interact with the target by sending requests and packets and observing the responses. An example is using NMAP to scan a target. In this type, we want to discover things like hosts, running servers, listening services and version numbers.

Active recon can be classified as:

1.  **External Recon**: Conducted outside the target's network and focuses on the externally facing assets assessable from the Internet. One example is running Nikto from outside the company network.
2.  **Internal Recon**: Conducted from within the target company's network. In other words, the pentester or red teamer might be physically located inside the company building. In this scenario, they might be using an exploited host on the target's network. An example would be using Nessus to scan the internal network using one of the target’s computers.

__Questions__

Ensure you have a clear understanding of the different types of recon activities before proceeding.
Answer: _None Needed_


Task 3 - Built-In Tools
------------------------------------

In this task we will learn about some of the passive recon tools:

* whois
* dig
* nslookup
* host
* tracert / traceroute

	WHOIS, is a request/response protocol which is used to query Registrar Database of domain names which they are required to keep as part of the RFC 3912 spec. The whois command will query that database and return information we are looking for.

We can see things like:

-   Registrar WHOIS server
-   Registrar URL
-   Record creation date
-   Record update date
-   Registrant contact info and address (unless withheld for privacy)
-   Admin contact info and address (unless withheld for privacy)
-   Tech contact info and address (unless withheld for privacy)


```bash
pentester@TryHackMe$ whois thmredteam.com
[Querying whois.verisign-grs.com]
[Redirected to whois.namecheap.com]
[Querying whois.namecheap.com]
[whois.namecheap.com]
Domain name: thmredteam.com
Registry Domain ID: 2643258257_DOMAIN_COM-VRSN
Registrar WHOIS Server: whois.namecheap.com
Registrar URL: http://www.namecheap.com
Updated Date: 0001-01-01T00:00:00.00Z
Creation Date: 2021-09-24T14:04:16.00Z
Registrar Registration Expiration Date: 2022-09-24T14:04:16.00Z
Registrar: NAMECHEAP INC
Registrar IANA ID: 1068
Registrar Abuse Contact Email: abuse@namecheap.com
Registrar Abuse Contact Phone: +1.6613102107
Reseller: NAMECHEAP INC
Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited
Registry Registrant ID: 
Registrant Name: Withheld for Privacy Purposes
Registrant Organisation: Privacy service provided by Withheld for Privacy ehf
Registrant Street: Kalkofnsvegur 2 
Registrant City: Reykjavik
Registrant State/Province: Capital Region
Registrant Postal Code: 101
Registrant Country: IS
Registrant Phone: +354.4212434
Registrant Phone Ext: 
Registrant Fax: 
Registrant Fax Ext: 
Registrant Email: 4c9d5617f14e4088a4396b2f25430925.protect@withheldforprivacy.com
Registry Admin ID: 
Admin Name: Withheld for Privacy Purposes
[...]
Tech Name: Withheld for Privacy Purposes
[...]
Name Server: kip.ns.cloudflare.comName Server: uma.ns.cloudflare.com
DNSSEC: unsigned
URL of the ICANN WHOIS Data Problem Reporting System: http://wdprs.internic.net/
>>> Last update of WHOIS database: 2021-10-13T10:42:40.11Z <<<
For more information on Whois status codes, please visit https://icann.org/epp
```

At first glance it looks basic, but having details about the owner, technical admin, email addresses, name servers etc is very valuable.

Next is DNS. We can use tools like nslookup and dig to return information.

```bash
pentester@TryHackMe$ nslookup cafe.thmredteam.com
Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
Name:	cafe.thmredteam.com
Address: 104.21.93.169
Name:	cafe.thmredteam.com
Address: 172.67.212.249
Name:	cafe.thmredteam.com
Address: 2606:4700:3034::ac43:d4f9
Name:	cafe.thmredteam.com
Address: 2606:4700:3034::6815:5da9
```


Dig is a tool that gives us more fine-grained control to find information. We can do things like point it at whatever DNS server we want. Here we will use Cloudflares DNS and ask our question:

```bash
pentester@TryHackMe$ dig cafe.thmredteam.com @1.1.1.1

; <<>> DiG 9.16.21-RH <<>> cafe.thmredteam.com @1.1.1.1
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 16698
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;cafe.thmredteam.com.		IN	A

;; ANSWER SECTION:
cafe.thmredteam.com.	3114	IN	A	104.21.93.169
cafe.thmredteam.com.	3114	IN	A	172.67.212.249

;; Query time: 4 msec
;; SERVER: 1.1.1.1#53(1.1.1.1)
;; WHEN: Thu Oct 14 10:44:11 EEST 2021
;; MSG SIZE  rcvd: 80
```

Another tool is the host tool. This tool will use local information from /etc/hosts before other sources where configured so be aware of that. These can be configured in /etc/nsswitch.conf along with the order of search on linux/unix systems.

```bash
pentester@TryHackMe$ host cafe.thmredteam.com
cafe.thmredteam.com has address 172.67.212.249
cafe.thmredteam.com has address 104.21.93.169
cafe.thmredteam.com has IPv6 address 2606:4700:3034::ac43:d4f9
cafe.thmredteam.com has IPv6 address 2606:4700:3034::6815:5da9
```

The last tool we will talk about is traceroute (linux systems) and tracert (windows systems).  These tools do the same thing, just written for different OS's.  As the name implies, it will trace the route of a packet from one location to another letting you examine the 'hops' between source and target. Please be aware that some routers won't respond to ping as a result we won't see their IP addresses. In that case we just see stars.

```bash
pentester@TryHackMe$ traceroute cafe.thmredteam.com
traceroute to cafe.thmredteam.com (172.67.212.249), 30 hops max, 60 byte packets
 1  _gateway (192.168.0.1)  3.535 ms  3.450 ms  3.398 ms
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  * * *
 7  172.16.79.229 (172.16.79.229)  4.663 ms  6.417 ms  6.347 ms
 8  * * *
 9  172.16.49.1 (172.16.49.1)  6.688 ms 172.16.48.1 (172.16.48.1)  6.671 ms 172.16.49.1 (172.16.49.1)  6.651 ms
10  213.242.116.233 (213.242.116.233)  96.769 ms 81.52.187.243 (81.52.187.243)  96.634 ms  96.614 ms
11  bundle-ether302.pastr4.paris.opentransit.net (193.251.131.116)  96.592 ms  96.689 ms  96.671 ms
12  193.251.133.251 (193.251.133.251)  96.679 ms  96.660 ms  72.465 ms
13  193.251.150.10 (193.251.150.10)  72.392 ms 172.67.212.249 (172.67.212.249)  91.378 ms  91.306 ms
```

In summary, these are passive tools. The safest of these is nslookup, dig since they query publically available info from public services. Traceroute is also quite safe to use as there is nothing illegal about using them, however, they can show up in logs if configured, tho it would appear innocuous.

__Questions__

When was `thmredteam.com` created (registered)? (YYYY-MM-DD)
Answer: _2021-09-24_

To how many IPv4 addresses does `clinic.thmredteam.com` resolve?
Answer: _2_

  
To how many IPv6 addresses does `clinic.thmredteam.com` resolve?
Answer: _2_


Task 4 - Advanced Searching
---------------------------------------------------

The next section we will cover here is some advanced search techniques aka Google Dorks.  Here are some examples:

| Symbol / Syntax                | Function                                          |
| ------------------------------ | ------------------------------------------------- |
| "search phrase"                | Find results w/ exact search phrase               |
| OSINT filetype:pdf             | Find file of PDF related to a certain term        |
| salary site:blog.tryhackme.com | Limit search results to a specific site           |
| pentest -site:example.com      | Exclude a specific term in the page title         |
| walkthrough intitle:TryHackMe  | Find pages with a specific term in the page title |
| challenge inurl:tryhackme      | Find pages with a specific term in the page URL   |
|                                |                                                   |


Note: In addition to PDF, there are many other filetypes that work such as doc, docx, ppt, pptx, xls and xlsx.
Some search engines, such as Google, provide a web interface for advanced searches: [Google Advanced Search](https://www.google.com/advanced_search). Other times, it is best to learn the syntax by heart, such as [Google Refine Web Searches](https://support.google.com/websearch/answer/2466433), [DuckDuckGo Search Syntax](https://help.duckduckgo.com/duckduckgo-help-pages/results/syntax/), and [Bing Advanced Search Options](https://help.bing.microsoft.com/apex/index/18/en-US/10002).

Because search engines crawl the web all the time, sometimes they can index secret or confidential information. Things like:

-   Documents for internal company use
-   Confidential spreadsheets with usernames, email addresses, and even passwords
-   Files containing usernames
-   Sensitive directories
-   Service version number (some of which might be vulnerable and unpatched)
-   Error messages


Combining advanced Google searches with specific terms, documents containing sensitive information or vulnerable web servers can be found. Websites such as [Google Hacking Database](https://www.exploit-db.com/google-hacking-database) (GHDB) collect such search terms and are publicly available.

The GHDB has the following categories:

-   **Footholds**  
    Consider [GHDB-ID: 6364](https://www.exploit-db.com/ghdb/6364) as it uses the query `intitle:"index of" "nginx.log"` to discover Nginx logs and might reveal server misconfigurations that can be exploited.
-   **Files Containing Usernames**  
    For example, [GHDB-ID: 7047](https://www.exploit-db.com/ghdb/7047) uses the search term `intitle:"index of" "contacts.txt"` to discover files that leak juicy information.
-   **Sensitive Directories**  
    For example, consider [GHDB-ID: 6768](https://www.exploit-db.com/ghdb/6768), which uses the search term `inurl:/certs/server.key` to find out if a private RSA key is exposed.
-   **Web Server Detection**  
    Consider [GHDB-ID: 6876](https://www.exploit-db.com/ghdb/6876), which detects GlassFish Server information using the query `intitle:"GlassFish Server - Server Running"`.
-   **Vulnerable Files**  
    For example, we can try to locate PHP files using the query `intitle:"index of" "*.php"`, as provided by [GHDB-ID: 7786](https://www.exploit-db.com/ghdb/7786).
-   **Vulnerable Servers**  
    For instance, to discover SolarWinds Orion web consoles, [GHDB-ID: 6728](https://www.exploit-db.com/ghdb/6728) uses the query `intext:"user name" intext:"orion core" -solarwinds.com`.
-   **Error Messages**  
    Plenty of useful information can be extracted from error messages. One example is [GHDB-ID: 5963](https://www.exploit-db.com/ghdb/5963), which uses the query `intitle:"index of" errors.log` to find log files related to errors.

Some of the queries you will find here, you may need to refactor to fit your needs. To avoid legal issues, it is best to refrain from accessing files outside the scope of your legal agreement. Tho, I would say that anything indexed via search engine is already in the public domain. It might be hard for a company to argue this point. If it was illegal then the search engine itself mostly to blame.

There is an excellent room on TryHackMe related to  [Google Dorking](https://tryhackme.com/room/googledorking) . Join that room for more in-depth information.

Next we will cover a few more resources that can provide us with valuable data without directly interacting with our target:

* Social Media
* Job Ads


### Social Media

Social Media sites these days are very popular. It's quite common to see employees posting photos of their offices, retreats, parties and even some private info. Here are some popular ones to check:

-   LinkedIn
-   Twitter
-   Facebook
-   Instagram

Using these you can find names of company employees and in some circumstances you could discover information that would allow you to solve those pesky Password Recovery Question/Challenge -> Reponses.  Example, Jill works at the Bank. She posts about her experience on Facebook, along with other personal details like pictures of her dog Trudy.  One of the questions ask on her Bank login if you click 'Forgot Password' might be 'What is your dogs name?'.  Other things like posts from Technical staff might reveal details about a company's vendors and systems. For example, a network engineer who was recently issued Juniper certifications may allude to Juniper networking infrastructure being used at their offices.


### Job Ads

Job Ads can also tell you a lot about a company. Things like email addresses, contact info, employee names, job posts for technical positions might give you an idea about what is in the company's infrastructure. It is also worth checking job listings in the newspapers, web and also their own company website.

Note that the [Wayback Machine](https://archive.org/web/) can be helpful to retrieve previous versions of a job opening page on your client’s site.

__Questions__

How would you search using Google for `xls` indexed for http://clinic.thmredteam.com?
Answer: _filetype:xls site:clinic.thmredteam.com_

How would you search using Google for files with the word `passwords` for http://clinic.thmredteam.com?
Answer: _passwords site:clinic.thmredteam.com_


Task 5 - Specialized Search Engines
-------------------------------------------------------------

### WHOIS and DNS Related

We previously talked about using WHOIS and DNS tools like dig to get information about a target. There are also paid services that maintain historical data like WHOIS data for a price. It might be useful for example to lookup old DNS records where the owner may not have initially applied for privacy. 

There are some websites that offer advanced DNS services that are free to use. Some of these are:

-   [VidewDNS.info](https://viewdns.info/)
-   [Threat Intelligence Platform](https://threatintelligenceplatform.com/)

### ViewDNS.info

[ViewDNS.info](https://viewdns.info/) offers _Reverse IP Lookup_. Previously web servers would use one or more IPs. More recently however,  it is common to find these shared hosting servers. With shared hosting, one IP address is shared among many web servers with different domain names. With a reverse IP lookup, starting from a domain name or an IP address, you can find the other domain names using a specific IP address.

In the figure below, we used reverse IP lookup to find other servers sharing the same IP addresses used by `cafe.thmredteam.com`. Therefore, it is important to note that knowing the IP address does not necessarily lead to a single website.

![[redteamrecon1.png]]

### Threat Intelligence Platform

[Threat Intelligence Platform](https://threatintelligenceplatform.com/) requires you to provide a domain name or an IP address, and it will launch a series of tests from malware checks to WHOIS and DNS queries. The results would be similar to WHOIS and DNS lookups but this platform presents them in a way that is easier to read. There is also extra info that we get with our report. For example Nameserver (NS) records are resolved as shown:

![[redteamrecon2.png]]

We also have the ability, like with the ViewDNS.info site, to see all the the domains on the same IP:

![[redteamrecon3.png]]


### Specialized Search Engines

**Censys**

[Censys Search](https://search.censys.io/) can provide a lot of information about IP addresses and domains. If we look at the next example, we can see that this IP address is hosted by Cloudflare and there are lots of ports and things.  It is easy to see that this IP address serves other websites than just our target `cafe.thmredteam.com`. We must be very careful in our RedTeam Engagements not to affect customers and services outside the scope of our contract.

![[redteamrecon4.png]]

**Shodan**

The [Shodan](https://www.shodan.io/) tool is widely used in Passive Recon. In this room we will discuss using it from the command line.

To use it, you first need to create an account with shodan and use your API key like so:
`shodan init API_KEY`

You can use diferent filters depending on the type of Shodan account you have. 

Check out [Shodan CLI](https://cli.shodan.io/) for more info.

Here is an example:

```
kali@kali  ~  nslookup cafe.thmredteam.com     
Server:         192.168.11.123
Address:        192.168.11.123#53

Non-authoritative answer:
Name:   cafe.thmredteam.com
Address: 104.21.93.169
Name:   cafe.thmredteam.com
Address: 172.67.212.249
Name:   cafe.thmredteam.com
Address: 2606:4700:3034::6815:5da9
Name:   cafe.thmredteam.com
Address: 2606:4700:3034::ac43:d4f9

 kali@kali  ~  shodan host 104.21.93.169                   
104.21.93.169
City:                    San Francisco
Country:                 United States
Organization:            Cloudflare, Inc.
Updated:                 2023-01-17T23:40:36.967982
Number of open ports:    9

Ports:
     80/tcp CloudFlare 
    443/tcp CloudFlare 
   2082/tcp  
   2083/tcp  
   2086/tcp  
   2087/tcp  
   8080/tcp CloudFlare 
   8443/tcp CloudFlare 
   8880/tcp  
 kali@kali  ~  

```

__Questions__

What is the `shodan` command to get your Internet-facing IP address?
Answer: _shodan myip_




Task 6 - Recon-ng
-----------------------------------------

[Recon-ng](https://github.com/lanmaster53/recon-ng) is a framework that helps automate the OSINT work.  This framework uses APIs from many different authors. Some of them require keys in order to query the API. 

First we can start it with the `recon-ng` command. It should be installed by default on all Kali installations.

After you start it you should get  prompt like `[recon-ng][default] >`. Now you would need to select whatever installed module you want to use.

```bash
kali@kali  ~  recon-ng -w thmredteam.com  
[*] Version check disabled.

    _/_/_/    _/_/_/_/    _/_/_/    _/_/_/    _/      _/            _/      _/    _/_/_/
   _/    _/  _/        _/        _/      _/  _/_/    _/            _/_/    _/  _/       
  _/_/_/    _/_/_/    _/        _/      _/  _/  _/  _/  _/_/_/_/  _/  _/  _/  _/  _/_/_/
 _/    _/  _/        _/        _/      _/  _/    _/_/            _/    _/_/  _/      _/ 
_/    _/  _/_/_/_/    _/_/_/    _/_/_/    _/      _/            _/      _/    _/_/_/    


                                          /\
                                         / \\ /\
    Sponsored by...               /\  /\/  \\V  \/\
                                 / \\/ // \\\\\ \\ \/\
                                // // BLACK HILLS \/ \\
                               www.blackhillsinfosec.com

                  ____   ____   ____   ____ _____ _  ____   ____  ____
                 |____] | ___/ |____| |       |   | |____  |____ |
                 |      |   \_ |    | |____   |   |  ____| |____ |____
                                   www.practisec.com

                      [recon-ng v5.1.2, Tim Tomes (@lanmaster53)]                       

[*] No modules enabled/installed.

[recon-ng][thmredteam.com] > help

Commands (type [help|?] <topic>):
---------------------------------
back            Exits the current context
dashboard       Displays a summary of activity
db              Interfaces with the workspace's database
exit            Exits the framework
help            Displays this menu
index           Creates a module index (dev only)
keys            Manages third party resource credentials
marketplace     Interfaces with the module marketplace
modules         Interfaces with installed modules
options         Manages the current context options
pdb             Starts a Python Debugger session (dev only)
script          Records and executes command scripts
shell           Executes shell commands
show            Shows various framework items
snapshots       Manages workspace snapshots
spool           Spools output to a file
workspaces      Manages workspaces
```

So now we will practice:

1. Create Workspace for our project
2. Insert the initial info into our DB.
3. Search the marketplace for modules and learn about them before installing.
4. List the installed modules and load one.
5. Run the loaded Module.

### Creating  a Workspace

Run `workspaces create WORKSPACE_NAME` to create  new workspace for your investigation.

`[recon-ng] > workspaces create thmredteam

### Seeding the Database

In recon, we start out with one peice of information on a target, such as the domin name, and add it to the database. Then as we add more info it will transform it further so we know more and more about the target.

If for example, we want to insert the domain for `thmredteam.com` into the domains table,  we can use the `db insert domains` command.

```bash
[recon-ng][thmredteam] > db insert domains
domain (TEXT): thmredteam.com
notes (TEXT): 
[*] 1 rows affected.
```

### Recon-ng Marketplace

Next it would be helpful to search for a module that takes the domain name and transforms it into further information.

Here are some of the Marketplace commands:

-   `marketplace search KEYWORD` to search for available modules with _keyword_.
-   `marketplace info MODULE` to provide information about the module in question.
-   `marketplace install MODULE` to install the specified module into Recon-ng.
-   `marketplace remove MODULE` to uninstall the specified module.

The modules are grouped under multiple categories like discovery, import, recon etc. Also those can be divided into many sub-categories.

Let's search for mods containing domains-

```bash
[recon-ng][thmredteam] > marketplace search domains
[*] Searching module index for 'domains'...

  +---------------------------------------------------------------------------------------------------+
  |                        Path                        | Version |     Status    |  Updated   | D | K |
  +---------------------------------------------------------------------------------------------------+
  | discovery/info_disclosure/cache_snoop              | 1.1     | not installed | 2020-10-13 |   |   |
  | recon/companies-domains/censys_subdomains          | 2.0     | not installed | 2021-05-10 | * | * |
  | recon/companies-domains/pen                        | 1.1     | not installed | 2019-10-15 |   |   |
  | recon/companies-domains/viewdns_reverse_whois      | 1.1     | not installed | 2021-08-24 |   |   |
  | recon/companies-domains/whoxy_dns                  | 1.1     | not installed | 2020-06-17 |   | * |
  | recon/companies-hosts/censys_tls_subjects          | 2.0     | not installed | 2021-05-11 | * | * |
  | recon/contacts-domains/migrate_contacts            | 1.1     | not installed | 2020-05-17 |   |   |
  | recon/domains-companies/censys_companies           | 2.0     | not installed | 2021-05-10 | * | * |
  | recon/domains-companies/pen                        | 1.1     | not installed | 2019-10-15 |   |   |
  | recon/domains-companies/whoxy_whois                | 1.1     | not installed | 2020-06-24 |   | * |
  | recon/domains-contacts/hunter_io                   | 1.3     | not installed | 2020-04-14 |   | * |
  | recon/domains-contacts/metacrawler                 | 1.1     | not installed | 2019-06-24 | * |   |
  | recon/domains-contacts/pen                         | 1.1     | not installed | 2019-10-15 |   |   |
  | recon/domains-contacts/pgp_search                  | 1.4     | not installed | 2019-10-16 |   |   |
  | recon/domains-contacts/whois_pocs                  | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-contacts/wikileaker                  | 1.0     | not installed | 2020-04-08 |   |   |
  | recon/domains-credentials/pwnedlist/account_creds  | 1.0     | not installed | 2019-06-24 | * | * |
  | recon/domains-credentials/pwnedlist/api_usage      | 1.0     | not installed | 2019-06-24 |   | * |
  | recon/domains-credentials/pwnedlist/domain_creds   | 1.0     | not installed | 2019-06-24 | * | * |
  | recon/domains-credentials/pwnedlist/domain_ispwned | 1.0     | not installed | 2019-06-24 |   | * |
  | recon/domains-credentials/pwnedlist/leak_lookup    | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-credentials/pwnedlist/leaks_dump     | 1.0     | not installed | 2019-06-24 |   | * |
  | recon/domains-domains/brute_suffix                 | 1.1     | not installed | 2020-05-17 |   |   |
  | recon/domains-hosts/binaryedge                     | 1.2     | not installed | 2020-06-18 |   | * |
  | recon/domains-hosts/bing_domain_api                | 1.0     | not installed | 2019-06-24 |   | * |
  | recon/domains-hosts/bing_domain_web                | 1.1     | not installed | 2019-07-04 |   |   |
  | recon/domains-hosts/brute_hosts                    | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-hosts/builtwith                      | 1.1     | not installed | 2021-08-24 |   | * |
  | recon/domains-hosts/censys_domain                  | 2.0     | not installed | 2021-05-10 | * | * |
  | recon/domains-hosts/certificate_transparency       | 1.2     | not installed | 2019-09-16 |   |   |
  | recon/domains-hosts/google_site_web                | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-hosts/hackertarget                   | 1.1     | not installed | 2020-05-17 |   |   |
  | recon/domains-hosts/mx_spf_ip                      | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-hosts/netcraft                       | 1.1     | not installed | 2020-02-05 |   |   |
  | recon/domains-hosts/shodan_hostname                | 1.1     | not installed | 2020-07-01 | * | * |
  | recon/domains-hosts/spyse_subdomains               | 1.1     | not installed | 2021-08-24 |   | * |
  | recon/domains-hosts/ssl_san                        | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-hosts/threatcrowd                    | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-hosts/threatminer                    | 1.0     | not installed | 2019-06-24 |   |   |
  | recon/domains-vulnerabilities/ghdb                 | 1.1     | not installed | 2019-06-26 |   |   |
  | recon/domains-vulnerabilities/xssed                | 1.1     | not installed | 2020-10-18 |   |   |
  | recon/hosts-domains/migrate_hosts                  | 1.1     | not installed | 2020-05-17 |   |   |
  | recon/hosts-hosts/censys_query                     | 2.0     | not installed | 2021-05-10 | * | * |
  | recon/hosts-hosts/virustotal                       | 1.0     | not installed | 2019-06-24 |   | * |
  | recon/netblocks-hosts/virustotal                   | 1.0     | not installed | 2019-06-24 |   | * |
  +---------------------------------------------------------------------------------------------------+

  D = Has dependencies. See info for details.
  K = Requires keys. See info for details.

[recon-ng][thmredteam] > 
```

See that many sub-categories under recon such as domain-hosts tells us what kind of new info we will get from that. Domain-hosts means that module will find hosts related to the provided domain.

Some modules marked with a `*` under the `K` column mean that they require a key.

Some modules marked with a `*` under the `D` column mean that their party libs might be needed.

To get more info on a module, you can use `marketplace info MODULE` 

```bash
[recon-ng][thmredteam] > marketplace info google_site_web
                                                                                                                       
  +---------------------------------------------------------------------------------------------------------------------------------+                                                                                                         
  | path          | recon/domains-hosts/google_site_web                                                                             |                                                                                                         
  | name          | Google Hostname Enumerator                                                                                      |
  | author        | Tim Tomes (@lanmaster53)                                                                                        |
  | version       | 1.0                                                                                                             |
  | last_updated  | 2019-06-24                                                                                                      |
  | description   | Harvests hosts from Google.com by using the 'site' search operator. Updates the 'hosts' table with the results. |
  | required_keys | []                                                                                                              |
  | dependencies  | []                                                                                                              |
  | files         | []                                                                                                              |
  | status        | not installed                                                                                                   |
  +---------------------------------------------------------------------------------------------------------------------------------+
```

We can then install the modules with `marketplace install MODULE`

```bash
[recon-ng][thmredteam] > marketplace install google_site_web
[*] Module installed: recon/domains-hosts/google_site_web
[*] Reloading modules...
[recon-ng][thmredteam] > marketplace info google_site_web

  +---------------------------------------------------------------------------------------------------------------------------------+
  | path          | recon/domains-hosts/google_site_web                                                                             |
  | name          | Google Hostname Enumerator                                                                                      |
  | author        | Tim Tomes (@lanmaster53)                                                                                        |
  | version       | 1.0                                                                                                             |
  | last_updated  | 2019-06-24                                                                                                      |
  | description   | Harvests hosts from Google.com by using the 'site' search operator. Updates the 'hosts' table with the results. |
  | required_keys | []                                                                                                              |
  | dependencies  | []                                                                                                              |
  | files         | []                                                                                                              |
  | status        | installed                                                                                                       |
  +---------------------------------------------------------------------------------------------------------------------------------+
```

### Working with Installed Modules

We can work with modules using:

-   `modules search` to get a list of all the installed modules
-   `modules load MODULE` to load a specific module to memory

Lets install and run viewdns_reverse_whois.

```bash
[recon-ng][thmredteam] > marketplace info viewdns_reverse_whois

  +-----------------------------------------------------------------------------------------------------------------+
  | path          | recon/companies-domains/viewdns_reverse_whois                                                   |
  | name          | Viewdns Reverse Whois Domain Harvester                                                          |
  | author        | Gaetan Ferry (@_mabote_) from @synacktiv                                                        |
  | version       | 1.1                                                                                             |
  | last_updated  | 2021-08-24                                                                                      |
  | description   | Harvests domain names belonging to a company by using the viewdns.info free reverse whois tool. |
  | required_keys | []                                                                                              |
  | dependencies  | []                                                                                              |
  | files         | []                                                                                              |
  | status        | not installed                                                                                   |
  +-----------------------------------------------------------------------------------------------------------------+

[recon-ng][thmredteam] > marketplace install viewdns_reverse_whois
[*] Module installed: recon/companies-domains/viewdns_reverse_whois
[*] Reloading modules...
[recon-ng][thmredteam] > modules load viewdns_reverse_whois
```

To run it we need to set the required options:
```bash
[recon-ng][thmredteam][viewdns_reverse_whois] > options list

  Name    Current Value  Required  Description
  ------  -------------  --------  -----------
  SOURCE  default        yes       source of input (see 'info' for details)

[recon-ng][thmredteam][viewdns_reverse_whois] > 
```

Next let's use the `google_site_web` module we installed previously.

```bash
[recon-ng][thmredteam.com] > modules search google
[*] Searching installed modules for 'google'...

  Recon
  -----
    recon/domains-hosts/google_site_web

[recon-ng][thmredteam.com] > modules load google_site_web
[recon-ng][thmredteam.com][google_site_web] > options list

  Name    Current Value  Required  Description
  ------  -------------  --------  -----------
  SOURCE  default        yes       source of input (see 'info' for details)

[recon-ng][thmredteam.com][google_site_web] > info

      Name: Google Hostname Enumerator
    Author: Tim Tomes (@lanmaster53)
   Version: 1.0

Description:
  Harvests hosts from Google.com by using the 'site' search operator. Updates the 'hosts' table with
  the results.

Options:
  Name    Current Value  Required  Description
  ------  -------------  --------  -----------
  SOURCE  default        yes       source of input (see 'info' for details)

Source Options:
  default        SELECT DISTINCT domain FROM domains WHERE domain IS NOT NULL
  <string>       string representing a single input
  <path>         path to a file containing a list of inputs
  query <sql>    database query returning one column of inputs

[recon-ng][thmredteam.com][google_site_web] > options set SOURCE thmredteam.com
SOURCE => thmredteam.com
[recon-ng][thmredteam.com][google_site_web] > options list

  Name    Current Value   Required  Description
  ------  -------------   --------  -----------
  SOURCE  thmredteam.com  yes       source of input (see 'info' for details)

[recon-ng][thmredteam.com][google_site_web] > run

--------------
THMREDTEAM.COM
--------------
[*] Searching Google for: site:thmredteam.com
[*] Country: None
[*] Host: cafe.thmredteam.com
[*] Ip_Address: None
[*] Latitude: None
[*] Longitude: None
[*] Notes: None
[*] Region: None
[*] --------------------------------------------------
[*] Country: None
[*] Host: clinic.thmredteam.com
[*] Ip_Address: None
[*] Latitude: None
[*] Longitude: None
[*] Notes: None
[*] Region: None
[*] --------------------------------------------------
[*] Searching Google for: site:thmredteam.com -site:cafe.thmredteam.com -site:clinic.thmredteam.com
[*] No New Subdomains Found on the Current Page. Jumping to Result 201.
[..]
[recon-ng][thmredteam.com][google_site_web] > db query select * from hosts

  +--------------------------------------------------------------------------------------------------------+
  |          host         | ip_address | region | country | latitude | longitude | notes |      module     |
  +--------------------------------------------------------------------------------------------------------+
  | cafe.thmredteam.com   |            |        |         |          |           |       | google_site_web |
  | clinic.thmredteam.com |            |        |         |          |           |       | google_site_web |
  +--------------------------------------------------------------------------------------------------------+

[*] 2 rows returned

```

This module has queried Google and discovered two hosts, `cafe.thmredteam.com` and `clinic.thmredteam.com`.

### Keys

Some modules as mentioned require keys to connect to their respective API.  A mark in the `K` column denotes this.

-   `keys list` lists the keys
-   `keys add KEY_NAME KEY_VALUE` adds a key
-   `keys remove KEY_NAME` removes a key

Once you have the set of modules installed, you can proceed to load and run them.

-   `modules load MODULE` loads an installed module
-   `CTRL + C` unloads the module.
-   `info` to review the loaded module’s info.
-   `options list` lists available options for the chosen module.
-   `options set NAME VALUE`
-   `run` to execute the loaded module.

### Demo

Done (repeat of above)

__Questions__

How do you start `recon-ng` with the workspace `clinicredteam`?
Answers: _recon-ng -w clinicredteam_

How many modules with the name `virustotal` exist?
```bash
[recon-ng][thmredteam.com] > marketplace search virus
[*] Searching module index for 'virus'...

  +---------------------------------------------------------------------------------+
  |               Path               | Version |     Status    |  Updated   | D | K |
  +---------------------------------------------------------------------------------+
  | recon/hosts-hosts/virustotal     | 1.0     | not installed | 2019-06-24 |   | * |
  | recon/netblocks-hosts/virustotal | 1.0     | not installed | 2019-06-24 |   | * |
  +---------------------------------------------------------------------------------+

  D = Has dependencies. See info for details.
  K = Requires keys. See info for details.
```
Answer: _2_

There is a single module under `hosts-domains`. What is its name?
```bash
[recon-ng][thmredteam.com] > marketplace search hosts-domains
[*] Searching module index for 'hosts-domains'...

  +----------------------------------------------------------------------------------+
  |                Path               | Version |     Status    |  Updated   | D | K |
  +----------------------------------------------------------------------------------+
  | recon/hosts-domains/migrate_hosts | 1.1     | not installed | 2020-05-17 |   |   |
  +----------------------------------------------------------------------------------+
```
Answer: _migrate_hosts_

`ensys_email_address` is a module that “retrieves email addresses from the TLS certificates for a company.” Who is the author?
```bash
[recon-ng][thmredteam.com] > marketplace info censys_email_address

  +-----------------------------------------------------------------------------------------------------------------------------------+
  | path          | recon/companies-contacts/censys_email_address                                                                     |
  | name          | Censys emails by company                                                                                          |
  | author        | Censys Team                                                                                                       |
  | version       | 2.0                                                                                                               |
  | last_updated  | 2021-05-11                                                                                                        |
  | description   | Retrieves email addresses from the TLS certificates for a company. Updates the 'contacts' table with the results. |
  | required_keys | ['censysio_id', 'censysio_secret']                                                                                |
  | dependencies  | ['censys>=2.0.0']                                                                                                 |
  | files         | []                                                                                                                |
  | status        | not installed                                                                                                     |
  +-----------------------------------------------------------------------------------------------------------------------------------+
```
Answer: _Censys Team_


Task 7 - Maltego
---------------------------------

[Maltego](https://www.maltego.com/) is an application that blends mind-mapping with OSINT. This tool takes a peice of information such as a name or email and then does various transforms.

This may be used later for phishing campaigns.

In this tool a **transform** is a piece of code that queries an API to gather info related to a specific entity.

![[maltego-1.png]]

Be careful because some of these transforms may affect connectivity to the target. It is recommended you understand how these work and what the outcome may be before using them.

Each transform is expected to lead to new values. For example, starting from "DNS Name" `cafe.thmredteam.com`, we should expect to get new kinds of entities back. If we used the "To IP Address" transform we should see some IP addresses.

![[maltego-2.png]]

One way to achieve this on Maltego is to right-click on the “DNS Name” `cafe.thmredteam.com` and choose:

1.  Standard Transforms
2.  Resolve to IP
3.  To IP Address (DNS)

After executing this transform, we would get one or more IP addresses, as shown below.

![[maltego-3.png]]

hen we can choose to apply another transform for one of the IP addresses. Consider the following transform:

1.  DNS from IP
2.  To DNS Name from passive DNS (Robtex)

This transform would continue to transform our graph as shown below:

![[maltego-4.png]]

From these examples, you should be able to see how the workflow of Maltego goes. The work is based on transforms. It allows you to use a few clicks to get together a nice graph of information that you can use within a few clicks.

We looked at the `whois` and `nslookup` commands from previous tasks.  When we use these in Maltego, we can see that it is able to extract the info and arrange it, but of note the email addresses don't seem useful, due to privacy concerns.

![[maltego-5.png]]

The transforms we have used are great, and powerful. But if we really want to take advantage of Maltego, we need a subscription. This will allow us to add even more powerful transforms. The transforms are grouped into categories based on type, pricing, etc.

![[maltego-6.png]]

Using Maltego requires activiation, even when just using the CE (community) edition. So we can either install Maltego on our own System or  by visiting [Maltego Transform Hub](https://www.maltego.com/transform-hub/)

__Questions__

What is the name of the transform that queries NIST’s National Vulnerability Database?
Answer: _NIST NVD_

What is the name of the project that offers a transform based on ATT&CK?
Answer: _MISP Project_


Task 8 - Summary
--------------------------------------

In Cyber era, and Redteaming, Information we can collect on a target prior to attack is paramount.

We have reviewed tools like `whois`, `dig`, and `tracer[t,oute]`.  We have also seen other tools such as recon-ng and Maltego, that allow us to collect info and display them in one place.

The purpose is so we can collect as much information as possible on the Target. There are of course a lot more tools such as [Sherlock](https://github.com/sherlock-project/sherlock.git), which are helpful at finding info on targets in Social Media Spaces. You should research and find and use as many of these tools as possible.

It should be noted too that this type of OSINT is invaluable when creating phishing campaigns. In brief, the more information we have on our target, the higher our chances of success.

__Questions__

The different tools and websites presented in this room provide the basics necessary to tackle further reconnaissance work.
Answer: _None Needed_


