Learn how to use DNS, advanced searching, Recon-ng, and Maltego to collect information about your target.

Task 1 - Introduction
-----------------------------------

It is important to understand your enemy in battle. If you watch and wait, you can understand their normal patterns and attack during a time they are not expecting.

Reconnaisance (recon) allows us to collect various information about our target without alerting them to our precense because it is a passive activity where we don't really need to connect to any of their resources. Much information can be found on the internet.

The tasks of this room cover the following topics:

-   Types of reconnaissance activities
-   WHOIS and DNS-based reconnaissance
-   Advanced searching
-   Searching by image
-   Google Hacking
-   Specialized search engines
-   Recon-ng
-   Maltego

Some specific objectives we'll cover include:

-   Discovering subdomains related to our target company
-   Gathering publicly available information about a host and IP addresses
-   Finding email addresses related to the target
-   Discovering login credentials and leaked passwords
-   Locating leaked documents and spreadsheets

There are essentially 2 types of recon:

* Active - This is noisy and may alert somenoe to our precense.
* Passive - This is stealthy and won't require us to connect to the enemy but rather gather data from other sources outside of the enemy resources.

__Questions__

We suggest you start the AttackBox and experiment with every command and tool we demonstrate.
Answer: _None Needed_

Task 2 - Taxonomy of Reconnaissance
----------------------------------------------------------------

Reconnaissance (recon) can be classified into two parts:

1.  **Passive Recon**: can be carried out by watching passively
2.  **Active Recon**: requires interacting with the target to provoke it in order to observe its response.

Passive recon is just using open tools like DNS lookups, whois and other data that are maintained by 3rd parties. We can find lots of great info such as IP address blocks, email addresses, employee names, and job postings.

Active recon requires that we interact with the target by sending requests and packets and observing the responses. An example is using NMAP to scan a target. In this type, we want to discover things like hosts, running servers, listening services and version numbers.

Active recon can be classified as:

1.  **External Recon**: Conducted outside the target's network and focuses on the externally facing assets assessable from the Internet. One example is running Nikto from outside the company network.
2.  **Internal Recon**: Conducted from within the target company's network. In other words, the pentester or red teamer might be physically located inside the company building. In this scenario, they might be using an exploited host on the target's network. An example would be using Nessus to scan the internal network using one of the target’s computers.

__Questions__

Ensure you have a clear understanding of the different types of recon activities before proceeding.
Answer: _None Needed_


Task 3 - Built-In Tools
------------------------------------

In this task we will learn about some of the passive recon tools:

* whois
* dig
* nslookup
* host
* tracert / traceroute

	WHOIS, is a request/response protocol which is used to query Registrar Database of domain names which they are required to keep as part of the RFC 3912 spec. The whois command will query that database and return information we are looking for.

We can see things like:

-   Registrar WHOIS server
-   Registrar URL
-   Record creation date
-   Record update date
-   Registrant contact info and address (unless withheld for privacy)
-   Admin contact info and address (unless withheld for privacy)
-   Tech contact info and address (unless withheld for privacy)


```bash
pentester@TryHackMe$ whois thmredteam.com
[Querying whois.verisign-grs.com]
[Redirected to whois.namecheap.com]
[Querying whois.namecheap.com]
[whois.namecheap.com]
Domain name: thmredteam.com
Registry Domain ID: 2643258257_DOMAIN_COM-VRSN
Registrar WHOIS Server: whois.namecheap.com
Registrar URL: http://www.namecheap.com
Updated Date: 0001-01-01T00:00:00.00Z
Creation Date: 2021-09-24T14:04:16.00Z
Registrar Registration Expiration Date: 2022-09-24T14:04:16.00Z
Registrar: NAMECHEAP INC
Registrar IANA ID: 1068
Registrar Abuse Contact Email: abuse@namecheap.com
Registrar Abuse Contact Phone: +1.6613102107
Reseller: NAMECHEAP INC
Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited
Registry Registrant ID: 
Registrant Name: Withheld for Privacy Purposes
Registrant Organisation: Privacy service provided by Withheld for Privacy ehf
Registrant Street: Kalkofnsvegur 2 
Registrant City: Reykjavik
Registrant State/Province: Capital Region
Registrant Postal Code: 101
Registrant Country: IS
Registrant Phone: +354.4212434
Registrant Phone Ext: 
Registrant Fax: 
Registrant Fax Ext: 
Registrant Email: 4c9d5617f14e4088a4396b2f25430925.protect@withheldforprivacy.com
Registry Admin ID: 
Admin Name: Withheld for Privacy Purposes
[...]
Tech Name: Withheld for Privacy Purposes
[...]
Name Server: kip.ns.cloudflare.comName Server: uma.ns.cloudflare.com
DNSSEC: unsigned
URL of the ICANN WHOIS Data Problem Reporting System: http://wdprs.internic.net/
>>> Last update of WHOIS database: 2021-10-13T10:42:40.11Z <<<
For more information on Whois status codes, please visit https://icann.org/epp
```

At first glance it looks basic, but having details about the owner, technical admin, email addresses, name servers etc is very valuable.

Next is DNS. We can use tools like nslookup and dig to return information.

```bash
pentester@TryHackMe$ nslookup cafe.thmredteam.com
Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
Name:	cafe.thmredteam.com
Address: 104.21.93.169
Name:	cafe.thmredteam.com
Address: 172.67.212.249
Name:	cafe.thmredteam.com
Address: 2606:4700:3034::ac43:d4f9
Name:	cafe.thmredteam.com
Address: 2606:4700:3034::6815:5da9
```


Dig is a tool that gives us more fine-grained control to find information. We can do things like point it at whatever DNS server we want. Here we will use Cloudflares DNS and ask our question:

```bash
pentester@TryHackMe$ dig cafe.thmredteam.com @1.1.1.1

; <<>> DiG 9.16.21-RH <<>> cafe.thmredteam.com @1.1.1.1
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 16698
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;cafe.thmredteam.com.		IN	A

;; ANSWER SECTION:
cafe.thmredteam.com.	3114	IN	A	104.21.93.169
cafe.thmredteam.com.	3114	IN	A	172.67.212.249

;; Query time: 4 msec
;; SERVER: 1.1.1.1#53(1.1.1.1)
;; WHEN: Thu Oct 14 10:44:11 EEST 2021
;; MSG SIZE  rcvd: 80
```

Another tool is the host tool. This tool will use local information from /etc/hosts before other sources where configured so be aware of that. These can be configured in /etc/nsswitch.conf along with the order of search on linux/unix systems.

```bash
pentester@TryHackMe$ host cafe.thmredteam.com
cafe.thmredteam.com has address 172.67.212.249
cafe.thmredteam.com has address 104.21.93.169
cafe.thmredteam.com has IPv6 address 2606:4700:3034::ac43:d4f9
cafe.thmredteam.com has IPv6 address 2606:4700:3034::6815:5da9
```

The last tool we will talk about is traceroute (linux systems) and tracert (windows systems).  These tools do the same thing, just written for different OS's.  As the name implies, it will trace the route of a packet from one location to another letting you examine the 'hops' between source and target. Please be aware that some routers won't respond to ping as a result we won't see their IP addresses. In that case we just see stars.

```bash
pentester@TryHackMe$ traceroute cafe.thmredteam.com
traceroute to cafe.thmredteam.com (172.67.212.249), 30 hops max, 60 byte packets
 1  _gateway (192.168.0.1)  3.535 ms  3.450 ms  3.398 ms
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  * * *
 7  172.16.79.229 (172.16.79.229)  4.663 ms  6.417 ms  6.347 ms
 8  * * *
 9  172.16.49.1 (172.16.49.1)  6.688 ms 172.16.48.1 (172.16.48.1)  6.671 ms 172.16.49.1 (172.16.49.1)  6.651 ms
10  213.242.116.233 (213.242.116.233)  96.769 ms 81.52.187.243 (81.52.187.243)  96.634 ms  96.614 ms
11  bundle-ether302.pastr4.paris.opentransit.net (193.251.131.116)  96.592 ms  96.689 ms  96.671 ms
12  193.251.133.251 (193.251.133.251)  96.679 ms  96.660 ms  72.465 ms
13  193.251.150.10 (193.251.150.10)  72.392 ms 172.67.212.249 (172.67.212.249)  91.378 ms  91.306 ms
```

In summary, these are passive tools. The safest of these is nslookup, dig since they query publically available info from public services. Traceroute is also quite safe to use as there is nothing illegal about using them, however, they can show up in logs if configured, tho it would appear innocuous.

__Questions__

When was `thmredteam.com` created (registered)? (YYYY-MM-DD)
Answer: _2021-09-24_

To how many IPv4 addresses does `clinic.thmredteam.com` resolve?
Answer: _2_

  
To how many IPv6 addresses does `clinic.thmredteam.com` resolve?
Answer: _2_


Task 4 - Advanced Searching
---------------------------------------------------

The next section we will cover here is some advanced search techniques aka Google Dorks.  Here are some examples:

| Symbol / Syntax                | Function                                          |
| ------------------------------ | ------------------------------------------------- |
| "search phrase"                | Find results w/ exact search phrase               |
| OSINT filetype:pdf             | Find file of PDF related to a certain term        |
| salary site:blog.tryhackme.com | Limit search results to a specific site           |
| pentest -site:example.com      | Exclude a specific term in the page title         |
| walkthrough intitle:TryHackMe  | Find pages with a specific term in the page title |
| challenge inurl:tryhackme      | Find pages with a specific term in the page URL   |
|                                |                                                   |


Note: In addition to PDF, there are many other filetypes that work such as doc, docx, ppt, pptx, xls and xlsx.
Some search engines, such as Google, provide a web interface for advanced searches: [Google Advanced Search](https://www.google.com/advanced_search). Other times, it is best to learn the syntax by heart, such as [Google Refine Web Searches](https://support.google.com/websearch/answer/2466433), [DuckDuckGo Search Syntax](https://help.duckduckgo.com/duckduckgo-help-pages/results/syntax/), and [Bing Advanced Search Options](https://help.bing.microsoft.com/apex/index/18/en-US/10002).

Because search engines crawl the web all the time, sometimes they can index secret or confidential information. Things like:

-   Documents for internal company use
-   Confidential spreadsheets with usernames, email addresses, and even passwords
-   Files containing usernames
-   Sensitive directories
-   Service version number (some of which might be vulnerable and unpatched)
-   Error messages


Combining advanced Google searches with specific terms, documents containing sensitive information or vulnerable web servers can be found. Websites such as [Google Hacking Database](https://www.exploit-db.com/google-hacking-database) (GHDB) collect such search terms and are publicly available.

The GHDB has the following categories:

-   **Footholds**  
    Consider [GHDB-ID: 6364](https://www.exploit-db.com/ghdb/6364) as it uses the query `intitle:"index of" "nginx.log"` to discover Nginx logs and might reveal server misconfigurations that can be exploited.
-   **Files Containing Usernames**  
    For example, [GHDB-ID: 7047](https://www.exploit-db.com/ghdb/7047) uses the search term `intitle:"index of" "contacts.txt"` to discover files that leak juicy information.
-   **Sensitive Directories**  
    For example, consider [GHDB-ID: 6768](https://www.exploit-db.com/ghdb/6768), which uses the search term `inurl:/certs/server.key` to find out if a private RSA key is exposed.
-   **Web Server Detection**  
    Consider [GHDB-ID: 6876](https://www.exploit-db.com/ghdb/6876), which detects GlassFish Server information using the query `intitle:"GlassFish Server - Server Running"`.
-   **Vulnerable Files**  
    For example, we can try to locate PHP files using the query `intitle:"index of" "*.php"`, as provided by [GHDB-ID: 7786](https://www.exploit-db.com/ghdb/7786).
-   **Vulnerable Servers**  
    For instance, to discover SolarWinds Orion web consoles, [GHDB-ID: 6728](https://www.exploit-db.com/ghdb/6728) uses the query `intext:"user name" intext:"orion core" -solarwinds.com`.
-   **Error Messages**  
    Plenty of useful information can be extracted from error messages. One example is [GHDB-ID: 5963](https://www.exploit-db.com/ghdb/5963), which uses the query `intitle:"index of" errors.log` to find log files related to errors.

Some of the queries you will find here, you may need to refactor to fit your needs. To avoid legal issues, it is best to refrain from accessing files outside the scope of your legal agreement. Tho, I would say that anything indexed via search engine is already in the public domain. It might be hard for a company to argue this point. If it was illegal then the search engine itself mostly to blame.

There is an excellent room on TryHackMe related to  [Google Dorking](https://tryhackme.com/room/googledorking) . Join that room for more in-depth information.

Next we will cover a few more resources that can provide us with valuable data without directly interacting with our target:

* Social Media
* Job Ads


### Social Media

Social Media sites these days are very popular. It's quite common to see employees posting photos of their offices, retreats, parties and even some private info. Here are some popular ones to check:

-   LinkedIn
-   Twitter
-   Facebook
-   Instagram

Using these you can find names of company employees and in some circumstances you could discover information that would allow you to solve those pesky Password Recovery Question/Challenge -> Reponses.  Example, Jill works at the Bank. She posts about her experience on Facebook, along with other personal details like pictures of her dog Trudy.  One of the questions ask on her Bank login if you click 'Forgot Password' might be 'What is your dogs name?'.  Other things like posts from Technical staff might reveal details about a company's vendors and systems. For example, a network engineer who was recently issued Juniper certifications may allude to Juniper networking infrastructure being used at their offices.


### Job Ads

Job Ads can also tell you a lot about a company. Things like email addresses, contact info, employee names, job posts for technical positions might give you an idea about what is in the company's infrastructure. It is also worth checking job listings in the newspapers, web and also their own company website.

Note that the [Wayback Machine](https://archive.org/web/) can be helpful to retrieve previous versions of a job opening page on your client’s site.

__Questions__

How would you search using Google for `xls` indexed for http://clinic.thmredteam.com?
Answer: _filetype:xls site:clinic.thmredteam.com_

How would you search using Google for files with the word `passwords` for http://clinic.thmredteam.com?
Answer: _passwords site:clinic.thmredteam.com_


Task 5 - Specialized Search Engines
-------------------------------------------------------------

### WHOIS and DNS Related

We previously talked about using WHOIS and DNS tools like dig to get information about a target. There are also paid services that maintain historical data like WHOIS data for a price. It might be useful for example to lookup old DNS records where the owner may not have initially applied for privacy. 

There are some websites that offer advanced DNS services that are free to use. Some of these are:

-   [VidewDNS.info](https://viewdns.info/)
-   [Threat Intelligence Platform](https://threatintelligenceplatform.com/)

### ViewDNS.info

[ViewDNS.info](https://viewdns.info/) offers _Reverse IP Lookup_. Previously web servers would use one or more IPs. More recently however,  it is common to find these shared hosting servers. With shared hosting, one IP address is shared among many web servers with different domain names. With a reverse IP lookup, starting from a domain name or an IP address, you can find the other domain names using a specific IP address.

In the figure below, we used reverse IP lookup to find other servers sharing the same IP addresses used by `cafe.thmredteam.com`. Therefore, it is important to note that knowing the IP address does not necessarily lead to a single website.

![[redteamrecon1.png]]

### Threat Intelligence Platform

[Threat Intelligence Platform](https://threatintelligenceplatform.com/) requires you to provide a domain name or an IP address, and it will launch a series of tests from malware checks to WHOIS and DNS queries. The results would be similar to WHOIS and DNS lookups but this platform presents them in a way that is easier to read. There is also extra info that we get with our report. For example Nameserver (NS) records are resolved as shown:

![[redteamrecon2.png]]

We also have the ability, like with the ViewDNS.info site, to see all the the domains on the same IP:

![[redteamrecon3.png]]


### Specialized Search Engines

**Censys**

[Censys Search](https://search.censys.io/) can provide a lot of information about IP addresses and domains. If we look at the next example, we can see that this IP address is hosted by Cloudflare and there are lots of ports and things.  It is easy to see that this IP address serves other websites than just our target `cafe.thmredteam.com`. We must be very careful in our RedTeam Engagements not to affect customers and services outside the scope of our contract.

![[redteamrecon4.png]]

**Shodan**

The [Shodan](https://www.shodan.io/) tool is widely used in Passive Recon. In this room we will discuss using it from the command line.

To use it, you first need to create an account with shodan and use your API key like so:
`shodan init API_KEY`

You can use diferent filters depending on the type of Shodan account you have. 

Check out [Shodan CLI](https://cli.shodan.io/) for more info.

Here is an example:

```
kali@kali  ~  nslookup cafe.thmredteam.com     
Server:         192.168.11.123
Address:        192.168.11.123#53

Non-authoritative answer:
Name:   cafe.thmredteam.com
Address: 104.21.93.169
Name:   cafe.thmredteam.com
Address: 172.67.212.249
Name:   cafe.thmredteam.com
Address: 2606:4700:3034::6815:5da9
Name:   cafe.thmredteam.com
Address: 2606:4700:3034::ac43:d4f9

 kali@kali  ~  shodan host 104.21.93.169                   
104.21.93.169
City:                    San Francisco
Country:                 United States
Organization:            Cloudflare, Inc.
Updated:                 2023-01-17T23:40:36.967982
Number of open ports:    9

Ports:
     80/tcp CloudFlare 
    443/tcp CloudFlare 
   2082/tcp  
   2083/tcp  
   2086/tcp  
   2087/tcp  
   8080/tcp CloudFlare 
   8443/tcp CloudFlare 
   8880/tcp  
 kali@kali  ~  

```

__Questions__

What is the `shodan` command to get your Internet-facing IP address?
Answer: _shodan myip_




Task 6 - Recon-ng
-----------------------------------------








