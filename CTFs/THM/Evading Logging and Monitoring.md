monitoringevation

Task 1 - Introduction
----------------------------------

One of the largest obstacles in an attacker’s path is logging and monitoring. Unlike anti-virus and **EDR** (**E**ndpoint **D**etection and **R**esponse) solutions, logging creates a physical record of activity that can be analyzed for malicious activity.

How a device is monitored will depend on the environment and preferences of the corporation. Teams may decide not to monitor some devices at all. Generally, a monitoring solution will begin at the host device, collecting application or event logs. Once logs are created, they can be kept on the device or sent to an event collector/forwarder. Once they are off the device, the defense team decides how to aggregate them; this is generally accomplished using an indexer and a **SIEM** (**S**ecurity **I**nformation and **E**vent **M**anager).

![[monitoringevasion-1.png]]

An attacker may not have much control once logs are taken off a device, but can control what is on the device and how it is ingested. The primary target for an attacker is the event logs, managed and controlled by **ETW** (**E**vent **T**racing for **W**indows).

This room will address event tracing and its weaknesses to allow an attacker to evade or disable ETW-based solutions.  

### Learning Objectives

-   Understand the technology and implementation of event tracing.
-   Understand how techniques are created to evade ETW.
-   Learn how to apply theoretical evasion concepts to code.

Before beginning this room, familiarize yourself with basic Windows usage and functionality; we recommend completing the [Windows Internals](https://tryhackme.com/room/windowsinternals) room. Basic programming knowledge in C and PowerShell is also recommended but not required.

We have provided a base Windows machine with the files needed to complete this room. You can access the machine in-browser or through RDP using the credentials below.

Machine IP: `MACHINE_IP`             Username: `Administrator`             Password: `Tryhackme!`

This is going to be a lot of information. Please buckle your seatbelts and locate your nearest fire extinguisher.

__Questions__

Read the above and continue to the next task.
Answer: _None Required_

Task 2 - Event Tracing
-----------------------------------

As previously mentioned, almost all event logging capability within Windows is handled from ETW at both the application and kernel level. While there are other services in place like _Event Logging_ and _Trace Logging,_ these are either extensions of ETW or less prevalent to attackers.

| Component   | Purpose                      |
| ----------- | ---------------------------- |
| Controllers | Build and configure sessions |
| Providers   | Generate events              |
| Consumers   | Interpret events                             |

We will cover each component and how it is instrumented in more depth in the next task.  

---

While less important to an attacker than components, event IDs are a core feature of Windows logging. Events are sent and transferred in XML(Extensible Markup Language) format which is the standard for how events are defined and implemented by providers. Below is an example of event ID 4624: _An account was successfully logged on_.

```jsx
Event ID:4624
Source:Security
Category:Logon/Logoff
Message:An account was successfully logged on.

Subject:
Security ID: NT AUTHORITY\\SYSTEM
Account Name: WORKSTATION123$
...
[ snip ]
...
Logon Type: 7

New Logon:
Security ID: CORPDOMAIN\\john.doe
Account Name: john.doe
...
[ snip ]
...
Process Information:
Process ID: 0x314
```

For more information about event logging, check out the [Windows Event Logs room](https://tryhackme.com/room/windowseventlogs).

---

At this point, we understand why logging can disrupt an attacker, but how exactly is ETW relevant to an attacker? ETW has visibility over a majority of the operating system, whereas logging generally has limited visibility or detail.

Due to the visibility of ETW, an attacker should always be mindful of the events that could be generated when carrying out their operation. The best approach to taking down ETW is to limit its insight as much as possible into specifically what you are doing while maintaining environment integrity.

In the upcoming tasks, we will cover ETW instrumentation, ETW evasion, and other ETW-based solutions.

__Questions__

What ETW component will build and configure sessions?
Answer: _Controllers_

What event ID logs when a user account was deleted?

**HINT:** For this, you need to good for ETW deleted user event id.

Answer: _4726_

Task 3 - Approaches to Log Evasion
-----------------------------------------------------------

Before diving deep into the more modern and technical evasion techniques, let’s look at the various approaches available and their impacts on attackers and defenders.

When first thinking about and assessing log evasion, you may think that simply destroying or tampering with the logs may be viable.

Following security best practices, it is typical for a modern environment to employ log forwarding. Log forwarding means that the SOC will move or “forward” logs from the host machine to a central server or indexer. Even if an attacker can delete logs from the host machine, they could already be off of the device and secured.

Assuming an attacker did destroy all of the logs before they were forwarded, or if they were not forwarded, how would this raise an alert? An attacker must first consider environment integrity; if no logs originate from a device, that can present serious suspicion and lead to an investigation. Even if an attacker did control what logs were removed and forwarded, defenders could still track the tampering.

| Event ID | Purpose                                      |
| -------- | -------------------------------------------- |
| 1102     | Logs when Windows Security audit was cleared |
| 104      | Logs when the log file was cleared           |
| 1100     | Logs when the Windows Event Log service was shut down                                             |

The above event IDs can monitor the process of destroying logs or “log smashing.” This poses a clear risk to attackers attempting to tamper with or destroy logs. Although it is possible to bypass these mitigations further or tamper with the logs, an attacker must assess the risk. When approaching an environment, you are generally unaware of security practices and take an **OPSEC** (**Op**erational **Sec**urity) risk by attempting this approach.

If the previous approach is too aggressive, how can we strategically approach the problem?

An attacker must focus on what logs a malicious technique may result in to keep an environment's integrity intact. Knowing what may be instrumented against them, they can utilize or modify published methods.

Most published techniques will target ETW components since that will allow an attacker the most control over the tracing process.

This room will break down some of the most common published techniques and a more modern technique that allows for a wide range of control.

__Questions__

How many total events can be used to track event tampering?
Answer: _3_

What event ID logs when the log file was cleared?
Answer: _104_




